# üöÄ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ–±–æ–≥–∞—â–µ–Ω–∏–µ –∞–¥—Ä–µ—Å–æ–≤ –¥–ª—è —Ç—ã—Å—è—á –æ–±—ä–µ–∫—Ç–æ–≤

## üìä –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å

| –û–±—ä—ë–º –æ–±—ä–µ–∫—Ç–æ–≤ | –í—Ä–µ–º—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ | API –∑–∞–ø—Ä–æ—Å—ã | –°—Ç–∞—Ç—É—Å |
|----------------|-----------------|-------------|--------|
| 100            | ~7 —Å–µ–∫—É–Ω–¥       | 60          | ‚úÖ –ë—ã—Å—Ç—Ä–æ |
| 1,000          | ~1 –º–∏–Ω—É—Ç–∞       | 600         | ‚úÖ –ë—ã—Å—Ç—Ä–æ |
| 5,000          | ~6 –º–∏–Ω—É—Ç        | 3,000       | ‚úÖ –ó–∞ —Ä–∞–∑ |
| 25,000         | ~28 –º–∏–Ω—É—Ç       | 15,000      | ‚úÖ –ó–∞ –¥–µ–Ω—å |

**–ö—ç—à —ç–∫–æ–Ω–æ–º–∏—Ç ~40% –∑–∞–ø—Ä–æ—Å–æ–≤** ‚Üí –ø–æ–≤—Ç–æ—Ä–Ω—ã–µ –∞–¥—Ä–µ—Å–∞ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—é—Ç—Å—è –º–≥–Ω–æ–≤–µ–Ω–Ω–æ!

---

## üéØ 3 —Ä–µ–∂–∏–º–∞ —Ä–∞–±–æ—Ç—ã

### 1Ô∏è‚É£ –ê–í–¢–û–ú–ê–¢–ò–ß–ï–°–ö–ò–ô (–¥–ª—è –æ–¥–∏–Ω–æ—á–Ω—ã—Ö –æ–±—ä–µ–∫—Ç–æ–≤)

**–ö–æ–≥–¥–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å:** –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –æ–±—ä–µ–∫—Ç–æ–≤ —á–µ—Ä–µ–∑ –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å, –≤–µ–±-—Ñ–æ—Ä–º—ã, API

**–ö–∞–∫ –ø–æ–¥–∫–ª—é—á–∏—Ç—å:**
```python
# –í app.py –ø–æ—Å–ª–µ —Å–æ–∑–¥–∞–Ω–∏—è db
from services.auto_geocoding import setup_auto_geocoding

with app.app_context():
    setup_auto_geocoding(db)  # –í–∫–ª—é—á–∏–ª–∏ –∞–≤—Ç–æ–º–∞—Ç–∏–∫—É
```

**–†–µ–∑—É–ª—å—Ç–∞—Ç:** –ö–∞–∂–¥—ã–π –Ω–æ–≤—ã–π –æ–±—ä–µ–∫—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ–±–æ–≥–∞—â–∞–µ—Ç—Å—è –ø—Ä–∏ `db.session.commit()`

```python
# –°–æ–∑–¥–∞—ë–º –æ–±—ä–µ–∫—Ç
prop = Property(
    title="2-–∫–æ–º–Ω –∫–≤–∞—Ä—Ç–∏—Ä–∞",
    latitude=45.0355,
    longitude=38.9753
)
db.session.add(prop)
db.session.commit()

# parsed_city, parsed_district, parsed_street –∑–∞–ø–æ–ª–Ω–∏–ª–∏—Å—å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏! ‚úÖ
print(prop.parsed_city)  # "–ö—Ä–∞—Å–Ω–æ–¥–∞—Ä"
```

---

### 2Ô∏è‚É£ BATCH –†–ï–ñ–ò–ú (–¥–ª—è –º–∞—Å—Å–æ–≤–æ–≥–æ –∏–º–ø–æ—Ä—Ç–∞)

**–ö–æ–≥–¥–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å:** –ò–º–ø–æ—Ä—Ç –∏–∑ Excel, –ø–∞—Ä—Å–∏–Ω–≥ —Å–∞–π—Ç–æ–≤, –º–∏–≥—Ä–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö

**–ö–∞–∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å:**
```python
from services.auto_geocoding import get_auto_geocoding_service

auto_service = get_auto_geocoding_service()

# –≠–¢–ê–ü 1: –ë—ã—Å—Ç—Ä—ã–π –∏–º–ø–æ—Ä—Ç –±–µ–∑ –æ–±–æ–≥–∞—â–µ–Ω–∏—è
auto_service.enable_batch_mode()  # –û—Ç–∫–ª—é—á–∞–µ–º –∞–≤—Ç–æ–º–∞—Ç–∏–∫—É

# –ò–º–ø–æ—Ä—Ç–∏—Ä—É–µ–º 1000 –æ–±—ä–µ–∫—Ç–æ–≤
for row in excel_data:
    prop = Property(title=row['title'], latitude=row['lat'], ...)
    db.session.add(prop)

db.session.commit()  # –ë—ã—Å—Ç—Ä—ã–π –∏–º–ø–æ—Ä—Ç –ë–ï–ó –≥–µ–æ–∫–æ–¥–∏—Ä–æ–≤–∞–Ω–∏—è

# –≠–¢–ê–ü 2: –ú–∞—Å—Å–æ–≤–æ–µ –æ–±–æ–≥–∞—â–µ–Ω–∏–µ –ø–∞–∫–µ—Ç–∞–º–∏
properties = Property.query.filter(Property.parsed_city.is_(None)).all()
stats = auto_service.enrich_batch(properties, batch_size=50)

auto_service.disable_batch_mode()  # –í–∫–ª—é—á–∞–µ–º –∞–≤—Ç–æ–º–∞—Ç–∏–∫—É –æ–±—Ä–∞—Ç–Ω–æ

print(f"–û–±–æ–≥–∞—â–µ–Ω–æ: {stats['enriched']}")
```

**–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞:**
- ‚ö° –ë—ã—Å—Ç—Ä—ã–π –∏–º–ø–æ—Ä—Ç (–Ω–µ –∂–¥—ë–º API)
- üì¶ –û–±–æ–≥–∞—â–µ–Ω–∏–µ –ø–∞–∫–µ—Ç–∞–º–∏ (–æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è)
- üíæ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–µ –∫–æ–º–º–∏—Ç—ã –∫–∞–∂–¥—ã–µ 50 –æ–±—ä–µ–∫—Ç–æ–≤
- üìä –î–µ—Ç–∞–ª—å–Ω–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞

---

### 3Ô∏è‚É£ –û–ë–û–ì–ê–©–ï–ù–ò–ï –°–£–©–ï–°–¢–í–£–Æ–©–ò–• (–¥–ª—è –≤–∞—à–µ–π –±–∞–∑—ã)

**–û–±–æ–≥–∞—Ç–∏—Ç—å –≤—Å–µ 354 –æ–±—ä–µ–∫—Ç–∞:**
```bash
python3 enrich_all_properties.py
```

**–ò–ª–∏ —á–µ—Ä–µ–∑ API (—Ç—Ä–µ–±—É–µ—Ç—Å—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è):**
```bash
curl -X POST "http://localhost:5000/api/geocode/enrich-properties?limit=100"
```

---

## üìù –ü—Ä–∏–º–µ—Ä—ã –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏

### –í–∞—Ä–∏–∞–Ω—Ç A: –î–æ–±–∞–≤–∏—Ç—å –≤ —Å–∫—Ä–∏–ø—Ç –∏–º–ø–æ—Ä—Ç–∞

```python
# scripts/import_from_excel.py

from services.auto_geocoding import get_auto_geocoding_service

def import_properties():
    auto_service = get_auto_geocoding_service()
    auto_service.enable_batch_mode()  # –í—ã–∫–ª—é—á–∞–µ–º –∞–≤—Ç–æ–º–∞—Ç–∏–∫—É
    
    # –ò–º–ø–æ—Ä—Ç
    properties = []
    for row in read_excel('data.xlsx'):
        prop = Property(...)
        db.session.add(prop)
        properties.append(prop)
    
    db.session.commit()
    
    # –û–±–æ–≥–∞—â–µ–Ω–∏–µ
    stats = auto_service.enrich_batch(properties)
    auto_service.disable_batch_mode()  # –í–∫–ª—é—á–∞–µ–º –∞–≤—Ç–æ–º–∞—Ç–∏–∫—É
    
    return stats
```

### –í–∞—Ä–∏–∞–Ω—Ç B: –í–∫–ª—é—á–∏—Ç—å –∞–≤—Ç–æ–º–∞—Ç–∏–∫—É –Ω–∞–≤—Å–µ–≥–¥–∞

```python
# app.py

from services.auto_geocoding import setup_auto_geocoding

# –ü–æ—Å–ª–µ —Å–æ–∑–¥–∞–Ω–∏—è db
with app.app_context():
    setup_auto_geocoding(db)  # –û–¥–∏–Ω —Ä–∞–∑ –Ω–∞—Å—Ç—Ä–æ–∏–ª–∏
    
# –¢–µ–ø–µ—Ä—å –í–°–ï –Ω–æ–≤—ã–µ –æ–±—ä–µ–∫—Ç—ã –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ–±–æ–≥–∞—â–∞—é—Ç—Å—è
```

---

## üîß –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

**–ó–∞–ø—É—Å—Ç–∏—Ç—å –¥–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏—é:**
```bash
python3 demo_auto_geocoding.py
```

–í—ã–±–µ—Ä–∏—Ç–µ —Å—Ü–µ–Ω–∞—Ä–∏–π:
- `1` - –û–¥–∏–Ω–æ—á–Ω—ã–π –æ–±—ä–µ–∫—Ç (–∞–≤—Ç–æ–º–∞—Ç–∏–∫–∞)
- `2` - Batch –∏–º–ø–æ—Ä—Ç 100 –æ–±—ä–µ–∫—Ç–æ–≤
- `3` - –û—Ü–µ–Ω–∫–∞ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
- `4` - –ü—Ä–∏–º–µ—Ä—ã –∫–æ–¥–∞
- `5` - –í—Å–µ —Å—Ü–µ–Ω–∞—Ä–∏–∏

---

## üí° –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏

### –î–ª—è –Ω–µ–±–æ–ª—å—à–∏—Ö –æ–±—ä—ë–º–æ–≤ (–¥–æ 1,000 –æ–±—ä–µ–∫—Ç–æ–≤)
‚úÖ –í–∫–ª—é—á–∏—Ç–µ **–∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π —Ä–µ–∂–∏–º** –≤ `app.py`
```python
setup_auto_geocoding(db)
```

### –î–ª—è –º–∞—Å—Å–æ–≤–æ–≥–æ –∏–º–ø–æ—Ä—Ç–∞ (—Ç—ã—Å—è—á–∏ –æ–±—ä–µ–∫—Ç–æ–≤)
‚úÖ –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ **batch —Ä–µ–∂–∏–º** –≤ —Å–∫—Ä–∏–ø—Ç–µ –∏–º–ø–æ—Ä—Ç–∞
```python
auto_service.enable_batch_mode()
# –∏–º–ø–æ—Ä—Ç
auto_service.enrich_batch(properties)
auto_service.disable_batch_mode()
```

### –î–ª—è –æ—á–µ–Ω—å –±–æ–ª—å—à–∏—Ö –æ–±—ä—ë–º–æ–≤ (25,000+)
‚úÖ –†–∞–∑–±–µ–π—Ç–µ –Ω–∞ —á–∞—Å—Ç–∏:
```python
# –î–µ–Ω—å 1: –ø–µ—Ä–≤—ã–µ 20,000
stats = auto_service.enrich_batch(properties[:20000])

# –î–µ–Ω—å 2: —Å–ª–µ–¥—É—é—â–∏–µ 20,000 (–∫—ç—à —Å–±—Ä–æ—à–µ–Ω —á–µ—Ä–µ–∑ 24—á)
stats = auto_service.enrich_batch(properties[20000:40000])
```

---

## üì¶ –ß—Ç–æ –∑–∞–ø–æ–ª–Ω—è–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏

| –ü–æ–ª–µ | –ü—Ä–∏–º–µ—Ä | –û—Ç–∫—É–¥–∞ –±–µ—Ä—ë—Ç—Å—è |
|------|--------|----------------|
| `parsed_city` | "–°–æ—á–∏" | Yandex Geocoder API |
| `parsed_district` | "–º–∏–∫—Ä–æ—Ä–∞–π–æ–Ω –ë—ã—Ç—Ö–∞" | Yandex Geocoder API |
| `parsed_street` | "–Ø—Å–Ω–æ–≥–æ—Ä—Å–∫–∞—è —É–ª–∏—Ü–∞" | Yandex Geocoder API |

**–¢—Ä–µ–±–æ–≤–∞–Ω–∏—è:** –û–±—ä–µ–∫—Ç –¥–æ–ª–∂–µ–Ω –∏–º–µ—Ç—å `latitude` –∏ `longitude`

---

## ‚öôÔ∏è –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è

### –ò–∑–º–µ–Ω–∏—Ç—å —Ä–∞–∑–º–µ—Ä –ø–∞–∫–µ—Ç–∞
```python
stats = auto_service.enrich_batch(properties, batch_size=100)  # –ü–æ 100 —à—Ç—É–∫
```

### –ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
```python
stats = auto_service.get_stats()
print(stats['total_enriched'])  # –°–∫–æ–ª—å–∫–æ –æ–±–æ–≥–∞—â–µ–Ω–æ
print(stats['cache_hit_rate'])  # –ü—Ä–æ—Ü–µ–Ω—Ç –ø–æ–ø–∞–¥–∞–Ω–∏–π –≤ –∫—ç—à
```

### –°–±—Ä–æ—Å–∏—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
```python
auto_service.reset_stats()
```

---

## üö® –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è API

- **–ë–µ—Å–ø–ª–∞—Ç–Ω—ã–π –ª–∏–º–∏—Ç:** 25,000 –∑–∞–ø—Ä–æ—Å–æ–≤/–¥–µ–Ω—å
- **–ö—ç—à:** 24 —á–∞—Å–∞ (–∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏)
- **–û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è:** ~40% –∑–∞–ø—Ä–æ—Å–æ–≤ —ç–∫–æ–Ω–æ–º–∏—Ç—Å—è —á–µ—Ä–µ–∑ –∫—ç—à

**–ï—Å–ª–∏ –Ω—É–∂–Ω–æ –±–æ–ª—å—à–µ:**
1. –ü–ª–∞—Ç–Ω—ã–π Yandex API –∫–ª—é—á (–±–µ–∑–ª–∏–º–∏—Ç)
2. –†–∞–∑–±–∏—Ç—å –æ–±—Ä–∞–±–æ—Ç–∫—É –Ω–∞ –Ω–µ—Å–∫–æ–ª—å–∫–æ –¥–Ω–µ–π
3. –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –¥—Ä—É–≥–æ–π –≥–µ–æ–∫–æ–¥–µ—Ä (Google, OpenStreetMap)

---

## ‚úÖ –ì–æ—Ç–æ–≤—ã–µ –∫–æ–º–∞–Ω–¥—ã

```bash
# 1. –û–±–æ–≥–∞—Ç–∏—Ç—å –≤—Å–µ –æ–±—ä–µ–∫—Ç—ã
python3 enrich_all_properties.py

# 2. –ó–∞–ø—É—Å—Ç–∏—Ç—å –¥–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏—é
python3 demo_auto_geocoding.py

# 3. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É API
curl http://localhost:5000/api/geocode/stats

# 4. –û–±–æ–≥–∞—Ç–∏—Ç—å —á–µ—Ä–µ–∑ API (50 —à—Ç—É–∫)
curl -X POST http://localhost:5000/api/geocode/enrich-properties?limit=50
```

---

## üìû –ü–æ–¥–¥–µ—Ä–∂–∫–∞

–ï—Å–ª–∏ –≤–æ–∑–Ω–∏–∫–ª–∏ –≤–æ–ø—Ä–æ—Å—ã:
1. –ó–∞–ø—É—Å—Ç–∏—Ç–µ `python3 demo_auto_geocoding.py` ‚Üí —Å—Ü–µ–Ω–∞—Ä–∏–π 3
2. –ü–æ—Å–º–æ—Ç—Ä–∏—Ç–µ –ø—Ä–∏–º–µ—Ä—ã –≤ `demo_auto_geocoding.py`
3. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏: `grep "geocoding" logs/*.log`
