{% extends "base.html" %}

{% block title %}Регистрация - Квиз | InBack{% endblock %}

{% block content %}
<div id="quiz-container">
<style>
    .quiz-container {
        background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
        min-height: 100vh;
        padding: 40px 0;
    }
    
    .step-indicator {
        transition: all 0.3s ease;
        width: 40px;
        height: 40px;
    }
    
    #quiz-container .step-active,
    .quiz-container .step-active,
    .step-active {
        background: #0088cc !important;
        color: white !important;
        transform: scale(1.1) !important;
        box-shadow: 0 4px 12px rgba(0, 136, 204, 0.4) !important;
    }
    
    #quiz-container .step-completed,
    .quiz-container .step-completed,
    .step-completed {
        background: #10b981 !important;
        color: white !important;
        box-shadow: 0 2px 8px rgba(16, 185, 129, 0.3) !important;
    }
    
    #quiz-container .step-inactive,
    .quiz-container .step-inactive,
    .step-inactive {
        background: #e5e7eb !important;
        color: #6b7280 !important;
    }
    
    .quiz-card {
        background: white;
        border-radius: 24px;
        box-shadow: 0 20px 60px rgba(0,0,0,0.15);
        transition: all 0.3s ease;
        max-width: 1000px;
        margin: 0 auto;
    }
    
    .option-card {
        border: 2px solid #e5e7eb;
        border-radius: 16px;
        padding: 24px;
        cursor: pointer;
        transition: all 0.3s ease;
        background: white;
        text-align: center;
        min-height: 140px;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
    }
    
    .option-card:hover {
        border-color: #0088cc;
        transform: translateY(-4px);
        box-shadow: 0 8px 25px rgba(0,136,204,0.25);
    }
    
    .option-card.selected {
        border-color: #0088cc;
        background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%);
        box-shadow: 0 8px 25px rgba(0,136,204,0.4);
        transform: translateY(-4px);
    }
    
    .btn-quiz {
        background: linear-gradient(135deg, #0088cc 0%, #32a4fb 100%);
        transition: all 0.3s ease;
    }
    
    .btn-quiz:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 20px rgba(0,136,204,0.3);
    }
    
    .fade-in {
        animation: fadeIn 0.4s ease-in;
    }
    
    @keyframes fadeIn {
        from { opacity: 0; transform: translateX(30px); }
        to { opacity: 1; transform: translateX(0); }
    }
    
    .progress-bar {
        height: 6px;
        background: #e5e7eb;
        border-radius: 10px;
        overflow: hidden;
        margin-bottom: 30px;
    }
    
    .progress-fill {
        height: 100%;
        background: linear-gradient(90deg, #0088cc 0%, #32a4fb 100%);
        transition: width 0.5s ease;
        border-radius: 10px;
    }
</style>

<div class="quiz-container">
    <div class="container mx-auto px-4">
        <!-- Compact Header -->
        <div class="text-center mb-6">
            <h1 class="text-3xl lg:text-4xl font-bold text-gray-800 mb-2">Подберем лучшие варианты</h1>
            <p class="text-gray-600 text-lg">Ответьте на 4 вопроса за 30 секунд</p>
        </div>
        
        <!-- Horizontal Progress Bar -->
        <div class="max-w-3xl mx-auto mb-8">
            <div class="progress-bar">
                <div id="progress-fill" class="progress-fill" style="width: 16.66%"></div>
            </div>
            <div class="flex justify-between items-center px-2">
                <div class="step-indicator step-active rounded-full flex items-center justify-center text-sm font-semibold" id="step-1">1</div>
                <div class="step-indicator step-inactive rounded-full flex items-center justify-center text-sm font-semibold" id="step-2">2</div>
                <div class="step-indicator step-inactive rounded-full flex items-center justify-center text-sm font-semibold" id="step-3">3</div>
                <div class="step-indicator step-inactive rounded-full flex items-center justify-center text-sm font-semibold" id="step-4">4</div>
                <div class="step-indicator step-inactive rounded-full flex items-center justify-center text-sm font-semibold" id="step-5">5</div>
                <div class="step-indicator step-inactive rounded-full flex items-center justify-center text-sm font-semibold" id="step-6">✓</div>
            </div>
        </div>
        
        <!-- Quiz Content -->
        <div class="quiz-card p-8 lg:p-12">
            <!-- Step 1: District Selection -->
            <div id="quiz-step-1" class="quiz-step fade-in">
                <h2 class="text-2xl lg:text-3xl font-bold text-gray-800 mb-3 text-center">В каком районе ищете?</h2>
                <p class="text-gray-600 text-center mb-8">Выберите предпочтительный район</p>
                
                <div class="grid grid-cols-2 lg:grid-cols-3 gap-3">
                    <div class="option-card flex items-center justify-center min-h-[80px]" data-value="Центральный" onclick="selectOption(this, 'district')">
                        <h3 class="font-semibold text-sm lg:text-base break-words text-center leading-tight">Центральный</h3>
                    </div>
                    <div class="option-card flex items-center justify-center min-h-[80px]" data-value="Прикубанский" onclick="selectOption(this, 'district')">
                        <h3 class="font-semibold text-sm lg:text-base break-words text-center leading-tight">Прикубанский</h3>
                    </div>
                    <div class="option-card flex items-center justify-center min-h-[80px]" data-value="Западный" onclick="selectOption(this, 'district')">
                        <h3 class="font-semibold text-sm lg:text-base break-words text-center leading-tight">Западный</h3>
                    </div>
                    <div class="option-card flex items-center justify-center min-h-[80px]" data-value="Карасунский" onclick="selectOption(this, 'district')">
                        <h3 class="font-semibold text-sm lg:text-base break-words text-center leading-tight">Карасунский</h3>
                    </div>
                    <div class="option-card flex items-center justify-center min-h-[80px] lg:col-start-2" data-value="Любой" onclick="selectOption(this, 'district')">
                        <h3 class="font-semibold text-sm lg:text-base break-words text-center leading-tight">Любой</h3>
                    </div>
                </div>
            </div>
            
            <!-- Step 2: Property Type -->
            <div id="quiz-step-2" class="quiz-step hidden fade-in">
                <h2 class="text-2xl lg:text-3xl font-bold text-gray-800 mb-3 text-center">Что ищете?</h2>
                <p class="text-gray-600 text-center mb-8">Выберите тип недвижимости</p>
                
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                    <div class="option-card" data-value="Квартира" onclick="selectOption(this, 'property_type')">
                        <h3 class="font-semibold text-xl mb-1">Квартира</h3>
                        <p class="text-gray-600 text-sm">В жилом комплексе</p>
                    </div>
                    <div class="option-card" data-value="Таунхаус" onclick="selectOption(this, 'property_type')">
                        <h3 class="font-semibold text-xl mb-1">Таунхаус</h3>
                        <p class="text-gray-600 text-sm">Многоуровневое жилье</p>
                    </div>
                    <div class="option-card" data-value="Дом" onclick="selectOption(this, 'property_type')">
                        <h3 class="font-semibold text-xl mb-1">Дом</h3>
                        <p class="text-gray-600 text-sm">Частный дом</p>
                    </div>
                </div>
            </div>
            
            <!-- Step 3: Room Count -->
            <div id="quiz-step-3" class="quiz-step hidden fade-in">
                <h2 class="text-2xl lg:text-3xl font-bold text-gray-800 mb-3 text-center">Сколько комнат?</h2>
                <p class="text-gray-600 text-center mb-8">Выберите количество комнат</p>
                
                <div class="grid grid-cols-2 lg:grid-cols-5 gap-4">
                    <div class="option-card" data-value="1" onclick="selectOption(this, 'room_count')">
                        <h3 class="font-semibold text-lg">1 комната</h3>
                    </div>
                    <div class="option-card" data-value="2" onclick="selectOption(this, 'room_count')">
                        <h3 class="font-semibold text-lg">2 комнаты</h3>
                    </div>
                    <div class="option-card" data-value="3" onclick="selectOption(this, 'room_count')">
                        <h3 class="font-semibold text-lg">3 комнаты</h3>
                    </div>
                    <div class="option-card" data-value="4+" onclick="selectOption(this, 'room_count')">
                        <h3 class="font-semibold text-lg">4+ комнат</h3>
                    </div>
                    <div class="option-card" data-value="Любое" onclick="selectOption(this, 'room_count')">
                        <h3 class="font-semibold text-lg">Любое</h3>
                    </div>
                </div>
            </div>
            
            <!-- Step 4: Budget -->
            <div id="quiz-step-4" class="quiz-step hidden fade-in">
                <h2 class="text-2xl lg:text-3xl font-bold text-gray-800 mb-3 text-center">Какой бюджет?</h2>
                <p class="text-gray-600 text-center mb-8">Выберите ценовой диапазон</p>
                
                <div class="grid grid-cols-2 lg:grid-cols-3 gap-4">
                    <div class="option-card" data-value="До 3 млн" onclick="selectOption(this, 'budget')">
                        <h3 class="font-semibold text-lg">До 3 млн ₽</h3>
                        <p class="text-gray-600 text-sm">Экономичные</p>
                    </div>
                    <div class="option-card" data-value="3-5 млн" onclick="selectOption(this, 'budget')">
                        <h3 class="font-semibold text-lg">3-5 млн ₽</h3>
                        <p class="text-gray-600 text-sm">Средний</p>
                    </div>
                    <div class="option-card" data-value="5-8 млн" onclick="selectOption(this, 'budget')">
                        <h3 class="font-semibold text-lg">5-8 млн ₽</h3>
                        <p class="text-gray-600 text-sm">Комфорт</p>
                    </div>
                    <div class="option-card" data-value="От 8 млн" onclick="selectOption(this, 'budget')">
                        <h3 class="font-semibold text-lg">От 8 млн ₽</h3>
                        <p class="text-gray-600 text-sm">Премиум</p>
                    </div>
                    <div class="option-card lg:col-span-2" data-value="Не определился" onclick="selectOption(this, 'budget')">
                        <h3 class="font-semibold text-lg">Еще не определился</h3>
                        <p class="text-gray-600 text-sm">Покажите все</p>
                    </div>
                </div>
            </div>
            
            <!-- Step 5: Personal Info -->
            <div id="quiz-step-5" class="quiz-step hidden fade-in">
                <h2 class="text-2xl lg:text-3xl font-bold text-gray-800 mb-3 text-center">Контактные данные</h2>
                <p class="text-gray-600 text-center mb-8">Как с вами связаться с подходящими вариантами?</p>
                
                <form id="registrationForm" class="max-w-xl mx-auto space-y-5">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Ваше имя *</label>
                        <input type="text" id="full_name" name="full_name" required 
                               class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-[#0088CC] focus:border-blue-500"
                               placeholder="Как к вам обращаться?">
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Телефон *</label>
                        <input type="tel" id="phone" name="phone" required 
                               class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-[#0088CC] focus:border-blue-500"
                               placeholder="+7 (900) 123-45-67"
                               pattern="\+7 \(\d{3}\) \d{3}-\d{2}-\d{2}"
                               title="Введите номер в формате +7 (900) 123-45-67">
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Email (необязательно)</label>
                        <input type="email" id="email" name="email" 
                               class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-[#0088CC] focus:border-blue-500"
                               placeholder="ivan@example.com">
                    </div>
                    
                    <div class="flex items-start pt-2">
                        <input type="checkbox" id="agree_terms" name="agree_terms" required class="mt-1 mr-3">
                        <label for="agree_terms" class="text-sm text-gray-600">
                            Я соглашаюсь с <a href="/privacy-policy" class="text-[#0088CC] hover:underline" target="_blank">политикой конфиденциальности</a> 
                            и <a href="/data-processing-consent" class="text-[#0088CC] hover:underline" target="_blank">обработкой персональных данных</a>
                        </label>
                    </div>
                </form>
            </div>
            
            <!-- Step 6: Thank You -->
            <div id="quiz-step-6" class="quiz-step hidden fade-in">
                <div class="text-center py-8">
                    <div class="mb-6">
                        <svg class="w-20 h-20 mx-auto text-green-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                        </svg>
                    </div>
                    <h2 class="text-3xl font-bold text-gray-800 mb-4">Спасибо за заявку!</h2>
                    <p class="text-lg text-gray-600 mb-6">Наш менеджер свяжется с вами в ближайшее время и подберет лучшие варианты по вашим критериям</p>
                    <button onclick="closeCallbackModal()" class="btn-quiz px-8 py-3 text-white font-semibold rounded-xl">
                        Закрыть
                    </button>
                </div>
            </div>
            
            <!-- Navigation -->
            <div class="flex justify-between items-center mt-10 pt-6 border-t border-gray-200">
                <button id="prevBtn" class="px-6 py-3 text-gray-600 hover:text-gray-800 font-medium transition-all" onclick="previousStep()" style="display: none;">
                    <i class="fas fa-arrow-left mr-2"></i>
                    Назад
                </button>
                <div class="flex-1"></div>
                <button id="submitBtn" class="btn-quiz px-10 py-4 text-white font-semibold rounded-xl hidden" onclick="submitRegistration()">
                    <span id="submitText">Получить подборку</span>
                    <span id="submitSpinner" class="hidden">
                        <i class="fas fa-spinner fa-spin"></i>
                    </span>
                </button>
            </div>
        </div>
    </div>
</div>

<script>
let currentStep = 1;
const totalSteps = 6;
const quizData = {
    district: '',
    property_type: '',
    room_count: '',
    budget: ''
};

function updateProgressBar() {
    const progress = (currentStep / totalSteps) * 100;
    document.getElementById('progress-fill').style.width = progress + '%';
}

function selectOption(element, category) {
    // Remove selection from siblings
    const siblings = element.parentNode.querySelectorAll('.option-card');
    siblings.forEach(sibling => sibling.classList.remove('selected'));
    
    // Add selection to current
    element.classList.add('selected');
    
    // Store selection
    quizData[category] = element.dataset.value;
    
    // Auto-advance to next step after 400ms
    setTimeout(() => {
        nextStep();
    }, 400);
}

function nextStep() {
    if (currentStep < totalSteps) {
        // Hide current step
        document.getElementById(`quiz-step-${currentStep}`).classList.add('hidden');
        
        // Update step indicator
        document.getElementById(`step-${currentStep}`).classList.remove('step-active');
        document.getElementById(`step-${currentStep}`).classList.add('step-completed');
        
        // Show next step
        currentStep++;
        document.getElementById(`quiz-step-${currentStep}`).classList.remove('hidden');
        document.getElementById(`step-${currentStep}`).classList.remove('step-inactive');
        document.getElementById(`step-${currentStep}`).classList.add('step-active');
        
        // Update navigation
        updateNavigation();
        updateProgressBar();
    }
}

function previousStep() {
    if (currentStep > 1) {
        // Hide current step
        document.getElementById(`quiz-step-${currentStep}`).classList.add('hidden');
        
        // Update step indicator
        document.getElementById(`step-${currentStep}`).classList.remove('step-active');
        document.getElementById(`step-${currentStep}`).classList.add('step-inactive');
        
        // Show previous step
        currentStep--;
        document.getElementById(`quiz-step-${currentStep}`).classList.remove('hidden');
        document.getElementById(`step-${currentStep}`).classList.remove('step-completed');
        document.getElementById(`step-${currentStep}`).classList.add('step-active');
        
        // Update navigation
        updateNavigation();
        updateProgressBar();
    }
}

function updateNavigation() {
    const prevBtn = document.getElementById('prevBtn');
    const submitBtn = document.getElementById('submitBtn');
    const navContainer = document.querySelector('.flex.justify-between.items-center');
    
    // Hide navigation on thank you page (step 6)
    if (currentStep === 6 && navContainer) {
        navContainer.style.display = 'none';
        return;
    } else if (navContainer) {
        navContainer.style.display = 'flex';
    }
    
    // Show/hide previous button (not on step 1 and not on step 5)
    if (prevBtn) {
        prevBtn.style.display = (currentStep > 1 && currentStep < 5) ? 'block' : 'none';
    }
    
    // Show submit button on step 5 only
    if (submitBtn) {
        if (currentStep === 5) {
            submitBtn.classList.remove('hidden');
        } else {
            submitBtn.classList.add('hidden');
        }
    }
}

function submitRegistration() {
    const form = document.getElementById('registrationForm');
    const formData = new FormData(form);
    
    // Validate form
    if (!form.checkValidity()) {
        form.reportValidity();
        return;
    }
    
    // Show loading
    document.getElementById('submitText').classList.add('hidden');
    document.getElementById('submitSpinner').classList.remove('hidden');
    document.getElementById('submitBtn').disabled = true;
    
    // Prepare application data for /api/contact-manager
    const applicationData = {
        name: formData.get('full_name'),
        phone: formData.get('phone'),
        email: formData.get('email') || '',
        district: quizData.district,
        rooms: quizData.room_count,
        property_type: quizData.property_type,
        budget: quizData.budget,
        message: `Квиз: Район: ${quizData.district}, Тип: ${quizData.property_type}, Комнат: ${quizData.room_count}, Бюджет: ${quizData.budget}`,
        preferred_contact: 'phone'
    };
    
    // Submit to /api/contact-manager
    fetch('/api/contact-manager', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify(applicationData)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Move to thank you step
            nextStep();
        } else {
            alert('❌ Ошибка отправки: ' + (data.error || 'Попробуйте позже'));
            // Reset button
            document.getElementById('submitText').classList.remove('hidden');
            document.getElementById('submitSpinner').classList.add('hidden');
            document.getElementById('submitBtn').disabled = false;
        }
    })
    .catch(error => {
        console.error('Registration error:', error);
        alert('❌ Произошла ошибка. Попробуйте еще раз.');
        // Reset button
        document.getElementById('submitText').classList.remove('hidden');
        document.getElementById('submitSpinner').classList.add('hidden');
        document.getElementById('submitBtn').disabled = false;
    });
}

// Phone number formatting
function formatPhoneNumber(input) {
    // Get only digits
    let value = input.value.replace(/\D/g, '');
    
    // Start with +7
    if (value.length > 0) {
        if (value[0] === '8') {
            value = '7' + value.slice(1);
        } else if (value[0] !== '7') {
            value = '7' + value;
        }
    }
    
    // Format as +7 (XXX) XXX-XX-XX
    let formatted = '+7';
    if (value.length > 1) {
        formatted += ' (' + value.slice(1, 4);
    }
    if (value.length >= 5) {
        formatted += ') ' + value.slice(4, 7);
    }
    if (value.length >= 8) {
        formatted += '-' + value.slice(7, 9);
    }
    if (value.length >= 10) {
        formatted += '-' + value.slice(9, 11);
    }
    
    input.value = formatted;
}

// Add phone formatting on page load
document.addEventListener('DOMContentLoaded', function() {
    const phoneInput = document.getElementById('phone');
    if (phoneInput) {
        phoneInput.addEventListener('input', function(e) {
            formatPhoneNumber(e.target);
        });
        phoneInput.addEventListener('focus', function(e) {
            if (!e.target.value) {
                e.target.value = '+7 ';
            }
        });
    }
});

// Initialize
updateNavigation();
updateProgressBar();
</script>
</div>
{% endblock %}
