{% extends "base.html" %}

{% block title %}{{ developer.name }} — Проекты застройщика с кэшбеком | InBack{% endblock %}
{% block description %}Все проекты застройщика {{ developer.name }} с кэшбеком до 5%. {{ total_properties }} квартир в {{ complexes|length }} жилых комплексах. Гарантированный возврат средств при покупке недвижимости.{% endblock %}
{% block keywords %}{{ developer.name }}, новостройки {{ developer.name }}, кэшбек застройщик, жилые комплексы {{ developer.name }}, ипотека новостройки{% endblock %}

{% block head %}
<script src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js" defer></script>
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "RealEstateAgent", 
  "name": "{{ developer.name }}",
  "description": "Застройщик {{ developer.name }} предлагает {{ total_properties }} квартир с кэшбеком через InBack",
  "areaServed": {
    "@type": "AdministrativeArea",
    "name": "Краснодар и Краснодарский край"
  },
  "address": {
    "@type": "PostalAddress",
    "addressLocality": "Краснодар",
    "addressRegion": "Краснодарский край"
  }
}
</script>
{% endblock %}

{% block content %}
<div class="bg-gradient-to-b from-white to-gray-50 min-h-screen">
<div class="max-w-6xl mx-auto px-4 py-8">

<!-- Developer Header Section -->
<div class="bg-white rounded-xl shadow-sm p-6 mb-8">
<div class="flex flex-col md:flex-row gap-6 items-start">
<div class="w-32 h-32 rounded-xl overflow-hidden bg-gray-100 flex-shrink-0">
{% if developer.logo %}
<img src="{{ developer.logo }}" alt="Логотип {{ developer.name }}" class="w-full h-full object-contain">
{% else %}
<div class="w-full h-full flex items-center justify-center bg-gradient-to-br from-blue-50 to-blue-100">
<i class="fas fa-building text-4xl text-blue-300"></i>
</div>
{% endif %}
</div>
<div class="flex-1">
<h1 class="text-3xl font-bold mb-2">{{ developer.name }}</h1>
<div class="flex flex-wrap gap-2 mb-4">
<span class="bg-blue-100 text-blue-800 px-3 py-1 rounded-full text-sm">Застройщик</span>
{% if developer.founded_year %}
<span class="bg-green-100 text-green-800 px-3 py-1 rounded-full text-sm">Работает с {{ developer.founded_year }}</span>
{% endif %}
{% if complexes|length >= 5 %}
<span class="bg-purple-100 text-purple-800 px-3 py-1 rounded-full text-sm">{{ complexes|length }}+ проектов</span>
{% endif %}
</div>
<p class="text-gray-600 mb-4">{{ developer.description or "Надежный застройщик с портфелем из " + complexes|length|string + " жилых комплексов" }}</p>
<div class="flex flex-col sm:flex-row sm:items-center gap-4 text-gray-600">
{% if developer.phone %}
<div class="flex items-center gap-2">
<i class="fas fa-phone-alt text-blue-600"></i>
<span>{{ developer.phone }}</span>
</div>
{% endif %}
{% if developer.website %}
<div class="flex items-center gap-2">
<i class="fas fa-globe text-blue-600"></i>
<span>{{ developer.website }}</span>
</div>
{% endif %}
</div>
</div>
</div>
</div>

<!-- Search and Stats Section -->
<div class="bg-white rounded-xl shadow-sm p-6 mb-8">
<div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4">
<h2 class="text-xl font-bold">Поиск по проектам застройщика</h2>
<div class="relative w-full md:w-96">
<input type="text" id="developer-search" placeholder="Найти ЖК по названию или району" 
class="w-full border border-gray-300 rounded-xl pl-10 pr-4 py-2 focus:ring-2 focus:ring-blue-500 focus:border-transparent">
<i class="fas fa-search absolute left-3 top-3 text-gray-400"></i>
</div>
</div>

<div class="grid grid-cols-2 sm:grid-cols-4 gap-4 mt-6">
<div class="bg-white rounded-xl p-4 shadow-sm border border-gray-100 cursor-pointer hover:shadow-md transition-shadow" onclick="openApplicationModal()">
<div class="text-gray-500 text-sm mb-1">ЖК в продаже</div>
<div class="text-2xl font-bold text-blue-600">{{ complexes|length }}</div>
<div class="text-xs text-gray-400 mt-1">Нажмите для консультации</div>
</div>
<div class="bg-white rounded-xl p-4 shadow-sm border border-gray-100 cursor-pointer hover:shadow-md transition-shadow" onclick="openApplicationModal()">
<div class="text-gray-500 text-sm mb-1">Квартир в продаже</div>
<div class="text-2xl font-bold text-blue-600">{{ total_properties }}</div>
<div class="text-xs text-gray-400 mt-1">Нажмите для консультации</div>
</div>
<div class="bg-white rounded-xl p-4 shadow-sm border border-gray-100 cursor-pointer hover:shadow-md transition-shadow" onclick="openApplicationModal()">
<div class="text-gray-500 text-sm mb-1">Цена от</div>
<div class="text-2xl font-bold text-blue-600">{{ "{:,.1f}".format(min_price / 1000000) }} млн</div>
<div class="text-xs text-gray-400 mt-1">Нажмите для консультации</div>
</div>
<div class="bg-white rounded-xl p-4 shadow-sm border border-gray-100 cursor-pointer hover:shadow-md transition-shadow" onclick="openApplicationModal()">
<div class="text-gray-500 text-sm mb-1">Кэшбек до</div>
<div class="text-2xl font-bold text-blue-600">{{ developer.max_cashback_percent or "10" }}%</div>
<div class="text-xs text-gray-400 mt-1">Нажмите для консультации</div>
</div>
</div>
</div>

<!-- Projects Section with Tabs -->
{% if complexes %}
<div class="bg-white rounded-xl shadow-sm p-6 mb-8" x-data="{ activeTab: 'all' }">
<h2 class="text-xl font-bold mb-6">Проекты застройщика</h2>

<!-- Tabs -->
<div class="flex overflow-x-auto scroll-hidden mb-6 pb-2">
<button 
@click="activeTab = 'all'" 
:class="activeTab === 'all' ? 'text-blue-600 border-blue-600' : 'text-gray-500 border-transparent hover:text-blue-600'"
class="px-4 py-2 font-medium border-b-2 whitespace-nowrap transition-colors">
Все проекты ({{ complexes|length }})
</button>
<button 
@click="activeTab = 'building'" 
:class="activeTab === 'building' ? 'text-blue-600 border-blue-600' : 'text-gray-500 border-transparent hover:text-blue-600'"
class="px-4 py-2 font-medium border-b-2 whitespace-nowrap transition-colors">
Строятся ({{ complexes|selectattr('status', 'equalto', 'building')|list|length }})
</button>
<button 
@click="activeTab = 'completed'" 
:class="activeTab === 'completed' ? 'text-blue-600 border-blue-600' : 'text-gray-500 border-transparent hover:text-blue-600'"
class="px-4 py-2 font-medium border-b-2 whitespace-nowrap transition-colors">
Сданы ({{ complexes|selectattr('status', 'equalto', 'completed')|list|length }})
</button>
</div>

<div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6">
{% for complex in complexes %}
<a href="/zk/{{ complex.name|slug }}" class="block bg-white border border-gray-200 rounded-xl overflow-hidden hover:shadow-md transition-shadow project-card cursor-pointer"
x-show="activeTab === 'all' || (activeTab === 'building' && '{{ complex.status or 'building' }}' === 'building') || (activeTab === 'completed' && '{{ complex.status }}' === 'completed')"
x-transition
data-name="{{ complex.name|lower }}"
data-district="{{ complex.district|lower }}">
<div class="h-48 bg-gray-200 relative">
{% if complex.image %}
<img src="{{ complex.image }}" alt="{{ complex.name }}" class="w-full h-full object-cover">
{% else %}
<div class="w-full h-full bg-gradient-to-br from-blue-50 to-blue-100 flex items-center justify-center">
<i class="fas fa-building text-4xl text-blue-300"></i>
</div>
{% endif %}
<div class="absolute top-3 left-3 bg-white/90 backdrop-blur px-2 py-1 rounded-full text-xs font-medium">
{% if complex.status == 'completed' %}Сдан{% else %}Строится{% endif %}
</div>
</div>
<div class="p-5">
<h3 class="font-bold text-lg mb-2 text-gray-900">{{ complex.name }}</h3>
<div class="flex items-center text-sm text-gray-500 mb-3">
<i class="fas fa-map-marker-alt mr-1"></i>
<span>{{ complex.district_name or complex.district or "Краснодар" }}</span>
</div>

<div class="grid grid-cols-2 gap-3 mb-4">
<div>
<p class="text-gray-500 text-xs">Срок сдачи</p>
<p class="font-medium">{{ complex.end_build_quarter or "4" }} кв. {{ complex.end_build_year or "2025" }}</p>
</div>
<div>
<p class="text-gray-500 text-xs">Класс</p>
<p class="font-medium capitalize">{{ complex.object_class_display_name or "Комфорт" }}</p>
</div>
<div>
<p class="text-gray-500 text-xs">Квартир</p>
<p class="font-medium">{{ complex.properties_count or "—" }}</p>
</div>
<div>
<p class="text-gray-500 text-xs">Цена</p>
<p class="font-medium">от {{ "{:,.1f}".format((complex.min_price or min_price or 12000000) / 1000000) }} млн ₽</p>
</div>
</div>

<div class="flex justify-between items-center">
<div class="flex items-center">
<div class="w-2 h-2 bg-green-500 rounded-full mr-2"></div>
<span class="text-xs text-gray-500">Кешбек {{ "%.1f"|format(complex.cashback_rate * 100) if complex.cashback_rate and complex.cashback_rate <= 1 else "10" }}%</span>
</div>
<div class="flex gap-2">
<button onclick="openApplicationModal()" class="bg-blue-600 text-white px-3 py-1 rounded-lg hover:bg-blue-700 text-xs font-medium" onclick="event.stopPropagation();">
Заявка
</button>
<span class="text-blue-600 text-sm font-medium">
<i class="fas fa-arrow-right text-xs"></i>
</span>
</div>
</div>
</div>
</a>
{% endfor %}
</div>
</div>
{% endif %}

<!-- Apartments Section -->
<div class="bg-white rounded-xl shadow-sm p-6 mb-8" x-data="{ roomFilter: 'all', buildingFilter: 'all' }">
<h3 class="font-bold text-xl mb-6">Квартиры в проектах застройщика</h3>

<!-- Apartment Filters -->
<div class="flex flex-wrap gap-3 mb-6">
<div class="relative">
<select x-model="buildingFilter" class="appearance-none bg-white border border-gray-300 rounded-xl px-4 py-2 pr-8 focus:ring-2 focus:ring-blue-500 focus:border-transparent">
<option value="all">Комплекс: Все</option>
{% for complex in complexes %}
<option value="{{ complex.name }}">{{ complex.name }}</option>
{% endfor %}
</select>
<div class="absolute inset-y-0 right-0 flex items-center pr-2 pointer-events-none">
<i class="fas fa-chevron-down text-gray-400"></i>
</div>
</div>
<div class="relative">
<select x-model="roomFilter" class="appearance-none bg-white border border-gray-300 rounded-xl px-4 py-2 pr-8 focus:ring-2 focus:ring-blue-500 focus:border-transparent">
<option value="all">Комнат: Все</option>
<option value="1">1</option>
<option value="2">2</option>
<option value="3">3</option>
<option value="4">4+</option>
</select>
<div class="absolute inset-y-0 right-0 flex items-center pr-2 pointer-events-none">
<i class="fas fa-chevron-down text-gray-400"></i>
</div>
</div>
</div>

<!-- Apartment Cards -->
{% if apartments %}
<div class="grid md:grid-cols-2 gap-6" id="apartments-grid">
{% for apartment in apartments[:6] %}
<div class="bg-white border border-gray-200 rounded-xl overflow-hidden hover:shadow-md transition-shadow apartment-card"
data-rooms="{{ apartment.object_rooms or '1' }}"
data-complex="{{ apartment.complex_name or 'unknown' }}"
x-show="(roomFilter === 'all' || roomFilter === '{{ apartment.object_rooms or '1' }}') && (buildingFilter === 'all' || buildingFilter === '{{ apartment.complex_name or 'unknown' }}')" style="display: block;"
x-transition>
<div class="h-48 bg-gray-200">
{% if apartment.image %}
<img src="{{ apartment.image }}" alt="{{ apartment.title or apartment.type }}" class="w-full h-full object-cover">
{% else %}
<div class="w-full h-full bg-gradient-to-br from-gray-50 to-gray-100 flex items-center justify-center">
<i class="fas fa-home text-4xl text-gray-300"></i>
</div>
{% endif %}
</div>
<div class="p-6">
<div class="flex justify-between items-start mb-3">
<div>
<h4 class="font-bold">{{ apartment.object_rooms or '1' }}-комнатная квартира, {{ apartment.object_area or '45' }} м²{% if apartment.object_min_floor %}, {{ apartment.object_min_floor }}/{{ apartment.object_max_floor }} эт.{% endif %}</h4>
<p class="text-sm text-gray-500">{{ apartment.complex_name or apartment.object_complex or 'ЖК' }}</p>
</div>
<div class="bg-blue-100 text-blue-600 px-3 py-1 rounded-full text-sm font-medium">
{{ apartment.object_rooms or '1' }} комн
</div>
</div>
<div class="grid grid-cols-2 gap-4 mb-4">
<div>
<p class="text-gray-500 text-xs">Площадь</p>
<p class="font-medium">{{ apartment.object_area or 45 }} м²</p>
</div>
<div>
<p class="text-gray-500 text-xs">Стоимость</p>
<p class="font-medium">{{ "{:,.0f}".format(apartment.price) }} ₽</p>
</div>
<div>
<p class="text-gray-500 text-xs">Цена за м²</p>
<p class="font-medium">{{ "{:,.0f}".format(apartment.square_price or (apartment.price / apartment.object_area) if apartment.object_area else 0) }} ₽</p>
</div>
<div>
<p class="text-gray-500 text-xs">Кешбек</p>
<p class="font-medium text-green-600">{{ "{:,.0f}".format(apartment.cashback_amount or (apartment.price * 0.05)) }} ₽</p>
</div>
</div>
<div class="flex justify-between items-center">
<p class="text-blue-600 text-sm font-medium">{{ apartment.cashback_percent or "5" }}% кешбек</p>
<div class="flex gap-2">
<button onclick="openApplicationModal()" class="bg-green-600 text-white px-3 py-1 rounded-lg hover:bg-green-700 text-xs font-medium">
Заявка
</button>
<a href="{{ url_for('property_detail', property_id=apartment.inner_id) }}" class="text-blue-600 hover:text-purple-600 font-medium text-sm flex items-center">
<i class="fas fa-chevron-right text-xs"></i>
</a>
</div>
</div>
</div>
</div>
{% endfor %}
</div>

<div class="mt-6 text-center">
<a href="{{ url_for('properties') }}?developer={{ developer.name }}" 
class="bg-gradient-to-r from-blue-600 to-purple-600 hover:from-blue-700 hover:to-purple-700 text-white font-semibold py-3 px-6 rounded-xl inline-flex items-center transition-all">
Показать все {{ apartments|length }} квартир <i class="fas fa-chevron-right ml-2"></i>
</a>
</div>
{% else %}
<div class="text-center py-12">
<i class="fas fa-home text-4xl text-gray-300 mb-4"></i>
<p class="text-gray-500">Нет доступных квартир в продаже</p>
</div>
{% endif %}
</div>

<!-- Developer Details Section -->
<div class="bg-white rounded-xl shadow-sm p-6 mb-8">
<div class="grid md:grid-cols-2 gap-8">
<!-- Левая колонка - информация о застройщике -->
<div>
<h3 class="font-bold text-xl mb-4">О застройщике</h3>
<p class="text-gray-600 mb-6">{{ developer.full_description or developer.description or "Опытный застройщик, специализирующийся на строительстве качественных жилых комплексов в Краснодарском крае." }}</p>

{% if features and features|length > 0 %}
<div class="mb-6">
<h4 class="font-bold text-lg mb-3">Особенности проектов</h4>
<div class="grid grid-cols-2 gap-3">
{% for feature in features %}
<div class="flex items-center gap-2">
<div class="w-6 h-6 bg-blue-100 rounded flex items-center justify-center">
<i class="fas fa-check text-sm text-blue-600"></i>
</div>
<span class="text-sm">{{ feature }}</span>
</div>
{% endfor %}
</div>
</div>
{% endif %}

{% if infrastructure and infrastructure|length > 0 %}
<div class="mb-6">
<h4 class="font-bold text-lg mb-3">Инфраструктура</h4>
<div class="grid grid-cols-2 gap-3">
{% for item in infrastructure %}
<div class="flex items-center gap-2">
<div class="w-6 h-6 bg-green-100 rounded flex items-center justify-center">
<i class="fas fa-check text-sm text-green-600"></i>
</div>
<span class="text-sm">{{ item }}</span>
</div>
{% endfor %}
</div>
</div>
{% endif %}
</div>

<!-- Правая колонка - карта и реквизиты -->
<div>
<!-- Карта застройщика -->
{% if developer.latitude and developer.longitude %}
<div class="mb-6">
<h4 class="font-bold text-lg mb-3">Расположение офиса</h4>
<div class="bg-gray-100 rounded-xl p-4 h-64">
<div id="developer-map" class="w-full h-full rounded-lg"></div>
</div>
</div>
{% endif %}

<!-- Реквизиты компании -->
{% if developer.inn or developer.kpp or developer.ogrn %}
<div class="bg-gray-50 rounded-xl p-4">
<h4 class="font-bold text-lg mb-3">Реквизиты компании</h4>
<div class="space-y-2 text-sm">
{% if developer.inn %}
<div class="flex justify-between">
<span class="text-gray-600">ИНН:</span>
<span class="font-mono">{{ developer.inn }}</span>
</div>
{% endif %}
{% if developer.kpp %}
<div class="flex justify-between">
<span class="text-gray-600">КПП:</span>
<span class="font-mono">{{ developer.kpp }}</span>
</div>
{% endif %}
{% if developer.ogrn %}
<div class="flex justify-between">
<span class="text-gray-600">ОГРН:</span>
<span class="font-mono">{{ developer.ogrn }}</span>
</div>
{% endif %}
</div>
</div>
{% endif %}
</div>
</div>
</div>

<!-- Special Offers -->
<div class="bg-gradient-to-r from-blue-600 to-purple-600 text-white rounded-xl p-8 mb-8">
<h2 class="text-2xl font-bold mb-4">Специальные условия от {{ developer.name }}</h2>
<div class="grid md:grid-cols-3 gap-6 mb-6">
<div class="text-center">
<div class="text-3xl font-bold mb-2">До {{ developer.max_cashback_percent or "10" }}%</div>
<div class="text-blue-100">Кэшбек с каждой покупки</div>
</div>
<div class="text-center">
<div class="text-3xl font-bold mb-2">{{ developer.min_mortgage_rate or "0.1" }}%</div>
<div class="text-blue-100">Льготная ипотека</div>
</div>
<div class="text-center">
<div class="text-3xl font-bold mb-2">100%</div>
<div class="text-blue-100">Юридическое сопровождение</div>
</div>
</div>
<div class="text-center">
<h3 class="text-xl font-bold mb-4">Персональная помощь от наших экспертов</h3>
<p class="text-blue-100 mb-4">Индивидуальный подбор квартир и максимальный кэшбек</p>
<button onclick="openApplicationModal()" class="bg-white text-blue-600 px-8 py-3 rounded-xl font-semibold hover:bg-opacity-90 transition-all">
Получить персональную консультацию
</button>
</div>
</div>

<!-- CTA Section -->
<div class="bg-blue-600 text-white rounded-xl p-8 text-center">
<h2 class="text-2xl font-bold mb-4">Заинтересовались проектами {{ developer.name }}?</h2>
<p class="text-lg mb-6 opacity-90">Оставьте заявку, и мы поможем выбрать лучший вариант с максимальным кэшбеком</p>
<div class="flex flex-col sm:flex-row justify-center gap-4">
<button onclick="openApplicationModal()" class="px-8 py-3 bg-white text-blue-600 rounded-lg hover:bg-opacity-90 transition-colors font-medium">
Получить консультацию
</button>
{% if developer.phone %}
<a href="tel:{{ developer.phone }}" class="px-8 py-3 border border-white text-white rounded-lg hover:bg-white hover:text-blue-600 transition-colors font-medium">
Позвонить сейчас
</a>
{% endif %}
</div>
</div>

</div>
</div>
{% endblock %}

{% block scripts %}
<!-- Leaflet CSS and JS for map -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<script>
// Developer search functionality
document.getElementById('developer-search').addEventListener('input', function(e) {
    const searchTerm = e.target.value.toLowerCase();
    const projectCards = document.querySelectorAll('.project-card');
    
    projectCards.forEach(card => {
        const name = card.dataset.name;
        const district = card.dataset.district;
        const isVisible = name.includes(searchTerm) || district.includes(searchTerm);
        card.style.display = isVisible ? 'block' : 'none';
    });
});

{% if developer.latitude and developer.longitude %}
// Initialize developer location map
document.addEventListener('DOMContentLoaded', function() {
    try {
        const lat = parseFloat('{{ developer.latitude or "45.0428" }}');
        const lng = parseFloat('{{ developer.longitude or "38.9769" }}');
        const zoom = parseInt('{{ developer.zoom_level or "13" }}');
        
        // Create map
        const map = L.map('developer-map').setView([lat, lng], zoom);
        
        // Add OpenStreetMap tiles
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '© OpenStreetMap contributors',
            maxZoom: 18
        }).addTo(map);
        
        // Add marker for developer office
        L.marker([lat, lng])
            .addTo(map)
            .bindPopup(`
                <div class="p-2">
                    <strong>{{ developer.name }}</strong><br>
                    <small>{{ developer.address or "г. Краснодар" }}</small>
                </div>
            `)
            .openPopup();
    } catch (error) {
        console.error('Error initializing developer map:', error);
        document.getElementById('developer-map').innerHTML = '<div class="flex items-center justify-center h-full text-gray-500"><i class="fas fa-map-marker-alt text-4xl"></i></div>';
    }
});
{% endif %}
</script>
{% endblock %}