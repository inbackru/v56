{% extends "base.html" %}

{% block title %}–¢–µ—Å—Ç –∫–∞—Ä—Ç —Å –≥—Ä–∞–Ω–∏—Ü–∞–º–∏ —Ä–∞–π–æ–Ω–æ–≤ | InBack{% endblock %}

{% block additional_js %}
<script src="https://api-maps.yandex.ru/2.1/?lang=ru_RU" type="text/javascript"></script>
{% endblock %}

{% block content %}
<div class="min-h-screen bg-gray-50 py-8">
    <div class="container mx-auto px-4">
        <h1 class="text-3xl font-bold text-center mb-8">–¢–µ—Å—Ç –∫–∞—Ä—Ç InBack.ru</h1>
        
        <!-- –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∫–∞—Ä—Ç–æ–π -->
        <div class="bg-white rounded-lg shadow-lg p-6 mb-6">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                    <h3 class="text-lg font-semibold mb-4">–ì—Ä–∞–Ω–∏—Ü—ã —Ä–∞–π–æ–Ω–æ–≤</h3>
                    <div class="space-y-2">
                        <button onclick="loadDistrictBoundaries('tsentralnyy')" 
                                class="w-full px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600">
                            –ü–æ–∫–∞–∑–∞—Ç—å –¶–µ–Ω—Ç—Ä–∞–ª—å–Ω—ã–π —Ä–∞–π–æ–Ω
                        </button>
                        <button onclick="loadDistrictBoundaries('zapadny')" 
                                class="w-full px-4 py-2 bg-green-500 text-white rounded hover:bg-green-600">
                            –ü–æ–∫–∞–∑–∞—Ç—å –ó–∞–ø–∞–¥–Ω—ã–π —Ä–∞–π–æ–Ω
                        </button>
                        <button onclick="loadDistrictBoundaries('karasunsky')" 
                                class="w-full px-4 py-2 bg-purple-500 text-white rounded hover:bg-purple-600">
                            –ü–æ–∫–∞–∑–∞—Ç—å –ö–∞—Ä–∞—Å—É–Ω—Å–∫–∏–π —Ä–∞–π–æ–Ω
                        </button>
                    </div>
                </div>
                
                <div>
                    <h3 class="text-lg font-semibold mb-4">–ü–æ–¥—Å–≤–µ—Ç–∫–∞ —É–ª–∏—Ü</h3>
                    <div class="space-y-2">
                        <button onclick="loadStreetHighlight('krasnaya')" 
                                class="w-full px-4 py-2 bg-red-500 text-white rounded hover:bg-red-600">
                            –ü–æ–¥—Å–≤–µ—Ç–∏—Ç—å —É–ª. –ö—Ä–∞—Å–Ω–∞—è
                        </button>
                        <button onclick="loadStreetHighlight('1-y-krasnyh-zor-proezd')" 
                                class="w-full px-4 py-2 bg-orange-500 text-white rounded hover:bg-orange-600">
                            –ü–æ–¥—Å–≤–µ—Ç–∏—Ç—å 1-–π –ö—Ä–∞—Å–Ω—ã—Ö –ó–æ—Ä—å –ø—Ä–æ–µ–∑–¥
                        </button>
                        <button onclick="clearAllMaps()" 
                                class="w-full px-4 py-2 bg-gray-500 text-white rounded hover:bg-gray-600">
                            –û—á–∏—Å—Ç–∏—Ç—å –∫–∞—Ä—Ç—É
                        </button>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –∫–∞—Ä—Ç—ã -->
        <div class="bg-white rounded-lg shadow-lg overflow-hidden">
            <div id="yandex-map" style="width: 100%; height: 600px;"></div>
        </div>
        
        <!-- –õ–æ–≥–∏ –∏ –æ—Ç–ª–∞–¥–∫–∞ -->
        <div class="bg-white rounded-lg shadow-lg p-6 mt-6">
            <h3 class="text-lg font-semibold mb-4">–õ–æ–≥–∏ —Ä–∞–±–æ—Ç—ã –∫–∞—Ä—Ç—ã</h3>
            <div id="map-logs" class="bg-gray-100 p-4 rounded max-h-96 overflow-y-auto text-sm font-mono">
                –û–∂–∏–¥–∞–Ω–∏–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ –∫–∞—Ä—Ç—ã...
            </div>
        </div>
    </div>
</div>

<script>
let mapInstance = null;

// –û–∂–∏–¥–∞–µ–º –∑–∞–≥—Ä—É–∑–∫–∏ –Ø–Ω–¥–µ–∫—Å API v2.1, –∑–∞—Ç–µ–º –∑–∞–≥—Ä—É–∂–∞–µ–º –Ω–∞—à –∫–ª–∞—Å—Å
ymaps.ready(function() {
    logMessage('‚úÖ –Ø–Ω–¥–µ–∫—Å.–ö–∞—Ä—Ç—ã API v2.1 –≥–æ—Ç–æ–≤');
    
    // –ó–∞–≥—Ä—É–∂–∞–µ–º –Ω–∞—à JavaScript –∫–ª–∞—Å—Å –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏
    const script = document.createElement('script');
    script.src = '{{ url_for("static", filename="js/yandex_maps.js") }}';
    script.onload = function() {
        logMessage('‚úÖ InBackMaps –∫–ª–∞—Å—Å –∑–∞–≥—Ä—É–∂–µ–Ω');
        initializeMap();
    };
    script.onerror = function() {
        logMessage('‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ yandex_maps.js');
    };
    document.head.appendChild(script);
});

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∫–∞—Ä—Ç—ã
async function initializeMap() {
    try {
        logMessage('üöÄ –ù–∞—á–∏–Ω–∞–µ–º –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—é –∫–∞—Ä—Ç—ã...');
        
        mapInstance = new InBackMaps();
        await mapInstance.initMap('yandex-map', [45.035180, 38.977414], 11);
        
        logMessage('‚úÖ –ö–∞—Ä—Ç–∞ —É—Å–ø–µ—à–Ω–æ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–∞');
        
        // –î–æ–±–∞–≤–ª—è–µ–º –º–∞—Ä–∫–µ—Ä —Ü–µ–Ω—Ç—Ä–∞ –ö—Ä–∞—Å–Ω–æ–¥–∞—Ä–∞
        mapInstance.addMarker(
            [45.035180, 38.977414], 
            '–¶–µ–Ω—Ç—Ä –ö—Ä–∞—Å–Ω–æ–¥–∞—Ä–∞', 
            '–î—Ä–∞–º–∞—Ç–∏—á–µ—Å–∫–∏–π —Ç–µ–∞—Ç—Ä - –¶–µ–Ω—Ç—Ä –≥–æ—Ä–æ–¥–∞ –ö—Ä–∞—Å–Ω–æ–¥–∞—Ä'
        );
        
        logMessage('üìç –î–æ–±–∞–≤–ª–µ–Ω –º–∞—Ä–∫–µ—Ä —Ü–µ–Ω—Ç—Ä–∞ –≥–æ—Ä–æ–¥–∞');
        
    } catch (error) {
        logMessage(`‚ùå –û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏: ${error.message}`);
        console.error('Map initialization error:', error);
    }
}

// –§—É–Ω–∫—Ü–∏–∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∫–∞—Ä—Ç–æ–π
async function loadDistrictBoundaries(districtSlug) {
    if (!mapInstance) {
        logMessage('‚ùå –ö–∞—Ä—Ç–∞ –Ω–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–∞');
        return;
    }
    
    logMessage(`üó∫Ô∏è –ó–∞–≥—Ä—É–∂–∞–µ–º –≥—Ä–∞–Ω–∏—Ü—ã —Ä–∞–π–æ–Ω–∞: ${districtSlug}`);
    
    try {
        const success = await mapInstance.loadDistrictBoundaries(districtSlug);
        if (success) {
            logMessage(`‚úÖ –ì—Ä–∞–Ω–∏—Ü—ã —Ä–∞–π–æ–Ω–∞ ${districtSlug} –∑–∞–≥—Ä—É–∂–µ–Ω—ã`);
        } else {
            logMessage(`‚ö†Ô∏è –ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –≥—Ä–∞–Ω–∏—Ü—ã —Ä–∞–π–æ–Ω–∞ ${districtSlug}`);
        }
    } catch (error) {
        logMessage(`‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –≥—Ä–∞–Ω–∏—Ü: ${error.message}`);
    }
}

async function loadStreetHighlight(streetSlug) {
    if (!mapInstance) {
        logMessage('‚ùå –ö–∞—Ä—Ç–∞ –Ω–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–∞');
        return;
    }
    
    logMessage(`üõ£Ô∏è –ó–∞–≥—Ä—É–∂–∞–µ–º –ø–æ–¥—Å–≤–µ—Ç–∫—É —É–ª–∏—Ü—ã: ${streetSlug}`);
    
    try {
        const success = await mapInstance.loadStreetHighlight(streetSlug);
        if (success) {
            logMessage(`‚úÖ –£–ª–∏—Ü–∞ ${streetSlug} –ø–æ–¥—Å–≤–µ—á–µ–Ω–∞`);
        } else {
            logMessage(`‚ö†Ô∏è –ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–¥—Å–≤–µ—Ç–∏—Ç—å —É–ª–∏—Ü—É ${streetSlug}`);
        }
    } catch (error) {
        logMessage(`‚ùå –û—à–∏–±–∫–∞ –ø–æ–¥—Å–≤–µ—Ç–∫–∏ —É–ª–∏—Ü—ã: ${error.message}`);
    }
}

function clearAllMaps() {
    if (!mapInstance) {
        logMessage('‚ùå –ö–∞—Ä—Ç–∞ –Ω–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–∞');
        return;
    }
    
    mapInstance.clearAll();
    logMessage('üßπ –ö–∞—Ä—Ç–∞ –æ—á–∏—â–µ–Ω–∞');
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è
function logMessage(message) {
    const timestamp = new Date().toLocaleTimeString();
    const logElement = document.getElementById('map-logs');
    const logLine = document.createElement('div');
    logLine.innerHTML = `[${timestamp}] ${message}`;
    
    logElement.appendChild(logLine);
    logElement.scrollTop = logElement.scrollHeight;
    
    console.log(message);
}

// –ì–ª–æ–±–∞–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏
window.testAPI = {
    async testDistrictAPI(slug) {
        try {
            const response = await fetch(`/api/district/boundaries/${slug}`);
            const data = await response.json();
            console.log('District API response:', data);
            logMessage(`üîç API —Ç–µ—Å—Ç —Ä–∞–π–æ–Ω–∞ ${slug}: ${data.success ? '—É—Å–ø–µ—Ö' : '–Ω–µ—É–¥–∞—á–∞'}`);
            return data;
        } catch (error) {
            console.error('API test error:', error);
            logMessage(`‚ùå –û—à–∏–±–∫–∞ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è API: ${error.message}`);
        }
    },
    
    async testStreetAPI(slug) {
        try {
            const response = await fetch(`/api/street/coordinates/${slug}`);
            const data = await response.json();
            console.log('Street API response:', data);
            logMessage(`üîç API —Ç–µ—Å—Ç —É–ª–∏—Ü—ã ${slug}: ${data.success ? '—É—Å–ø–µ—Ö' : '–Ω–µ—É–¥–∞—á–∞'}`);
            return data;
        } catch (error) {
            console.error('API test error:', error);
            logMessage(`‚ùå –û—à–∏–±–∫–∞ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è API: ${error.message}`);
        }
    }
};
</script>
{% endblock %}