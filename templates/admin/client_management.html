{% extends "admin/base.html" %}

{% block title %}–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∫–ª–∏–µ–Ω—Ç–∞–º–∏ - –ê–¥–º–∏–Ω –ø–∞–Ω–µ–ª—å | InBack{% endblock %}
{% block page_title %}–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∫–ª–∏–µ–Ω—Ç–∞–º–∏{% endblock %}

{% block content %}
<div class="space-y-6">
    <!-- Header -->
    <div class="bg-gradient-to-r from-[#1e40af] to-indigo-700 rounded-xl p-6 text-white">
        <div class="flex items-center justify-between">
            <div>
                <h1 class="text-2xl font-bold mb-2">–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∫–ª–∏–µ–Ω—Ç–∞–º–∏</h1>
                <p class="text-blue-100">–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ –º–µ–Ω–µ–¥–∂–µ—Ä–æ–≤ –∫–ª–∏–µ–Ω—Ç–∞–º —Å–∏—Å—Ç–µ–º—ã</p>
            </div>
            <div class="hidden md:block">
                <div class="bg-white bg-opacity-20 rounded-lg p-4">
                    <i class="fas fa-users-cog text-3xl"></i>
                </div>
            </div>
        </div>
    </div>

    <!-- Client Management Section -->
    <div class="bg-white rounded-lg shadow-lg">
        <div class="px-6 py-4 border-b border-gray-200">
            <div class="flex items-center justify-between">
                <h3 class="text-lg font-medium text-gray-900">
                    <i class="fas fa-users text-[#1e40af] mr-2"></i>
                    –ö–ª–∏–µ–Ω—Ç—ã —Å–∏—Å—Ç–µ–º—ã
                </h3>
                <div class="flex space-x-2">
                    <button onclick="loadClientsManagers()" class="bg-[#1e40af] text-white px-4 py-2 rounded-md hover:bg-blue-700 transition-colors">
                        <i class="fas fa-sync-alt mr-2"></i>
                        –û–±–Ω–æ–≤–∏—Ç—å –¥–∞–Ω–Ω—ã–µ
                    </button>
                    <a href="/admin/dashboard" class="bg-gray-500 text-white px-4 py-2 rounded-md hover:bg-gray-600 transition-colors">
                        <i class="fas fa-arrow-left mr-2"></i>
                        –ö –¥–∞—à–±–æ—Ä–¥—É
                    </a>
                </div>
            </div>
        </div>
        <div class="p-6">
            <div id="clients-managers-content">
                <div class="text-center py-12">
                    <i class="fas fa-spinner fa-spin text-3xl text-gray-400 mb-4"></i>
                    <p class="text-gray-500 text-lg">–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö –æ –∫–ª–∏–µ–Ω—Ç–∞—Ö...</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Statistics Cards -->
    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
        <div class="bg-white rounded-lg shadow p-6">
            <div class="flex items-center">
                <div class="p-3 bg-blue-100 rounded-lg">
                    <i class="fas fa-users text-[#1e40af] text-xl"></i>
                </div>
                <div class="ml-4">
                    <h3 class="text-sm font-medium text-gray-500">–í—Å–µ–≥–æ –∫–ª–∏–µ–Ω—Ç–æ–≤</h3>
                    <p id="total-clients" class="text-2xl font-bold text-gray-900">-</p>
                </div>
            </div>
        </div>

        <div class="bg-white rounded-lg shadow p-6">
            <div class="flex items-center">
                <div class="p-3 bg-green-100 rounded-lg">
                    <i class="fas fa-user-tie text-green-600 text-xl"></i>
                </div>
                <div class="ml-4">
                    <h3 class="text-sm font-medium text-gray-500">–ù–∞–∑–Ω–∞—á–µ–Ω–Ω—ã—Ö</h3>
                    <p id="assigned-clients" class="text-2xl font-bold text-gray-900">-</p>
                </div>
            </div>
        </div>

        <div class="bg-white rounded-lg shadow p-6">
            <div class="flex items-center">
                <div class="p-3 bg-yellow-100 rounded-lg">
                    <i class="fas fa-user-clock text-yellow-600 text-xl"></i>
                </div>
                <div class="ml-4">
                    <h3 class="text-sm font-medium text-gray-500">–ë–µ–∑ –º–µ–Ω–µ–¥–∂–µ—Ä–∞</h3>
                    <p id="unassigned-clients" class="text-2xl font-bold text-gray-900">-</p>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// Client Management Functions
function loadClientsManagers() {
    const contentDiv = document.getElementById('clients-managers-content');
    
    contentDiv.innerHTML = `
        <div class="text-center py-12">
            <i class="fas fa-spinner fa-spin text-3xl text-gray-400 mb-4"></i>
            <p class="text-gray-500 text-lg">–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö –æ –∫–ª–∏–µ–Ω—Ç–∞—Ö...</p>
        </div>
    `;
    
    fetch('/api/admin/clients-managers')
        .then(response => response.json())
        .then(data => {
            console.log('üìä API Response:', data);
            console.log('üìä First 3 clients:', data.clients ? data.clients.slice(0, 3) : []);
            if (data.success) {
                renderClientsManagers(data.clients, data.managers);
                updateStatistics(data.clients);
            } else {
                contentDiv.innerHTML = `
                    <div class="text-center py-12">
                        <i class="fas fa-exclamation-triangle text-red-500 text-3xl mb-4"></i>
                        <p class="text-red-600 text-lg">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏: ${data.error}</p>
                        <button onclick="loadClientsManagers()" class="mt-4 bg-[#1e40af] text-white px-4 py-2 rounded hover:bg-blue-700">
                            –ü–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å —Å–Ω–æ–≤–∞
                        </button>
                    </div>
                `;
            }
        })
        .catch(error => {
            console.error('Error loading clients and managers:', error);
            contentDiv.innerHTML = `
                <div class="text-center py-12">
                    <i class="fas fa-exclamation-triangle text-red-500 text-3xl mb-4"></i>
                    <p class="text-red-600 text-lg">–û—à–∏–±–∫–∞ —Å–µ—Ç–∏ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –¥–∞–Ω–Ω—ã—Ö</p>
                    <button onclick="loadClientsManagers()" class="mt-4 bg-[#1e40af] text-white px-4 py-2 rounded hover:bg-blue-700">
                        –ü–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å —Å–Ω–æ–≤–∞
                    </button>
                </div>
            `;
        });
}

function updateStatistics(clients) {
    const totalClients = clients.length;
    const assignedClients = clients.filter(client => client.assigned_manager).length;
    const unassignedClients = totalClients - assignedClients;
    
    document.getElementById('total-clients').textContent = totalClients;
    document.getElementById('assigned-clients').textContent = assignedClients;
    document.getElementById('unassigned-clients').textContent = unassignedClients;
}

function renderClientsManagers(clients, managers) {
    const contentDiv = document.getElementById('clients-managers-content');
    
    const managersOptions = managers.map(manager => 
        `<option value="${manager.id}">${manager.name} (${manager.assigned_clients_count} –∫–ª–∏–µ–Ω—Ç–æ–≤)</option>`
    ).join('');
    
    const clientsRows = clients.map(client => {
        const assignedManagerName = (client.assigned_manager && client.assigned_manager.name) ? client.assigned_manager.name : '–ù–µ –Ω–∞–∑–Ω–∞—á–µ–Ω';
        const statusClass = (client.assigned_manager && client.assigned_manager.name) ? 'text-green-600' : 'text-yellow-600';
        const rowClass = (client.assigned_manager && client.assigned_manager.name) ? 'bg-green-50' : 'bg-yellow-50';
        
        return `
            <tr class="border-b border-gray-200 hover:bg-gray-50 ${rowClass}">
                <td class="py-4 px-4">
                    <div class="flex items-center">
                        <div class="h-10 w-10 rounded-full bg-gray-300 flex items-center justify-center mr-3">
                            <i class="fas fa-user text-gray-600"></i>
                        </div>
                        <div>
                            <div class="font-medium text-gray-900">${client.full_name}</div>
                            <div class="text-sm text-gray-500">${client.email}</div>
                            <div class="text-xs text-gray-400">${client.user_id}</div>
                        </div>
                    </div>
                </td>
                <td class="py-4 px-4 text-sm text-gray-600">${client.phone || '–ù–µ —É–∫–∞–∑–∞–Ω'}</td>
                <td class="py-4 px-4 text-sm text-gray-600">${client.created_at || '–ù–µ —É–∫–∞–∑–∞–Ω–æ'}</td>
                <td class="py-4 px-4">
                    <span class="text-sm font-medium ${statusClass}">${assignedManagerName}</span>
                </td>
                <td class="py-4 px-4">
                    <select class="block w-full text-sm border border-gray-300 rounded-md px-3 py-2 bg-white focus:outline-none focus:ring-2 focus:ring-[#1e40af] focus:border-transparent" 
                            onchange="assignClientToManager(${client.id}, this.value, this)">
                        <option value="0">–ù–µ –Ω–∞–∑–Ω–∞—á–µ–Ω</option>
                        ${managersOptions}
                    </select>
                </td>
            </tr>
        `;
    }).join('');
    
    if (clients.length === 0) {
        contentDiv.innerHTML = `
            <div class="text-center py-12">
                <i class="fas fa-users text-gray-400 text-4xl mb-4"></i>
                <h3 class="text-lg font-medium text-gray-900 mb-2">–ö–ª–∏–µ–Ω—Ç–æ–≤ –ø–æ–∫–∞ –Ω–µ—Ç</h3>
                <p class="text-gray-500">–ö–ª–∏–µ–Ω—Ç—ã –ø–æ—è–≤—è—Ç—Å—è –∑–¥–µ—Å—å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–æ—Å–ª–µ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ –≤ —Å–∏—Å—Ç–µ–º–µ</p>
            </div>
        `;
        return;
    }
    
    contentDiv.innerHTML = `
        <div class="mb-6 p-4 bg-blue-50 border border-blue-200 rounded-lg">
            <div class="flex items-center">
                <i class="fas fa-info-circle text-blue-600 mr-2"></i>
                <div>
                    <h4 class="font-medium text-blue-800">–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ –∫–ª–∏–µ–Ω—Ç–æ–≤</h4>
                    <p class="text-sm text-blue-600 mt-1">–í—Å–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ —Å —Ä–æ–ª—å—é "–ü–æ–∫—É–ø–∞—Ç–µ–ª—å" –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–æ—è–≤–ª—è—é—Ç—Å—è –≤ —ç—Ç–æ–π —Å–∏—Å—Ç–µ–º–µ</p>
                </div>
            </div>
        </div>
        
        <div class="overflow-x-auto">
            <table class="min-w-full bg-white border border-gray-200 rounded-lg">
                <thead class="bg-gray-50">
                    <tr>
                        <th class="py-3 px-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider border-b">
                            <i class="fas fa-user mr-1"></i>
                            –ö–ª–∏–µ–Ω—Ç
                        </th>
                        <th class="py-3 px-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider border-b">
                            <i class="fas fa-phone mr-1"></i>
                            –¢–µ–ª–µ—Ñ–æ–Ω
                        </th>
                        <th class="py-3 px-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider border-b">
                            <i class="fas fa-calendar mr-1"></i>
                            –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è
                        </th>
                        <th class="py-3 px-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider border-b">
                            <i class="fas fa-user-tie mr-1"></i>
                            –ú–µ–Ω–µ–¥–∂–µ—Ä
                        </th>
                        <th class="py-3 px-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider border-b">
                            <i class="fas fa-cog mr-1"></i>
                            –ù–∞–∑–Ω–∞—á–∏—Ç—å
                        </th>
                    </tr>
                </thead>
                <tbody class="divide-y divide-gray-200">
                    ${clientsRows}
                </tbody>
            </table>
        </div>
        
        <div class="mt-6 p-4 bg-gray-50 border border-gray-200 rounded-lg">
            <div class="flex items-center text-sm text-gray-600">
                <i class="fas fa-lightbulb text-yellow-500 mr-2"></i>
                <span><strong>–ü–æ–¥—Å–∫–∞–∑–∫–∞:</strong> –í—ã–±–µ—Ä–∏—Ç–µ –º–µ–Ω–µ–¥–∂–µ—Ä–∞ –∏–∑ —Å–ø–∏—Å–∫–∞ —á—Ç–æ–±—ã –Ω–∞–∑–Ω–∞—á–∏—Ç—å –µ–≥–æ –∫–ª–∏–µ–Ω—Ç—É. –ú–µ–Ω–µ–¥–∂–µ—Ä –±—É–¥–µ—Ç –≤–∏–¥–µ—Ç—å —ç—Ç–æ–≥–æ –∫–ª–∏–µ–Ω—Ç–∞ –≤ —Å–≤–æ–µ–º –¥–∞—à–±–æ—Ä–¥–µ.</span>
            </div>
        </div>
    `;
    
    // Set current manager selections
    clients.forEach(client => {
        if (client.assigned_manager) {
            const select = document.querySelector(`select[onchange*="assignClientToManager(${client.id}"]`);
            if (select) {
                select.value = client.assigned_manager.id;
            }
        }
    });
}

function assignClientToManager(clientId, managerId, selectElement) {
    const originalValue = selectElement.value;
    selectElement.disabled = true;
    selectElement.style.opacity = '0.6';
    
    fetch('/api/admin/assign-client', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': document.querySelector('meta[name="csrf-token"]')?.getAttribute('content') || ''
        },
        body: JSON.stringify({
            client_id: clientId,
            manager_id: managerId == 0 ? null : managerId
        })
    })
    .then(response => response.json())
    .then(data => {
        selectElement.disabled = false;
        selectElement.style.opacity = '1';
        
        if (data.success) {
            // Show success notification
            showNotification(data.message, 'success');
            
            // Update manager column in the table
            const row = selectElement.closest('tr');
            const managerCell = row.children[3];
            
            if (managerId == 0) {
                managerCell.innerHTML = '<span class="text-yellow-600 font-medium">–ù–µ –Ω–∞–∑–Ω–∞—á–µ–Ω</span>';
                row.className = 'border-b border-gray-200 hover:bg-gray-50 bg-yellow-50';
            } else {
                managerCell.innerHTML = `<span class="text-green-600 font-medium">${data.manager_name}</span>`;
                row.className = 'border-b border-gray-200 hover:bg-gray-50 bg-green-50';
            }
            
            // Refresh statistics
            setTimeout(() => {
                loadClientsManagers();
            }, 1000);
        } else {
            // Revert selection and show error
            selectElement.value = originalValue;
            showNotification('–û—à–∏–±–∫–∞: ' + data.error, 'error');
        }
    })
    .catch(error => {
        selectElement.disabled = false;
        selectElement.style.opacity = '1';
        selectElement.value = originalValue;
        console.error('Error assigning client:', error);
        showNotification('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏ –ø—Ä–∏ –Ω–∞–∑–Ω–∞—á–µ–Ω–∏–∏', 'error');
    });
}

function showNotification(message, type) {
    const notification = document.createElement('div');
    const bgColor = type === 'success' ? 'bg-green-500' : 'bg-red-500';
    const icon = type === 'success' ? 'fas fa-check' : 'fas fa-times';
    
    notification.className = `fixed top-4 right-4 ${bgColor} text-white px-6 py-3 rounded-lg shadow-lg z-50 max-w-sm`;
    notification.innerHTML = `
        <div class="flex items-center">
            <i class="${icon} mr-3"></i>
            <span>${message}</span>
        </div>
    `;
    
    document.body.appendChild(notification);
    
    // Auto remove after 4 seconds
    setTimeout(() => {
        notification.remove();
    }, 4000);
}

// Auto-load clients and managers when page loads
document.addEventListener('DOMContentLoaded', function() {
    loadClientsManagers();
});
</script>
{% endblock %}