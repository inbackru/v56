{% extends "manager/base.html" %}

{% block title %}{{ presentation.title }} | Презентация | InBack{% endblock %}

{% block head %}
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.css">
<script src="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.js"></script>
<style>
    /* Modern presentation styles with gradients and animations */
    .presentation-actions {
        background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
        border: 1px solid #cbd5e1;
        border-radius: 16px;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.05);
    }
    
    .action-button {
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        border: 1px solid #e2e8f0;
        position: relative;
        overflow: hidden;
    }
    
    .action-button::before {
        content: '';
        position: absolute;
        top: 0;
        left: -100%;
        width: 100%;
        height: 100%;
        background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
        transition: left 0.5s;
    }
    
    .action-button:hover::before {
        left: 100%;
    }
    
    .action-button:hover {
        transform: translateY(-2px) scale(1.02);
        box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
    }
    
    .property-card {
        transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        border: 1px solid #e2e8f0;
        border-radius: 20px;
        overflow: hidden;
        background: linear-gradient(145deg, #ffffff 0%, #f8fafc 100%);
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
        position: relative;
    }
    
    .property-card::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: linear-gradient(45deg, rgba(0, 136, 204, 0.05), rgba(37, 99, 235, 0.08));
        opacity: 0;
        transition: opacity 0.3s ease;
        z-index: 1;
    }
    
    .property-card:hover::before {
        opacity: 1;
    }
    
    .property-card:hover {
        transform: translateY(-8px) scale(1.02);
        box-shadow: 0 20px 40px rgba(0, 0, 0, 0.12);
        border-color: rgba(0, 136, 204, 0.3);
    }
    
    .property-card > * {
        position: relative;
        z-index: 2;
    }
    
    .social-button {
        transition: all 0.3s ease;
        border-radius: 12px;
    }
    
    .social-button:hover {
        transform: scale(1.1) rotate(2deg);
        box-shadow: 0 8px 20px rgba(0, 0, 0, 0.15);
    }
    
    .presentation-header {
        background: linear-gradient(135deg, #0088CC 0%, #006699 25%, #1D4ED8 50%, #334155 100%);
        border-radius: 20px;
        box-shadow: 0 10px 40px rgba(0, 136, 204, 0.25);
        position: relative;
        overflow: hidden;
        animation: headerPulse 6s ease-in-out infinite;
    }
    
    .presentation-header::before {
        content: '';
        position: absolute;
        top: -50%;
        left: -50%;
        width: 200%;
        height: 200%;
        background: linear-gradient(45deg, transparent, rgba(255,255,255,0.1), transparent);
        animation: shimmer 8s ease-in-out infinite;
    }
    
    @keyframes headerPulse {
        0%, 100% { box-shadow: 0 10px 40px rgba(0, 136, 204, 0.25); }
        50% { box-shadow: 0 15px 50px rgba(37, 99, 235, 0.3); }
    }
    
    @keyframes shimmer {
        0% { transform: translateX(-100%) translateY(-100%) rotate(45deg); }
        50% { transform: translateX(0%) translateY(0%) rotate(45deg); }
        100% { transform: translateX(100%) translateY(100%) rotate(45deg); }
    }
    
    .back-button {
        transition: all 0.3s ease;
        border-radius: 12px;
        backdrop-filter: blur(8px);
    }
    
    .back-button:hover {
        background-color: rgba(255, 255, 255, 0.2);
        transform: translateX(-3px);
        box-shadow: 0 4px 15px rgba(255, 255, 255, 0.3);
    }
    
    .stats-card {
        background: rgba(255, 255, 255, 0.15);
        border-radius: 16px;
        backdrop-filter: blur(10px);
        border: 1px solid rgba(255, 255, 255, 0.2);
        transition: all 0.3s ease;
    }
    
    .stats-card:hover {
        transform: translateY(-2px);
        background: rgba(255, 255, 255, 0.25);
        box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
    }
    
    .gradient-text {
        background: linear-gradient(135deg, #ffffff 0%, #f0f9ff 100%);
        background-clip: text;
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        color: transparent;
    }
    
    .price-badge {
        background: linear-gradient(135deg, #0088CC 0%, #1D4ED8 100%);
        border-radius: 12px;
        box-shadow: 0 4px 15px rgba(0, 136, 204, 0.3);
        position: relative;
        overflow: hidden;
    }
    
    .price-badge::before {
        content: '';
        position: absolute;
        top: 0;
        left: -100%;
        width: 100%;
        height: 100%;
        background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
        transition: left 0.6s;
    }
    
    .price-badge:hover::before {
        left: 100%;
    }
    
    /* Swiper styles for photo galleries */
    .property-gallery {
        border-radius: 16px;
        overflow: hidden;
        box-shadow: 0 8px 30px rgba(0, 0, 0, 0.12);
    }
    
    .swiper-button-prev,
    .swiper-button-next {
        color: white !important;
        background: rgba(0, 0, 0, 0.6) !important;
        width: 40px !important;
        height: 40px !important;
        border-radius: 50% !important;
        transition: all 0.3s ease !important;
    }
    
    .swiper-button-prev:hover,
    .swiper-button-next:hover {
        background: rgba(0, 136, 204, 0.9) !important;
        transform: scale(1.1) !important;
    }
    
    .tabs-container {
        background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
        border-radius: 16px;
        padding: 8px;
        margin-bottom: 24px;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.05);
    }
    
    .tab-button {
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        border-radius: 12px;
        position: relative;
        overflow: hidden;
    }
    
    .tab-button.active {
        background: linear-gradient(135deg, #0088CC 0%, #1D4ED8 100%);
        color: white;
        box-shadow: 0 4px 15px rgba(0, 136, 204, 0.3);
    }
    
    .tab-button:not(.active):hover {
        background: rgba(255, 255, 255, 0.8);
        transform: translateY(-1px);
    }
    
    /* Animation classes */
    .fade-in {
        animation: fadeIn 0.6s ease-out;
    }
    
    .slide-up {
        animation: slideUp 0.6s ease-out;
    }
    
    @keyframes fadeIn {
        from { opacity: 0; }
        to { opacity: 1; }
    }
    
    @keyframes slideUp {
        from { 
            opacity: 0;
            transform: translateY(20px);
        }
        to { 
            opacity: 1;
            transform: translateY(0);
        }
    }
    
    /* Property card image effects */
    .property-image {
        transition: all 0.4s ease;
        position: relative;
        overflow: hidden;
    }
    
    .property-image::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: linear-gradient(45deg, rgba(0, 136, 204, 0.1), rgba(37, 99, 235, 0.1));
        opacity: 0;
        transition: opacity 0.3s ease;
        z-index: 0;
        pointer-events: none;
    }
    
    .property-card:hover .property-image::before {
        opacity: 1;
    }
    
    .property-image img {
        transition: transform 0.4s ease;
    }
    
    .property-card:hover .property-image img {
        transform: scale(1.05);
    }
    
    /* Compact Button Styles */
    .compact-btn {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        padding: 4px;
        border-radius: 6px;
        transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
        border: none;
        background: transparent;
        cursor: pointer;
        min-width: 28px;
        min-height: 28px;
    }
    
    .compact-btn:hover {
        transform: translateY(-1px);
        transition: all 0.15s ease;
    }
    
    .compact-btn:active {
        transform: translateY(0);
    }
    
    .compact-btn svg {
        flex-shrink: 0;
    }
    
    /* Compact Actions Container */
    .compact-actions {
        position: absolute;
        bottom: 12px;
        right: 12px;
        z-index: 10;
        opacity: 0;
        transition: all 0.3s ease;
    }
    
    .property-card:hover .compact-actions {
        opacity: 1;
    }
    
    /* Touch device support - always show buttons on small screens */
    @media (hover: none) and (pointer: coarse) {
        .compact-actions {
            opacity: 0.85;
        }
        .compact-actions:hover {
            opacity: 1;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="bg-gray-50 min-h-screen py-4">
    <div class="max-w-7xl mx-auto px-4">
        <!-- Modern gradient header with enhanced design -->
        <div class="presentation-header text-white p-8 mb-8 fade-in">
            <div class="flex flex-col lg:flex-row items-start lg:items-center justify-between gap-6">
                <div class="flex flex-col sm:flex-row items-start sm:items-center space-y-4 sm:space-y-0 sm:space-x-6 flex-1">
                    <a href="{{ url_for('manager_dashboard') }}" 
                       class="back-button inline-flex items-center px-4 py-3 text-white group">
                        <svg class="w-5 h-5 mr-3 group-hover:-translate-x-1 transition-transform duration-300" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M9.707 16.707a1 1 0 01-1.414 0l-6-6a1 1 0 010-1.414l6-6a1 1 0 011.414 1.414L5.414 9H17a1 1 0 110 2H5.414l4.293 4.293a1 1 0 010 1.414z" clip-rule="evenodd"/>
                        </svg>
                        <span class="font-medium">Назад к дашборду</span>
                    </a>
                    
                    <div class="h-px sm:h-12 w-12 sm:w-px bg-white bg-opacity-30"></div>
                    
                    <div class="flex-1">
                        <h1 class="text-3xl lg:text-4xl font-bold mb-3 gradient-text">{{ presentation.title }}</h1>
                        <div class="flex flex-wrap items-center gap-4 text-blue-100">
                            <div class="flex items-center">
                                <svg class="w-4 h-4 mr-2" fill="currentColor" viewBox="0 0 20 20">
                                    <path d="M3 4a1 1 0 011-1h12a1 1 0 011 1v2a1 1 0 01-1 1H4a1 1 0 01-1-1V4zM3 10a1 1 0 011-1h6a1 1 0 011 1v6a1 1 0 01-1 1H4a1 1 0 01-1-1v-6zM14 9a1 1 0 00-1 1v6a1 1 0 001 1h2a1 1 0 001-1v-6a1 1 0 00-1-1h-2z"/>
                                </svg>
                                <span class="font-medium">{{ presentation.properties_count }} объектов</span>
                            </div>
                            <div class="flex items-center">
                                <svg class="w-4 h-4 mr-2" fill="currentColor" viewBox="0 0 20 20">
                                    <path fill-rule="evenodd" d="M6 2a1 1 0 00-1 1v1H4a2 2 0 00-2 2v10a2 2 0 002 2h12a2 2 0 002-2V6a2 2 0 00-2-2h-1V3a1 1 0 10-2 0v1H7V3a1 1 0 00-1-1zm0 5a1 1 0 000 2h8a1 1 0 100-2H6z" clip-rule="evenodd"/>
                                </svg>
                                <span>Создано {{ presentation.created_at.strftime('%d.%m.%Y') }}</span>
                            </div>
                            {% if presentation.client_name %}
                            <div class="flex items-center">
                                <svg class="w-4 h-4 mr-2" fill="currentColor" viewBox="0 0 20 20">
                                    <path fill-rule="evenodd" d="M10 9a3 3 0 100-6 3 3 0 000 6zm-7 9a7 7 0 1114 0H3z" clip-rule="evenodd"/>
                                </svg>
                                <span class="font-medium">{{ presentation.client_name }}</span>
                            </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
                
                <!-- Stats cards -->
                <div class="flex flex-col sm:flex-row gap-4">
                    <div class="stats-card p-4 text-center min-w-[120px]">
                        <div class="flex items-center justify-center mb-2">
                            <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20">
                                <path d="M10 12a2 2 0 100-4 2 2 0 000 4z"/>
                                <path fill-rule="evenodd" d="M.458 10C1.732 5.943 5.522 3 10 3s8.268 2.943 9.542 7c-1.274 4.057-5.064 7-9.542 7S1.732 14.057.458 10zM14 10a4 4 0 11-8 0 4 4 0 018 0z" clip-rule="evenodd"/>
                            </svg>
                            <span class="text-sm font-medium">Просмотров</span>
                        </div>
                        <p class="text-2xl font-bold">{{ presentation.view_count or 0 }}</p>
                    </div>
                    
                    {% if presentation.last_viewed_at %}
                    <div class="stats-card p-4 text-center min-w-[140px]">
                        <div class="flex items-center justify-center mb-2">
                            <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-12a1 1 0 10-2 0v4a1 1 0 00.293.707l2.828 2.829a1 1 0 101.415-1.415L11 9.586V6z" clip-rule="evenodd"/>
                            </svg>
                            <span class="text-sm font-medium">Последний</span>
                        </div>
                        <p class="text-sm font-semibold">{{ presentation.last_viewed_at.strftime('%d.%m.%Y') }}</p>
                        <p class="text-xs opacity-80">{{ presentation.last_viewed_at.strftime('%H:%M') }}</p>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Action buttons section -->
        <div class="presentation-actions rounded-lg p-6 mb-6">
            <div class="flex flex-wrap items-center justify-between gap-4">
                <!-- Left side - Main actions -->
                <div class="flex flex-wrap items-center gap-3">
                    <button onclick="sharePresentation('{{ presentation.id }}')" 
                            class="action-button bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg flex items-center">
                        <svg class="w-4 h-4 mr-2" fill="currentColor" viewBox="0 0 20 20">
                            <path d="M15 8a3 3 0 10-2.977-2.63l-4.94 2.47a3 3 0 100 4.319l4.94 2.47a3 3 0 10.895-1.789l-4.94-2.47a3.027 3.027 0 000-.74l4.94-2.47C13.456 7.68 14.19 8 15 8z"/>
                        </svg>
                        Поделиться
                    </button>
                    
                    {% if presentation.assigned_to_user %}
                    <button onclick="sendToClientDashboard('{{ presentation.id }}')" 
                            class="action-button bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg flex items-center">
                        <svg class="w-4 h-4 mr-2" fill="currentColor" viewBox="0 0 20 20">
                            <path d="M10.894 2.553a1 1 0 00-1.788 0l-7 14a1 1 0 001.169 1.409l5-1.429A1 1 0 009 15.571V11a1 1 0 112 0v4.571a1 1 0 00.725.962l5 1.428a1 1 0 001.17-1.408l-7-14z"/>
                        </svg>
                        Отправить клиенту в ЛК
                    </button>
                    {% endif %}
                    
                    <button onclick="downloadAll('{{ presentation.id }}')" 
                            class="action-button bg-slate-600 hover:bg-slate-700 text-white px-4 py-2 rounded-lg flex items-center">
                        <svg class="w-4 h-4 mr-2" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm3.293-7.707a1 1 0 011.414 0L9 10.586V3a1 1 0 112 0v7.586l1.293-1.293a1 1 0 111.414 1.414l-3 3a1 1 0 01-1.414 0l-3-3a1 1 0 010-1.414z" clip-rule="evenodd"/>
                        </svg>
                        Скачать все
                    </button>
                    
                    <button onclick="shareLink('{{ presentation.id }}')" 
                            class="action-button bg-slate-600 hover:bg-slate-700 text-white px-4 py-2 rounded-lg flex items-center">
                        <svg class="w-4 h-4 mr-2" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M12.586 4.586a2 2 0 112.828 2.828l-3 3a2 2 0 01-2.828 0 1 1 0 00-1.414 1.414 4 4 0 005.656 0l3-3a4 4 0 00-5.656-5.656l-1.5 1.5a1 1 0 101.414 1.414l1.5-1.5zm-5 5a2 2 0 012.828 0 1 1 0 101.414-1.414 4 4 0 00-5.656 0l-3 3a4 4 0 105.656 5.656l1.5-1.5a1 1 0 10-1.414-1.414l-1.5 1.5a2 2 0 11-2.828-2.828l3-3z" clip-rule="evenodd"/>
                        </svg>
                        Ссылка
                    </button>
                </div>

                <!-- Center - Social media buttons -->
                <div class="flex items-center gap-2">
                    <span class="text-sm text-gray-600 mr-2">Поделиться будет доступно после создания ссылки</span>
                </div>

                <!-- Right side - Management actions -->
                <div class="flex items-center gap-3">
                    <button onclick="clearAll('{{ presentation.id }}')" 
                            class="action-button bg-slate-600 hover:bg-slate-700 text-white px-4 py-2 rounded-lg flex items-center">
                        <svg class="w-4 h-4 mr-2" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd"/>
                        </svg>
                        Очистить всё
                    </button>
                    
                    <button onclick="addProperty('{{ presentation.id }}')" 
                            class="action-button bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg flex items-center">
                        <svg class="w-4 h-4 mr-2" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M10 3a1 1 0 011 1v5h5a1 1 0 110 2h-5v5a1 1 0 11-2 0v-5H4a1 1 0 110-2h5V4a1 1 0 011-1z" clip-rule="evenodd"/>
                        </svg>
                        Добавить объект
                    </button>
                </div>
            </div>
        </div>

        <!-- Tabs container - preparation for future tabs -->
        <div class="tabs-container slide-up">
            <div class="flex items-center justify-center">
                <button class="tab-button active px-6 py-3 text-sm font-medium">
                    <svg class="w-4 h-4 mr-2 inline" fill="currentColor" viewBox="0 0 20 20">
                        <path d="M3 4a1 1 0 011-1h12a1 1 0 011 1v2a1 1 0 01-1 1H4a1 1 0 01-1-1V4zM3 10a1 1 0 011-1h6a1 1 0 011 1v6a1 1 0 01-1 1H4a1 1 0 01-1-1v-6zM14 9a1 1 0 00-1 1v6a1 1 0 001 1h2a1 1 0 001-1v-6a1 1 0 00-1-1h-2z"/>
                    </svg>
                    Объекты недвижимости
                </button>
            </div>
        </div>

        <!-- Modern Properties grid -->
        {% if presentation.properties %}
        <div class="grid grid-cols-1 xl:grid-cols-2 gap-8 slide-up">
            {% for property in presentation.properties %}
            <div class="property-card group" data-property-id="{{ property.property_id }}">
                <!-- Enhanced Property Image Gallery -->
                <div class="property-image relative h-80 bg-gradient-to-br from-gray-100 to-gray-200">
                    {% set all_images = [] %}
                    {% if property.images and property.images|length > 0 %}
                        {% set _ = all_images.extend(property.images) %}
                    {% endif %}
                    {% if property.layout_image %}
                        {% set _ = all_images.append(property.layout_image) %}
                    {% endif %}
                    
                    {% if all_images|length > 1 %}
                        <!-- Swiper Gallery -->
                        <div class="swiper property-gallery h-full" id="gallery-{{ property.property_id }}">
                            <div class="swiper-wrapper">
                                {% for image in all_images %}
                                <div class="swiper-slide">
                                    <img src="{{ image }}" alt="Объект {{ property.property_id }}" class="w-full h-full object-cover">
                                    {% if loop.last and property.layout_image and image == property.layout_image %}
                                    <div class="absolute bottom-4 left-4 bg-black bg-opacity-70 text-white px-3 py-1 rounded-full text-sm font-medium">
                                        <svg class="w-4 h-4 mr-1 inline" fill="currentColor" viewBox="0 0 20 20">
                                            <path d="M4 3a2 2 0 00-2 2v10a2 2 0 002 2h12a2 2 0 002-2V5a2 2 0 00-2-2H4zm12 12H4l4-8 3 6 2-4 3 6z"/>
                                        </svg>
                                        Планировка
                                    </div>
                                    {% endif %}
                                </div>
                                {% endfor %}
                            </div>
                            <div class="swiper-button-prev"></div>
                            <div class="swiper-button-next"></div>
                            <div class="swiper-pagination"></div>
                        </div>
                    {% elif all_images|length == 1 %}
                        <!-- Single Image -->
                        <img src="{{ all_images[0] }}" alt="Объект {{ property.property_id }}" class="w-full h-full object-cover">
                        {% if property.layout_image and all_images[0] == property.layout_image %}
                        <div class="absolute bottom-4 left-4 bg-black bg-opacity-70 text-white px-3 py-1 rounded-full text-sm font-medium">
                            <svg class="w-4 h-4 mr-1 inline" fill="currentColor" viewBox="0 0 20 20">
                                <path d="M4 3a2 2 0 00-2 2v10a2 2 0 002 2h12a2 2 0 002-2V5a2 2 0 00-2-2H4zm12 12H4l4-8 3 6 2-4 3 6z"/>
                            </svg>
                            Планировка
                        </div>
                        {% endif %}
                    {% else %}
                        <!-- No Image Placeholder -->
                        <div class="w-full h-full flex flex-col items-center justify-center text-gray-400 bg-gradient-to-br from-gray-50 to-gray-100">
                            <svg class="w-20 h-20 mb-3" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M4 3a2 2 0 00-2 2v10a2 2 0 002 2h12a2 2 0 002-2V5a2 2 0 00-2-2H4zm12 12H4l4-8 3 6 2-4 3 6z" clip-rule="evenodd"/>
                            </svg>
                            <p class="text-sm font-medium">Фото отсутствует</p>
                        </div>
                    {% endif %}
                    
                    <!-- Enhanced Price Badge -->
                    <div class="price-badge absolute top-4 right-4 text-white px-4 py-2 font-bold text-lg">
                        {{ "{:,}".format(property.price).replace(",", " ") }} ₽
                    </div>
                    
                    <!-- Property Type Badge -->
                    <div class="absolute top-4 left-4 bg-white bg-opacity-90 text-gray-800 px-3 py-1 rounded-full text-sm font-semibold backdrop-blur-sm">
                        {% if property.rooms == 0 %}
                            🏠 Студия
                        {% else %}
                            🏠 {{ property.rooms }}-комн
                        {% endif %}
                    </div>
                    
                    <!-- Compact Action Buttons -->
                    <div class="compact-actions">
                        <div class="flex items-center space-x-1 bg-white/95 backdrop-blur-sm rounded-lg p-1 shadow-lg border border-gray-200">
                            <button onclick="viewFullPropertyManager('{{ presentation.id }}', '{{ property.property_id }}')" 
                                    class="compact-btn text-slate-600 hover:text-blue-600 hover:bg-blue-50"
                                    title="Подробнее">
                                <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                                    <path d="M10 12a2 2 0 100-4 2 2 0 000 4z"/>
                                    <path fill-rule="evenodd" d="M.458 10C1.732 5.943 5.522 3 10 3s8.268 2.943 9.542 7c-1.274 4.057-5.064 7-9.542 7S1.732 14.057.458 10zM14 10a4 4 0 11-8 0 4 4 0 018 0z" clip-rule="evenodd"/>
                                </svg>
                            </button>
                            <button onclick="downloadPropertyPDFManager('{{ presentation.id }}', '{{ property.property_id }}')" 
                                    class="compact-btn text-slate-600 hover:text-blue-600 hover:bg-blue-50"
                                    title="PDF">
                                <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                                    <path fill-rule="evenodd" d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm3.293-7.707a1 1 0 011.414 0L9 10.586V3a1 1 0 112 0v7.586l1.293-1.293a1 1 0 111.414 1.414l-3 3a1 1 0 01-1.414 0l-3-3a1 1 0 010-1.414z" clip-rule="evenodd"/>
                                </svg>
                            </button>
                            <button onclick="printPropertyManager('{{ presentation.id }}', '{{ property.property_id }}')" 
                                    class="compact-btn text-slate-600 hover:text-blue-600 hover:bg-blue-50"
                                    title="Печать">
                                <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                                    <path fill-rule="evenodd" d="M5 4v3H4a2 2 0 00-2 2v3a2 2 0 002 2h1v2a2 2 0 002 2h6a2 2 0 002-2v-2h1a2 2 0 002-2V9a2 2 0 00-2-2h-1V4a2 2 0 00-2-2H7a2 2 0 00-2 2zm8 0H7v3h6V4zM5 14H4v-2h1v2zm1 0v2h6v-2H6zm-1-6h8a1 1 0 110 2H5a1 1 0 110-2z" clip-rule="evenodd"/>
                                </svg>
                            </button>
                            <button onclick="addComment('{{ presentation.id }}', '{{ property.property_id }}')" 
                                    class="compact-btn text-slate-600 hover:text-blue-600 hover:bg-blue-50"
                                    title="Комментарий">
                                <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                                    <path fill-rule="evenodd" d="M18 10c0 3.866-3.582 7-8 7a8.841 8.841 0 01-4.083-.98L2 17l1.338-3.123C2.493 12.767 2 11.434 2 10c0-3.866 3.582-7 8-7s8 3.134 8 7zM7 9H5v2h2V9zm8 0h-2v2h2V9zM9 9h2v2H9V9z" clip-rule="evenodd"/>
                                </svg>
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Enhanced Property Details -->
                <div class="p-6">
                    <!-- Header with title and actions -->
                    <div class="flex items-start justify-between mb-6">
                        <div class="flex-1">
                            <h3 class="text-xl font-bold text-gray-900 mb-2 group-hover:text-blue-600 transition-colors">
                                {% if property.rooms == 0 %}
                                    Студия {{ property.area }} м²
                                {% else %}
                                    {{ property.rooms }}-комнатная квартира {{ property.area }} м²
                                {% endif %}
                            </h3>
                            <div class="flex items-center text-gray-600 mb-2">
                                <svg class="w-4 h-4 mr-2" fill="currentColor" viewBox="0 0 20 20">
                                    <path fill-rule="evenodd" d="M5.05 4.05a7 7 0 119.9 9.9L10 18.9l-4.95-4.95a7 7 0 010-9.9zM10 11a2 2 0 100-4 2 2 0 000 4z" clip-rule="evenodd"/>
                                </svg>
                                <span class="font-medium">{{ property.complex_name }}</span>
                            </div>
                            {% if property.address %}
                            <p class="text-gray-500 text-sm flex items-center">
                                <svg class="w-3 h-3 mr-1" fill="currentColor" viewBox="0 0 20 20">
                                    <path fill-rule="evenodd" d="M5.05 4.05a7 7 0 119.9 9.9L10 18.9l-4.95-4.95a7 7 0 010-9.9zM10 11a2 2 0 100-4 2 2 0 000 4z" clip-rule="evenodd"/>
                                </svg>
                                {{ property.address }}
                            </p>
                            {% endif %}
                        </div>
                        <button onclick="deletePropertyFromPresentation('{{ presentation.id }}', '{{ property.property_id }}')" 
                                class="compact-btn text-slate-600 hover:text-slate-700 hover:bg-slate-100" 
                                title="Удалить">
                            <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"/>
                            </svg>
                        </button>
                    </div>

                    <!-- Manager Comment Display -->
                    <div id="comment-block-{{ property.property_id }}" class="manager-comment-block" style="display: none;">
                        <div class="bg-gradient-to-r from-yellow-50 to-amber-50 border border-yellow-200 rounded-xl p-4 mb-4">
                            <div class="flex items-start space-x-3">
                                <div class="flex-shrink-0">
                                    <svg class="w-5 h-5 text-yellow-600" fill="currentColor" viewBox="0 0 20 20">
                                        <path fill-rule="evenodd" d="M18 10c0 3.866-3.582 7-8 7a8.841 8.841 0 01-4.083-.98L2 17l1.338-3.123C2.493 12.767 2 11.434 2 10c0-3.866 3.582-7 8-7s8 3.134 8 7zM7 9H5v2h2V9zm8 0h-2v2h2V9zM9 9h2v2H9V9z" clip-rule="evenodd"/>
                                    </svg>
                                </div>
                                <div class="flex-1">
                                    <h4 class="text-sm font-semibold text-yellow-800 mb-1">Комментарий менеджера</h4>
                                    <p class="text-sm text-yellow-700 manager-note" id="comment-text-{{ property.property_id }}"></p>
                                </div>
                                <button onclick="addComment('{{ presentation.id }}', '{{ property.property_id }}')" 
                                        class="text-yellow-600 hover:text-yellow-800 transition-colors p-1" 
                                        title="Редактировать комментарий">
                                    <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                                        <path d="M13.586 3.586a2 2 0 112.828 2.828l-.793.793-2.828-2.828.793-.793zM11.379 5.793L3 14.172V17h2.828l8.38-8.379-2.83-2.828z"/>
                                    </svg>
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Enhanced Property Features Grid -->
                    <div class="grid grid-cols-2 sm:grid-cols-4 gap-4 mb-6">
                        <div class="bg-gradient-to-br from-blue-50 to-blue-100 p-3 rounded-xl text-center border border-blue-200">
                            <div class="text-blue-600 mb-1">
                                <svg class="w-5 h-5 mx-auto" fill="currentColor" viewBox="0 0 20 20">
                                    <path d="M3 4a1 1 0 011-1h12a1 1 0 011 1v2a1 1 0 01-1 1H4a1 1 0 01-1-1V4zM3 10a1 1 0 011-1h6a1 1 0 011 1v6a1 1 0 01-1 1H4a1 1 0 01-1-1v-6zM14 9a1 1 0 00-1 1v6a1 1 0 001 1h2a1 1 0 001-1v-6a1 1 0 00-1-1h-2z"/>
                                </svg>
                            </div>
                            <p class="text-xs text-blue-700 font-medium mb-1">Площадь</p>
                            <p class="font-bold text-blue-900">{{ property.area }} м²</p>
                        </div>
                        
                        <div class="bg-gradient-to-br from-slate-50 to-slate-100 p-3 rounded-xl text-center border border-slate-200">
                            <div class="text-slate-600 mb-1">
                                <svg class="w-5 h-5 mx-auto" fill="currentColor" viewBox="0 0 20 20">
                                    <path d="M10.894 2.553a1 1 0 00-1.788 0l-7 14a1 1 0 001.169 1.409l5-1.429A1 1 0 009 15.571V11a1 1 0 112 0v4.571a1 1 0 00.725.962l5 1.428a1 1 0 001.17-1.408l-7-14z"/>
                                </svg>
                            </div>
                            <p class="text-xs text-slate-700 font-medium mb-1">Этаж</p>
                            <p class="font-bold text-slate-900">{{ property.floor }}/{{ property.total_floors }}</p>
                        </div>
                        
                        <div class="bg-gradient-to-br from-blue-50 to-blue-100 p-3 rounded-xl text-center border border-blue-200">
                            <div class="text-blue-600 mb-1">
                                <svg class="w-5 h-5 mx-auto" fill="currentColor" viewBox="0 0 20 20">
                                    <path fill-rule="evenodd" d="M4 4a2 2 0 00-2 2v8a2 2 0 002 2h12a2 2 0 002-2V6a2 2 0 00-2-2H4zm3 5a1 1 0 011-1h4a1 1 0 110 2H8a1 1 0 01-1-1z" clip-rule="evenodd"/>
                                </svg>
                            </div>
                            <p class="text-xs text-blue-700 font-medium mb-1">За м²</p>
                            <p class="font-bold text-blue-900">{{ "{:,}".format(property.price // property.area).replace(",", " ") }} ₽</p>
                        </div>
                        
                        <div class="bg-gradient-to-br from-orange-50 to-orange-100 p-3 rounded-xl text-center border border-orange-200">
                            <div class="text-orange-600 mb-1">
                                <svg class="w-5 h-5 mx-auto" fill="currentColor" viewBox="0 0 20 20">
                                    <path fill-rule="evenodd" d="M6 2a1 1 0 00-1 1v1H4a2 2 0 00-2 2v10a2 2 0 002 2h12a2 2 0 002-2V6a2 2 0 00-2-2h-1V3a1 1 0 10-2 0v1H7V3a1 1 0 00-1-1zm0 5a1 1 0 000 2h8a1 1 0 100-2H6z" clip-rule="evenodd"/>
                                </svg>
                            </div>
                            <p class="text-xs text-orange-700 font-medium mb-1">Тип</p>
                            <p class="font-bold text-orange-900 text-xs">{{ property.property_type }}</p>
                        </div>
                    </div>
                    
                    <!-- Additional property info from rich data -->
                    {% if property.property_info %}
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 mb-6">
                        {% if property.property_info.get('cashback_available') and property.property_info.get('cashback') %}
                        <div class="bg-gradient-to-r from-blue-500 to-blue-600 text-white p-4 rounded-xl">
                            <div class="flex items-center mb-2">
                                <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20">
                                    <path d="M8.433 7.418c.155-.103.346-.196.567-.267v1.698a2.305 2.305 0 01-.567-.267C8.07 8.34 8 8.114 8 8c0-.114.07-.34.433-.582zM11 12.849v-1.698c.22.071.412.164.567.267.364.243.433.468.433.582 0 .114-.07.34-.433.582a2.305 2.305 0 01-.567.267z"/>
                                    <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-13a1 1 0 10-2 0v.092a4.535 4.535 0 00-1.676.662C6.602 6.234 6 7.009 6 8c0 .99.602 1.765 1.324 2.246.48.32 1.054.545 1.676.662v1.941c-.391-.127-.68-.317-.843-.504a1 1 0 10-1.51 1.31c.562.649 1.413 1.076 2.353 1.253V15a1 1 0 102 0v-.092a4.535 4.535 0 001.676-.662C13.398 13.766 14 12.991 14 12c0-.99-.602-1.765-1.324-2.246A4.535 4.535 0 0011 9.092V7.151c.391.127.68.317.843.504a1 1 0 101.511-1.31c-.563-.649-1.413-1.076-2.354-1.253V5z" clip-rule="evenodd"/>
                                </svg>
                                <span class="font-bold">Кэшбек возможен</span>
                            </div>
                            <p class="text-xl font-bold">{{ "{:,}".format(property.property_info.cashback).replace(",", " ") }} ₽</p>
                            <p class="text-blue-100 text-sm">До 5% от стоимости</p>
                        </div>
                        {% endif %}
                        
                        {% if property.property_info.get('developer') %}
                        <div class="bg-gradient-to-r from-blue-500 to-indigo-600 text-white p-4 rounded-xl">
                            <div class="flex items-center mb-2">
                                <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20">
                                    <path fill-rule="evenodd" d="M4 4a2 2 0 00-2 2v8a2 2 0 002 2h12a2 2 0 002-2V6a2 2 0 00-2-2H4zm3 5a1 1 0 011-1h4a1 1 0 110 2H8a1 1 0 01-1-1z" clip-rule="evenodd"/>
                                </svg>
                                <span class="font-bold">Застройщик</span>
                            </div>
                            <p class="text-lg font-semibold">{{ property.property_info.developer }}</p>
                        </div>
                        {% endif %}
                    </div>
                    {% endif %}

                    <!-- Enhanced Manager Note -->
                    {% if property.manager_note %}
                    <div class="bg-gradient-to-r from-blue-50 to-indigo-50 border-l-4 border-blue-500 rounded-lg p-4 mb-6 manager-comment-block">
                        <div class="flex items-start">
                            <div class="flex-shrink-0 mr-3">
                                <svg class="w-5 h-5 text-blue-600" fill="currentColor" viewBox="0 0 20 20">
                                    <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd"/>
                                </svg>
                            </div>
                            <div class="flex-1">
                                <h4 class="text-sm font-semibold text-blue-800 mb-1">💬 Комментарий менеджера</h4>
                                <p class="text-sm text-blue-700 manager-note leading-relaxed">{{ property.manager_note }}</p>
                            </div>
                        </div>
                    </div>
                    {% endif %}

                    <!-- Modern Property Actions -->
                    <div class="pt-6 border-t border-gray-100">
                        <!-- Primary Action Buttons Grid -->
                        <div class="grid grid-cols-2 gap-3 mb-4">
                            <!-- View Button -->
                            <button onclick="viewFullPropertyManager('{{ presentation.id }}', '{{ property.property_id }}')" 
                                    class="action-button bg-gradient-to-r from-blue-600 to-blue-700 hover:from-blue-700 hover:to-blue-800 text-white px-4 py-3 rounded-xl text-sm font-semibold transition-all duration-300 flex items-center justify-center group">
                                <svg class="w-4 h-4 mr-2 group-hover:scale-110 transition-transform" fill="currentColor" viewBox="0 0 20 20">
                                    <path d="M10 12a2 2 0 100-4 2 2 0 000 4z"/>
                                    <path fill-rule="evenodd" d="M.458 10C1.732 5.943 5.522 3 10 3s8.268 2.943 9.542 7c-1.274 4.057-5.064 7-9.542 7S1.732 14.057.458 10zM14 10a4 4 0 11-8 0 4 4 0 018 0z" clip-rule="evenodd"/>
                                </svg>
                                👁️ Просмотр
                            </button>
                            
                            <!-- Download PDF Button -->
                            <button onclick="downloadPropertyPDFManager('{{ presentation.id }}', '{{ property.property_id }}')" 
                                    class="action-button bg-gradient-to-r from-blue-600 to-blue-700 hover:from-blue-700 hover:to-blue-800 text-white px-4 py-3 rounded-xl text-sm font-semibold transition-all duration-300 flex items-center justify-center group">
                                <svg class="w-4 h-4 mr-2 group-hover:scale-110 transition-transform" fill="currentColor" viewBox="0 0 20 20">
                                    <path fill-rule="evenodd" d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm3.293-7.707a1 1 0 011.414 0L9 10.586V3a1 1 0 112 0v7.586l1.293-1.293a1 1 0 111.414 1.414l-3 3a1 1 0 01-1.414 0l-3-3a1 1 0 010-1.414z" clip-rule="evenodd"/>
                                </svg>
                                💾 PDF
                            </button>
                        </div>
                        
                        <!-- Secondary Actions -->
                        <div class="flex items-center justify-between">
                            <button onclick="addComment('{{ presentation.id }}', '{{ property.property_id }}')" 
                                    class="text-[#0088CC] hover:text-[#006699] text-sm font-medium flex items-center group transition-all duration-200 hover:bg-blue-50 px-3 py-2 rounded-lg">
                                <svg class="w-4 h-4 mr-2 group-hover:scale-110 transition-transform" fill="currentColor" viewBox="0 0 20 20">
                                    <path fill-rule="evenodd" d="M18 10c0 3.866-3.582 7-8 7a8.841 8.841 0 01-4.083-.98L2 17l1.338-3.123C2.493 12.767 2 11.434 2 10c0-3.866 3.582-7 8-7s8 3.134 8 7zM7 9H5v2h2V9zm8 0h-2v2h2V9zM9 9h2v2H9V9z" clip-rule="evenodd"/>
                                </svg>
                                💬 {% if property.manager_note %}Изменить комментарий{% else %}Добавить комментарий{% endif %}
                            </button>
                            
                            <button onclick="printPropertyManager('{{ presentation.id }}', '{{ property.property_id }}')" 
                                    class="text-gray-600 hover:text-gray-800 text-sm font-medium flex items-center group transition-all duration-200 hover:bg-gray-50 px-3 py-2 rounded-lg">
                                <svg class="w-4 h-4 mr-2 group-hover:scale-110 transition-transform" fill="currentColor" viewBox="0 0 20 20">
                                    <path fill-rule="evenodd" d="M5 4v3H4a2 2 0 00-2 2v3a2 2 0 002 2h1v2a2 2 0 002 2h6a2 2 0 002-2v-2h1a2 2 0 002-2V9a2 2 0 00-2-2h-1V4a2 2 0 00-2-2H7a2 2 0 00-2 2zm8 0H7v3h6V4zm0 8H7v4h6v-4z" clip-rule="evenodd"/>
                                </svg>
                                🖨️ Печать
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
        {% else %}
        <!-- Enhanced Empty state -->
        <div class="bg-gradient-to-br from-white to-gray-50 rounded-2xl shadow-lg p-16 text-center border border-gray-100">
            <div class="w-24 h-24 bg-gradient-to-br from-blue-100 to-indigo-200 rounded-full flex items-center justify-center mx-auto mb-6 relative">
                <svg class="w-12 h-12 text-blue-600" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M4 3a2 2 0 00-2 2v10a2 2 0 002 2h12a2 2 0 002-2V5a2 2 0 00-2-2H4zm12 12H4l4-8 3 6 2-4 3 6z" clip-rule="evenodd"/>
                </svg>
                <div class="absolute -top-2 -right-2 w-8 h-8 bg-blue-500 rounded-full flex items-center justify-center">
                    <svg class="w-4 h-4 text-white" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M10 3a1 1 0 011 1v5h5a1 1 0 110 2h-5v5a1 1 0 11-2 0v-5H4a1 1 0 110-2h5V4a1 1 0 011-1z" clip-rule="evenodd"/>
                    </svg>
                </div>
            </div>
            <h3 class="text-2xl font-bold text-gray-900 mb-3">📋 Презентация готова к наполнению</h3>
            <p class="text-gray-600 mb-8 max-w-md mx-auto leading-relaxed">Добавьте объекты недвижимости, чтобы создать привлекательную презентацию для ваших клиентов</p>
            <button onclick="addProperty('{{ presentation.id }}')" 
                    class="action-button bg-gradient-to-r from-blue-600 to-blue-700 hover:from-blue-700 hover:to-blue-800 text-white px-8 py-4 rounded-xl font-semibold inline-flex items-center text-lg group transition-all duration-300">
                <svg class="w-6 h-6 mr-3 group-hover:scale-110 transition-transform" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M10 3a1 1 0 011 1v5h5a1 1 0 110 2h-5v5a1 1 0 11-2 0v-5H4a1 1 0 110-2h5V4a1 1 0 011-1z" clip-rule="evenodd"/>
                </svg>
                🏠 Добавить первый объект
            </button>
            <div class="mt-6 text-sm text-gray-500">
                💡 Совет: Вы можете добавить несколько объектов и создать ссылку для отправки клиенту
            </div>
        </div>
        {% endif %}
    </div>
</div>

<!-- Share Modal -->
<div id="shareModal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center">
    <div class="bg-white rounded-lg p-6 w-full max-w-md mx-4">
        <div class="flex justify-between items-center mb-4">
            <h3 class="text-lg font-semibold text-gray-900">Сформировать ссылку</h3>
            <button onclick="closeShareModal()" class="text-gray-400 hover:text-gray-600">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                </svg>
            </button>
        </div>

        <div class="space-y-4">
            <!-- Tab buttons -->
            <div class="flex border-b">
                <button id="formTab" onclick="switchTab('form')" class="px-4 py-2 border-b-2 border-purple-500 text-purple-600 font-medium">
                    Сформировать
                </button>
                <button id="settingsTab" onclick="switchTab('settings')" class="px-4 py-2 text-gray-500 hover:text-gray-700">
                    Настроить
                </button>
            </div>

            <!-- Form content -->
            <div id="formContent">
                <div class="space-y-4">
                    <div>
                        <label for="clientName" class="block text-sm font-medium text-gray-700 mb-1">
                            ФИО клиента<span class="text-red-500">*</span>
                        </label>
                        <input type="text" id="clientName" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-purple-500 focus:border-purple-500" 
                               placeholder="Введите ФИО клиента">
                    </div>

                    <div>
                        <label for="language" class="block text-sm font-medium text-gray-700 mb-1">
                            Язык
                        </label>
                        <select id="language" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-purple-500 focus:border-purple-500">
                            <option value="ru">Русский</option>
                            <option value="en">English</option>
                        </select>
                    </div>

                    <button onclick="generateFinalLink()" class="w-full bg-blue-600 hover:bg-blue-700 text-white py-2 px-4 rounded-lg font-medium">
                        Сформировать ссылку
                    </button>

                    <div class="text-center">
                        <button onclick="previewPresentation()" class="text-blue-600 hover:text-blue-800 text-sm underline">
                            Предварительный просмотр
                        </button>
                    </div>

                    <!-- Generated link display -->
                    <div id="generatedLinkContainer" class="hidden">
                        <div class="bg-gray-50 p-3 rounded-lg">
                            <label class="block text-sm font-medium text-gray-700 mb-2">Ссылка для клиента:</label>
                            <div class="flex mb-3">
                                <input type="text" id="generatedLink" class="flex-1 px-3 py-2 border border-gray-300 rounded-l-lg bg-white" readonly>
                                <button onclick="copyLink()" class="px-4 py-2 bg-slate-600 text-white rounded-r-lg hover:bg-slate-700">
                                    Копировать
                                </button>
                            </div>
                            
                            <!-- Social sharing buttons -->
                            <div class="border-t pt-3">
                                <div class="flex items-center justify-between">
                                    <span class="text-sm font-medium text-gray-700">Поделиться:</span>
                                    <div class="flex gap-2">
                                        <button onclick="shareToTelegram()" 
                                                class="social-button bg-blue-500 hover:bg-blue-600 text-white p-2 rounded-lg" title="Telegram">
                                            <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 24 24">
                                                <path d="M11.944 0A12 12 0 0 0 0 12a12 12 0 0 0 12 12 12 12 0 0 0 12-12A12 12 0 0 0 12 0a12 12 0 0 0-.056 0zm4.962 7.224c.1-.002.321.023.465.14a.506.506 0 0 1 .171.325c.016.093.036.306.02.472-.18 1.898-.962 6.502-1.36 8.627-.168.9-.499 1.201-.82 1.23-.696.065-1.225-.46-1.9-.902-1.056-.693-1.653-1.124-2.678-1.8-1.185-.78-.417-1.21.258-1.91.177-.184 3.247-2.977 3.307-3.23.007-.032.014-.15-.056-.212s-.174-.041-.249-.024c-.106.024-1.793 1.14-5.061 3.345-.48.33-.913.49-1.302.48-.428-.008-1.252-.241-1.865-.44-.752-.245-1.349-.374-1.297-.789.027-.216.325-.437.893-.663 3.498-1.524 5.83-2.529 6.998-3.014 3.332-1.386 4.025-1.627 4.476-1.635z"/>
                                            </svg>
                                        </button>
                                        
                                        <button onclick="shareToWhatsApp()" 
                                                class="social-button bg-slate-500 hover:bg-slate-600 text-white p-2 rounded-lg" title="WhatsApp">
                                            <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 24 24">
                                                <path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893A11.821 11.821 0 0020.885 3.488"/>
                                            </svg>
                                        </button>
                                        
                                        <button onclick="shareToVK()" 
                                                class="social-button bg-blue-700 hover:bg-blue-800 text-white p-2 rounded-lg" title="VKontakte">
                                            <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 24 24">
                                                <path d="M15.684 0H8.316C1.592 0 0 1.592 0 8.316v7.368C0 22.408 1.592 24 8.316 24h7.368C22.408 24 24 22.408 24 15.684V8.316C24 1.592 22.408 0 15.684 0zm3.692 17.123h-1.744c-.66 0-.864-.525-2.05-1.211-1.040-1.026-1.49-.734-1.49.308v1.563c0 .42-.133.67-1.252.67-1.851 0-3.906-1.125-5.368-3.208C5.578 10.665 4.7 7.342 6.567 6.812c.626-.178 2.144-.044 2.144 1.135 0 .86-.42 2.542.704 2.542.42 0 .658-.282 1.49-1.135 1.222-1.255.86-3.026-.42-3.026-.315 0-.63.044-.86.133 1.04-3.472 4.488-2.542 5.368.31.308 1.006-.133 2.144-.42 3.208-.42 1.562-.863 2.542 0 3.208.42.315 1.252-.42 2.144-1.135.42-.336.525-.42.525-.42.42-.336.945.462.42.798z"/>
                                            </svg>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Settings content -->
            <div id="settingsContent" class="hidden">
                <div class="text-center text-gray-500 py-8">
                    Настройки презентации<br>
                    <small>Дополнительные параметры будут доступны позже</small>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- JavaScript for functionality -->
<script>
// Sharing functions (duplicate removed - using improved version below)

function shareToTelegram() {
    const generatedLink = document.getElementById('generatedLink').value;
    if (!generatedLink) {
        alert('Сначала создайте ссылку');
        return;
    }
    
    const telegramUrl = `https://telegram.me/share/url?url=${encodeURIComponent(generatedLink)}&text=${encodeURIComponent('Презентация недвижимости от InBack')}`;
    window.open(telegramUrl, '_blank');
}

function shareToWhatsApp() {
    const generatedLink = document.getElementById('generatedLink').value;
    if (!generatedLink) {
        alert('Сначала создайте ссылку');
        return;
    }
    
    const whatsappUrl = `https://wa.me/?text=${encodeURIComponent('Презентация недвижимости от InBack: ' + generatedLink)}`;
    window.open(whatsappUrl, '_blank');
}

function shareToVK() {
    const generatedLink = document.getElementById('generatedLink').value;
    if (!generatedLink) {
        alert('Сначала создайте ссылку');
        return;
    }
    
    const vkUrl = `https://vk.com/share.php?url=${encodeURIComponent(generatedLink)}&title=${encodeURIComponent('Презентация недвижимости от InBack')}`;
    window.open(vkUrl, '_blank');
}

function sendToEmail(presentationId) {
    // TODO: Implement email sending
    alert('Функция отправки на почту будет реализована');
}

function downloadAll(presentationId) {
    console.log(`🔥 Starting downloadAll for presentation ID: ${presentationId}`);
    
    // Get the button that triggered this
    const button = event.target.closest('button');
    const originalHTML = button.innerHTML;
    
    // Show loading state
    button.innerHTML = '<svg class="w-4 h-4 mr-2 animate-spin" fill="currentColor" viewBox="0 0 20 20"><path d="M4 2a2 2 0 00-2 2v12a2 2 0 002 2h12a2 2 0 002-2V2a2 2 0 00-2-2H4z"/></svg>Подготовка...';
    button.disabled = true;
    
    try {
        // Create download link for all materials
        const link = document.createElement('a');
        link.href = `/api/manager/presentation/${presentationId}/download-all`;
        link.download = `Презентация ${presentationId} - Все материалы.zip`;
        link.style.display = 'none';
        
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        
        // Show success message
        showNotification && showNotification('Скачивание начато...', 'success');
        
        // Restore button after delay
        setTimeout(() => {
            button.innerHTML = originalHTML;
            button.disabled = false;
        }, 2000);
        
    } catch (error) {
        console.error('Error downloading all materials:', error);
        showNotification && showNotification('Ошибка при скачивании', 'error');
        
        // Restore button
        button.innerHTML = originalHTML;
        button.disabled = false;
    }
}

function clearAll(presentationId) {
    if (confirm('Вы уверены, что хотите очистить всю презентацию?')) {
        // TODO: Implement clear all functionality
        alert('Функция очистки будет реализована');
    }
}

function addProperty(presentationId) {
    // TODO: Implement add property functionality
    alert('Функция добавления объекта будет реализована');
}

function removeProperty(presentationId, propertyId) {
    if (confirm('Удалить этот объект из презентации?')) {
        // TODO: Implement remove property functionality
        alert('Функция удаления объекта будет реализована');
    }
}

async function addComment(presentationId, propertyId) {
    // Найти текущий комментарий
    const commentElement = document.querySelector(`[data-property-id="${propertyId}"] .manager-note`);
    const currentComment = commentElement ? commentElement.textContent.replace('Комментарий: ', '').trim() : '';
    
    const newComment = prompt('Введите комментарий к объекту:', currentComment);
    
    if (newComment !== null) {
        try {
            const csrfToken = document.querySelector('meta[name="csrf-token"]')?.content || '';
            const response = await fetch(`/api/manager/presentation/${presentationId}/property/${propertyId}/comment`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrfToken,
                },
                body: JSON.stringify({
                    manager_note: newComment.trim()
                })
            });
            
            const data = await response.json();
            
            if (data.success) {
                // Обновить отображение комментария на странице
                updateCommentDisplay(propertyId, newComment.trim());
                
                // Показать уведомление об успехе
                showNotification('Комментарий сохранен', 'success');
            } else {
                throw new Error(data.error || 'Не удалось сохранить комментарий');
            }
        } catch (error) {
            console.error('Error updating comment:', error);
            alert('Ошибка при сохранении комментария: ' + error.message);
        }
    }
}

function updateCommentDisplay(propertyId, comment) {
    // Найти элемент комментария для этого объекта
    const propertyCard = document.querySelector(`[data-property-id="${propertyId}"]`);
    if (!propertyCard) return;
    
    let commentBlock = propertyCard.querySelector('.manager-comment-block');
    const buttonElement = propertyCard.querySelector('[onclick*="addComment"]');
    
    if (comment && comment.trim()) {
        // Если комментарий есть, показать его
        if (!commentBlock) {
            // Создать блок комментария если его нет
            commentBlock = document.createElement('div');
            commentBlock.className = 'bg-blue-50 border border-blue-200 rounded-lg p-3 mb-4 manager-comment-block';
            commentBlock.innerHTML = `
                <p class="text-sm text-blue-800 manager-note">
                    <span class="font-medium">Комментарий:</span> ${comment}
                </p>
            `;
            
            // Вставить перед кнопками
            const actionsBlock = propertyCard.querySelector('.pt-4.border-t');
            if (actionsBlock) {
                actionsBlock.parentNode.insertBefore(commentBlock, actionsBlock);
            }
        } else {
            // Обновить существующий комментарий
            const noteElement = commentBlock.querySelector('.manager-note');
            if (noteElement) {
                noteElement.innerHTML = `<span class="font-medium">Комментарий:</span> ${comment}`;
            }
        }
        
        // Обновить текст кнопки
        if (buttonElement) {
            buttonElement.innerHTML = `
                <svg class="w-4 h-4 mr-1" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M18 10c0 3.866-3.582 7-8 7a8.841 8.841 0 01-4.083-.98L2 17l1.338-3.123C2.493 12.767 2 11.434 2 10c0-3.866 3.582-7 8-7s8 3.134 8 7zM7 9H5v2h2V9zm8 0h-2v2h2V9zM9 9h2v2H9V9z" clip-rule="evenodd"/>
                </svg>
                Изменить комментарий
            `;
        }
    } else {
        // Если комментарий пустой, скрыть блок
        if (commentBlock) {
            commentBlock.remove();
        }
        
        // Обновить текст кнопки
        if (buttonElement) {
            buttonElement.innerHTML = `
                <svg class="w-4 h-4 mr-1" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M18 10c0 3.866-3.582 7-8 7a8.841 8.841 0 01-4.083-.98L2 17l1.338-3.123C2.493 12.767 2 11.434 2 10c0-3.866 3.582-7 8-7s8 3.134 8 7zM7 9H5v2h2V9zm8 0h-2v2h2V9zM9 9h2v2H9V9z" clip-rule="evenodd"/>
                </svg>
                Добавить комментарий
            `;
        }
    }
}

function showNotification(message, type = 'info') {
    // Создать уведомление
    const notification = document.createElement('div');
    notification.className = `fixed top-4 right-4 z-50 px-4 py-3 rounded-lg shadow-lg text-white ${
        type === 'success' ? 'bg-blue-500' : 
        type === 'error' ? 'bg-slate-500' : 'bg-blue-500'
    }`;
    notification.textContent = message;
    
    document.body.appendChild(notification);
    
    // Удалить через 3 секунды
    setTimeout(() => {
        notification.remove();
    }, 3000);
}

// Modal functions
let currentPresentationUrl = '';
let currentPresentationId = '';

function showShareModal() {
    // Use the already stored presentation ID
    currentPresentationId = window.currentPresentationId || window.currentPresentationIdForModal || '';
    console.log('showShareModal - currentPresentationId:', currentPresentationId);
    document.getElementById('clientName').value = '';
    document.getElementById('shareModal').classList.remove('hidden');
    document.getElementById('generatedLinkContainer').classList.add('hidden');
    // Reset to form tab
    switchTab('form');
}

function closeShareModal() {
    document.getElementById('shareModal').classList.add('hidden');
    document.getElementById('generatedLinkContainer').classList.add('hidden');
    document.getElementById('clientName').value = '';
    document.getElementById('language').value = 'ru';
    currentPresentationUrl = '';
    currentPresentationId = '';
    
    // Reset button states
    const generateButton = document.querySelector('button[onclick="generateFinalLink()"]');
    const copyButton = document.querySelector('button[onclick="copyLink()"]');
    if (generateButton) {
        generateButton.textContent = 'Сформировать ссылку';
        generateButton.disabled = false;
    }
    if (copyButton) {
        copyButton.textContent = 'Копировать';
        copyButton.style.backgroundColor = '';
    }
}

function switchTab(tab) {
    const formTab = document.getElementById('formTab');
    const settingsTab = document.getElementById('settingsTab');
    const formContent = document.getElementById('formContent');
    const settingsContent = document.getElementById('settingsContent');

    if (tab === 'form') {
        formTab.classList.add('border-b-2', 'border-blue-500', 'text-blue-600', 'font-medium');
        formTab.classList.remove('text-gray-500');
        settingsTab.classList.remove('border-b-2', 'border-blue-500', 'text-blue-600', 'font-medium');
        settingsTab.classList.add('text-gray-500');
        formContent.classList.remove('hidden');
        settingsContent.classList.add('hidden');
    } else {
        settingsTab.classList.add('border-b-2', 'border-blue-500', 'text-blue-600', 'font-medium');
        settingsTab.classList.remove('text-gray-500');
        formTab.classList.remove('border-b-2', 'border-blue-500', 'text-blue-600', 'font-medium');
        formTab.classList.add('text-gray-500');
        settingsContent.classList.remove('hidden');
        formContent.classList.add('hidden');
    }
}

async function generateFinalLink() {
    const clientName = document.getElementById('clientName').value.trim();
    const language = document.getElementById('language').value;
    
    if (!clientName) {
        alert('Пожалуйста, введите ФИО клиента');
        document.getElementById('clientName').focus();
        return;
    }

    // Use the correct global variable name with comprehensive debugging
    const presentationId = window.currentPresentationId || window.currentPresentationIdForModal;
    
    console.log('🔗 generateFinalLink - Debug info:', {
        currentPresentationId: window.currentPresentationId,
        currentPresentationIdForModal: window.currentPresentationIdForModal,
        finalPresentationId: presentationId,
        clientName: clientName
    });
    
    if (!presentationId || presentationId === 'undefined' || presentationId === null || presentationId === '') {
        console.error('🚨 No presentation ID found:', {
            currentPresentationId: window.currentPresentationId,
            currentPresentationIdForModal: window.currentPresentationIdForModal
        });
        alert('Ошибка: ID презентации не найден. Попробуйте закрыть окно и открыть снова.');
        return;
    }

    const generateButton = document.querySelector('button[onclick="generateFinalLink()"]');
    const originalText = generateButton.textContent;
    
    try {
        // Show loading state
        generateButton.textContent = 'Генерация ссылки...';
        generateButton.disabled = true;
        
        const response = await fetch(`/api/manager/presentation/${presentationId}/share`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{ csrf_token() }}'
            },
            credentials: 'same-origin',
            body: JSON.stringify({
                client_name: clientName,
                language: language
            })
        });
        
        const data = await response.json();
        
        if (data.success && data.share_data && data.share_data.presentation_url) {
            // Show generated link
            document.getElementById('generatedLink').value = data.share_data.presentation_url;
            document.getElementById('generatedLinkContainer').classList.remove('hidden');
            
            // Success feedback
            generateButton.textContent = '✓ Ссылка создана';
            setTimeout(() => {
                generateButton.textContent = originalText;
            }, 2000);
        } else {
            throw new Error(data.error || 'Не удалось создать ссылку');
        }
        
    } catch (error) {
        console.error('Error generating final link:', error);
        alert('Ошибка при генерации ссылки: ' + error.message);
        
        generateButton.textContent = originalText;
    } finally {
        generateButton.disabled = false;
    }
}

function previewPresentation() {
    if (currentPresentationUrl) {
        window.open(currentPresentationUrl, '_blank');
    }
}

async function copyLink() {
    const linkInput = document.getElementById('generatedLink');
    const copyButton = document.querySelector('button[onclick="copyLink()"]');
    const originalText = copyButton.textContent;
    
    if (!linkInput.value) {
        alert('Сначала создайте ссылку');
        return;
    }
    
    try {
        copyButton.textContent = 'Копирование...';
        
        if (navigator.clipboard && window.isSecureContext) {
            await navigator.clipboard.writeText(linkInput.value);
        } else {
            // Fallback for older browsers or non-HTTPS
            linkInput.select();
            linkInput.setSelectionRange(0, 99999);
            document.execCommand('copy');
        }
        
        copyButton.textContent = '✓ Скопировано';
        copyButton.style.backgroundColor = '#10b981';
        
        setTimeout(() => {
            copyButton.textContent = originalText;
            copyButton.style.backgroundColor = '';
        }, 2000);
        
    } catch (err) {
        console.error('Copy failed:', err);
        copyButton.textContent = originalText;
        alert('Не удалось скопировать ссылку. Попробуйте выделить и скопировать вручную.');
        // Select the text for manual copying
        linkInput.select();
    }
}

// ===== НОВЫЕ ФУНКЦИИ ДЛЯ ДЕЙСТВИЙ С ОБЪЕКТАМИ (МЕНЕДЖЕРСКАЯ ВЕРСИЯ) =====

// Print property - открыть print-friendly версию
function printPropertyManager(presentationId, propertyId) {
    const printUrl = `/api/presentation/${presentationId}/property/${propertyId}/print`;
    const printWindow = window.open(printUrl, '_blank', 'width=800,height=600');
    
    if (printWindow) {
        printWindow.focus();
    } else {
        alert('Не удалось открыть окно печати. Пожалуйста, разрешите всплывающие окна.');
    }
}

// Download property PDF
function downloadPropertyPDFManager(presentationId, propertyId) {
    const downloadUrl = `/api/presentation/${presentationId}/property/${propertyId}/download`;
    
    // Показать индикатор загрузки
    const button = event.target.closest('button');
    const originalText = button.innerHTML;
    button.innerHTML = '<i class="fas fa-spinner fa-spin mr-1"></i>Генерируем...';
    button.disabled = true;
    
    // Создать временную ссылку для скачивания
    const link = document.createElement('a');
    link.href = downloadUrl;
    link.download = `property_${propertyId}.pdf`;
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
    
    // Восстановить кнопку через 3 секунды
    setTimeout(() => {
        button.innerHTML = originalText;
        button.disabled = false;
    }, 3000);
}

// View full property on website
function viewFullPropertyManager(presentationId, propertyId) {
    const viewUrl = `/api/presentation/${presentationId}/property/${propertyId}/view`;
    window.open(viewUrl, '_blank');
}

// Delete property from presentation (manager only with confirmation)
async function deletePropertyFromPresentation(presentationId, propertyId) {
    // Подтверждение удаления
    if (!confirm('Вы уверены, что хотите удалить этот объект из презентации?')) {
        return;
    }
    
    const button = event.target.closest('button');
    const originalText = button.innerHTML;
    button.innerHTML = '<i class="fas fa-spinner fa-spin mr-1"></i>Удаляем...';
    button.disabled = true;
    
    try {
        const csrfToken = document.querySelector('meta[name="csrf-token"]')?.content || '';
        const response = await fetch(`/api/manager/presentation/${presentationId}/property/${propertyId}/delete`, {
            method: 'DELETE',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrfToken
            }
        });
        
        const data = await response.json();
        
        if (data.success) {
            // Удалить карточку объекта из DOM
            const propertyCard = button.closest('.property-card');
            if (propertyCard) {
                propertyCard.style.transition = 'all 0.3s ease';
                propertyCard.style.opacity = '0';
                propertyCard.style.transform = 'translateX(-100%)';
                
                setTimeout(() => {
                    propertyCard.remove();
                    
                    // Проверить, остались ли объекты
                    const remainingCards = document.querySelectorAll('.property-card');
                    if (remainingCards.length === 0) {
                        // Перезагрузить страницу если больше нет объектов
                        location.reload();
                    }
                }, 300);
            }
            
            // Показать уведомление об успехе
            showManagerNotification('Объект успешно удален из презентации', 'success');
            
        } else {
            throw new Error(data.error || 'Не удалось удалить объект');
        }
        
    } catch (error) {
        console.error('Error deleting property:', error);
        showManagerNotification('Ошибка при удалении объекта: ' + error.message, 'error');
        
        // Восстановить кнопку при ошибке
        button.innerHTML = originalText;
        button.disabled = false;
    }
}

// Показать уведомление (менеджерская версия)
function showManagerNotification(message, type = 'success') {
    const notification = document.createElement('div');
    notification.className = `fixed top-4 right-4 z-50 px-6 py-3 rounded-lg shadow-lg text-white ${type === 'success' ? 'bg-blue-600' : 'bg-slate-600'}`;
    notification.textContent = message;
    
    document.body.appendChild(notification);
    
    // Анимация появления
    notification.style.opacity = '0';
    notification.style.transform = 'translateX(100%)';
    setTimeout(() => {
        notification.style.transition = 'all 0.3s ease';
        notification.style.opacity = '1';
        notification.style.transform = 'translateX(0)';
    }, 10);
    
    // Автоматическое скрытие через 4 секунды
    setTimeout(() => {
        notification.style.opacity = '0';
        notification.style.transform = 'translateX(100%)';
        setTimeout(() => {
            if (notification.parentNode) {
                notification.parentNode.removeChild(notification);
            }
        }, 300);
    }, 4000);
}

// ===== MISSING FUNCTIONS FOR PRESENTATION ACTIONS =====

// Send presentation to email
async function sendToEmail(presentationId) {
    const button = event.target.closest('button');
    const originalText = button.innerHTML;
    button.innerHTML = '<i class="fas fa-spinner fa-spin mr-1"></i>Отправляем...';
    button.disabled = true;
    
    try {
        // Prompt for email
        const email = prompt('Введите email для отправки презентации:');
        if (!email) {
            button.innerHTML = originalText;
            button.disabled = false;
            return;
        }
        
        const response = await fetch(`/api/manager/presentation/${presentationId}/send-email`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{ csrf_token() }}'
            },
            body: JSON.stringify({
                email: email
            })
        });
        
        const data = await response.json();
        
        if (data.success) {
            showManagerNotification('Презентация успешно отправлена на email', 'success');
            button.innerHTML = '✓ Отправлено';
        } else {
            throw new Error(data.error || 'Не удалось отправить презентацию');
        }
        
    } catch (error) {
        console.error('Error sending to email:', error);
        showManagerNotification('Ошибка при отправке: ' + error.message, 'error');
        button.innerHTML = originalText;
    } finally {
        setTimeout(() => {
            button.innerHTML = originalText;
            button.disabled = false;
        }, 3000);
    }
}

// Download all properties as ZIP or PDF
async function downloadAll(presentationId) {
    const button = event.target.closest('button');
    const originalText = button.innerHTML;
    button.innerHTML = '<i class="fas fa-spinner fa-spin mr-1"></i>Генерируем...';
    button.disabled = true;
    
    try {
        // Create download link
        const downloadUrl = `/api/manager/presentation/${presentationId}/download-all`;
        
        const link = document.createElement('a');
        link.href = downloadUrl;
        link.download = `presentation_${presentationId}_all_properties.zip`;
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        
        showManagerNotification('Скачивание началось', 'success');
        button.innerHTML = '✓ Скачано';
        
    } catch (error) {
        console.error('Error downloading all:', error);
        showManagerNotification('Ошибка при скачивании: ' + error.message, 'error');
        button.innerHTML = originalText;
    } finally {
        setTimeout(() => {
            button.innerHTML = originalText;
            button.disabled = false;
        }, 3000);
    }
}

// Share presentation link (opens modal)
function shareLink(presentationId) {
    console.log('🔗 shareLink called with presentationId:', presentationId);
    console.log('🔗 Type of presentationId:', typeof presentationId);
    
    // Validate presentation ID
    if (!presentationId || presentationId === 'undefined' || presentationId === null) {
        console.error('🚨 Invalid presentation ID provided:', presentationId);
        alert('Ошибка: неверный ID презентации');
        return;
    }
    
    // Store the presentation ID globally for the modal (both variable names for compatibility)
    window.currentPresentationId = String(presentationId);
    window.currentPresentationIdForModal = String(presentationId);
    
    console.log('🔗 Stored presentation IDs:', {
        currentPresentationId: window.currentPresentationId,
        currentPresentationIdForModal: window.currentPresentationIdForModal
    });
    
    // Find and open the share modal
    const shareModal = document.getElementById('shareModal');
    if (shareModal) {
        shareModal.classList.remove('hidden');
        document.getElementById('generatedLinkContainer').classList.add('hidden');
        // Reset form
        document.getElementById('clientName').value = '';
        document.getElementById('language').value = 'ru';
        
        console.log('🔗 Share modal opened successfully');
        
        // Focus on client name input
        const clientNameInput = document.getElementById('clientName');
        if (clientNameInput) {
            setTimeout(() => clientNameInput.focus(), 100);
        }
    } else {
        console.error('🚨 Share modal not found!');
        alert('Модальное окно для создания ссылки не найдено');
    }
}

// Clear all properties from presentation
async function clearAll(presentationId) {
    if (!confirm('Вы уверены, что хотите удалить ВСЕ объекты из презентации? Это действие нельзя отменить.')) {
        return;
    }
    
    const button = event.target.closest('button');
    const originalText = button.innerHTML;
    button.innerHTML = '<i class="fas fa-spinner fa-spin mr-1"></i>Очищаем...';
    button.disabled = true;
    
    try {
        const response = await fetch(`/api/manager/presentation/${presentationId}/clear-all`, {
            method: 'DELETE',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{ csrf_token() }}'
            }
        });
        
        const data = await response.json();
        
        if (data.success) {
            showManagerNotification('Все объекты удалены из презентации', 'success');
            // Reload page to show empty state
            setTimeout(() => {
                location.reload();
            }, 1500);
        } else {
            throw new Error(data.error || 'Не удалось очистить презентацию');
        }
        
    } catch (error) {
        console.error('Error clearing all:', error);
        showManagerNotification('Ошибка при очистке: ' + error.message, 'error');
        button.innerHTML = originalText;
        button.disabled = false;
    }
}

// Add property to presentation
function addProperty(presentationId) {
    // Redirect to property search with presentation context
    window.location.href = `/manager/properties?add_to_presentation=${presentationId}`;
}

// Add comment to property
async function addComment(presentationId, propertyId) {
    // Get existing comment if any
    const existingComment = document.querySelector(`.property-card[data-property-id="${propertyId}"] .manager-note`)?.textContent.replace('Комментарий: ', '') || '';
    
    const comment = prompt('Введите комментарий к объекту:', existingComment);
    if (comment === null) return; // User cancelled
    
    const button = event.target.closest('button');
    const originalText = button.innerHTML;
    button.innerHTML = '<i class="fas fa-spinner fa-spin mr-1"></i>Сохраняем...';
    button.disabled = true;
    
    try {
        const url = `/api/manager/presentation/${presentationId}/property/${propertyId}/comment`;
        console.log('Comment API - Making request to:', url);
        console.log('Comment API - Request data:', { manager_note: comment });
        
        const response = await fetch(url, {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json'
            },
            credentials: 'same-origin',
            body: JSON.stringify({
                manager_note: comment
            })
        });
        
        console.log('Comment API - Response status:', response.status);
        console.log('Comment API - Response headers:', [...response.headers.entries()]);
        
        if (!response.ok) {
            const text = await response.text();
            console.error('Comment API - Non-OK response:', response.status, text);
            throw new Error(`HTTP ${response.status}: ${text}`);
        }
        
        const contentType = response.headers.get('content-type');
        console.log('Comment API - Content-Type:', contentType);
        
        if (!contentType || !contentType.includes('application/json')) {
            const text = await response.text();
            console.error('Comment API - Not JSON response:', text.substring(0, 200));
            throw new Error('Expected JSON response but got: ' + contentType);
        }
        
        const data = await response.json();
        console.log('Comment API - Response data:', data);
        
        if (data.success) {
            // Update comment in DOM
            const propertyCard = document.querySelector(`.property-card[data-property-id="${propertyId}"]`);
            if (propertyCard) {
                let commentBlock = propertyCard.querySelector('.manager-comment-block');
                
                if (comment.trim()) {
                    // Add or update comment
                    if (!commentBlock) {
                        // Create new comment block
                        commentBlock = document.createElement('div');
                        commentBlock.className = 'bg-blue-50 border border-blue-200 rounded-lg p-3 mb-4 manager-comment-block';
                        commentBlock.innerHTML = `
                            <p class="text-sm text-blue-800 manager-note">
                                <span class="font-medium">Комментарий:</span> ${comment}
                            </p>
                        `;
                        // Insert before property actions
                        const actionsDiv = propertyCard.querySelector('.pt-4.border-t');
                        actionsDiv.parentNode.insertBefore(commentBlock, actionsDiv);
                    } else {
                        // Update existing comment
                        const noteElement = commentBlock.querySelector('.manager-note');
                        noteElement.innerHTML = `<span class="font-medium">Комментарий:</span> ${comment}`;
                    }
                } else {
                    // Remove comment block if comment is empty
                    if (commentBlock) {
                        commentBlock.remove();
                    }
                }
            }
            
            showManagerNotification('Комментарий сохранен', 'success');
            button.innerHTML = comment.trim() ? 'Изменить комментарий' : 'Добавить комментарий';
        } else {
            throw new Error(data.error || 'Не удалось сохранить комментарий');
        }
        
    } catch (error) {
        console.error('Error adding comment:', error);
        showManagerNotification('Ошибка при сохранении комментария: ' + error.message, 'error');
        button.innerHTML = originalText;
    } finally {
        button.disabled = false;
    }
}

// Remove property from presentation (alternative to delete)
function removeProperty(presentationId, propertyId) {
    // Use the same function as delete
    deletePropertyFromPresentation(presentationId, propertyId);
}

// Close share modal
function closeShareModal() {
    const shareModal = document.getElementById('shareModal');
    if (shareModal) {
        shareModal.classList.add('hidden');
    }
}

// Switch tabs in share modal
function switchTab(tabName) {
    // Update tab buttons
    const formTab = document.getElementById('formTab');
    const settingsTab = document.getElementById('settingsTab');
    
    if (tabName === 'form') {
        formTab.classList.add('border-purple-500', 'text-purple-600');
        formTab.classList.remove('text-gray-500');
        settingsTab.classList.remove('border-purple-500', 'text-purple-600');
        settingsTab.classList.add('text-gray-500');
    } else {
        settingsTab.classList.add('border-purple-500', 'text-purple-600');
        settingsTab.classList.remove('text-gray-500');
        formTab.classList.remove('border-purple-500', 'text-purple-600');
        formTab.classList.add('text-gray-500');
    }
    
    // Show/hide tab content
    const formContent = document.getElementById('formContent');
    const settingsContent = document.getElementById('settingsContent');
    
    if (tabName === 'form') {
        formContent?.classList.remove('hidden');
        settingsContent?.classList.add('hidden');
    } else {
        settingsContent?.classList.remove('hidden');
        formContent?.classList.add('hidden');
    }
}

// Share to social media functions
function shareToTelegram() {
    const link = document.getElementById('generatedLink')?.value;
    if (!link) {
        alert('Сначала создайте ссылку на презентацию');
        return;
    }
    const text = encodeURIComponent(`Презентация недвижимости: ${link}`);
    window.open(`https://t.me/share/url?url=${encodeURIComponent(link)}&text=${text}`, '_blank');
}

function shareToWhatsApp() {
    const link = document.getElementById('generatedLink')?.value;
    if (!link) {
        alert('Сначала создайте ссылку на презентацию');
        return;
    }
    const text = encodeURIComponent(`Презентация недвижимости: ${link}`);
    window.open(`https://wa.me/?text=${text}`, '_blank');
}

function shareToVK() {
    const link = document.getElementById('generatedLink')?.value;
    if (!link) {
        alert('Сначала создайте ссылку на презентацию');
        return;
    }
    const url = encodeURIComponent(link);
    const title = encodeURIComponent('Презентация недвижимости');
    window.open(`https://vk.com/share.php?url=${url}&title=${title}`, '_blank');
}

// Alias function for viewPropertyPublic (alternative naming for compatibility)
function viewPropertyPublic(presentationId, propertyId) {
    // Redirect to the public view of the property
    viewFullPropertyManager(presentationId, propertyId);
}

// Initialize Swiper galleries for all property cards
document.addEventListener('DOMContentLoaded', function() {
    console.log('🎨 Initializing modern presentation view...');
    
    // Initialize all Swiper galleries
    const galleries = document.querySelectorAll('.property-gallery');
    console.log(`🖼️ Found ${galleries.length} property galleries to initialize`);
    
    galleries.forEach((gallery, index) => {
        const galleryId = gallery.id;
        console.log(`🎨 Initializing gallery: ${galleryId}`);
        
        try {
            const swiper = new Swiper(`#${galleryId}`, {
                // Basic settings
                loop: true,
                autoplay: {
                    delay: 4000,
                    disableOnInteraction: false,
                    pauseOnMouseEnter: true
                },
                speed: 600,
                
                // Effects
                effect: 'fade',
                fadeEffect: {
                    crossFade: true
                },
                
                // Navigation
                navigation: {
                    nextEl: `#${galleryId} .swiper-button-next`,
                    prevEl: `#${galleryId} .swiper-button-prev`,
                },
                
                // Pagination
                pagination: {
                    el: `#${galleryId} .swiper-pagination`,
                    clickable: true,
                    dynamicBullets: true,
                    renderBullet: function (index, className) {
                        return `<span class="${className}">${index + 1}</span>`;
                    }
                },
                
                // Touch settings
                touchRatio: 1,
                touchAngle: 45,
                simulateTouch: true,
                
                // Performance
                watchSlidesProgress: true,
                watchSlidesVisibility: true,
                
                // Events
                on: {
                    init: function() {
                        console.log(`✅ Gallery ${galleryId} initialized successfully`);
                    },
                    slideChange: function() {
                        // Add subtle animation effects
                        const activeSlide = this.slides[this.activeIndex];
                        if (activeSlide) {
                            const img = activeSlide.querySelector('img');
                            if (img) {
                                img.style.transform = 'scale(1.02)';
                                setTimeout(() => {
                                    img.style.transform = 'scale(1)';
                                }, 300);
                            }
                        }
                    }
                }
            });
            
            // Store swiper instance for potential future use
            gallery.swiperInstance = swiper;
            
        } catch (error) {
            console.error(`❌ Error initializing gallery ${galleryId}:`, error);
        }
    });
    
    // Add modern scroll animations
    const observerOptions = {
        threshold: 0.1,
        rootMargin: '0px 0px -50px 0px'
    };
    
    const observer = new IntersectionObserver((entries) => {
        entries.forEach(entry => {
            if (entry.isIntersecting) {
                entry.target.style.opacity = '1';
                entry.target.style.transform = 'translateY(0)';
            }
        });
    }, observerOptions);
    
    // Observe all property cards for entrance animations
    document.querySelectorAll('.property-card').forEach((card, index) => {
        // Set initial state for animation
        card.style.opacity = '0';
        card.style.transform = 'translateY(20px)';
        card.style.transition = `opacity 0.6s ease ${index * 0.1}s, transform 0.6s ease ${index * 0.1}s`;
        
        observer.observe(card);
    });
    
    // Animate action buttons on hover
    document.querySelectorAll('.action-button').forEach(button => {
        button.addEventListener('mouseenter', function() {
            this.style.transform = 'translateY(-2px) scale(1.02)';
        });
        
        button.addEventListener('mouseleave', function() {
            this.style.transform = 'translateY(0) scale(1)';
        });
    });
    
    // Enhanced ripple effect for buttons
    document.querySelectorAll('button').forEach(button => {
        button.addEventListener('click', function(e) {
            const ripple = document.createElement('div');
            const rect = this.getBoundingClientRect();
            const size = Math.max(rect.width, rect.height);
            const x = e.clientX - rect.left - size / 2;
            const y = e.clientY - rect.top - size / 2;
            
            ripple.style.cssText = `
                position: absolute;
                border-radius: 50%;
                background: rgba(255, 255, 255, 0.3);
                transform: scale(0);
                animation: ripple 0.6s linear;
                left: ${x}px;
                top: ${y}px;
                width: ${size}px;
                height: ${size}px;
                pointer-events: none;
            `;
            
            // Add ripple animation keyframes if not already added
            if (!document.querySelector('#ripple-style')) {
                const style = document.createElement('style');
                style.id = 'ripple-style';
                style.textContent = `
                    @keyframes ripple {
                        to {
                            transform: scale(2);
                            opacity: 0;
                        }
                    }
                `;
                document.head.appendChild(style);
            }
            
            this.style.position = 'relative';
            this.style.overflow = 'hidden';
            this.appendChild(ripple);
            
            setTimeout(() => {
                ripple.remove();
            }, 600);
        });
    });
    
    // Add smooth scrolling for any anchor links
    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener('click', function (e) {
            e.preventDefault();
            const target = document.querySelector(this.getAttribute('href'));
            if (target) {
                target.scrollIntoView({
                    behavior: 'smooth',
                    block: 'start'
                });
            }
        });
    });
    
    console.log('✅ Modern presentation view initialization complete!');
});

// Global resize handler for responsive galleries
window.addEventListener('resize', debounce(() => {
    document.querySelectorAll('.property-gallery').forEach(gallery => {
        if (gallery.swiperInstance) {
            gallery.swiperInstance.update();
        }
    });
}, 250));

// Utility function for debouncing
function debounce(func, wait) {
    let timeout;
    return function executedFunction(...args) {
        const later = () => {
            clearTimeout(timeout);
            func(...args);
        };
        clearTimeout(timeout);
        timeout = setTimeout(later, wait);
    };
}

// Send presentation to client's dashboard
async function sendToClientDashboard(presentationId) {
    if (!confirm('Отправить презентацию в личный кабинет клиента? Клиент получит уведомление.')) {
        return;
    }
    
    try {
        const response = await fetch(`/api/manager/collection/${presentationId}/send-to-client`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': document.querySelector('meta[name="csrf-token"]').content
            }
        });
        
        const data = await response.json();
        
        if (data.success) {
            alert('Презентация успешно отправлена клиенту!');
            location.reload();
        } else {
            alert(data.error || 'Ошибка при отправке презентации');
        }
    } catch (error) {
        console.error('Error sending presentation to client:', error);
        alert('Ошибка при отправке презентации');
    }
}

</script>
{% endblock %}