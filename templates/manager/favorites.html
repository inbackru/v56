{% extends "base.html" %}

{% block title %}Избранные объекты менеджера - InBack.ru{% endblock %}

{% block description %}Избранные объекты недвижимости менеджера {{ current_manager.full_name }}. Сохраненные квартиры и жилые комплексы.{% endblock %}

{% block head_extra %}
<!-- ✅ FIX: Set manager authentication flag BEFORE favorites.js loads -->
<script>
window.manager_authenticated = true;
console.log('✅ Manager flag set in HEAD - manager_authenticated:', window.manager_authenticated);
</script>
{% endblock %}

{% block content %}
<div class="bg-gradient-to-r from-[#0088CC] to-[#006699] text-white py-16">
    <div class="container mx-auto px-4 text-center">
        <div class="flex items-center justify-center gap-3 mb-4">
            <div class="favorites-counter">
                <i class="fas fa-heart text-4xl"></i>
                <div class="badge show" id="total-favorites-badge">0</div>
            </div>
        </div>
        <h1 class="text-4xl font-bold mb-4">Избранные объекты</h1>
        <p class="text-xl text-blue-100 max-w-2xl mx-auto">
            Ваши сохраненные квартиры и жилые комплексы для работы с клиентами.
        </p>
        <p class="text-lg text-blue-200 mt-2">
            Менеджер: {{ current_manager.full_name }}
        </p>
    </div>
</div>

<section class="py-16 bg-gray-50">
    <div class="container mx-auto px-4">
        <!-- Back to dashboard -->
        <div class="mb-6">
            <a href="{{ url_for('manager_dashboard') }}" class="inline-flex items-center text-[#0088CC] hover:text-[#006699] font-medium">
                <i class="fas fa-arrow-left mr-2"></i>
                Вернуться к панели менеджера
            </a>
        </div>
        
        <!-- Tabs for Properties and Complexes -->
        <div class="bg-white rounded-xl shadow-sm mb-8">
            <div class="border-b border-gray-200">
                <nav class="flex">
                    <button class="favorites-tab-button active py-4 px-6 text-sm font-medium border-b-2 border-[#0088CC] text-[#0088CC]" data-tab="properties">
                        <i class="fas fa-home mr-2"></i>
                        Квартиры (<span id="properties-count">0</span>)
                    </button>
                    <button class="favorites-tab-button py-4 px-6 text-sm font-medium border-b-2 border-transparent text-gray-500 hover:text-gray-700" data-tab="complexes">
                        <i class="fas fa-building mr-2"></i>
                        Жилые комплексы (<span id="complexes-count">0</span>)
                    </button>
                </nav>
            </div>

            <!-- Properties Tab -->
            <div class="favorites-tab-content active p-6" id="properties-tab">
                <!-- Clear All Button -->
                <div class="mb-4 flex justify-end" id="clear-properties-container" style="display: none;">
                    <button onclick="clearAllProperties()" class="px-4 py-2 bg-red-500 text-white rounded-lg hover:bg-red-600 transition-colors flex items-center gap-2">
                        <i class="fas fa-trash"></i>
                        Очистить все квартиры
                    </button>
                </div>
                
                <!-- Empty State -->
                <div id="empty-properties" class="text-center py-16 hidden">
                    <div class="mb-8">
                        <i class="fas fa-heart text-6xl text-gray-300 mb-4"></i>
                        <h2 class="text-2xl font-bold text-gray-700 mb-4">Нет избранных квартир</h2>
                        <p class="text-gray-500 mb-8 max-w-md mx-auto">
                            Добавляйте квартиры в избранное из каталога недвижимости
                        </p>
                    </div>
                    
                    <div class="flex flex-col sm:flex-row gap-4 justify-center">
                        <a href="{{ url_for('properties') }}" class="inline-flex items-center px-6 py-3 bg-[#0088CC] text-white rounded-lg hover:bg-[#0077BB] transition-colors">
                            <i class="fas fa-search mr-2"></i>
                            Поиск квартир
                        </a>
                        <a href="{{ url_for('manager_dashboard') }}" class="inline-flex items-center px-6 py-3 border border-[#0088CC] text-[#0088CC] rounded-lg hover:bg-blue-50 transition-colors">
                            <i class="fas fa-tachometer-alt mr-2"></i>
                            К панели менеджера
                        </a>
                    </div>
                </div>

                <!-- Properties Grid -->
                <div id="properties-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                    <!-- Properties loading state -->
                    <div class="col-span-full text-center py-8" id="properties-loading">
                        <div class="inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-[#0088CC]"></div>
                        <p class="mt-2 text-gray-600">Загрузка избранных квартир...</p>
                    </div>
                </div>
            </div>

            <!-- Complexes Tab -->
            <div class="favorites-tab-content p-6" id="complexes-tab">
                <!-- Clear All Button -->
                <div class="mb-4 flex justify-end" id="clear-complexes-container" style="display: none;">
                    <button onclick="clearAllComplexes()" class="px-4 py-2 bg-red-500 text-white rounded-lg hover:bg-red-600 transition-colors flex items-center gap-2">
                        <i class="fas fa-trash"></i>
                        Очистить все ЖК
                    </button>
                </div>
                
                <!-- Empty State -->
                <div id="empty-complexes" class="text-center py-16 hidden">
                    <div class="mb-8">
                        <i class="fas fa-building text-6xl text-gray-300 mb-4"></i>
                        <h2 class="text-2xl font-bold text-gray-700 mb-4">Нет избранных ЖК</h2>
                        <p class="text-gray-500 mb-8 max-w-md mx-auto">
                            Добавляйте жилые комплексы в избранное из каталога
                        </p>
                    </div>
                    
                    <div class="flex flex-col sm:flex-row gap-4 justify-center">
                        <a href="{{ url_for('residential_complexes') }}" class="inline-flex items-center px-6 py-3 bg-[#0088CC] text-white rounded-lg hover:bg-[#0077BB] transition-colors">
                            <i class="fas fa-building mr-2"></i>
                            Каталог ЖК
                        </a>
                        <a href="{{ url_for('manager_dashboard') }}" class="inline-flex items-center px-6 py-3 border border-[#0088CC] text-[#0088CC] rounded-lg hover:bg-blue-50 transition-colors">
                            <i class="fas fa-tachometer-alt mr-2"></i>
                            К панели менеджера
                        </a>
                    </div>
                </div>

                <!-- Complexes Grid -->
                <div id="complexes-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                    <!-- Complexes loading state -->
                    <div class="col-span-full text-center py-8" id="complexes-loading">
                        <div class="inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-[#0088CC]"></div>
                        <p class="mt-2 text-gray-600">Загрузка избранных ЖК...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>

<script>
// ✅ FIX: Set manager authentication flag so favorites.js calls correct APIs
window.manager_authenticated = true;
console.log('✅ Manager favorites page - window.manager_authenticated set to:', window.manager_authenticated);

document.addEventListener('DOMContentLoaded', function() {
    // Tab functionality
    const tabButtons = document.querySelectorAll('.favorites-tab-button');
    const tabContents = document.querySelectorAll('.favorites-tab-content');

    tabButtons.forEach(button => {
        button.addEventListener('click', function() {
            const targetTab = this.dataset.tab;
            
            // Remove active class from all buttons and contents
            tabButtons.forEach(btn => {
                btn.classList.remove('active', 'border-[#0088CC]', 'text-[#0088CC]');
                btn.classList.add('border-transparent', 'text-gray-500');
            });
            tabContents.forEach(content => content.classList.remove('active'));
            
            // Add active class to current button and content
            this.classList.add('active', 'border-[#0088CC]', 'text-[#0088CC]');
            this.classList.remove('border-transparent', 'text-gray-500');
            document.getElementById(targetTab + '-tab').classList.add('active');
        });
    });

    // Load favorites data
    loadManagerFavorites();
    
    // Comparison system now managed by ComparisonManager in comparison.js
});

async function loadManagerFavorites() {
    try {
        // Load properties
        const propertiesResponse = await fetch('/api/manager/favorites/list', {
            credentials: 'same-origin',
            headers: {
                'Content-Type': 'application/json',
            }
        });
        const propertiesData = await propertiesResponse.json();
        // Load complexes
        const complexesResponse = await fetch('/api/manager/complexes/favorites/list', {
            credentials: 'same-origin',
            headers: {
                'Content-Type': 'application/json',
            }
        });
        const complexesData = await complexesResponse.json();
        // Use fallbacks for robustness
        const props = propertiesData.success ? (propertiesData.favorites || propertiesData.properties || propertiesData.favorite_properties || []) : [];
        const cmplx = complexesData.success ? (complexesData.complexes || complexesData.favorites || complexesData.favorite_complexes || []) : [];
        
        displayProperties(props);
        displayComplexes(cmplx);
        
        // Initialize comparison buttons from localStorage
        updateButtonsFromStorage();
        
        document.getElementById('properties-count').textContent = props.length;
        document.getElementById('complexes-count').textContent = cmplx.length;
        
        // Update total count
        const totalCount = props.length + cmplx.length;
        document.getElementById('total-favorites-badge').textContent = totalCount;
        
    } catch (error) {
        console.error('❌ Error loading manager favorites:', error);
        console.error('❌ Error stack:', error.stack);
        showError('Ошибка загрузки избранного');
    }
}

function displayProperties(properties) {
    const container = document.getElementById('properties-grid');
    const loading = document.getElementById('properties-loading');
    const empty = document.getElementById('empty-properties');
    const clearBtn = document.getElementById('clear-properties-container');
    
    loading.classList.add('hidden');
    
    if (properties.length === 0) {
        empty.classList.remove('hidden');
        container.innerHTML = '';
        if (clearBtn) clearBtn.style.display = 'none';
        return;
    }
    
    empty.classList.add('hidden');
    if (clearBtn) clearBtn.style.display = 'flex';
    container.innerHTML = properties.map(property => createPropertyCard(property)).join('');
}

function displayComplexes(complexes) {
    const container = document.getElementById('complexes-grid');
    const loading = document.getElementById('complexes-loading');
    const empty = document.getElementById('empty-complexes');
    const clearBtn = document.getElementById('clear-complexes-container');
    
    loading.classList.add('hidden');
    
    if (complexes.length === 0) {
        empty.classList.remove('hidden');
        container.innerHTML = '';
        if (clearBtn) clearBtn.style.display = 'none';
        return;
    }
    
    empty.classList.add('hidden');
    if (clearBtn) clearBtn.style.display = 'flex';
    container.innerHTML = complexes.map(complex => createComplexCard(complex)).join('');
}

function createPropertyCard(property) {
    const price = Number(property.price) || 0;
    const cashbackPercent = Number(property.cashback_percent) || 5;
    const cashback = Number(property.cashback_amount) || Math.floor(price * cashbackPercent / 100);
    
    return `
        <div class="bg-white rounded-xl shadow-lg hover:shadow-xl transition-all duration-300 overflow-hidden relative" data-property-id="${property.id}">
            <!-- Remove from favorites button -->
            <button class="absolute top-3 right-3 z-20 w-8 h-8 bg-red-500 text-white rounded-full hover:bg-red-600 transition-colors flex items-center justify-center" 
                    onclick="removeFromFavorites('${property.id}', event)" 
                    title="Удалить из избранного">
                <i class="fas fa-times text-sm"></i>
            </button>
            
            <!-- Property image -->
            <div class="h-48 bg-gray-100">
                ${property.image ? 
                    `<img src="${property.image}" alt="${property.title}" class="w-full h-48 object-cover">` :
                    `<div class="h-48 bg-gradient-to-br from-blue-100 to-blue-200 flex items-center justify-center">
                        <i class="fas fa-home text-4xl text-[#0088CC]"></i>
                    </div>`
                }
            </div>
            
            <div class="p-4">
                <h3 class="font-semibold text-lg mb-2">
                    ${property.title || 'Квартира'}
                </h3>
                <p class="text-gray-600 text-sm mb-2">
                    <i class="fas fa-map-marker-alt mr-1 text-[#0088CC]"></i>
                    ${property.district && property.district !== 'Район не указан' ? property.district : (property.address || 'Адрес не указан')}
                </p>
                <p class="text-gray-600 text-sm mb-3">
                    ${property.complex || 'ЖК не указан'}
                </p>
                
                <div class="flex justify-between items-center mb-4">
                    <div>
                        <div class="text-xl font-bold text-[#0088CC]">
                            ${price.toLocaleString('ru-RU')} ₽
                        </div>
                    </div>
                    <div class="text-right">
                        <div class="text-sm font-medium text-green-600">Кэшбек ${cashbackPercent}%</div>
                        <div class="text-sm text-gray-500">до ${cashback.toLocaleString('ru-RU')} ₽</div>
                    </div>
                </div>
                
                <div class="text-xs text-gray-500 mb-3">
                    Добавлено: ${property.created_at || 'недавно'}
                </div>
                
                <div class="flex gap-2">
                    <a href="/object/${property.id}" class="flex-1 bg-[#0088CC] text-white text-center py-2 rounded-lg hover:bg-[#0077BB] transition-colors text-sm">
                        Подробнее
                    </a>
                    <button class="compare-btn px-3 py-2 border border-gray-300 rounded-lg hover:bg-blue-50 hover:border-blue-300 transition-colors" 
                            data-property-id="${property.id}" title="Сравнить">
                        <i class="fas fa-balance-scale text-sm"></i>
                    </button>
                    <button onclick="shareProperty('${property.id}')" class="px-3 py-2 border border-gray-300 rounded-lg hover:bg-gray-50 transition-colors" title="Поделиться">
                        <i class="fas fa-share-alt text-sm"></i>
                    </button>
                </div>
            </div>
        </div>
    `;
}

function createComplexCard(complex) {
    // API returns name, developer, address, image, district
    const name = complex.name || complex.complex_name || 'Жилой комплекс';
    const developer = complex.developer || complex.developer_name || 'Застройщик не указан';
    const address = complex.address || complex.complex_address || 'Адрес не указан';
    const district = complex.district || 'Район не указан';
    const image = complex.image || complex.complex_image;
    const url = complex.url || complex.complex_url || '/residential-complexes';
    const addedAt = complex.created_at || complex.added_at || 'недавно';
    
    return `
        <div class="bg-white rounded-xl shadow-lg hover:shadow-xl transition-all duration-300 overflow-hidden relative" data-complex-id="${complex.id}">
            <!-- Remove from favorites button -->
            <button class="absolute top-3 right-3 z-20 w-8 h-8 bg-red-500 text-white rounded-full hover:bg-red-600 transition-colors flex items-center justify-center" 
                    onclick="removeComplexFromFavorites('${complex.id}', event)" 
                    title="Удалить из избранного">
                <i class="fas fa-times text-sm"></i>
            </button>
            
            <!-- Complex image -->
            <div class="h-48 bg-gray-100">
                ${image ? 
                    `<img src="${image}" alt="${name}" class="w-full h-48 object-cover">` :
                    `<div class="h-48 bg-gradient-to-br from-purple-100 to-purple-200 flex items-center justify-center">
                        <i class="fas fa-building text-4xl text-purple-600"></i>
                    </div>`
                }
            </div>
            
            <div class="p-4">
                <h3 class="font-semibold text-lg mb-2">
                    ${name}
                </h3>
                <p class="text-gray-600 text-sm mb-2">
                    <i class="fas fa-map-marker-alt mr-1 text-[#0088CC]"></i>
                    ${district}
                </p>
                <p class="text-gray-600 text-sm mb-2">
                    <i class="fas fa-hammer mr-1 text-[#0088CC]"></i>
                    ${developer}
                </p>
                <p class="text-gray-600 text-sm mb-3">
                    <i class="fas fa-map-marker mr-1 text-[#0088CC]"></i>
                    ${address}
                </p>
                
                ${complex.min_price || complex.max_price ? `
                <div class="mb-4">
                    <div class="text-lg font-bold text-[#0088CC]">
                        ${complex.min_price ? `от ${parseInt(complex.min_price).toLocaleString('ru-RU')} ₽` : ''}
                        ${complex.max_price && complex.min_price ? ` до ${parseInt(complex.max_price).toLocaleString('ru-RU')} ₽` : ''}
                    </div>
                    <div class="text-sm text-gray-500">Кэшбек: ${complex.cashback_rate || 5}%</div>
                </div>
                ` : ''}
                
                <div class="text-xs text-gray-500 mb-3">
                    Добавлено: ${addedAt}
                </div>
                
                <div class="flex gap-2">
                    <a href="${url}" class="flex-1 bg-[#0088CC] text-white text-center py-2 rounded-lg hover:bg-[#0077BB] transition-colors text-sm">
                        Подробнее
                    </a>
                    <button class="complex-compare-btn px-3 py-2 border border-gray-300 rounded-lg hover:bg-blue-50 hover:border-blue-300 transition-colors" 
                            data-complex-id="${complex.id}" title="Сравнить ЖК">
                        <i class="fas fa-balance-scale text-sm"></i>
                    </button>
                    <button onclick="shareComplex('${complex.id}')" class="px-3 py-2 border border-gray-300 rounded-lg hover:bg-gray-50 transition-colors" title="Поделиться">
                        <i class="fas fa-share-alt text-sm"></i>
                    </button>
                </div>
            </div>
        </div>
    `;
}

async function removeFromFavorites(propertyId, event) {
    // Stop event propagation to prevent duplicate handling
    if (event) {
        event.stopPropagation();
        event.preventDefault();
    }
    
    if (!confirm('Удалить объект из избранного?')) return;
    
    try {
        const response = await fetch(`/api/manager/favorites/${propertyId}`, {
            method: 'DELETE',
            credentials: 'same-origin',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCsrfToken()
            }
        });
        
        const result = await response.json();
        if (result.success) {
            // Remove card from DOM immediately
            const card = document.querySelector(`[data-property-id="${propertyId}"]`);
            if (card) {
                card.style.transition = 'opacity 0.3s, transform 0.3s';
                card.style.opacity = '0';
                card.style.transform = 'scale(0.95)';
                setTimeout(() => {
                    card.remove();
                    
                    // Check if grid is now empty
                    const propertiesGrid = document.getElementById('properties-grid');
                    if (propertiesGrid && propertiesGrid.children.length === 0) {
                        document.getElementById('empty-properties').classList.remove('hidden');
                    }
                }, 300);
            } else {
                console.warn('Card not found for property ID:', propertyId);
            }
            
            // Update counts
            const propertiesCount = document.getElementById('properties-count');
            const totalBadge = document.getElementById('total-favorites-badge');
            if (propertiesCount) propertiesCount.textContent = Math.max(0, parseInt(propertiesCount.textContent) - 1);
            if (totalBadge) totalBadge.textContent = Math.max(0, parseInt(totalBadge.textContent) - 1);
            
            showSuccess('Объект удален из избранного');
        } else {
            showError(result.error || 'Ошибка удаления из избранного');
        }
    } catch (error) {
        console.error('Error removing from favorites:', error);
        showError('Ошибка удаления из избранного');
    }
}

async function removeComplexFromFavorites(complexId, event) {
    // Stop event propagation to prevent duplicate handling
    if (event) {
        event.stopPropagation();
        event.preventDefault();
    }
    
    if (!confirm('Удалить ЖК из избранного?')) return;
    
    try {
        const response = await fetch(`/api/manager/complexes/favorites/${complexId}`, {
            method: 'DELETE',
            credentials: 'same-origin',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCsrfToken()
            }
        });
        
        const result = await response.json();
        if (result.success) {
            // Remove card from DOM immediately
            const card = document.querySelector(`[data-complex-id="${complexId}"]`);
            if (card) {
                card.style.transition = 'opacity 0.3s, transform 0.3s';
                card.style.opacity = '0';
                card.style.transform = 'scale(0.95)';
                setTimeout(() => {
                    card.remove();
                    
                    // Check if grid is now empty
                    const complexesGrid = document.getElementById('complexes-grid');
                    if (complexesGrid && complexesGrid.children.length === 0) {
                        document.getElementById('empty-complexes').classList.remove('hidden');
                    }
                }, 300);
            } else {
                console.warn('Card not found for complex ID:', complexId);
            }
            
            // Update counts
            const complexesCount = document.getElementById('complexes-count');
            const totalBadge = document.getElementById('total-favorites-badge');
            if (complexesCount) complexesCount.textContent = Math.max(0, parseInt(complexesCount.textContent) - 1);
            if (totalBadge) totalBadge.textContent = Math.max(0, parseInt(totalBadge.textContent) - 1);
            
            showSuccess('ЖК удален из избранного');
        } else {
            showError(result.error || 'Ошибка удаления из избранного');
        }
    } catch (error) {
        console.error('Error removing complex from favorites:', error);
        showError('Ошибка удаления из избранного');
    }
}

function shareProperty(propertyId) {
    const url = `${window.location.origin}/object/${propertyId}`;
    if (navigator.share) {
        navigator.share({
            title: 'Квартира с кэшбеком на InBack.ru',
            url: url
        });
    } else {
        navigator.clipboard.writeText(url).then(() => {
            showSuccess('Ссылка скопирована в буфер обмена');
        });
    }
}

function shareComplex(complexId) {
    const url = `${window.location.origin}/residential-complex/${complexId}`;
    if (navigator.share) {
        navigator.share({
            title: 'Жилой комплекс на InBack.ru',
            url: url
        });
    } else {
        navigator.clipboard.writeText(url).then(() => {
            showSuccess('Ссылка скопирована в буфер обмена');
        });
    }
}

function getCsrfToken() {
    return document.querySelector('meta[name=csrf-token]')?.getAttribute('content') || '';
}

function showSuccess(message) {
    // Simple success notification
    const notification = document.createElement('div');
    notification.className = 'fixed top-4 right-4 bg-green-500 text-white px-6 py-3 rounded-lg shadow-lg z-50';
    notification.textContent = message;
    document.body.appendChild(notification);
    
    setTimeout(() => {
        notification.remove();
    }, 3000);
}

function showError(message) {
    // Simple error notification
    const notification = document.createElement('div');
    notification.className = 'fixed top-4 right-4 bg-red-500 text-white px-6 py-3 rounded-lg shadow-lg z-50';
    notification.textContent = message;
    document.body.appendChild(notification);
    
    setTimeout(() => {
        notification.remove();
    }, 5000);
}

// Manager comparison is now handled by ComparisonManager in comparison.js
// Removed duplicate comparison logic to avoid conflicts with the centralized system

function updateButtonsFromStorage() {
    // Initialize property comparison buttons
    const propertyComparisons = JSON.parse(localStorage.getItem('comparisons') || '[]');
    document.querySelectorAll('.compare-btn').forEach(button => {
        const propertyId = button.dataset.propertyId;
        if (propertyComparisons.includes(propertyId)) {
            button.classList.add('bg-blue-100', 'border-blue-300', 'text-blue-600');
            button.classList.remove('border-gray-300', 'text-gray-600');
        }
    });
    
    // Initialize complex comparison buttons
    const complexComparisons = JSON.parse(localStorage.getItem('comparison_complexes') || '[]');
    document.querySelectorAll('.complex-compare-btn').forEach(button => {
        const complexId = button.dataset.complexId;
        if (complexComparisons.includes(complexId)) {
            button.classList.add('bg-blue-100', 'border-blue-300', 'text-blue-600');
            button.classList.remove('border-gray-300', 'text-gray-600');
        }
    });
    
    // Show floating compare link if needed
    if (propertyComparisons.length >= 2) {
        showComparisonLink('properties', propertyComparisons.length);
    } else if (complexComparisons.length >= 2) {
        showComparisonLink('complexes', complexComparisons.length);
    } else {
        hideComparisonLink();
    }
}

// Missing comparison link functions that were referenced but not defined
function showComparisonLink(type, count) {
    // Create or update floating comparison link
    let floatingLink = document.getElementById('floating-comparison-link');
    
    if (!floatingLink) {
        floatingLink = document.createElement('div');
        floatingLink.id = 'floating-comparison-link';
        floatingLink.className = 'fixed bottom-6 right-6 z-50';
        document.body.appendChild(floatingLink);
    }
    
    const linkUrl = type === 'properties' ? '/manager/property-comparison' : '/manager/complex-comparison';
    const linkText = type === 'properties' ? 'Сравнить квартиры' : 'Сравнить ЖК';
    
    floatingLink.innerHTML = `
        <a href="${linkUrl}" class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-3 rounded-full shadow-lg flex items-center space-x-2 transition-all">
            <span class="bg-blue-500 text-white rounded-full w-6 h-6 flex items-center justify-center text-sm font-bold">${count}</span>
            <span>${linkText}</span>
        </a>
    `;
    
    floatingLink.style.display = 'block';
}

function hideComparisonLink() {
    // Hide floating comparison link
    const floatingLink = document.getElementById('floating-comparison-link');
    if (floatingLink) {
        floatingLink.style.display = 'none';
    }
}

async function clearAllProperties() {
    if (!confirm('Удалить все квартиры из избранного? Это действие нельзя отменить.')) return;
    
    try {
        const response = await fetch('/api/manager/favorites/clear', {
            method: 'DELETE',
            credentials: 'same-origin',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCsrfToken()
            }
        });
        
        const result = await response.json();
        if (result.success) {
            // Clear properties grid
            document.getElementById('properties-grid').innerHTML = '';
            document.getElementById('empty-properties').classList.remove('hidden');
            document.getElementById('clear-properties-container').style.display = 'none';
            
            // Update counts
            document.getElementById('properties-count').textContent = '0';
            const complexCount = parseInt(document.getElementById('complexes-count').textContent) || 0;
            document.getElementById('total-favorites-badge').textContent = complexCount;
            
            showSuccess('Все квартиры удалены из избранного');
        } else {
            showError(result.error || 'Ошибка очистки избранного');
        }
    } catch (error) {
        console.error('Error clearing all properties:', error);
        showError('Ошибка очистки избранного');
    }
}

async function clearAllComplexes() {
    if (!confirm('Удалить все ЖК из избранного? Это действие нельзя отменить.')) return;
    
    try {
        const response = await fetch('/api/manager/complexes/favorites/clear', {
            method: 'DELETE',
            credentials: 'same-origin',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCsrfToken()
            }
        });
        
        const result = await response.json();
        if (result.success) {
            // Clear complexes grid
            document.getElementById('complexes-grid').innerHTML = '';
            document.getElementById('empty-complexes').classList.remove('hidden');
            document.getElementById('clear-complexes-container').style.display = 'none';
            
            // Update counts
            document.getElementById('complexes-count').textContent = '0';
            const propCount = parseInt(document.getElementById('properties-count').textContent) || 0;
            document.getElementById('total-favorites-badge').textContent = propCount;
            
            showSuccess('Все ЖК удалены из избранного');
        } else {
            showError(result.error || 'Ошибка очистки избранного');
        }
    } catch (error) {
        console.error('Error clearing all complexes:', error);
        showError('Ошибка очистки избранного');
    }
}
</script>

<style>
/* Tab styling */
.favorites-tab-content {
    display: none;
}

.favorites-tab-content.active {
    display: block;
}

.favorites-tab-button.active {
    color: #0088CC !important;
    border-color: #0088CC !important;
}

.favorites-counter {
    position: relative;
    display: inline-block;
}

.favorites-counter .badge {
    position: absolute;
    top: -8px;
    right: -8px;
    background: #dc2626;
    color: white;
    border-radius: 12px;
    padding: 4px 8px;
    font-size: 12px;
    font-weight: bold;
    min-width: 20px;
    text-align: center;
    line-height: 1;
}

.favorites-counter .badge.show {
    display: block;
}
</style>
{% endblock %}