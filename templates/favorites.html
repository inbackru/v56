{% extends "base.html" %}

{% block title %}–ò–∑–±—Ä–∞–Ω–Ω—ã–µ –æ–±—ä–µ–∫—Ç—ã - InBack.ru{% endblock %}

{% block description %}–í–∞—à–∏ –∏–∑–±—Ä–∞–Ω–Ω—ã–µ –æ–±—ä–µ–∫—Ç—ã –Ω–µ–¥–≤–∏–∂–∏–º–æ—Å—Ç–∏ –≤ –ö—Ä–∞—Å–Ω–æ–¥–∞—Ä–µ. –°–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–µ –∫–≤–∞—Ä—Ç–∏—Ä—ã –∏ –∞–ø–∞—Ä—Ç–∞–º–µ–Ω—Ç—ã —Å –∫—ç—à–±–µ–∫–æ–º.{% endblock %}

{% block content %}
<div class="bg-gradient-to-r from-[#0088CC] to-[#006699] text-white py-16">
    <div class="container mx-auto px-4 text-center">
        <div class="flex items-center justify-center gap-3 mb-4">
            <div class="favorites-counter">
                <i class="fas fa-heart text-4xl"></i>
                <div class="badge show">0</div>
            </div>
        </div>
        <h1 class="text-4xl font-bold mb-4">–ò–∑–±—Ä–∞–Ω–Ω—ã–µ –æ–±—ä–µ–∫—Ç—ã</h1>
        <p class="text-xl text-blue-100 max-w-2xl mx-auto">
            –ó–¥–µ—Å—å —Å–æ–±—Ä–∞–Ω—ã –≤—Å–µ –∫–≤–∞—Ä—Ç–∏—Ä—ã, –∫–æ—Ç–æ—Ä—ã–µ –≤—ã –¥–æ–±–∞–≤–∏–ª–∏ –≤ –∏–∑–±—Ä–∞–Ω–Ω–æ–µ. –°—Ä–∞–≤–Ω–∏–≤–∞–π—Ç–µ, –∞–Ω–∞–ª–∏–∑–∏—Ä—É–π—Ç–µ –∏ –≤—ã–±–∏—Ä–∞–π—Ç–µ –ª—É—á—à–∏–π –≤–∞—Ä–∏–∞–Ω—Ç –¥–ª—è –ø–æ–∫—É–ø–∫–∏.
        </p>
    </div>
</div>

<section class="py-16 bg-gray-50">
    <div class="container mx-auto px-4">
        <!-- Empty State -->
        <div id="empty-favorites" class="text-center py-16">
            <div class="mb-8">
                <i class="fas fa-heart text-6xl text-gray-300 mb-4"></i>
                <h2 class="text-2xl font-bold text-gray-700 mb-4">–£ –≤–∞—Å –ø–æ–∫–∞ –Ω–µ—Ç –∏–∑–±—Ä–∞–Ω–Ω—ã—Ö –æ–±—ä–µ–∫—Ç–æ–≤</h2>
                <p class="text-gray-500 mb-8 max-w-md mx-auto">
                    –î–æ–±–∞–≤–ª—è–π—Ç–µ –ø–æ–Ω—Ä–∞–≤–∏–≤—à–∏–µ—Å—è –∫–≤–∞—Ä—Ç–∏—Ä—ã –≤ –∏–∑–±—Ä–∞–Ω–Ω–æ–µ, –Ω–∞–∂–∏–º–∞—è –Ω–∞ —Å–µ—Ä–¥–µ—á–∫–æ –≤ –∫–∞—Ä—Ç–æ—á–∫–µ –æ–±—ä–µ–∫—Ç–∞
                </p>
            </div>
            
            <div class="flex flex-col sm:flex-row gap-4 justify-center">
                <a href="{{ url_for('properties') }}" class="inline-flex items-center px-6 py-3 bg-[#0088CC] text-white rounded-lg hover:bg-[#0077BB] transition-colors">
                    <i class="fas fa-search mr-2"></i>
                    –ü–æ–∏—Å–∫ –∫–≤–∞—Ä—Ç–∏—Ä
                </a>
                <a href="{{ url_for('districts') }}" class="inline-flex items-center px-6 py-3 border border-[#0088CC] text-[#0088CC] rounded-lg hover:bg-blue-50 transition-colors">
                    <i class="fas fa-map-marker-alt mr-2"></i>
                    –í—ã–±—Ä–∞—Ç—å —Ä–∞–π–æ–Ω
                </a>
            </div>

            <!-- Pulse Animation Tutorial -->
            <div class="mt-12 p-6 bg-white rounded-xl shadow-md max-w-lg mx-auto">
                <h3 class="font-semibold mb-4 flex items-center justify-center gap-2">
                    <span>–ö–∞–∫ –¥–æ–±–∞–≤–∏—Ç—å –≤ –∏–∑–±—Ä–∞–Ω–Ω–æ–µ?</span>
                </h3>
                <div class="flex items-center justify-center gap-4 mb-4">
                    <div class="text-center">
                        <div class="w-16 h-16 bg-gray-100 rounded-lg flex items-center justify-center mb-2">
                            <i class="fas fa-home text-2xl text-gray-400"></i>
                        </div>
                        <p class="text-sm text-gray-600">–ù–∞–π–¥–∏—Ç–µ –∫–≤–∞—Ä—Ç–∏—Ä—É</p>
                    </div>
                    <i class="fas fa-arrow-right text-gray-400"></i>
                    <div class="text-center">
                        <div class="w-16 h-16 bg-gray-100 rounded-lg flex items-center justify-center mb-2">
                            <div class="favorite-heart pulse">
                                <i class="fas fa-heart"></i>
                            </div>
                        </div>
                        <p class="text-sm text-gray-600">–ù–∞–∂–º–∏—Ç–µ –Ω–∞ —Å–µ—Ä–¥–µ—á–∫–æ</p>
                    </div>
                    <i class="fas fa-arrow-right text-gray-400"></i>
                    <div class="text-center">
                        <div class="w-16 h-16 bg-gray-100 rounded-lg flex items-center justify-center mb-2">
                            <div class="favorite-heart favorited">
                                <i class="fas fa-heart"></i>
                            </div>
                        </div>
                        <p class="text-sm text-gray-600">–ì–æ—Ç–æ–≤–æ!</p>
                    </div>
                </div>
                <p class="text-xs text-gray-500">
                    –°–µ—Ä–¥–µ—á–∫–æ —Å—Ç–∞–Ω–µ—Ç –∫—Ä–∞—Å–Ω—ã–º –∏ –±—É–¥–µ—Ç –ø—É–ª—å—Å–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–∏ –Ω–∞–≤–µ–¥–µ–Ω–∏–∏ –∫—É—Ä—Å–æ—Ä–∞ –Ω–∞ –∫–∞—Ä—Ç–æ—á–∫—É
                </p>
            </div>
        </div>

        <!-- Favorites Grid -->
        <div id="favorites-grid" class="hidden">
            <div class="flex justify-between items-center mb-8">
                <h2 class="text-2xl font-bold flex items-center gap-2">
                    <i class="fas fa-heart text-red-500"></i>
                    –ò–∑–±—Ä–∞–Ω–Ω—ã–µ –æ–±—ä–µ–∫—Ç—ã
                    <span class="bg-red-500 text-white px-3 py-1 rounded-full text-sm font-medium ml-2" id="favorites-count">0</span>
                </h2>
                
                <div class="flex gap-3">
                    <button onclick="compareSelectedProperties()" id="compare-btn" class="hidden px-4 py-2 bg-green-500 text-white rounded-lg hover:bg-green-600 transition-colors">
                        <i class="fas fa-balance-scale mr-2"></i>
                        –°—Ä–∞–≤–Ω–∏—Ç—å (<span id="selected-count">0</span>)
                    </button>
                    <button onclick="clearAllFavorites()" class="px-4 py-2 border border-red-500 text-red-500 rounded-lg hover:bg-red-50 transition-colors">
                        <i class="fas fa-trash mr-2"></i>
                        –û—á–∏—Å—Ç–∏—Ç—å –≤—Å–µ
                    </button>
                </div>
            </div>

            <!-- Properties Container -->
            <div id="favorites-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                <!-- Property cards will be inserted here by JavaScript -->
            </div>

            <!-- Comparison Panel (Hidden by default) -->
            <div id="comparison-panel" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
                <div class="bg-white rounded-xl shadow-2xl max-w-6xl w-full max-h-[90vh] overflow-y-auto">
                    <div class="flex justify-between items-center p-6 border-b">
                        <h3 class="text-xl font-bold">–°—Ä–∞–≤–Ω–µ–Ω–∏–µ –æ–±—ä–µ–∫—Ç–æ–≤</h3>
                        <button onclick="closeComparison()" class="text-gray-500 hover:text-gray-700">
                            <i class="fas fa-times text-xl"></i>
                        </button>
                    </div>
                    <div id="comparison-content" class="p-6">
                        <!-- Comparison content will be inserted here -->
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>

<script>
// ‚úÖ –ù–û–í–ê–Ø –ü–†–û–°–¢–ê–Ø –°–ò–°–¢–ï–ú–ê: 2 —Ñ—É–Ω–∫—Ü–∏–∏ –¥–ª—è –Ω–æ—Ä–º–∞–ª—å–Ω–æ–≥–æ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –∏–∑–±—Ä–∞–Ω–Ω–æ–≥–æ
document.addEventListener('DOMContentLoaded', function() {
    loadFavoritesFromAPI();
});

// ‚úÖ –§–£–ù–ö–¶–ò–Ø 1: –ü—Ä–æ—Å—Ç–∞—è –∑–∞–≥—Ä—É–∑–∫–∞ –∏–∑–±—Ä–∞–Ω–Ω–æ–≥–æ –∏–∑ API
async function loadFavoritesFromAPI() {
    console.log('üî• –ó–∞–≥—Ä—É–∂–∞–µ–º –∏–∑–±—Ä–∞–Ω–Ω–æ–µ –∏–∑ API...');
    
    try {
        const response = await fetch('/api/favorites/list');
        const data = await response.json();
        
        console.log('üì¶ –ü–æ–ª—É—á–µ–Ω—ã –¥–∞–Ω–Ω—ã–µ:', data);
        
        if (data.success && data.favorites && data.favorites.length > 0) {
            renderFavoriteCards(data.favorites);
        } else {
            showEmptyState();
        }
    } catch (error) {
        console.error('‚ùå –û—à–∏–±–∫–∞:', error);
        showEmptyState();
    }
}

// ‚úÖ –§–£–ù–ö–¶–ò–Ø 2: –ü—Ä–æ—Å—Ç–æ–µ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∫–∞—Ä—Ç–æ—á–µ–∫ –∏–∑–±—Ä–∞–Ω–Ω–æ–≥–æ
function renderFavoriteCards(favorites) {
    console.log('üé® –û—Ç–æ–±—Ä–∞–∂–∞–µ–º –∫–∞—Ä—Ç–æ—á–∫–∏:', favorites.length);
    
    const emptyState = document.getElementById('empty-favorites');
    const favoritesGrid = document.getElementById('favorites-grid');
    const favoritesContainer = document.getElementById('favorites-container');
    const favoritesCount = document.getElementById('favorites-count');
    
    // –°–∫—Ä—ã–≤–∞–µ–º –ø—É—Å—Ç–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–µ—Ç–∫—É
    emptyState.classList.add('hidden');
    favoritesGrid.classList.remove('hidden');
    favoritesCount.textContent = favorites.length;
    
    // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º HTML –∫–∞—Ä—Ç–æ—á–µ–∫
    const cardsHTML = favorites.map(property => `
        <div class="bg-white rounded-xl shadow-lg hover:shadow-xl transition-all duration-300 overflow-hidden">
            <div class="relative">
                <img src="${property.image}" alt="${property.title}" class="w-full h-48 object-cover">
                <button onclick="removeFavorite('${property.id}')" 
                        class="absolute top-3 right-3 w-10 h-10 bg-red-500 text-white rounded-full hover:bg-red-600 transition-colors flex items-center justify-center">
                    <i class="fas fa-heart"></i>
                </button>
            </div>
            <div class="p-6">
                <h3 class="text-lg font-semibold mb-2 text-gray-800">${property.title}</h3>
                <p class="text-sm text-gray-600 mb-2">üìç ${property.district}</p>
                <p class="text-sm text-gray-600 mb-3">üè¢ ${property.complex}</p>
                <div class="flex justify-between items-center mb-3">
                    <div class="text-xl font-bold text-blue-600">${property.price.toLocaleString()} ‚ÇΩ</div>
                    <div class="text-sm text-green-600 font-medium">üí∞ ${property.cashback_amount.toLocaleString()} ‚ÇΩ</div>
                </div>
                <div class="text-xs text-gray-500">–î–æ–±–∞–≤–ª–µ–Ω–æ: ${property.created_at}</div>
            </div>
        </div>
    `).join('');
    
    favoritesContainer.innerHTML = cardsHTML;
    console.log('‚úÖ –ö–∞—Ä—Ç–æ—á–∫–∏ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω—ã —É—Å–ø–µ—à–Ω–æ!');
}

// ‚úÖ –í–°–ü–û–ú–û–ì–ê–¢–ï–õ–¨–ù–ê–Ø –§–£–ù–ö–¶–ò–Ø: –ü–æ–∫–∞–∑–∞—Ç—å –ø—É—Å—Ç–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ
function showEmptyState() {
    console.log('üì≠ –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø—É—Å—Ç–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ');
    
    const emptyState = document.getElementById('empty-favorites');
    const favoritesGrid = document.getElementById('favorites-grid');
    
    emptyState.classList.remove('hidden');
    favoritesGrid.classList.add('hidden');
}

// ‚úÖ –í–ï–°–¨ –°–¢–ê–†–´–ô –ö–û–î –£–î–ê–õ–ï–ù - –∏—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è —Ç–æ–ª—å–∫–æ 2 –Ω–æ–≤—ã–µ –ø—Ä–æ—Å—Ç—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ –≤—ã—à–µ
</script>
{% endblock %}
    return `
        <div class="property-card bg-white rounded-xl shadow-lg hover:shadow-xl transition-all duration-300 overflow-hidden relative">
            <!-- Favorite Heart (always favorited on this page) -->
            <div class="favorite-heart favorited" data-property-id="${property.id}" title="–£–¥–∞–ª–∏—Ç—å –∏–∑ –∏–∑–±—Ä–∞–Ω–Ω–æ–≥–æ">
                <i class="fas fa-heart"></i>
            </div>
            
            <!-- Comparison Checkbox -->
            <div class="absolute top-3 left-3 z-20">
                <label class="flex items-center cursor-pointer">
                    <input type="checkbox" class="comparison-checkbox sr-only" data-property-id="${property.id}" onchange="updateComparisonButton()">
                    <div class="w-6 h-6 bg-white border-2 border-gray-300 rounded flex items-center justify-center transition-colors hover:border-blue-500">
                        <i class="fas fa-check text-[#0088CC] text-xs hidden"></i>
                    </div>
                </label>
            </div>
            
            <img src="${property.image}" alt="${property.title}" class="w-full h-48 object-cover">
            
            <div class="p-4">
                <h3 class="font-semibold text-lg mb-2">${property.title}, ${property.area} –º¬≤</h3>
                <p class="text-gray-600 text-sm mb-2">
                    <i class="fas fa-map-marker-alt mr-1 text-[#0088CC]"></i>
                    ${property.district}, ${property.complex_name}
                </p>
                <p class="text-gray-600 text-sm mb-3">${property.floor}/${property.total_floors} —ç—Ç–∞–∂</p>
                
                <div class="flex justify-between items-center mb-4">
                    <div>
                        <div class="text-xl font-bold text-[#0088CC]">
                            ${property.price.toLocaleString('ru-RU')} ‚ÇΩ
                        </div>
                        <div class="text-sm text-gray-500">
                            ${pricePerSqm.toLocaleString('ru-RU')} ‚ÇΩ/–º¬≤
                        </div>
                    </div>
                    <div class="text-right">
                        <div class="text-sm font-medium text-green-600">–ö—ç—à–±–µ–∫ 5%</div>
                        <div class="text-sm text-gray-500">–¥–æ ${Math.floor(property.price * 0.05).toLocaleString('ru-RU')} ‚ÇΩ</div>
                    </div>
                </div>
                
                <div class="flex gap-2">
                    <a href="/object/${property.id}" class="flex-1 bg-[#0088CC] text-white text-center py-2 rounded-lg hover:bg-[#0077BB] transition-colors text-sm">
                        –ü–æ–¥—Ä–æ–±–Ω–µ–µ
                    </a>
                    <button onclick="shareProperty(${property.id})" class="px-3 py-2 border border-gray-300 rounded-lg hover:bg-gray-50 transition-colors" title="–ü–æ–¥–µ–ª–∏—Ç—å—Å—è">
                        <i class="fas fa-share-alt text-sm"></i>
                    </button>
                </div>
            </div>
        </div>
    `;
}

function updateComparisonButton() {
    const selected = document.querySelectorAll('.comparison-checkbox:checked');
    const compareBtn = document.getElementById('compare-btn');
    const selectedCount = document.getElementById('selected-count');
    
    selectedCount.textContent = selected.length;
    
    if (selected.length >= 2) {
        compareBtn.classList.remove('hidden');
    } else {
        compareBtn.classList.add('hidden');
    }
}

function clearAllFavorites() {
    if (confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å –≤—Å–µ –∏–∑–±—Ä–∞–Ω–Ω—ã–µ –æ–±—ä–µ–∫—Ç—ã?')) {
        if (window.favoritesManager) {
            window.favoritesManager.clearAllFavorites();
        }
        loadFavoritesPage();
    }
}

function shareProperty(propertyId) {
    const url = `${window.location.origin}/object/${propertyId}`;
    if (navigator.share) {
        navigator.share({
            title: '–ö–≤–∞—Ä—Ç–∏—Ä–∞ —Å –∫—ç—à–±–µ–∫–æ–º –Ω–∞ InBack.ru',
            url: url
        });
    } else {
        navigator.clipboard.writeText(url).then(() => {
            window.favoritesManager?.showNotification('–°—Å—ã–ª–∫–∞ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∞ –≤ –±—É—Ñ–µ—Ä –æ–±–º–µ–Ω–∞', 'success');
        });
    }
}

// Comparison functionality
function compareSelectedProperties() {
    const selected = Array.from(document.querySelectorAll('.comparison-checkbox:checked'))
                          .map(cb => cb.dataset.propertyId);
    
    if (selected.length < 2) {
        alert('–í—ã–±–µ—Ä–∏—Ç–µ –º–∏–Ω–∏–º—É–º 2 –æ–±—ä–µ–∫—Ç–∞ –¥–ª—è —Å—Ä–∞–≤–Ω–µ–Ω–∏—è');
        return;
    }
    
    // Show comparison panel
    document.getElementById('comparison-panel').classList.remove('hidden');
    // Add comparison logic here
}

function closeComparison() {
    document.getElementById('comparison-panel').classList.add('hidden');
}
</script>

<style>
/* Custom checkbox styles */
.comparison-checkbox:checked + div {
    background-color: #3b82f6;
    border-color: #3b82f6;
}

.comparison-checkbox:checked + div i {
    display: block !important;
}

/* Favorite heart positioning for favorites page */
.property-card .favorite-heart {
    top: 12px;
    right: 12px;
}
</style>
{% endblock %}