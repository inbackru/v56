{% extends "base.html" %}

{% block title %}Личный кабинет | InBack{% endblock %}

{% block head %}
<meta name="csrf-token" content="{{ csrf_token() if csrf_token else 'no-token' }}">
{% endblock %}

{% block content %}
<style>
.content-section {
    display: none;
}

.content-section.active {
    display: block;
}

.tab-button.active {
    color: #0088CC !important;
    border-color: #0088CC !important;
}

.tab-button:hover {
    color: #374151 !important;
    border-color: #D1D5DB !important;
}

/* Минималистичные ползунки для калькулятора кешбека */
.slider-blue {
    background: linear-gradient(to right, #0088CC 0%, #0088CC var(--slider-progress, 0%), #e5e7eb var(--slider-progress, 0%), #e5e7eb 100%);
}

.slider-blue::-webkit-slider-thumb {
    appearance: none;
    width: 18px;
    height: 18px;
    border-radius: 50%;
    background: #ffffff;
    border: 2px solid #0088CC;
    cursor: pointer;
    box-shadow: 0 2px 4px rgba(0, 136, 204, 0.3);
    transition: all 0.2s ease;
}

.slider-blue::-webkit-slider-thumb:hover {
    transform: scale(1.1);
    box-shadow: 0 4px 8px rgba(0, 136, 204, 0.4);
}

.slider-blue::-moz-range-thumb {
    width: 18px;
    height: 18px;
    border: 2px solid #0088CC;
    border-radius: 50%;
    background: #ffffff;
    cursor: pointer;
    box-shadow: 0 2px 4px rgba(0, 136, 204, 0.3);
    transition: all 0.2s ease;
}

.slider-blue::-moz-range-thumb:hover {
    transform: scale(1.1);
    box-shadow: 0 4px 8px rgba(0, 136, 204, 0.4);
}

.slider-blue::-moz-range-track {
    background: #e5e7eb;
    height: 8px;
    border-radius: 4px;
}

/* Стильные ползунки для калькулятора кешбека */
.slider {
    -webkit-appearance: none;
    background: transparent;
    cursor: pointer;
}

.slider::-webkit-slider-track {
    width: 100%;
    height: 12px;
    cursor: pointer;
    background: rgba(255, 255, 255, 0.2);
    border-radius: 6px;
}

.slider::-webkit-slider-thumb {
    height: 20px;
    width: 20px;
    border-radius: 50%;
    background: #ffffff;
    cursor: pointer;
    -webkit-appearance: none;
    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
    border: 2px solid #4F8EF7;
    transition: all 0.2s ease;
}

.slider::-webkit-slider-thumb:hover {
    transform: scale(1.1);
    box-shadow: 0 6px 12px rgba(0, 0, 0, 0.3);
}

.slider::-moz-range-track {
    width: 100%;
    height: 12px;
    cursor: pointer;
    background: rgba(255, 255, 255, 0.2);
    border-radius: 6px;
    border: none;
}

.slider::-moz-range-thumb {
    height: 20px;
    width: 20px;
    border-radius: 50%;
    background: #ffffff;
    cursor: pointer;
    border: 2px solid #4F8EF7;
    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
    transition: all 0.2s ease;
}

.slider::-moz-range-thumb:hover {
    transform: scale(1.1);
    box-shadow: 0 6px 12px rgba(0, 0, 0, 0.3);
}

.slider:focus {
    outline: none;
}

.slider:focus::-webkit-slider-thumb {
    box-shadow: 0 0 0 3px rgba(79, 142, 247, 0.3);
}

/* Стили для фильтров сделок */
.deals-filter-btn {
    background: #f3f4f6;
    color: #6b7280;
    border: 1px solid transparent;
}

.deals-filter-btn:hover {
    background: #e5e7eb;
    color: #374151;
}

.deals-filter-btn.active {
    background: #0088CC;
    color: white;
    border-color: #0088CC;
}

/* Стили для карточек сделок */
.deal-card {
    transition: all 0.2s ease;
}

.deal-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
}

.status-badge {
    display: inline-flex;
    align-items: center;
    font-size: 0.75rem;
    font-weight: 500;
    padding: 0.25rem 0.75rem;
    border-radius: 9999px;
}

.status-new { background: #dbeafe; color: #1d4ed8; }
.status-reserved { background: #fef3c7; color: #d97706; }
.status-mortgage { background: #fed7aa; color: #ea580c; }
.status-completed { background: #dcfce7; color: #16a34a; }
.status-rejected { background: #fee2e2; color: #dc2626; }
</style>

<!-- Tab Navigation under main header -->
<div class="bg-white border-b border-gray-200">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
        <div class="overflow-x-auto">
            <nav class="flex space-x-8" aria-label="Tabs">
                <a class="flex items-center px-1 py-4 text-sm font-medium border-b-2 border-[#0088CC] text-[#0088CC] whitespace-nowrap tab-button active" href="#" data-page="dashboard">
                    <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20">
                        <path d="M10 2L3 7v11h3v-6h8v6h3V7l-7-5z"/>
                    </svg>
                    Главная
                </a>
                <a class="flex items-center px-1 py-4 text-sm font-medium border-b-2 border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 whitespace-nowrap tab-button" href="#" data-page="cashback">
                    <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20">
                        <path d="M4 4a2 2 0 00-2 2v4a2 2 0 002 2V6h10a2 2 0 00-2-2H4zm2 6a2 2 0 012-2h8a2 2 0 012 2v4a2 2 0 01-2 2H8a2 2 0 01-2-2v-4zm6 4a2 2 0 100-4 2 2 0 000 4z"/>
                    </svg>
                    Кешбек
                    <span class="ml-2 bg-gradient-to-r from-[#0088CC] to-[#006699] text-white text-xs px-2 py-1 rounded-full font-medium hidden" id="cashback-count">0</span>
                </a>
                <a class="flex items-center px-1 py-4 text-sm font-medium border-b-2 border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 whitespace-nowrap tab-button" href="#" data-page="favorites">
                    <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M3.172 5.172a4 4 0 015.656 0L10 6.343l1.172-1.171a4 4 0 115.656 5.656L10 17.657l-6.828-6.829a4 4 0 010-5.656z" clip-rule="evenodd"/>
                    </svg>
                    Избранное
                    <span class="ml-2 bg-gradient-to-r from-red-500 to-red-600 text-white text-xs px-2 py-1 rounded-full font-medium" id="top-favorites-count">0</span>
                </a>
                <a class="flex items-center px-1 py-4 text-sm font-medium border-b-2 border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 whitespace-nowrap tab-button" href="#" data-page="deals">
                    <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M6 2a2 2 0 00-2 2v12a2 2 0 002 2h8a2 2 0 002-2V7.414A2 2 0 0015.414 6L12 2.586A2 2 0 0010.586 2H6zm5 6a1 1 0 10-2 0v2H7a1 1 0 100 2h2v2a1 1 0 102 0v-2h2a1 1 0 100-2h-2V8z" clip-rule="evenodd"/>
                    </svg>
                    Сделки
                    <span class="ml-2 bg-gradient-to-r from-orange-500 to-orange-600 text-white text-xs px-2 py-1 rounded-full font-medium" id="deals-count">0</span>
                </a>
                <a class="flex items-center px-1 py-4 text-sm font-medium border-b-2 border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 whitespace-nowrap tab-button" href="#" data-page="saved-searches">
                    <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20">
                        <path d="M10 2a6 6 0 00-6 6v3.586l-.707.707A1 1 0 004 14h12a1 1 0 00.707-1.707L16 11.586V8a6 6 0 00-6-6zM10 18a3 3 0 01-3-3h6a3 3 0 01-3 3z"/>
                    </svg>
                    Мои поиски и уведомления
                    <span class="ml-2 bg-gradient-to-r from-purple-500 to-purple-600 text-white text-xs px-2 py-1 rounded-full font-medium hidden" id="saved-searches-count">0</span>
                </a>
                <a class="flex items-center px-1 py-4 text-sm font-medium border-b-2 border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 whitespace-nowrap tab-button" href="#" data-page="recommendations">
                    <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20">
                        <path d="M2.003 5.884L10 9.882l7.997-3.998A2 2 0 0016 4H4a2 2 0 00-1.997 1.884z"/>
                        <path d="M18 8.118l-8 4-8-4V14a2 2 0 002 2h12a2 2 0 002-2V8.118z"/>
                    </svg>
                    Рекомендации
                    <span class="ml-2 bg-gradient-to-r from-green-500 to-green-600 text-white text-xs px-2 py-1 rounded-full font-medium hidden" id="recommendations-count">0</span>
                </a>
                <a class="flex items-center px-1 py-4 text-sm font-medium border-b-2 border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 whitespace-nowrap tab-button" href="#" data-page="comparison">
                    <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M10 2a1 1 0 011 1v1a1 1 0 11-2 0V3a1 1 0 011-1zm4 8a4 4 0 11-8 0 4 4 0 018 0zm-.464 4.95l.707.707a1 1 0 001.414-1.414l-.707-.707a1 1 0 00-1.414 1.414zm2.12-10.607a1 1 0 010 1.414l-.706.707a1 1 0 11-1.414-1.414l.707-.707a1 1 0 011.414 0zM17 11a1 1 0 100-2h-1a1 1 0 100 2h1zm-7 4a1 1 0 011 1v1a1 1 0 11-2 0v-1a1 1 0 011-1zM5.05 6.464A1 1 0 106.465 5.05l-.708-.707a1 1 0 00-1.414 1.414l.707.707zm1.414 8.486l-.707.707a1 1 0 01-1.414-1.414l.707-.707a1 1 0 011.414 1.414zM4 11a1 1 0 100-2H3a1 1 0 000 2h1z" clip-rule="evenodd"/>
                    </svg>
                    Сравнение
                    <span class="ml-2 bg-gradient-to-r from-blue-500 to-blue-600 text-white text-xs px-2 py-1 rounded-full font-medium" id="comparison-count">0</span>
                </a>
                {% if current_manager or (current_user.is_authenticated and current_user.role == 'manager') %}
                <a class="flex items-center px-1 py-4 text-sm font-medium border-b-2 border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 whitespace-nowrap tab-button" href="#" data-page="clients">
                    <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20">
                        <path d="M9 6a3 3 0 11-6 0 3 3 0 016 0zM17 6a3 3 0 11-6 0 3 3 0 016 0zM12.93 17c.046-.327.07-.66.07-1a6.97 6.97 0 00-1.5-4.33A5 5 0 0119 16v1h-6.07zM6 11a5 5 0 015 5v1H1v-1a5 5 0 015-5z"/>
                    </svg>
                    Клиенты
                    <span class="ml-2 bg-gradient-to-r from-blue-500 to-blue-600 text-white text-xs px-2 py-1 rounded-full font-medium" id="clients-count">0</span>
                </a>
                <a class="flex items-center px-1 py-4 text-sm font-medium border-b-2 border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 whitespace-nowrap tab-button" href="#" data-page="data-management">
                    <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20">
                        <path d="M5 3a2 2 0 00-2 2v2a2 2 0 002 2h2a2 2 0 002-2V5a2 2 0 00-2-2H5zM5 11a2 2 0 00-2 2v2a2 2 0 002 2h2a2 2 0 002-2v-2a2 2 0 00-2-2H5zM11 5a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2V5zM11 13a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2v-2z"/>
                    </svg>
                    Управление данными
                    <span class="ml-2 bg-gradient-to-r from-purple-500 to-purple-600 text-white text-xs px-2 py-1 rounded-full font-medium">Excel</span>
                </a>
                {% endif %}
            </nav>
        </div>
    </div>
</div>

<!-- Main Content Area - Full Width -->
<div class="bg-gradient-to-b from-white to-gray-50 min-h-screen">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <!-- Dashboard Section (Default) -->
        <div class="content-section active" id="dashboard">
            <div class="bg-white rounded-xl shadow-sm p-6 mb-8">
                <div class="text-center bg-gradient-to-br from-blue-50 to-blue-100 rounded-xl p-8 mb-8">
                    <div class="inline-flex items-center justify-center w-16 h-16 bg-gradient-to-br from-[#0088CC] to-[#006699] rounded-full mb-4">
                        <svg class="w-8 h-8 text-white" fill="currentColor" viewBox="0 0 20 20">
                            <path d="M10 2L3 7v11h3v-6h8v6h3V7l-7-5z"/>
                        </svg>
                    </div>
                    <h2 class="text-3xl font-bold text-gray-900 mb-2">Добро пожаловать, {{ current_user.full_name }}!</h2>
                    <p class="text-lg text-gray-600 mb-6">Ваш личный кабинет покупателя недвижимости</p>
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4 text-center">
                        <div class="bg-white rounded-lg p-4 shadow-sm">
                            <div class="text-2xl font-bold text-[#0088CC]">до 30 дней</div>
                            <div class="text-sm text-gray-600">Выплата</div>
                        </div>
                        <div class="bg-white rounded-lg p-4 shadow-sm">
                            <div class="text-2xl font-bold text-green-600">до 5%</div>
                            <div class="text-sm text-gray-600">Кешбека</div>
                        </div>
                        <div class="bg-white rounded-lg p-4 shadow-sm">
                            <div class="text-2xl font-bold text-blue-600">1000+</div>
                            <div class="text-sm text-gray-600">ЖК</div>
                        </div>
                        <div class="bg-white rounded-lg p-4 shadow-sm">
                            <div class="text-2xl font-bold text-purple-600">4</div>
                            <div class="text-sm text-gray-600">Сохранено</div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Ваш менеджер -->
            {% if current_user.assigned_manager_id %}
            <div class="bg-gradient-to-br from-white to-green-50 rounded-xl shadow-sm p-6 mb-6 border border-green-100">
                <div class="flex items-start space-x-4">
                    {% if current_user.assigned_manager and current_user.assigned_manager.profile_image and 'randomuser.me' not in current_user.assigned_manager.profile_image %}
                    <div class="w-14 h-14 rounded-full flex items-center justify-center flex-shrink-0 overflow-hidden">
                        <img src="{{ current_user.assigned_manager.profile_image }}" alt="{{ current_user.assigned_manager.full_name }}" class="w-full h-full object-cover">
                    </div>
                    {% elif current_user.assigned_manager and current_user.assigned_manager.full_name %}
                    <div class="w-14 h-14 bg-gradient-to-br from-[#0088CC] to-[#006699] rounded-full flex items-center justify-center flex-shrink-0">
                        <span class="text-white font-semibold text-xl">{{ current_user.assigned_manager.full_name[0] }}</span>
                    </div>
                    {% else %}
                    <div class="w-14 h-14 bg-gradient-to-br from-[#0088CC] to-[#006699] rounded-full flex items-center justify-center flex-shrink-0">
                        <svg class="w-7 h-7 text-white" fill="currentColor" viewBox="0 0 20 20">
                            <path d="M10 9a3 3 0 100-6 3 3 0 000 6zm-7 9a7 7 0 1114 0H3z"/>
                        </svg>
                    </div>
                    {% endif %}
                    <div class="flex-1">
                        <h3 class="text-xl font-semibold text-gray-900 mb-2">Ваш персональный менеджер</h3>
                        {% if current_user.assigned_manager %}
                        <div class="space-y-2">
                            <p class="text-lg font-medium text-gray-800">{{ current_user.assigned_manager.full_name }}</p>
                            {% if current_user.assigned_manager.phone %}
                            <div class="flex items-center space-x-2 text-gray-700">
                                <svg class="w-5 h-5 text-green-600" fill="currentColor" viewBox="0 0 20 20">
                                    <path d="M2 3a1 1 0 011-1h2.153a1 1 0 01.986.836l.74 4.435a1 1 0 01-.54 1.06l-1.548.773a11.037 11.037 0 006.105 6.105l.774-1.548a1 1 0 011.059-.54l4.435.74a1 1 0 01.836.986V17a1 1 0 01-1 1h-2C7.82 18 2 12.18 2 5V3z"/>
                                </svg>
                                <a href="tel:{{ current_user.assigned_manager.phone }}" class="text-lg font-medium hover:text-green-600 transition-colors">{{ current_user.assigned_manager.phone }}</a>
                            </div>
                            {% endif %}
                            {% if current_user.assigned_manager.email %}
                            <div class="flex items-center space-x-2 text-gray-600">
                                <svg class="w-5 h-5 text-green-600" fill="currentColor" viewBox="0 0 20 20">
                                    <path d="M2.003 5.884L10 9.882l7.997-3.998A2 2 0 0016 4H4a2 2 0 00-1.997 1.884z"/>
                                    <path d="M18 8.118l-8 4-8-4V14a2 2 0 002 2h12a2 2 0 002-2V8.118z"/>
                                </svg>
                                <a href="mailto:{{ current_user.assigned_manager.email }}" class="hover:text-green-600 transition-colors">{{ current_user.assigned_manager.email }}</a>
                            </div>
                            {% endif %}
                        </div>
                        {% else %}
                        <p class="text-gray-600">Информация о менеджере загружается...</p>
                        {% endif %}
                    </div>
                </div>
            </div>
            {% else %}
            <div class="bg-gradient-to-br from-white to-blue-50 rounded-xl shadow-sm p-6 mb-6 border border-blue-100">
                <div class="flex items-start space-x-4">
                    <div class="w-14 h-14 bg-gradient-to-br from-blue-500 to-blue-600 rounded-full flex items-center justify-center flex-shrink-0">
                        <svg class="w-7 h-7 text-white" fill="currentColor" viewBox="0 0 20 20">
                            <path d="M2 3a1 1 0 011-1h2.153a1 1 0 01.986.836l.74 4.435a1 1 0 01-.54 1.06l-1.548.773a11.037 11.037 0 006.105 6.105l.774-1.548a1 1 0 011.059-.54l4.435.74a1 1 0 01.836.986V17a1 1 0 01-1 1h-2C7.82 18 2 12.18 2 5V3z"/>
                        </svg>
                    </div>
                    <div class="flex-1">
                        <h3 class="text-xl font-semibold text-gray-900 mb-2">Менеджер еще не назначен</h3>
                        <p class="text-gray-600 mb-3">В ближайшее время с вами свяжется наш специалист для персонального сопровождения покупки</p>
                        <div class="space-y-2 bg-white rounded-lg p-4 border border-gray-200">
                            <p class="font-medium text-gray-800">Контакты компании InBack:</p>
                            <div class="flex items-center space-x-2 text-gray-700">
                                <svg class="w-5 h-5 text-blue-600" fill="currentColor" viewBox="0 0 20 20">
                                    <path d="M2 3a1 1 0 011-1h2.153a1 1 0 01.986.836l.74 4.435a1 1 0 01-.54 1.06l-1.548.773a11.037 11.037 0 006.105 6.105l.774-1.548a1 1 0 011.059-.54l4.435.74a1 1 0 01.836.986V17a1 1 0 01-1 1h-2C7.82 18 2 12.18 2 5V3z"/>
                                </svg>
                                <a href="tel:+78612345678" class="text-lg font-medium hover:text-blue-600 transition-colors">+7 (861) 234-56-78</a>
                            </div>
                            <div class="flex items-center space-x-2 text-gray-600">
                                <svg class="w-5 h-5 text-blue-600" fill="currentColor" viewBox="0 0 20 20">
                                    <path d="M2.003 5.884L10 9.882l7.997-3.998A2 2 0 0016 4H4a2 2 0 00-1.997 1.884z"/>
                                    <path d="M18 8.118l-8 4-8-4V14a2 2 0 002 2h12a2 2 0 002-2V8.118z"/>
                                </svg>
                                <a href="mailto:info@inback.ru" class="hover:text-blue-600 transition-colors">info@inback.ru</a>
                            </div>
                            <p class="text-sm text-gray-500 mt-2">Работаем ежедневно с 9:00 до 21:00</p>
                        </div>
                    </div>
                </div>
            </div>
            {% endif %}

            <!-- Quick Actions -->
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 mb-8">
                <!-- Property Search -->
                <div class="bg-white rounded-xl shadow-sm p-6 hover:shadow-md transition-shadow">
                    <div class="flex items-center mb-4">
                        <div class="w-12 h-12 bg-[#0088CC] rounded-lg flex items-center justify-center mr-4">
                            <svg class="w-6 h-6 text-white" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M8 4a4 4 0 100 8 4 4 0 000-8zM2 8a6 6 0 1110.89 3.476l4.817 4.817a1 1 0 01-1.414 1.414l-4.816-4.816A6 6 0 012 8z" clip-rule="evenodd"/>
                            </svg>
                        </div>
                        <div>
                            <h3 class="font-semibold text-gray-900">Поиск недвижимости</h3>
                            <p class="text-sm text-gray-600">Найти идеальный объект</p>
                        </div>
                    </div>
                    <button onclick="window.location.href='/properties'" class="w-full bg-[#0088CC] text-white py-2 px-4 rounded-lg hover:bg-[#006699] transition-colors">
                        Начать поиск
                    </button>
                </div>
                
                <!-- Cashback Calculator -->
                <div class="bg-white rounded-xl shadow-sm p-6 hover:shadow-md transition-shadow">
                    <div class="flex items-center mb-4">
                        <div class="w-12 h-12 bg-green-500 rounded-lg flex items-center justify-center mr-4">
                            <span class="text-white font-bold text-xl">₽</span>
                        </div>
                        <div>
                            <h3 class="font-semibold text-gray-900">Калькулятор кешбека</h3>
                            <p class="text-sm text-gray-600">Рассчитать возврат</p>
                        </div>
                    </div>
                    <button onclick="document.querySelector('[data-page=cashback]').click()" class="w-full bg-green-500 text-white py-2 px-4 rounded-lg hover:bg-green-600 transition-colors">
                        Рассчитать
                    </button>
                </div>
                
                <!-- Book Consultation -->
                <div class="bg-white rounded-xl shadow-sm p-6 hover:shadow-md transition-shadow">
                    <div class="flex items-center mb-4">
                        <div class="w-12 h-12 bg-indigo-500 rounded-lg flex items-center justify-center mr-4">
                            <svg class="w-6 h-6 text-white" fill="currentColor" viewBox="0 0 20 20">
                                <path d="M2 3a1 1 0 011-1h2.153a1 1 0 01.986.836l.74 4.435a1 1 0 01-.54 1.06l-1.548.773a11.037 11.037 0 006.105 6.105l.774-1.548a1 1 0 011.059-.54l4.435.74a1 1 0 01.836.986V17a1 1 0 01-1 1h-2C7.82 18 2 12.18 2 5V3z"/>
                            </svg>
                        </div>
                        <div>
                            <h3 class="font-semibold text-gray-900">Консультация</h3>
                            <p class="text-sm text-gray-600">Связаться с экспертом</p>
                        </div>
                    </div>
                    <button onclick="openApplicationModal()" class="w-full bg-indigo-500 text-white py-2 px-4 rounded-lg hover:bg-indigo-600 transition-colors">
                        Заказать звонок
                    </button>
                </div>
            </div>
            
            <!-- How to Buy with Cashback Guide -->
            <div class="bg-white rounded-xl shadow-sm p-6 mb-6">
                <div class="flex items-center justify-between mb-6">
                    <h3 class="text-xl font-semibold text-gray-900">Как покупать с кешбеком</h3>
                    <button class="text-gray-400 hover:text-gray-600" onclick="toggleGuide()">
                        <span class="text-sm">Скрыть</span>
                    </button>
                </div>
                
                <div id="cashbackGuide" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                    <!-- Step 1 -->
                    <div class="text-center">
                        <div class="w-16 h-16 bg-gradient-to-br from-[#0088CC] to-[#006699] rounded-full flex items-center justify-center text-white text-xl font-bold mx-auto mb-4">
                            01
                        </div>
                        <h4 class="font-semibold text-gray-900 mb-2">Выбор квартиры</h4>
                        <p class="text-sm text-gray-600">Подбираем подходящий вариант из каталога проверенных застройщиков с экспертной поддержкой</p>
                    </div>
                    
                    <!-- Step 2 -->
                    <div class="text-center">
                        <div class="w-16 h-16 bg-gradient-to-br from-green-500 to-green-600 rounded-full flex items-center justify-center text-white text-xl font-bold mx-auto mb-4">
                            02
                        </div>
                        <h4 class="font-semibold text-gray-900 mb-2">Оформление как клиент InBack</h4>
                        <p class="text-sm text-gray-600">Регистрируем вас у застройщика для получения специальных условий и кэшбека</p>
                    </div>
                    
                    <!-- Step 3 -->
                    <div class="text-center">
                        <div class="w-16 h-16 bg-gradient-to-br from-orange-500 to-orange-600 rounded-full flex items-center justify-center text-white text-xl font-bold mx-auto mb-4">
                            03
                        </div>
                        <h4 class="font-semibold text-gray-900 mb-2">Сопровождение сделки</h4>
                        <p class="text-sm text-gray-600">Обеспечиваем юридическую поддержку и ведение всех документов до завершения покупки</p>
                    </div>
                    
                    <!-- Step 4 -->
                    <div class="text-center">
                        <div class="w-16 h-16 bg-gradient-to-br from-purple-500 to-purple-600 rounded-full flex items-center justify-center text-white text-xl font-bold mx-auto mb-4">
                            04
                        </div>
                        <h4 class="font-semibold text-gray-900 mb-2">Получение кэшбека</h4>
                        <p class="text-sm text-gray-600">Перечисляем возврат до 500 000 ₽ на вашу банковскую карту после завершения сделки</p>
                    </div>
                </div>
            </div>

            <!-- Phone Binding Block -->
            <div class="bg-gradient-to-br from-blue-50 to-indigo-50 rounded-xl shadow-sm p-6 mb-6 border border-blue-100">
                <div class="flex items-center justify-between mb-4">
                    <div class="flex items-center space-x-3">
                        <div class="w-10 h-10 bg-gradient-to-br from-[#0088CC] to-[#006699] rounded-lg flex items-center justify-center">
                            <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 18h.01M8 21h8a2 2 0 002-2V5a2 2 0 00-2-2H8a2 2 0 00-2 2v14a2 2 0 002 2z"></path>
                            </svg>
                        </div>
                        <div>
                            <h3 class="text-lg font-semibold text-gray-800">Привяжите номер телефона</h3>
                            <p class="text-sm text-gray-600">Для получения уведомлений о новых объектах и акциях</p>
                        </div>
                    </div>
                    <div class="text-right">
                        {% if current_user.phone and current_user.phone_verified %}
                        <span class="px-3 py-1 bg-green-100 text-green-800 rounded-full text-sm font-medium">
                            ✓ Подтвержден
                        </span>
                        {% else %}
                        <span class="px-3 py-1 bg-yellow-100 text-yellow-800 rounded-full text-sm font-medium">
                            Не привязан
                        </span>
                        {% endif %}
                    </div>
                </div>
                
                {% if not current_user.phone or not current_user.phone_verified %}
                <div class="bg-white rounded-lg p-4 border border-gray-200">
                    <div class="flex space-x-3">
                        <div class="flex-1">
                            <input 
                                type="tel" 
                                id="phoneInput"
                                placeholder="+7 (___) ___-__-__"
                                value="{{ current_user.phone or '' }}"
                                class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[#0088CC] focus:border-[#0088CC] transition-colors"
                            >
                        </div>
                        <button 
                            onclick="bindPhone()"
                            class="px-4 py-2 bg-gradient-to-r from-[#0088CC] to-[#006699] text-white font-medium rounded-lg hover:from-[#006699] hover:to-[#004466] transition-all"
                        >
                            Привязать
                        </button>
                    </div>
                    <p class="text-xs text-gray-500 mt-2">На указанный номер будет отправлен код подтверждения</p>
                </div>
                {% else %}
                <div class="bg-white rounded-lg p-4 border border-gray-200">
                    <div class="flex items-center justify-between">
                        <div class="flex items-center space-x-3">
                            <div class="w-8 h-8 bg-green-100 rounded-full flex items-center justify-center">
                                <svg class="w-4 h-4 text-green-600" fill="currentColor" viewBox="0 0 20 20">
                                    <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"></path>
                                </svg>
                            </div>
                            <span class="text-sm font-medium text-gray-900">{{ current_user.phone }}</span>
                        </div>
                        <button 
                            onclick="changePhone()"
                            class="text-sm text-[#0088CC] hover:text-[#006699] font-medium"
                        >
                            Изменить
                        </button>
                    </div>
                </div>
                {% endif %}
            </div>
            
            <!-- Recent Activity -->
            <div class="bg-white rounded-xl shadow-sm p-6">
                <h3 class="text-lg font-semibold text-gray-900 mb-4">Последняя активность</h3>
                <div class="space-y-3">
                    {% if recent_activities %}
                        {% for activity in recent_activities %}
                        <div class="flex items-center justify-between py-3 {% if not loop.last %}border-b border-gray-100{% endif %}">
                            <div class="flex items-center">
                                {% if activity.activity_type == 'favorite_added' %}
                                    <div class="w-2 h-2 bg-red-500 rounded-full mr-3"></div>
                                {% elif activity.activity_type == 'comparison_added' %}
                                    <div class="w-2 h-2 bg-blue-500 rounded-full mr-3"></div>
                                {% elif activity.activity_type == 'search_saved' %}
                                    <div class="w-2 h-2 bg-green-500 rounded-full mr-3"></div>
                                {% elif activity.activity_type == 'property_viewed' %}
                                    <div class="w-2 h-2 bg-[#0088CC] rounded-full mr-3"></div>
                                {% elif activity.activity_type == 'complex_viewed' %}
                                    <div class="w-2 h-2 bg-purple-500 rounded-full mr-3"></div>
                                {% else %}
                                    <div class="w-2 h-2 bg-gray-500 rounded-full mr-3"></div>
                                {% endif %}
                                <span class="text-sm text-gray-700">{{ activity.description }}</span>
                            </div>
                            <span class="text-xs text-gray-500">{{ activity.created_at|msk_time if activity.created_at else 'Недавно' }}</span>
                        </div>
                        {% endfor %}
                    {% else %}
                        <div class="text-center py-8">
                            <div class="w-12 h-12 bg-gray-100 rounded-full flex items-center justify-center mx-auto mb-3">
                                <svg class="w-6 h-6 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v10a2 2 0 002 2h8a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"></path>
                                </svg>
                            </div>
                            <p class="text-sm text-gray-500">Пока нет активности</p>
                            <p class="text-xs text-gray-400 mt-1">Начните искать недвижимость, чтобы увидеть историю</p>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
        
        <!-- Cashback Section -->
        <div class="content-section" id="cashback">
            <!-- Hero Section -->
            <div class="bg-white rounded-xl shadow-sm p-6 mb-8">
                <div class="text-center bg-gradient-to-br from-green-50 to-green-100 rounded-xl p-8 mb-8">
                    <div class="inline-flex items-center justify-center w-16 h-16 bg-gradient-to-br from-green-500 to-green-600 rounded-full mb-4">
                        <span class="text-white font-bold text-xl">₽</span>
                    </div>
                    <h2 class="text-3xl font-bold text-gray-900 mb-2">Кешбек программа</h2>
                    <p class="text-lg text-gray-600 mb-6">Получайте до 500 000 ₽ от стоимости квартиры</p>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 text-center">
                        <div class="bg-white rounded-lg p-4 shadow-sm">
                            <div class="text-2xl font-bold text-green-600">до 500 000 ₽</div>
                            <div class="text-sm text-gray-600">Выплата</div>
                        </div>
                        <div class="bg-white rounded-lg p-4 shadow-sm">
                            <div class="text-2xl font-bold text-blue-600">до 500 000 ₽</div>
                            <div class="text-sm text-gray-600">Максимальный кешбек</div>
                        </div>
                        <div class="bg-white rounded-lg p-4 shadow-sm">
                            <div class="text-2xl font-bold text-purple-600">30 дней</div>
                            <div class="text-sm text-gray-600">На выплату</div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Минималистичный калькулятор кешбека -->
            <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-6 mb-8">
                <!-- Простой заголовок -->
                <div class="text-center mb-6">
                    <h3 class="text-2xl font-bold text-gray-900 mb-2">Калькулятор кешбека</h3>
                    <p class="text-gray-600 text-sm">Рассчитайте свой возврат</p>
                </div>

                <!-- Минималистичный результат сверху -->
                <div class="text-center mb-8 p-6 bg-gradient-to-r from-blue-50 to-indigo-50 rounded-xl border border-blue-100">
                    <div class="text-sm text-gray-500 mb-1">Ваш кешбек</div>
                    <div id="cashback-amount" class="text-4xl font-bold text-[#0088CC] mb-2">87 500 ₽</div>
                    <div class="text-xs text-gray-400">от покупки за <span id="summary-price" class="font-medium">3 500 000 ₽</span></div>
                </div>

                <!-- Лаконичные слайдеры -->
                <div class="space-y-6">
                    <!-- Стоимость квартиры -->
                    <div>
                        <div class="flex items-center justify-between mb-3">
                            <label class="text-sm font-medium text-gray-700">Стоимость</label>
                            <span id="price-display" class="text-sm font-bold text-gray-900">3 500 000 ₽</span>
                        </div>
                        <div class="relative">
                            <input type="range" 
                                   id="price-slider" 
                                   min="1000000" 
                                   max="50000000" 
                                   step="100000" 
                                   value="3500000"
                                   class="w-full h-2 bg-gray-200 rounded-full appearance-none cursor-pointer slider-blue">
                            <div class="flex justify-between mt-1 text-xs text-gray-400">
                                <span>1 млн</span>
                                <span>50 млн</span>
                            </div>
                        </div>
                    </div>

                    <!-- Процент кешбека -->
                    <div>
                        <div class="flex items-center justify-between mb-3">
                            <label class="text-sm font-medium text-gray-700">Кешбек</label>
                            <span id="rate-display" class="text-sm font-bold text-gray-900">2.5%</span>
                        </div>
                        <div class="relative">
                            <input type="range" 
                                   id="rate-slider" 
                                   min="0.5" 
                                   max="5.0" 
                                   step="0.1" 
                                   value="2.5"
                                   class="w-full h-2 bg-gray-200 rounded-full appearance-none cursor-pointer slider-blue">
                            <div class="flex justify-between mt-1 text-xs text-gray-400">
                                <span>0.5%</span>
                                <span>5.0%</span>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Простая кнопка -->
                <div class="mt-6">
                    <button id="apply-cashback-btn" 
                            class="w-full bg-[#0088CC] hover:bg-[#006699] text-white font-medium py-3 px-6 rounded-lg transition-colors duration-200">
                        <span class="flex items-center justify-center space-x-2">
                            <span>Получить кешбек</span>
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7l5 5m0 0l-5 5m5-5H6"></path>
                            </svg>
                        </span>
                    </button>
                </div>

                <!-- Краткая подсказка -->
                <div class="mt-4 text-center">
                    <p class="text-xs text-gray-500">Точный процент зависит от ЖК и условий застройщика</p>
                </div>

                <!-- Контакты менеджера или компании -->
                <div class="mt-6 p-4 bg-gray-50 rounded-lg border border-gray-200">
                    {% if current_user.assigned_manager %}
                        <div class="text-center">
                            <p class="text-sm font-medium text-gray-700 mb-2">Свяжитесь с своим менеджером</p>
                            <div class="text-sm text-gray-600">
                                <div class="font-medium text-gray-900">{{ current_user.assigned_manager.full_name }}</div>
                                {% if current_user.assigned_manager.phone %}
                                    <div class="mt-1">
                                        <a href="tel:{{ current_user.assigned_manager.phone }}" 
                                           class="inline-flex items-center text-[#0088CC] hover:text-[#006699] font-medium">
                                            <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z"></path>
                                            </svg>
                                            {{ current_user.assigned_manager.phone }}
                                        </a>
                                    </div>
                                {% endif %}
                                {% if current_user.assigned_manager.email %}
                                    <div class="mt-1">
                                        <a href="mailto:{{ current_user.assigned_manager.email }}" 
                                           class="inline-flex items-center text-[#0088CC] hover:text-[#006699] font-medium">
                                            <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 12a4 4 0 10-8 0 4 4 0 008 0zm0 0v1.5a2.5 2.5 0 005 0V12a9 9 0 10-9 9m4.5-1.206a8.959 8.959 0 01-4.5 1.207"></path>
                                            </svg>
                                            {{ current_user.assigned_manager.email }}
                                        </a>
                                    </div>
                                {% endif %}
                            </div>
                        </div>
                    {% else %}
                        <div class="text-center">
                            <p class="text-sm font-medium text-gray-700 mb-2">Свяжитесь с нами</p>
                            <div class="text-sm text-gray-600">
                                <div class="font-medium text-gray-900">InBack</div>
                                <div class="mt-1">
                                    <a href="tel:+78612345678" 
                                       class="inline-flex items-center text-[#0088CC] hover:text-[#006699] font-medium">
                                        <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z"></path>
                                        </svg>
                                        +7 (861) 234-56-78
                                    </a>
                                </div>
                                <div class="mt-1">
                                    <a href="mailto:info@inback.ru" 
                                       class="inline-flex items-center text-[#0088CC] hover:text-[#006699] font-medium">
                                        <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 12a4 4 0 10-8 0 4 4 0 008 0zm0 0v1.5a2.5 2.5 0 005 0V12a9 9 0 10-9 9m4.5-1.206a8.959 8.959 0 01-4.5 1.207"></path>
                                        </svg>
                                        info@inback.ru
                                    </a>
                                </div>
                            </div>
                        </div>
                    {% endif %}
                </div>
            </div>

            <!-- Cashback Application Modal -->
            <div id="cashback-modal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden">
                <div class="flex items-center justify-center min-h-screen p-4">
                    <div class="bg-white rounded-xl p-6 w-full max-w-md">
                        <div class="flex items-center justify-between mb-4">
                            <h3 class="text-lg font-semibold text-gray-900">Заявка на кешбек</h3>
                            <button onclick="closeCashbackModal()" class="text-gray-400 hover:text-gray-600">
                                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                                </svg>
                            </button>
                        </div>
                        
                        <div class="mb-4 p-4 bg-green-50 rounded-lg">
                            <div class="text-sm text-gray-600 mb-2">Ваш кешбек:</div>
                            <div class="text-2xl font-bold text-green-600" id="modal-cashback-amount">0 ₽</div>
                            <div class="text-xs text-gray-500" id="modal-complex-info"></div>
                        </div>

                        <form id="cashback-application-form" class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Имя *</label>
                                <input type="text" id="cashback-name" required
                                       class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[#0088CC] focus:border-transparent"
                                       value="{{ current_user.full_name if current_user.is_authenticated and current_user.full_name else '' }}">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Телефон *</label>
                                <input type="tel" id="cashback-phone" required
                                       placeholder="+7 (___) ___-__-__"
                                       class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[#0088CC] focus:border-transparent"
                                       value="{{ current_user.phone if current_user.is_authenticated and current_user.phone else '' }}">
                            </div>
                            <div class="flex space-x-3 pt-4">
                                <button type="button" onclick="closeCashbackModal()" 
                                        class="flex-1 px-4 py-2 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50">
                                    Отмена
                                </button>
                                <button type="submit" 
                                        class="flex-1 px-4 py-2 bg-[#0088CC] text-white rounded-lg hover:bg-[#006699]">
                                    Отправить
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
            
            <!-- Cashback History -->
            <div class="bg-white rounded-xl shadow-sm p-6">
                <h3 class="text-xl font-semibold text-gray-800 mb-6">История кешбека</h3>
                <div class="space-y-4">
                    {% if cashback_applications %}
                        {% for app in cashback_applications %}
                        <div class="border border-gray-200 rounded-lg p-4">
                            <div class="flex items-center justify-between">
                                <div>
                                    <h4 class="font-medium text-gray-900">{{ app.property_name }}</h4>
                                    <p class="text-sm text-gray-600 mt-1">
                                        {{ app.property_type }}, {{ app.property_size }} м² • 
                                        {{ app.created_at|msk_time('%d.%m.%Y') if app.created_at else 'Дата неизвестна' }}
                                    </p>
                                    <p class="text-xs text-gray-500 mt-1">Стоимость: {{ "{:,}".format(app.property_price) }} ₽</p>
                                </div>
                                <div class="text-right">
                                    <div class="text-lg font-bold text-green-600">+{{ "{:,}".format(app.cashback_amount) }} ₽</div>
                                    {% if app.status == 'В обработке' %}
                                    <span class="text-xs bg-yellow-100 text-yellow-800 px-2 py-1 rounded">В обработке</span>
                                    {% elif app.status == 'Подтверждена' %}
                                    <span class="text-xs bg-blue-100 text-blue-800 px-2 py-1 rounded">Подтверждена</span>
                                    {% elif app.status == 'Выплачена' %}
                                    <span class="text-xs bg-green-100 text-green-800 px-2 py-1 rounded">Выплачена</span>
                                    {% elif app.status == 'Отклонена' %}
                                    <span class="text-xs bg-red-100 text-red-800 px-2 py-1 rounded">Отклонена</span>
                                    {% else %}
                                    <span class="text-xs bg-gray-100 text-gray-800 px-2 py-1 rounded">{{ app.status }}</span>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    {% else %}
                        <div class="text-center text-gray-500 py-8">
                            <div class="w-12 h-12 bg-gray-100 rounded-full flex items-center justify-center mx-auto mb-3">
                                <svg class="w-6 h-6 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1"></path>
                                </svg>
                            </div>
                            <p class="text-sm">У вас пока нет заявок на кешбек</p>
                            <p class="text-xs text-gray-400 mt-1">Подайте заявку через калькулятор кешбека выше</p>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
        
        <!-- Applications Section -->
        <div class="content-section" id="applications">
            <div class="bg-white rounded-xl shadow-sm p-6 mb-8">
                <div class="text-center bg-gradient-to-br from-blue-50 to-blue-100 rounded-xl p-8 mb-8">
                    <div class="inline-flex items-center justify-center w-16 h-16 bg-gradient-to-br from-blue-500 to-blue-600 rounded-full mb-4">
                        <svg class="w-8 h-8 text-white" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M4 4a2 2 0 012-2h8a2 2 0 012 2v12a2 2 0 01-2 2H6a2 2 0 01-2-2V4zm2 0h8v12H6V4z" clip-rule="evenodd"/>
                        </svg>
                    </div>
                    <h2 class="text-3xl font-bold text-gray-900 mb-2">Мои заявки</h2>
                    <p class="text-lg text-gray-600 mb-6">Отслеживайте статус ваших заявок</p>
                    <div class="text-center">
                        <div class="text-sm text-gray-500">У вас пока нет заявок</div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Favorites Section -->
        <div class="content-section" id="favorites">
            <!-- Hero Section -->
            <div class="bg-white rounded-xl shadow-sm p-6 mb-8">
                <div class="text-center bg-gradient-to-br from-red-50 to-red-100 rounded-xl p-8 mb-8">
                    <div class="inline-flex items-center justify-center w-16 h-16 bg-gradient-to-br from-red-500 to-red-600 rounded-full mb-4">
                        <svg class="w-8 h-8 text-white" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M3.172 5.172a4 4 0 015.656 0L10 6.343l1.172-1.171a4 4 0 115.656 5.656L10 17.657l-6.828-6.829a4 4 0 010-5.656z" clip-rule="evenodd"/>
                        </svg>
                    </div>
                    <h2 class="text-3xl font-bold text-gray-900 mb-2">Избранное</h2>
                    <p class="text-lg text-gray-600 mb-6">Сохраненные объекты недвижимости</p>
                    <div class="flex justify-center space-x-4">
                        <span class="bg-white rounded-lg px-4 py-2 shadow-sm">
                            <span class="text-2xl font-bold text-red-600" id="favorites-count">0</span>
                            <span class="text-sm text-gray-600 block" id="favorites-count-label">квартир</span>
                        </span>
                        <span class="bg-white rounded-lg px-4 py-2 shadow-sm">
                            <span class="text-2xl font-bold text-blue-600" id="complex-favorites-count">0</span>
                            <span class="text-sm text-gray-600 block">ЖК</span>
                        </span>
                    </div>
                </div>
            </div>
            
            <!-- Favorites Content -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                <!-- Property Favorites -->
                <div class="bg-white rounded-xl shadow-sm p-6">
                    <div class="flex items-center justify-between mb-6">
                        <h3 class="text-xl font-semibold text-gray-800">Избранные объекты</h3>
                        <div class="flex space-x-2">
                            <button class="text-sm text-red-600 hover:text-red-800 font-medium" onclick="clearAllPropertyFavorites()">
                                Очистить все
                            </button>
                            <button class="text-sm text-[#0088CC] hover:text-[#006699] font-medium" onclick="window.location.href='/properties'">
                                Найти больше
                            </button>
                        </div>
                    </div>
                    <div id="favorites-list" class="space-y-4">
                        <!-- Favorites loading state - УНИФИЦИРОВАННАЯ АНИМАЦИЯ -->
                        <div id="favorites-loading" class="text-center py-8">
                            <svg class="animate-spin mx-auto h-8 w-8 text-[#0088CC]" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                            </svg>
                            <p class="mt-3 text-gray-600 font-medium">Загрузка избранного...</p>
                        </div>
                        <div id="favorites-empty" class="text-center py-8 hidden">
                            <svg class="mx-auto h-16 w-16 text-gray-300 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z"/>
                            </svg>
                            <p class="text-gray-600">Нет избранных объектов</p>
                            <button class="mt-4 bg-[#0088CC] text-white px-4 py-2 rounded-lg hover:bg-[#006699] transition-colors" onclick="window.location.href='/properties'">
                                Найти недвижимость
                            </button>
                        </div>
                        

                    </div>
                </div>
                
                <!-- Complex Favorites -->
                <div class="bg-white rounded-xl shadow-sm p-6">
                    <div class="flex items-center justify-between mb-6">
                        <h3 class="text-xl font-semibold text-gray-800">Избранные ЖК</h3>
                        <div class="flex space-x-2">
                            <button class="text-sm text-red-600 hover:text-red-800 font-medium" onclick="clearAllComplexFavorites()">
                                Очистить все
                            </button>
                            <button class="text-sm text-[#0088CC] hover:text-[#006699] font-medium" onclick="window.location.href='/complexes'">
                                Все ЖК
                            </button>
                        </div>
                    </div>
                    <div id="complex-favorites-list" class="space-y-4">
                        <!-- Loading state - УНИФИЦИРОВАННАЯ АНИМАЦИЯ -->
                        <div id="complex-loading" class="text-center py-8">
                            <svg class="animate-spin mx-auto h-8 w-8 text-[#0088CC]" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                            </svg>
                            <p class="mt-3 text-gray-600 font-medium">Загрузка избранного...</p>
                        </div>
                        
                        <!-- Empty state -->
                        <div id="complex-empty" class="text-center py-8 hidden">
                            <svg class="mx-auto h-16 w-16 text-gray-300 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"/>
                            </svg>
                            <p class="text-gray-600">У вас пока нет избранных ЖК</p>
                            <button class="mt-4 bg-[#0088CC] text-white px-4 py-2 rounded-lg hover:bg-[#006699] transition-colors" onclick="window.location.href='/complexes'">
                                Посмотреть все ЖК
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Deals Section -->
        <div class="content-section" id="deals">
            <div class="bg-white rounded-xl shadow-sm p-6 mb-8">
                <div class="text-center bg-gradient-to-br from-orange-50 to-orange-100 rounded-xl p-8 mb-8">
                    <div class="inline-flex items-center justify-center w-16 h-16 bg-gradient-to-br from-orange-500 to-orange-600 rounded-full mb-4">
                        <svg class="w-8 h-8 text-white" fill="currentColor" viewBox="0 0 24 24">
                            <path d="M12.5 2c1.1 0 2.1.3 3 .8L13.8 4.5c-.5-.2-1.1-.3-1.3-.3-.6 0-1.2.1-1.7.4-.6.3-1 .7-1.3 1.2l-1.5-1.3c.5-.8 1.2-1.4 2-1.8.9-.5 1.9-.7 3-.7zm7.5 4c1 0 1.8.4 2.4 1 .6.6 1 1.4 1 2.4 0 .7-.2 1.3-.6 1.8L18 15.9c-.3.4-.7.6-1.2.6-.4 0-.8-.2-1.1-.5l-3.8-3.8c-.3-.3-.5-.7-.5-1.1 0-.4.2-.8.5-1.1l4.7-4.7c.5-.5 1.1-.7 1.9-.7z"/>
                            <path d="M2 12.5c0-1.1.3-2.1.8-3L4.5 11.2c-.2.5-.3 1.1-.3 1.3 0 .6.1 1.2.4 1.7.3.6.7 1 1.2 1.3l-1.3 1.5c-.8-.5-1.4-1.2-1.8-2-.5-.9-.7-1.9-.7-3zm4-7.5c0-1 .4-1.8 1-2.4.6-.6 1.4-1 2.4-1 .7 0 1.3.2 1.8.6L15.9 6c.4.3.6.7.6 1.2 0 .4-.2.8-.5 1.1l-3.8 3.8c-.3.3-.7.5-1.1.5-.4 0-.8-.2-1.1-.5l-4.7-4.7c-.5-.5-.7-1.1-.7-1.9z"/>
                        </svg>
                    </div>
                    <h2 class="text-3xl font-bold text-gray-900 mb-2">Мои сделки</h2>
                    <p class="text-lg text-gray-600 mb-6">Отслеживайте статус ваших сделок и получайте обновления</p>
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4 text-center">
                        <div class="bg-white rounded-lg p-4 shadow-sm">
                            <div class="text-2xl font-bold text-orange-500" id="deals-total-count">0</div>
                            <div class="text-sm text-gray-600">Всего сделок</div>
                        </div>
                        <div class="bg-white rounded-lg p-4 shadow-sm">
                            <div class="text-2xl font-bold text-blue-600" id="deals-active-count">0</div>
                            <div class="text-sm text-gray-600">В процессе</div>
                        </div>
                        <div class="bg-white rounded-lg p-4 shadow-sm">
                            <div class="text-2xl font-bold text-green-600" id="deals-completed-count">0</div>
                            <div class="text-sm text-gray-600">Завершено</div>
                        </div>
                        <div class="bg-white rounded-lg p-4 shadow-sm">
                            <div class="text-2xl font-bold text-purple-600" id="deals-cashback-total">0 ₽</div>
                            <div class="text-sm text-gray-600">Общий кешбек</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Status Filters -->
            <div class="bg-white rounded-xl shadow-sm p-6 mb-6">
                <h3 class="text-lg font-semibold text-gray-800 mb-4">Фильтр по статусу</h3>
                <div class="flex flex-wrap gap-3">
                    <button class="deals-filter-btn active px-4 py-2 rounded-lg font-medium transition-all" data-status="all">
                        Все сделки
                    </button>
                    <button class="deals-filter-btn px-4 py-2 rounded-lg font-medium transition-all" data-status="new,object_reserved">
                        <span class="inline-block w-2 h-2 bg-yellow-500 rounded-full mr-2"></span>
                        На рассмотрении
                    </button>
                    <button class="deals-filter-btn px-4 py-2 rounded-lg font-medium transition-all" data-status="mortgage">
                        <span class="inline-block w-2 h-2 bg-orange-500 rounded-full mr-2"></span>
                        Ипотека
                    </button>
                    <button class="deals-filter-btn px-4 py-2 rounded-lg font-medium transition-all" data-status="successful">
                        <span class="inline-block w-2 h-2 bg-green-500 rounded-full mr-2"></span>
                        Завершены
                    </button>
                    <button class="deals-filter-btn px-4 py-2 rounded-lg font-medium transition-all" data-status="rejected">
                        <span class="inline-block w-2 h-2 bg-red-500 rounded-full mr-2"></span>
                        Отклонены
                    </button>
                </div>
            </div>

            <!-- Deals List -->
            <div class="space-y-4" id="deals-list">
                <!-- Deals will be loaded here dynamically via JavaScript -->
            </div>
            
            <!-- Deal Card Template (hidden, used by JavaScript) -->
            <div id="deal-card-template" class="hidden">
                <div class="deal-card bg-white rounded-xl shadow-sm p-6 border border-gray-100">
                    <div class="flex flex-col md:flex-row md:items-center justify-between mb-4">
                        <div class="flex items-center space-x-3 mb-2 md:mb-0">
                            <div class="w-10 h-10 bg-gradient-to-br from-orange-400 to-orange-500 rounded-lg flex items-center justify-center">
                                <span class="text-white font-bold text-sm deal-number-short"></span>
                            </div>
                            <div>
                                <h4 class="font-semibold text-gray-900 deal-number"></h4>
                                <p class="text-sm text-gray-500 deal-created-at"></p>
                            </div>
                        </div>
                        <div class="status-badge deal-status-badge"></div>
                    </div>
                    
                    <!-- Property Details -->
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                        <div>
                            <h5 class="font-medium text-gray-900 mb-1 deal-complex-name"></h5>
                            <p class="text-sm text-gray-600 deal-property-description"></p>
                            <div class="flex flex-wrap gap-2 mt-2 text-xs text-gray-500">
                                <span class="deal-property-area"></span>
                                <span class="deal-property-rooms"></span>
                                <span class="deal-property-floor"></span>
                            </div>
                        </div>
                        <div class="space-y-2">
                            <div class="flex justify-between">
                                <span class="text-sm text-gray-600">Стоимость:</span>
                                <span class="font-semibold text-gray-900 deal-price"></span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-sm text-gray-600">Кешбек:</span>
                                <span class="font-semibold text-green-600 deal-cashback"></span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-sm text-gray-600">Процент:</span>
                                <span class="font-semibold text-blue-600 deal-cashback-percent"></span>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Client Notes -->
                    <div class="deal-client-notes-section hidden">
                        <div class="bg-gray-50 rounded-lg p-3">
                            <p class="text-sm text-gray-600 mb-1">Ваши заметки:</p>
                            <p class="text-sm text-gray-800 deal-client-notes"></p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Empty State -->
            <div class="bg-white rounded-xl shadow-sm p-12 text-center hidden" id="deals-empty-state">
                <div class="inline-flex items-center justify-center w-16 h-16 bg-gray-100 rounded-full mb-4">
                    <svg class="w-8 h-8 text-gray-400" fill="currentColor" viewBox="0 0 24 24">
                        <path d="M12.5 2c1.1 0 2.1.3 3 .8L13.8 4.5c-.5-.2-1.1-.3-1.3-.3-.6 0-1.2.1-1.7.4-.6.3-1 .7-1.3 1.2l-1.5-1.3c.5-.8 1.2-1.4 2-1.8.9-.5 1.9-.7 3-.7zm7.5 4c1 0 1.8.4 2.4 1 .6.6 1 1.4 1 2.4 0 .7-.2 1.3-.6 1.8L18 15.9c-.3.4-.7.6-1.2.6-.4 0-.8-.2-1.1-.5l-3.8-3.8c-.3-.3-.5-.7-.5-1.1 0-.4.2-.8.5-1.1l4.7-4.7c.5-.5 1.1-.7 1.9-.7z"/>
                        <path d="M2 12.5c0-1.1.3-2.1.8-3L4.5 11.2c-.2.5-.3 1.1-.3 1.3 0 .6.1 1.2.4 1.7.3.6.7 1 1.2 1.3l-1.3 1.5c-.8-.5-1.4-1.2-1.8-2-.5-.9-.7-1.9-.7-3zm4-7.5c0-1 .4-1.8 1-2.4.6-.6 1.4-1 2.4-1 .7 0 1.3.2 1.8.6L15.9 6c.4.3.6.7.6 1.2 0 .4-.2.8-.5 1.1l-3.8 3.8c-.3.3-.7.5-1.1.5-.4 0-.8-.2-1.1-.5l-4.7-4.7c-.5-.5-.7-1.1-.7-1.9z"/>
                    </svg>
                </div>
                <h3 class="text-xl font-semibold text-gray-800 mb-2">У вас пока нет сделок</h3>
                <p class="text-gray-600 mb-6">Как только вы оформите заявку на покупку недвижимости, здесь появится информация о сделке</p>
                <button onclick="window.location.href='/properties'" class="bg-[#0088CC] text-white px-6 py-3 rounded-lg hover:bg-[#006699] transition-colors">
                    Найти недвижимость
                </button>
            </div>

            <!-- Loading State -->
            <div class="bg-white rounded-xl shadow-sm p-12 text-center hidden" id="deals-loading-state">
                <div class="inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-[#0088CC] mb-4"></div>
                <p class="text-gray-600">Загружаем ваши сделки...</p>
            </div>
        </div>
        
        <!-- Saved Searches & Notifications Section -->
        <div class="content-section" id="saved-searches">
            <!-- Hero Section -->
            <div class="bg-white rounded-xl shadow-sm p-6 mb-8">
                <div class="text-center bg-gradient-to-br from-purple-50 to-purple-100 rounded-xl p-8 mb-8">
                    <div class="inline-flex items-center justify-center w-16 h-16 bg-gradient-to-br from-purple-500 to-purple-600 rounded-full mb-4">
                        <svg class="w-8 h-8 text-white" fill="currentColor" viewBox="0 0 20 20">
                            <path d="M10 2a6 6 0 00-6 6v3.586l-.707.707A1 1 0 004 14h12a1 1 0 00.707-1.707L16 11.586V8a6 6 0 00-6-6zM10 18a3 3 0 01-3-3h6a3 3 0 01-3 3z"/>
                        </svg>
                    </div>
                    <h2 class="text-3xl font-bold text-gray-900 mb-2">Мои поиски и уведомления</h2>
                    <p class="text-lg text-gray-600 mb-6">Управляйте сохранёнными поисками и настройками оповещений</p>
                    <div class="flex justify-center space-x-4">
                        <span class="bg-white rounded-lg px-4 py-2 shadow-sm">
                            <span class="text-2xl font-bold text-purple-600" id="saved-searches-total-count">0</span>
                            <span class="text-sm text-gray-600 block">Поисков</span>
                        </span>
                        <span class="bg-white rounded-lg px-4 py-2 shadow-sm">
                            <span class="text-2xl font-bold text-green-600" id="active-alerts-count">0</span>
                            <span class="text-sm text-gray-600 block">Активных уведомлений</span>
                        </span>
                        <button class="bg-[#0088CC] text-white px-6 py-2 rounded-lg hover:bg-[#006699] transition-colors" onclick="window.location.href='/properties'">
                            Создать поиск
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- Saved Searches with Notification Settings -->
            <div class="bg-white rounded-xl shadow-sm p-6 mb-6">
                <div class="flex items-center justify-between mb-6">
                    <h3 class="text-xl font-semibold text-gray-800">Сохранённые поиски</h3>
                    <button class="text-sm text-[#0088CC] hover:text-[#006699] font-medium" onclick="window.location.href='/properties'">
                        <svg class="w-4 h-4 inline mr-1" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M10 5a1 1 0 011 1v3h3a1 1 0 110 2h-3v3a1 1 0 11-2 0v-3H6a1 1 0 110-2h3V6a1 1 0 011-1z" clip-rule="evenodd"/>
                        </svg>
                        Создать новый поиск
                    </button>
                </div>
                
                <div id="saved-searches-list" class="space-y-4">
                    <!-- Searches will be loaded dynamically -->
                    <div class="text-center py-8">
                        <div class="inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-purple-600"></div>
                        <p class="text-gray-500 mt-2 text-sm">Загружаем ваши поиски...</p>
                    </div>
                </div>
            </div>
            
            <!-- Notification History -->
            <div class="bg-white rounded-xl shadow-sm p-6">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-xl font-semibold text-gray-800">История уведомлений</h3>
                    <button id="toggle-history" class="text-sm text-gray-600 hover:text-gray-800" onclick="toggleAlertHistory()">
                        <svg class="w-5 h-5 inline transition-transform" id="history-chevron" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd"/>
                        </svg>
                    </button>
                </div>
                
                <div id="alert-history-content" class="hidden">
                    <div class="bg-gray-50 rounded-lg p-4 mb-4">
                        <div class="flex items-center space-x-2 text-sm text-gray-600">
                            <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd"/>
                            </svg>
                            <span>Последние 20 уведомлений о новых объектах по вашим поискам</span>
                        </div>
                    </div>
                    
                    <div id="alert-history-list" class="space-y-3">
                        <!-- History will be loaded dynamically -->
                        <div class="text-center py-6">
                            <div class="inline-block animate-spin rounded-full h-6 w-6 border-b-2 border-gray-400"></div>
                            <p class="text-gray-500 mt-2 text-sm">Загружаем историю...</p>
                        </div>
                    </div>
                </div>
                
                <div id="no-history-message" class="hidden text-center text-gray-500 py-8">
                    <svg class="w-12 h-12 mx-auto mb-3 text-gray-300" fill="currentColor" viewBox="0 0 20 20">
                        <path d="M10 2a6 6 0 00-6 6v3.586l-.707.707A1 1 0 004 14h12a1 1 0 00.707-1.707L16 11.586V8a6 6 0 00-6-6zM10 18a3 3 0 01-3-3h6a3 3 0 01-3 3z"/>
                    </svg>
                    <p>Пока нет уведомлений</p>
                    <p class="text-sm mt-2">Когда появятся новые объекты по вашим поискам, вы получите уведомления</p>
                </div>
            </div>
        </div>
        
        <!-- Presentations Section -->
        <div class="content-section" id="recommendations">
            <!-- Hero Section -->
            <div class="bg-white rounded-xl shadow-sm p-6 mb-8">
                <div class="text-center bg-gradient-to-br from-blue-50 to-blue-100 rounded-xl p-8 mb-8">
                    <div class="inline-flex items-center justify-center w-16 h-16 bg-gradient-to-br from-[#0088CC] to-[#006699] rounded-full mb-4">
                        <svg class="w-8 h-8 text-white" fill="currentColor" viewBox="0 0 20 20">
                            <path d="M7 3a1 1 0 000 2h6a1 1 0 100-2H7zM4 7a1 1 0 011-1h10a1 1 0 110 2H5a1 1 0 01-1-1zM2 11a2 2 0 012-2h12a2 2 0 012 2v4a2 2 0 01-2 2H4a2 2 0 01-2-2v-4z"/>
                        </svg>
                    </div>
                    <h2 class="text-3xl font-bold text-gray-900 mb-2">Презентации от менеджера</h2>
                    <p class="text-lg text-gray-600 mb-6">Персональные подборки объектов от вашего менеджера</p>
                    <div class="flex justify-center space-x-4">
                        <span class="bg-white rounded-lg px-4 py-2 shadow-sm">
                            <span class="text-2xl font-bold text-[#0088CC]" id="presentations-new-count">0</span>
                            <span class="text-sm text-gray-600 block">Новых</span>
                        </span>
                        <span class="bg-white rounded-lg px-4 py-2 shadow-sm">
                            <span class="text-2xl font-bold text-green-600" id="presentations-total-count">0</span>
                            <span class="text-sm text-gray-600 block">Всего</span>
                        </span>
                    </div>
                </div>
            </div>
            
            <!-- Presentations Content -->
            <div class="bg-white rounded-xl shadow-sm p-6">
                <div class="flex items-center justify-between mb-6">
                    <h3 class="text-xl font-semibold text-gray-800">Презентации объектов</h3>
                </div>
                
                <!-- Presentations will be loaded dynamically via JavaScript -->
                <div class="space-y-4" id="presentationsList">
                    <div class="text-center py-8">
                        <div class="inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-[#0088CC]"></div>
                        <p class="text-gray-500 mt-2 text-sm">Загрузка презентаций...</p>
                    </div>
                </div>
                </div>
            </div>
        </div>
        
        <!-- Comparison Section -->
        <div class="content-section" id="comparison">
            <!-- Hero Section -->
            <div class="bg-white rounded-xl shadow-sm p-6 mb-8">
                <div class="text-center bg-gradient-to-br from-indigo-50 to-indigo-100 rounded-xl p-8 mb-8">
                    <div class="inline-flex items-center justify-center w-16 h-16 bg-gradient-to-br from-indigo-500 to-indigo-600 rounded-full mb-4">
                        <svg class="w-8 h-8 text-white" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M10 2a1 1 0 011 1v1a1 1 0 11-2 0V3a1 1 0 011-1zm4 8a4 4 0 11-8 0 4 4 0 018 0zm-.464 4.95l.707.707a1 1 0 001.414-1.414l-.707-.707a1 1 0 00-1.414 1.414zm2.12-10.607a1 1 0 010 1.414l-.706.707a1 1 0 11-1.414-1.414l.707-.707a1 1 0 011.414 0zM17 11a1 1 0 100-2h-1a1 1 0 100 2h1zm-7 4a1 1 0 011 1v1a1 1 0 11-2 0v-1a1 1 0 011-1zM5.05 6.464A1 1 0 106.465 5.05l-.708-.707a1 1 0 00-1.414 1.414l.707.707zm1.414 8.486l-.707.707a1 1 0 01-1.414-1.414l.707-.707a1 1 0 011.414 1.414zM4 11a1 1 0 100-2H3a1 1 0 000 2h1z" clip-rule="evenodd"/>
                        </svg>
                    </div>
                    <h2 class="text-3xl font-bold text-gray-900 mb-2">Сравнение</h2>
                    <p class="text-lg text-gray-600 mb-6">Сравните выбранные объекты и ЖК</p>
                    <div class="flex justify-center space-x-4">
                        <span class="bg-white rounded-lg px-4 py-2 shadow-sm">
                            <span class="text-2xl font-bold text-indigo-600" id="comparison-properties-count">2</span>
                            <span class="text-sm text-gray-600 block">Объектов</span>
                        </span>
                        <span class="bg-white rounded-lg px-4 py-2 shadow-sm">
                            <span class="text-2xl font-bold text-blue-600" id="comparison-complexes-count">1</span>
                            <span class="text-sm text-gray-600 block">ЖК</span>
                        </span>
                    </div>
                </div>
            </div>
            
            <!-- Comparison Content -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                <!-- Properties Comparison -->
                <div class="bg-white rounded-xl shadow-sm p-6">
                    <div class="flex items-center justify-between mb-6">
                        <h3 class="text-xl font-semibold text-gray-800">Сравнение объектов</h3>
                        <button class="text-sm bg-indigo-600 text-white px-4 py-2 rounded-lg hover:bg-indigo-700 transition-colors" onclick="window.location.href='/comparison'">
                            Детальное сравнение
                        </button>
                    </div>
                    <div id="properties-comparison-list" class="space-y-3">
                        <div class="text-center py-4 text-gray-500 text-sm">Загрузка объектов сравнения...</div>
                    </div>
                </div>
                
                <!-- Complexes Comparison -->
                <div class="bg-white rounded-xl shadow-sm p-6">
                    <div class="flex items-center justify-between mb-6">
                        <h3 class="text-xl font-semibold text-gray-800">Сравнение ЖК</h3>
                        <button class="text-sm bg-indigo-600 text-white px-4 py-2 rounded-lg hover:bg-indigo-700 transition-colors" onclick="window.location.href='/comparison'">
                            Детальное сравнение
                        </button>
                    </div>
                    <div id="complexes-comparison-list" class="space-y-4">
                        <!-- Complex Comparison Item -->
                        <div class="border border-gray-200 rounded-lg p-3 bg-gray-50">
                            <div class="flex items-center justify-between">
                                <div class="flex-1">
                                    <h5 class="font-medium text-gray-900 text-sm">ЖК «Эталон»</h5>
                                    <p class="text-xs text-gray-600">от 3.1 млн ₽ • кешбек 5% • 15 объектов</p>
                                </div>
                                <button class="text-red-600 hover:text-red-800 text-xs" onclick="removeFromComparison('etalon', 'complex')">
                                    ✕
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Hidden elements for comparison.js compatibility -->
        <div class="hidden">
            <div id="quickComparisonGrid"></div>
            <div id="detailedComparisonContainer"></div>
        </div>
    </div>
</div>


<!-- Data Management Section (Admins Only) -->
<div class="content-section" id="data-management">
    <div class="bg-white rounded-xl shadow-sm p-6 mb-8">
        <div class="text-center bg-gradient-to-br from-purple-50 to-purple-100 rounded-xl p-8 mb-8">
            <div class="inline-flex items-center justify-center w-16 h-16 bg-gradient-to-br from-purple-600 to-purple-700 rounded-full mb-4">
                <svg class="w-8 h-8 text-white" fill="currentColor" viewBox="0 0 20 20">
                    <path d="M5 3a2 2 0 00-2 2v2a2 2 0 002 2h2a2 2 0 002-2V5a2 2 0 00-2-2H5zM5 11a2 2 0 00-2 2v2a2 2 0 002 2h2a2 2 0 002-2v-2a2 2 0 00-2-2H5zM11 5a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2V5zM11 13a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2v-2z"/>
                </svg>
            </div>
            <h2 class="text-3xl font-bold text-gray-900 mb-2">Управление данными Excel</h2>
            <p class="text-lg text-gray-600 mb-6">Автоматическая загрузка и обработка данных недвижимости</p>
            
            <!-- Status Cards -->
            <div class="grid grid-cols-2 md:grid-cols-4 gap-4 text-center">
                <div class="bg-white rounded-lg p-4 shadow-sm" id="data-stats-properties">
                    <div class="text-2xl font-bold text-purple-600">...</div>
                    <div class="text-sm text-gray-600">Квартир в БД</div>
                </div>
                <div class="bg-white rounded-lg p-4 shadow-sm" id="data-stats-complexes">
                    <div class="text-2xl font-bold text-blue-600">...</div>
                    <div class="text-sm text-gray-600">ЖК</div>
                </div>
                <div class="bg-white rounded-lg p-4 shadow-sm" id="data-stats-developers">
                    <div class="text-2xl font-bold text-green-600">...</div>
                    <div class="text-sm text-gray-600">Застройщиков</div>
                </div>
                <div class="bg-white rounded-lg p-4 shadow-sm" id="data-stats-columns">
                    <div class="text-2xl font-bold text-orange-600">77</div>
                    <div class="text-sm text-gray-600">Колонок Excel</div>
                </div>
            </div>
        </div>
        
        <!-- Upload Excel Form -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
            <!-- File Upload Section -->
            <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6">
                <h3 class="text-xl font-semibold text-gray-800 mb-4 flex items-center">
                    <svg class="w-6 h-6 mr-2 text-purple-600" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zM6.293 6.707a1 1 0 010-1.414l3-3a1 1 0 011.414 0l3 3a1 1 0 01-1.414 1.414L11 5.414V13a1 1 0 11-2 0V5.414L7.707 6.707a1 1 0 01-1.414 0z" clip-rule="evenodd"/>
                    </svg>
                    Загрузка Excel файла
                </h3>
                
                <form id="excel-upload-form" enctype="multipart/form-data" class="space-y-4">
                    <div class="border-2 border-dashed border-gray-300 rounded-lg p-6 text-center hover:border-purple-400 transition-colors" id="upload-area">
                        <svg class="mx-auto h-12 w-12 text-gray-400" stroke="currentColor" fill="none" viewBox="0 0 48 48">
                            <path d="M28 8H12a4 4 0 00-4 4v20m32-12v8m0 0v8a4 4 0 01-4 4H12a4 4 0 01-4-4v-4m32-4l-3.172-3.172a4 4 0 00-5.656 0L28 28M8 32l9.172-9.172a4 4 0 015.656 0L28 28m0 0l4 4m4-24h8m-4-4v8m-12 4h.02" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                        </svg>
                        <div class="mt-4">
                            <label for="excel-file" class="cursor-pointer">
                                <span class="mt-2 block text-sm font-medium text-gray-900">
                                    Перетащите Excel файл сюда или
                                </span>
                                <span class="text-purple-600 hover:text-purple-500">выберите файл</span>
                            </label>
                            <input type="file" id="excel-file" name="excel_file" accept=".xlsx,.xls" class="hidden">
                        </div>
                        <p class="mt-2 text-xs text-gray-500">Поддерживаются: .xlsx, .xls (до 50 МБ)</p>
                    </div>
                    
                    <!-- Upload Options -->
                    <div class="space-y-3">
                        <label class="flex items-center">
                            <input type="checkbox" id="replace-data" name="replace_data" class="rounded border-gray-300 text-purple-600 focus:ring-purple-500">
                            <span class="ml-2 text-sm text-gray-700">Заменить существующие данные</span>
                        </label>
                        <label class="flex items-center">
                            <input type="checkbox" id="auto-sync" name="auto_sync" checked class="rounded border-gray-300 text-purple-600 focus:ring-purple-500">
                            <span class="ml-2 text-sm text-gray-700">Автоматически синхронизировать ЖК</span>
                        </label>
                    </div>
                    
                    <button type="submit" id="upload-btn" class="w-full bg-gradient-to-r from-purple-600 to-purple-700 text-white py-3 px-4 rounded-lg font-medium hover:from-purple-700 hover:to-purple-800 transition-all duration-200 disabled:opacity-50 disabled:cursor-not-allowed">
                        <span class="flex items-center justify-center">
                            <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zM6.293 6.707a1 1 0 010-1.414l3-3a1 1 0 011.414 0l3 3a1 1 0 01-1.414 1.414L11 5.414V13a1 1 0 11-2 0V5.414L7.707 6.707a1 1 0 01-1.414 0z" clip-rule="evenodd"/>
                            </svg>
                            Загрузить и обработать
                        </span>
                    </button>
                </form>
                
                <!-- Progress Bar -->
                <div id="upload-progress" class="hidden mt-4">
                    <div class="flex justify-between text-sm text-gray-600 mb-1">
                        <span>Загрузка...</span>
                        <span id="progress-percent">0%</span>
                    </div>
                    <div class="w-full bg-gray-200 rounded-full h-2">
                        <div id="progress-bar" class="bg-purple-600 h-2 rounded-full transition-all duration-300" style="width: 0%"></div>
                    </div>
                </div>
            </div>
            
            <!-- Testing & Validation Section -->
            <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6">
                <h3 class="text-xl font-semibold text-gray-800 mb-4 flex items-center">
                    <svg class="w-6 h-6 mr-2 text-green-600" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"/>
                    </svg>
                    Тестирование и проверка
                </h3>
                
                <div class="space-y-3">
                    <button onclick="runFullSystemTest()" class="w-full bg-gradient-to-r from-green-600 to-green-700 text-white py-3 px-4 rounded-lg font-medium hover:from-green-700 hover:to-green-800 transition-all duration-200">
                        <span class="flex items-center justify-center">
                            <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"/>
                            </svg>
                            Полная проверка системы
                        </span>
                    </button>
                    
                    <button onclick="testColumnMapping()" class="w-full bg-gradient-to-r from-blue-600 to-blue-700 text-white py-3 px-4 rounded-lg font-medium hover:from-blue-700 hover:to-blue-800 transition-all duration-200">
                        <span class="flex items-center justify-center">
                            <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20">
                                <path d="M5 3a2 2 0 00-2 2v2a2 2 0 002 2h2a2 2 0 002-2V5a2 2 0 00-2-2H5zM5 11a2 2 0 00-2 2v2a2 2 0 002 2h2a2 2 0 002-2v-2a2 2 0 00-2-2H5zM11 5a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2V5zM11 13a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2v-2z"/>
                            </svg>
                            Проверить 77 колонок
                        </span>
                    </button>
                    
                    <button onclick="testNewDataCreation()" class="w-full bg-gradient-to-r from-orange-600 to-orange-700 text-white py-3 px-4 rounded-lg font-medium hover:from-orange-700 hover:to-orange-800 transition-all duration-200">
                        <span class="flex items-center justify-center">
                            <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M10 3a1 1 0 011 1v5h5a1 1 0 110 2h-5v5a1 1 0 11-2 0v-5H4a1 1 0 110-2h5V4a1 1 0 011-1z" clip-rule="evenodd"/>
                            </svg>
                            Тест создания новых ЖК
                        </span>
                    </button>
                    
                    <button onclick="validateDataIntegrity()" class="w-full bg-gradient-to-r from-indigo-600 to-indigo-700 text-white py-3 px-4 rounded-lg font-medium hover:from-indigo-700 hover:to-indigo-800 transition-all duration-200">
                        <span class="flex items-center justify-center">
                            <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M2.166 4.999A11.954 11.954 0 0010 1.944 11.954 11.954 0 0017.834 5c.11.65.166 1.32.166 2.001 0 5.225-3.34 9.67-8 11.317C5.34 16.67 2 12.225 2 7c0-.682.057-1.35.166-2.001zm11.541 3.708a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"/>
                            </svg>
                            Проверить целостность данных
                        </span>
                    </button>
                </div>
            </div>
        </div>
        
        <!-- Results Section -->
        <div id="test-results" class="mt-8 bg-gray-50 rounded-xl p-6 hidden">
            <h3 class="text-lg font-semibold text-gray-800 mb-4">Результаты тестирования</h3>
            <div id="test-output" class="bg-white rounded-lg p-4 border max-h-96 overflow-y-auto">
                <pre class="text-sm text-gray-700 whitespace-pre-wrap" id="test-log"></pre>
            </div>
        </div>
        
        <!-- Upload Results -->
        <div id="upload-results" class="mt-8 bg-gray-50 rounded-xl p-6 hidden">
            <h3 class="text-lg font-semibold text-gray-800 mb-4">Результаты загрузки</h3>
            <div id="upload-output" class="bg-white rounded-lg p-4 border">
                <div id="upload-log" class="text-sm text-gray-700"></div>
            </div>
        </div>
    </div>
</div>

<script>
// Функция для склонения русских слов
function pluralize(count, one, few, many) {
    const mod10 = count % 10;
    const mod100 = count % 100;
    
    if (mod10 === 1 && mod100 !== 11) {
        return one;  // 1, 21, 31... квартира
    } else if (mod10 >= 2 && mod10 <= 4 && (mod100 < 10 || mod100 >= 20)) {
        return few;  // 2-4, 22-24... квартиры
    } else {
        return many; // 0, 5-20, 25-30... квартир
    }
}

// Обновление счетчика квартир с правильным склонением
function updateFavoritesCounter(count) {
    const countElement = document.getElementById('favorites-count');
    const labelElement = document.getElementById('favorites-count-label');
    
    if (countElement) countElement.textContent = count;
    if (labelElement) labelElement.textContent = pluralize(count, 'квартира', 'квартиры', 'квартир');
}


// Dashboard tab switching functionality
(function() {
    'use strict';
    
    function initializeDashboardTabs() {
        console.log('Initializing dashboard tabs...');
        
        const tabButtons = document.querySelectorAll('.tab-button');
        const contentSections = document.querySelectorAll('.content-section');
        
        console.log('Found tab buttons:', tabButtons.length);
        console.log('Found content sections:', contentSections.length);
        
        if (tabButtons.length === 0) {
            console.warn('No tab buttons found');
            return;
        }
        
        tabButtons.forEach(function(button, index) {
            button.addEventListener('click', function(e) {
                e.preventDefault();
                console.log('Tab clicked:', this.dataset.page);
                
                // ✅ Обновляем счетчики при переходе на табы избранного и сравнения
                if (this.dataset.page === 'favorites' || this.dataset.page === 'comparison') {
                    updateTopMenuCounters();
                }
                
                // ✅ Загружаем презентации при открытии вкладки рекомендаций
                if (this.dataset.page === 'recommendations') {
                    console.log('📦 Loading collections for recommendations tab...');
                    if (typeof loadUserCollections === 'function') {
                        loadUserCollections();
                    }
                }
                
                // Remove active class from all buttons
                tabButtons.forEach(function(btn) {
                    btn.classList.remove('active');
                    btn.classList.remove('border-[#0088CC]', 'text-[#0088CC]');
                    btn.classList.add('border-transparent', 'text-gray-500');
                });
                
                // Hide all content sections
                contentSections.forEach(function(section) {
                    section.classList.remove('active');
                });
                
                // Add active class to clicked button
                this.classList.add('active');
                this.classList.remove('border-transparent', 'text-gray-500');
                this.classList.add('border-[#0088CC]', 'text-[#0088CC]');
                
                // Show corresponding content section
                const targetPage = this.dataset.page;
                const targetSection = document.getElementById(targetPage);
                if (targetSection) {
                    targetSection.classList.add('active');
                    console.log('Activated section:', targetPage);
                    
                    // Load favorites when favorites section is activated
                    if (targetPage === 'favorites') {
                        console.log('Loading favorites list...');
                        setTimeout(() => {
                            loadFavoritesList(); // Загружает объекты и ЖК (через createComplexCard)
                            updateFavoritesCounters(); // Обновление счетчиков
                        }, 100);
                    }
                    
                    // Load comparison content when comparison section is activated
                    if (targetPage === 'comparison') {
                        console.log('Loading comparison content...');
                        setTimeout(() => {
                            loadComparisonContent();
                            updateDashboardCounters();
                        }, 100);
                    }
                } else {
                    console.warn('Target section not found:', targetPage);
                }
            });
        });
        
        console.log('Dashboard tabs initialized successfully');
    }
    
    // Initialize when DOM is ready
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', initializeDashboardTabs);
    } else {
        initializeDashboardTabs();
    }
    
    // Handle hash navigation (e.g., /dashboard#favorites)
    function handleHashNavigation() {
        const hash = window.location.hash.substring(1); // Remove # from hash
        if (hash) {
            console.log('Hash detected:', hash);
            const tabButton = document.querySelector(`.tab-button[data-page="${hash}"]`);
            if (tabButton) {
                console.log('Clicking tab button for:', hash);
                tabButton.click();
            }
        }
    }
    
    // Handle hash on page load
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', handleHashNavigation);
    } else {
        setTimeout(handleHashNavigation, 100); // Small delay to ensure tabs are initialized
    }
    
    // Handle hash changes (when clicking browser back/forward)
    window.addEventListener('hashchange', handleHashNavigation);
})();

// ✅ ОПТИМИЗАЦИЯ: Предзагрузка данных при открытии dashboard
// Загружаем избранное, счетчики и сделки сразу, не дожидаясь кликов по вкладкам
(function preloadDashboardData() {
    console.log('🚀 Dashboard: Starting data preload...');
    
    // ✅ УДАЛЕНО: Предзагрузка избранного перенесена на клик по табу
    // Это предотвращает дублирующие API запросы
    // loadFavoritesList() теперь вызывается только при клике на таб "Избранное"
    
    // Предзагрузка счетчиков
    setTimeout(() => {
        console.log('📊 Preloading counters...');
        if (typeof updateDashboardCounters === 'function') {
            updateDashboardCounters();
        }
        if (typeof updateFavoritesCounters === 'function') {
            updateFavoritesCounters();
        }
        if (typeof updateTopMenuCounters === 'function') {
            updateTopMenuCounters();
        }
    }, 300);
    
    // Предзагрузка данных о сделках
    setTimeout(() => {
        console.log('📊 Preloading deals data...');
        if (typeof loadDeals === 'function') {
            loadDeals().catch(err => {
                console.error('❌ Error preloading deals:', err);
            });
        }
    }, 1000);
    
    console.log('✅ Dashboard preload initiated');
})();

// ✅ УДАЛЕНО: Дублирующая функция loadComplexFavorites с шаблоном heart icon
// Теперь используем только createComplexCard() с кнопкой "Удалить" через loadFavoritesList()

// Load favorites list for dashboard - ОПТИМИЗИРОВАНО: 1 запрос вместо 2-х
async function loadFavoritesList() {
    console.log('⚡ loadFavoritesList: НАЧАЛО (1 запрос)');
    const favoritesContainer = document.getElementById('favorites-list');
    const loadingElement = document.getElementById('favorites-loading');
    const emptyElement = document.getElementById('favorites-empty');
    const complexLoadingElement = document.getElementById('complex-loading');
    const complexEmptyElement = document.getElementById('complex-empty');
    const complexFavoritesList = document.getElementById('complex-favorites-list');
    
    if (!favoritesContainer) {
        console.error('Favorites container not found');
        return;
    }
    
    // Показываем загрузку
    if (loadingElement) loadingElement.classList.remove('hidden');
    if (emptyElement) emptyElement.classList.add('hidden');
    if (complexLoadingElement) complexLoadingElement.classList.remove('hidden');
    if (complexEmptyElement) complexEmptyElement.classList.add('hidden');
    
    // Очищаем контейнеры
    const existingCards = favoritesContainer.querySelectorAll('.property-card-wrapper, .favorite-card, [data-favorite-card]');
    existingCards.forEach(card => card.remove());
    
    if (complexFavoritesList) {
        const existingComplexCards = complexFavoritesList.querySelectorAll('.border');
        existingComplexCards.forEach(card => card.remove());
    }
    
    // ⚡ ОДИН ЗАПРОС для всего избранного
    try {
        const response = await fetch('/api/favorites/all', {
            method: 'GET',
            credentials: 'same-origin',
            headers: { 'Content-Type': 'application/json' }
        });
        
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}`);
        }
        
        const data = await response.json();
        console.log('⚡ Загружено за 1 запрос - квартиры:', data.properties?.length || 0, 'ЖК:', data.complexes?.length || 0);
        
        let totalCount = 0;
        
        // Добавляем квартиры
        if (data.properties && data.properties.length > 0) {
            data.properties.forEach((favorite) => {
                const favoriteCard = createFavoriteCard(favorite, !favorite.viewed);
                loadingElement.parentNode.insertBefore(favoriteCard, loadingElement);
                totalCount++;
            });
        }
        
        // Добавляем ЖК
        let complexCount = 0;
        if (data.complexes && data.complexes.length > 0 && complexFavoritesList) {
            data.complexes.forEach((complex, index) => {
                const complexCard = createComplexCard(complex, !complex.viewed);
                complexFavoritesList.appendChild(complexCard);
                complexCount++;
            });
        }
        
        // Обновляем UI
        if (loadingElement) loadingElement.classList.add('hidden');
        if (complexLoadingElement) complexLoadingElement.classList.add('hidden');
        
        if (totalCount === 0 && emptyElement) {
            emptyElement.classList.remove('hidden');
        }
        
        if (complexCount === 0 && complexEmptyElement) {
            complexEmptyElement.classList.remove('hidden');
        }
        
        // Обновляем счетчики
        updateFavoritesCounter(totalCount);
        
        console.log('✅ Избранное загружено за 1 запрос:', totalCount + complexCount);
        
    } catch (error) {
        console.error('❌ Ошибка загрузки избранного:', error);
        if (loadingElement) loadingElement.classList.add('hidden');
        if (complexLoadingElement) complexLoadingElement.classList.add('hidden');
        if (emptyElement) emptyElement.classList.remove('hidden');
        if (complexEmptyElement) complexEmptyElement.classList.remove('hidden');
    }
}

function createFavoriteCard(favorite, isNew = false) {
    const priceFormatted = favorite.price ? favorite.price.toLocaleString('ru-RU') + ' ₽' : 'Цена уточняется';
    const cashbackFormatted = favorite.cashback_amount ? '+' + favorite.cashback_amount.toLocaleString('ru-RU') + ' ₽' : '';
    
    const cardElement = document.createElement('div');
    cardElement.className = `border border-gray-200 rounded-lg p-4 hover:border-red-300 transition-colors ${isNew ? 'border-l-4 border-l-green-400' : ''}`;
    
    cardElement.innerHTML = `
        <div class="flex items-start space-x-4">
            <img src="${favorite.image}" 
                 alt="Квартира" class="w-16 h-12 object-cover rounded-lg">
            <div class="flex-1">
                <div class="flex items-center">
                    <h4 class="font-medium text-gray-900 text-sm">${favorite.title} в ${favorite.complex}</h4>
                    ${isNew ? '<span class="ml-2 bg-green-100 text-green-800 text-xs px-2 py-1 rounded">Новое</span>' : ''}
                </div>
                <p class="text-xs text-gray-600 mt-1">${favorite.district} • Новостройка</p>
                <p class="text-xs text-gray-500 mt-1">Добавлено: ${favorite.created_at || 'Недавно'}</p>
                <div class="flex items-center justify-between mt-2">
                    <div>
                        <span class="text-sm font-bold text-gray-900">${priceFormatted}</span>
                        ${cashbackFormatted ? `<span class="text-xs text-green-600 ml-1">${cashbackFormatted}</span>` : ''}
                    </div>
                    <div class="flex items-center space-x-2">
                        <button class="text-[#0088CC] hover:bg-blue-50 px-2 py-1 rounded text-xs" onclick="viewFavoriteProperty('${favorite.id}')">
                            Смотреть
                        </button>
                        <button class="text-red-600 hover:bg-red-50 px-2 py-1 rounded text-xs" onclick="removePropertyFromFavorites('${favorite.id}', this.closest('.border'))">
                            Удалить
                        </button>
                    </div>
                </div>
            </div>
        </div>
    `;
    
    return cardElement;
}

// ✅ ДОБАВЛЕНО: Функция создания карточек ЖК
function createComplexCard(complex, isNew = false) {
    const priceFormatted = complex.min_price ? `от ${(complex.min_price / 1000000).toFixed(1)} млн ₽` : 'Цена уточняется';
    const cashbackRate = complex.cashback_rate || 5; // Используем динамический кэшбек из админ панели
    
    // ✅ ЛОГИКА для второго фото ЖК
    let complexImage = complex.image || 'https://images.unsplash.com/photo-1600607687920-4e2a09cf159d?ixlib=rb-4.0.3&auto=format&fit=crop&w=80&h=60&q=80';
    
    // Если есть массив photos, берем вторую фотографию (индекс 1)
    if (complex.photos && Array.isArray(complex.photos) && complex.photos.length > 1) {
        complexImage = complex.photos[1];
    }
    // Если есть строка photos с разделителем, пробуем разделить и взять вторую
    else if (complex.photos && typeof complex.photos === 'string') {
        const photosArray = complex.photos.split(',').map(p => p.trim()).filter(p => p);
        if (photosArray.length > 1) {
            complexImage = photosArray[1];
        }
    }
    
    const cardElement = document.createElement('div');
    cardElement.className = `border border-gray-200 rounded-lg p-4 hover:border-blue-300 transition-colors ${isNew ? 'border-l-4 border-l-green-400' : ''}`;
    
    cardElement.innerHTML = `
        <div class="flex items-start space-x-4">
            <img src="${complexImage}" 
                 alt="ЖК" class="w-16 h-12 object-cover rounded-lg">
            <div class="flex-1">
                <div class="flex items-center">
                    <h4 class="font-medium text-gray-900 text-sm">${complex.name}</h4>
                    ${isNew ? '<span class="ml-2 bg-green-100 text-green-800 text-xs px-2 py-1 rounded">Новое</span>' : ''}
                </div>
                <p class="text-xs text-gray-600 mt-1">${complex.developer || 'Застройщик не указан'}</p>
                <p class="text-xs text-gray-500 mt-1">Добавлено: ${complex.created_at || 'Недавно'}</p>
                <div class="flex items-center justify-between mt-2">
                    <div>
                        <span class="text-sm font-bold text-gray-900">${priceFormatted}</span>
                        <span class="text-xs text-green-600 ml-1">кешбек ${cashbackRate}%</span>
                    </div>
                    <div class="flex items-center space-x-2">
                        <button class="text-[#0088CC] hover:bg-blue-50 px-2 py-1 rounded text-xs" onclick="viewComplexFavorite('${complex.id}')">
                            Смотреть
                        </button>
                        <button class="text-red-600 hover:bg-red-50 px-2 py-1 rounded text-xs" onclick="removeComplexFromFavorites('${complex.id}', this.closest('.border'))">
                            Удалить
                        </button>
                    </div>
                </div>
            </div>
        </div>
    `;
    
    return cardElement;
}

// ✅ ФУНКЦИИ для очистки всего избранного
function clearAllPropertyFavorites() {
    if (confirm('Вы уверены, что хотите удалить ВСЕ избранные квартиры?')) {
        // Отправляем запрос на удаление всех избранных объектов
        fetch('/api/favorites/clear-all', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': document.querySelector('meta[name="csrf-token"]')?.content || ''
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Обновляем UI
                const favoritesList = document.getElementById('favorites-list');
                const favoritesEmpty = document.getElementById('favorites-empty');
                const favoritesLoading = document.getElementById('favorites-loading');
                
                if (favoritesList) {
                    favoritesList.innerHTML = '';
                    favoritesList.appendChild(favoritesLoading);
                    favoritesList.appendChild(favoritesEmpty);
                    favoritesLoading.classList.add('hidden');
                    favoritesEmpty.classList.remove('hidden');
                }
                
                // Обновляем счетчики
                updateDashboardCounters();
                updateTopMenuCounters();
                
                console.log('✅ Все избранные квартиры удалены');
            } else {
                alert('Ошибка при удалении избранного: ' + (data.error || 'Неизвестная ошибка'));
            }
        })
        .catch(error => {
            console.error('Ошибка очистки избранного:', error);
            alert('Ошибка при удалении избранного');
        });
    }
}

function clearAllComplexFavorites() {
    if (confirm('Вы уверены, что хотите удалить ВСЕ избранные ЖК?')) {
        // Отправляем запрос на удаление всех избранных ЖК
        fetch('/api/complexes/favorites/clear-all', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': document.querySelector('meta[name="csrf-token"]')?.content || ''
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Обновляем UI
                const complexFavoritesList = document.getElementById('complex-favorites-list');
                
                if (complexFavoritesList) {
                    // Очищаем все карточки ЖК
                    const existingCards = complexFavoritesList.querySelectorAll('.border');
                    existingCards.forEach(card => card.remove());
                }
                
                // Обновляем счетчики
                updateDashboardCounters();
                updateTopMenuCounters();
                
                console.log('✅ Все избранные ЖК удалены');
            } else {
                alert('Ошибка при удалении избранных ЖК: ' + (data.error || 'Неизвестная ошибка'));
            }
        })
        .catch(error => {
            console.error('Ошибка очистки избранных ЖК:', error);
            alert('Ошибка при удалении избранных ЖК');
        });
    }
}

// Функция для просмотра избранного объекта с отметкой как просмотренного
async function viewFavoriteProperty(propertyId) {
    try {
        // Отмечаем объект как просмотренный
        await fetch(`/api/favorites/mark-viewed/${propertyId}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            }
        });
        
        // Переходим на страницу объекта
        window.location.href = `/object/${propertyId}`;
    } catch (error) {
        console.error('Error marking favorite as viewed:', error);
        // Все равно переходим на страницу, даже если не удалось отметить
        window.location.href = `/object/${propertyId}`;
    }
}

// Функция для просмотра избранного ЖК с отметкой как просмотренного
async function viewComplexFavorite(complexId) {
    try {
        // Отмечаем ЖК как просмотренный
        await fetch(`/api/complexes/favorites/mark-viewed/${complexId}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            }
        });
        
        // Переходим на страницу ЖК
        window.location.href = `/residential-complex/${complexId}`;
    } catch (error) {
        console.error('Error marking complex favorite as viewed:', error);
        // Все равно переходим на страницу, даже если не удалось отметить
        window.location.href = `/residential-complex/${complexId}`;
    }
}

// ✅ ФУНКЦИИ для удаления отдельных объектов из избранного
function removePropertyFromFavorites(propertyId, cardElement) {
    if (confirm('Удалить квартиру из избранного?')) {
        // Отправляем запрос на удаление
        fetch(`/api/favorites/${propertyId}`, {
            method: 'DELETE',
            headers: {
                'Content-Type': 'application/json',
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Удаляем карточку из UI
                if (cardElement) {
                    cardElement.style.opacity = '0.5';
                    setTimeout(() => {
                        cardElement.remove();
                        // Обновляем счетчики
                        updateDashboardCounters();
                        updateTopMenuCounters();
                        if (typeof updateHeaderFavoritesCount === 'function') {
                            updateHeaderFavoritesCount();
                        }
                    }, 200);
                }
                console.log('✅ Квартира удалена из избранного:', propertyId);
            } else {
                alert('Ошибка при удалении из избранного: ' + (data.error || 'Неизвестная ошибка'));
            }
        })
        .catch(error => {
            console.error('Ошибка удаления из избранного:', error);
            alert('Ошибка при удалении из избранного');
        });
    }
}

function removeComplexFromFavorites(complexId, cardElement) {
    if (confirm('Удалить ЖК из избранного?')) {
        // Отправляем запрос на удаление ЖК
        fetch(`/api/complexes/favorites/${complexId}`, {
            method: 'DELETE',
            headers: {
                'Content-Type': 'application/json',
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Удаляем карточку из UI
                if (cardElement) {
                    cardElement.style.opacity = '0.5';
                    setTimeout(() => {
                        cardElement.remove();
                        // Обновляем счетчики
                        updateDashboardCounters();
                        updateTopMenuCounters();
                        if (typeof updateHeaderFavoritesCount === 'function') {
                            updateHeaderFavoritesCount();
                        }
                    }, 200);
                }
                console.log('✅ ЖК удален из избранного:', complexId);
            } else {
                alert('Ошибка при удалении ЖК из избранного: ' + (data.error || 'Неизвестная ошибка'));
            }
        })
        .catch(error => {
            console.error('Ошибка удаления ЖК из избранного:', error);
            alert('Ошибка при удалении ЖК из избранного');
        });
    }
}
</script>

<!-- Dashboard JavaScript Modules -->
<!-- favorites.js is loaded in base.html to avoid duplicate loading -->
<script src="{{ url_for('static', filename='js/saved_searches.js') }}"></script>
<script src="{{ url_for('static', filename='js/alert-settings.js') }}"></script>

<script>
// Dashboard initialization and counter updates
(function() {
    'use strict';
    
    // ✅ ИСПРАВЛЕНО: Делаем функцию глобальной для доступа везде
    window.updateDashboardCounters = function updateDashboardCounters() {
        // ✅ ИСПРАВЛЕНО: НЕ затираем счетчик квартир - за него отвечает updateFavoritesCounters()
        // Счетчик квартир обновляется только при переходе на таб "Избранное"
        
        // ✅ ИСПРАВЛЕНО: Update complex favorites counters from API
        // ✅ ИСПРАВЛЕНО: Используем правильный endpoint для обычных пользователей
        fetch('/api/complexes/favorites/list')
            .then(response => response.json())
            .then(data => {
                const complexesCount = data.complexes ? data.complexes.length : 0;
                const complexFavCountElement = document.getElementById('complex-favorites-count');
                if (complexFavCountElement) complexFavCountElement.textContent = complexesCount;
                console.log('🔥 Dashboard: Updated complex favorites counter:', complexesCount);
            })
            .catch(error => {
                console.log('Could not load complex favorites count');
            });
        
        // ✅ ИСПРАВЛЕНО: Update comparison counters from multiple sources
        // Try new format first, then fallback to old formats
        let comparisonProperties = JSON.parse(localStorage.getItem('comparisons') || '[]');
        if (comparisonProperties.length === 0) {
            comparisonProperties = JSON.parse(localStorage.getItem('comparison_properties') || '[]');
        }
        
        const comparisonComplexes = JSON.parse(localStorage.getItem('comparison_complexes') || '[]');
        
        const propCompCountElement = document.getElementById('comparison-properties-count');
        const complexCompCountElement = document.getElementById('comparison-complexes-count');
        
        if (propCompCountElement) propCompCountElement.textContent = comparisonProperties.length;
        if (complexCompCountElement) complexCompCountElement.textContent = comparisonComplexes.length;
        
        // Update saved searches counter
        updateSavedSearchesCounter();
    }
    
    function updateSavedSearchesCounter() {
        // This will be updated by the SavedSearchesManager when it loads
        fetch('/api/user/saved-searches/count')
            .then(response => response.json())
            .then(data => {
                const savedSearchesCountElement = document.getElementById('saved-searches-count');
                if (savedSearchesCountElement && data.success) {
                    savedSearchesCountElement.textContent = data.count;
                }
            })
            .catch(error => {
                console.log('Could not load saved searches count');
            });
    }

    // ✅ НОВАЯ ФУНКЦИЯ: Обновление счетчиков в горизонтальном меню
    window.updateTopMenuCounters = function updateTopMenuCounters() {
        // Обновляем счетчик избранного в горизонтальном меню (квартиры + ЖК)
        Promise.all([
            fetch('/api/favorites/list').then(r => r.json()),
            fetch('/api/complexes/favorites/list').then(r => r.json())
        ]).then(([propertiesData, complexesData]) => {
            const propertiesCount = propertiesData.success ? (propertiesData.favorites?.length || 0) : 0;
            const complexesCount = complexesData.complexes?.length || 0;
            const totalFavoritesCount = propertiesCount + complexesCount;
            
            const topFavElement = document.getElementById('top-favorites-count');
            if (topFavElement) {
                topFavElement.textContent = totalFavoritesCount;
                console.log('🏠 Обновлен счетчик избранного в меню:', totalFavoritesCount, '(', propertiesCount, 'квартир +', complexesCount, 'ЖК)');
            }
        }).catch(error => console.log('Ошибка обновления счетчика избранного в меню:', error));

        // Обновляем счетчик сравнения в горизонтальном меню
        updateComparisonCounterMenu();
    };

    // ✅ НОВАЯ ФУНКЦИЯ: Обновление счетчика сравнения в меню
    // ✅ ИСПРАВЛЕННАЯ ФУНКЦИЯ: Получение счетчиков сравнения из API
    window.updateComparisonCounterMenu = async function updateComparisonCounterMenu() {
        try {
            console.log('🔄 Обновляем счетчики сравнения для пользователя из API...');
            
            let propertiesCount = 0;
            let complexesCount = 0;
            
            // ✅ FIX: Use the improved /api/user/comparison/load endpoint that returns counts
            const isManager = Boolean(window.manager_authenticated);
            const endpoint = isManager ? '/api/manager/comparison/load' : '/api/user/comparison/load';
            
            try {
                const response = await fetch(endpoint);
                if (response.ok) {
                    const data = await response.json();
                    propertiesCount = data.properties_count || (data.properties ? data.properties.length : 0);
                    complexesCount = data.complexes_count || (data.complexes ? data.complexes.length : 0);
                    console.log('🏠 Квартир в сравнении из API:', propertiesCount);
                    console.log('🏢 ЖК в сравнении из API:', complexesCount);
                }
            } catch (error) {
                console.log('Ошибка загрузки счетчиков сравнения:', error);
            }
            
            // Общий счетчик
            const totalCount = propertiesCount + complexesCount;
            
            const compElement = document.getElementById('comparison-count');
            if (compElement) {
                compElement.textContent = totalCount;
                console.log('⚖️ Обновлен счетчик сравнения в меню:', totalCount, '(', propertiesCount, 'квартир +', complexesCount, 'ЖК)');
            }
            
            // Also update detailed counters if they exist
            const propCompCountElement = document.getElementById('comparison-properties-count');
            const complexCompCountElement = document.getElementById('comparison-complexes-count');
            if (propCompCountElement) propCompCountElement.textContent = propertiesCount;
            if (complexCompCountElement) complexCompCountElement.textContent = complexesCount;
        } catch (error) {
            console.log('Ошибка обновления счетчика сравнения:', error);
        }
    };
    
    function loadFavoritesContent() {
        console.log('🔥 Dashboard: loadFavoritesContent() готова (загрузка по клику на таб)');
        // ✅ ИСПРАВЛЕНО: Не загружаем данные здесь - они загружаются при клике на таб "Избранное"
        // Это предотвращает дублирующие API запросы
        // loadFavoritesList() вызывается только в обработчике клика по табу (line ~1857)
    }
    
    // ✅ НОВАЯ ПРОСТАЯ ФУНКЦИЯ: Отображение карточек избранного
    async function showFavoritesCards() {
        console.log('🚀 showFavoritesCards() ЗАПУЩЕНА!');
        
        const container = document.getElementById('new-favorites-container');
        const loading = document.getElementById('new-favorites-loading');
        const empty = document.getElementById('new-favorites-empty');
        
        if (!container) {
            console.error('❌ Контейнер new-favorites-container не найден!');
            return;
        }
        
        console.log('✅ Элементы найдены, начинаем загрузку...');
        
        // Показываем загрузку
        loading.classList.remove('hidden');
        empty.classList.add('hidden');
        container.innerHTML = '';
        
        let totalCards = 0;
        
        // Загружаем квартиры
        try {
            console.log('📡 Загружаю квартиры...');
            const response = await fetch('/api/favorites/list');
            if (response.ok) {
                const data = await response.json();
                console.log('🏠 Квартиры получены:', data.success ? data.favorites?.length || 0 : 0);
                
                if (data.success && data.favorites && data.favorites.length > 0) {
                    data.favorites.forEach(item => {
                        const card = createSimpleCard(item, 'квартира');
                        container.appendChild(card);
                        totalCards++;
                    });
                }
            }
        } catch (error) {
            console.error('❌ Ошибка загрузки квартир:', error);
        }
        
        // Загружаем ЖК
        try {
            console.log('📡 Загружаю ЖК...');
            const response = await fetch('/api/complexes/favorites/list');
            if (response.ok) {
                const data = await response.json();
                console.log('🏢 ЖК получены:', data.complexes?.length || 0);
                
                if (data.complexes && data.complexes.length > 0) {
                    data.complexes.forEach(item => {
                        const card = createSimpleCard(item, 'жк');
                        container.appendChild(card);
                        totalCards++;
                    });
                }
            }
        } catch (error) {
            console.error('❌ Ошибка загрузки ЖК:', error);
        }
        
        // Показываем результат
        loading.classList.add('hidden');
        
        if (totalCards > 0) {
            console.log('🎉 Отображено карточек:', totalCards);
        } else {
            empty.classList.remove('hidden');
            console.log('📭 Нет данных для отображения');
        }
    }
    
    // ✅ СОЗДАНИЕ ПРОСТЫХ КАРТОЧЕК
    function createSimpleCard(item, type) {
        const card = document.createElement('div');
        card.className = 'bg-white border rounded-lg p-4 shadow-sm hover:shadow-md transition-shadow';
        
        const isProperty = type === 'квартира';
        const title = isProperty ? item.title : item.name;
        const price = isProperty ? 
            (item.price ? item.price.toLocaleString('ru-RU') + ' ₽' : 'Цена уточняется') :
            (item.min_price ? 'от ' + item.min_price.toLocaleString('ru-RU') + ' ₽' : 'Цена уточняется');
        
        card.innerHTML = `
            <div class="flex items-start space-x-3">
                <img src="${item.image || '/static/images/default-property.jpg'}" 
                     alt="${title}" 
                     class="w-16 h-12 object-cover rounded">
                <div class="flex-1 min-w-0">
                    <h4 class="font-medium text-gray-900 text-sm truncate">${title}</h4>
                    <p class="text-xs text-gray-500 mt-1">${isProperty ? item.complex : item.address}</p>
                    <p class="text-sm font-semibold text-blue-600 mt-2">${price}</p>
                    <span class="inline-block bg-gray-100 text-gray-700 text-xs px-2 py-1 rounded mt-2">
                        ${type === 'квартира' ? '🏠 Квартира' : '🏢 ЖК'}
                    </span>
                </div>
            </div>
        `;
        
        return card;
    }
    
    // ✅ НОВАЯ ФУНКЦИЯ: Обход проблемы кеширования
    window.displayFavoritesNow = async function() {
        console.log('🚀🚀🚀 displayFavoritesNow() ЗАПУЩЕНА ПРИНУДИТЕЛЬНО!');
        
        const container = document.getElementById('new-favorites-container');
        const loading = document.getElementById('new-favorites-loading');
        const empty = document.getElementById('new-favorites-empty');
        
        if (!container) {
            console.error('❌ Контейнер new-favorites-container не найден!');
            alert('❌ Контейнер не найден!');
            return;
        }
        
        console.log('✅ Элементы найдены, начинаем загрузку принудительно...');
        
        // Показываем загрузку
        loading.classList.remove('hidden');
        empty.classList.add('hidden');
        container.innerHTML = '';
        
        let totalCards = 0;
        
        // Загружаем квартиры
        try {
            console.log('📡 ПРИНУДИТЕЛЬНО загружаю квартиры...');
            const response = await fetch('/api/favorites/list');
            console.log('📡 Response status:', response.status);
            
            if (response.ok) {
                const data = await response.json();
                console.log('🏠 ПРИНУДИТЕЛЬНО получены квартиры:', data.success ? data.favorites?.length || 0 : 0);
                console.log('🏠 Полные данные квартир:', data);
                
                if (data.success && data.favorites && data.favorites.length > 0) {
                    data.favorites.forEach((item, index) => {
                        console.log(`🏠 Создаю карточку квартиры ${index + 1}:`, item.title);
                        const card = createSimpleCard(item, 'квартира');
                        container.appendChild(card);
                        totalCards++;
                    });
                }
            } else {
                console.error('❌ Ошибка response квартир:', response.status);
            }
        } catch (error) {
            console.error('❌ Критическая ошибка загрузки квартир:', error);
        }
        
        // Загружаем ЖК
        try {
            console.log('📡 ПРИНУДИТЕЛЬНО загружаю ЖК...');
            const response = await fetch('/api/complexes/favorites/list');
            console.log('📡 ЖК Response status:', response.status);
            
            if (response.ok) {
                const data = await response.json();
                console.log('🏢 ПРИНУДИТЕЛЬНО получены ЖК:', data.complexes?.length || 0);
                console.log('🏢 Полные данные ЖК:', data);
                
                if (data.complexes && data.complexes.length > 0) {
                    data.complexes.forEach((item, index) => {
                        console.log(`🏢 Создаю карточку ЖК ${index + 1}:`, item.name);
                        const card = createSimpleCard(item, 'жк');
                        container.appendChild(card);
                        totalCards++;
                    });
                }
            } else {
                console.error('❌ Ошибка response ЖК:', response.status);
            }
        } catch (error) {
            console.error('❌ Критическая ошибка загрузки ЖК:', error);
        }
        
        // Показываем результат
        loading.classList.add('hidden');
        
        if (totalCards > 0) {
            console.log('🎉 ПРИНУДИТЕЛЬНО отображено карточек:', totalCards);
            alert(`🎉 Показано ${totalCards} карточек избранного!`);
        } else {
            empty.classList.remove('hidden');
            console.log('📭 ПРИНУДИТЕЛЬНО: Нет данных для отображения');
            alert('📭 Нет данных для отображения');
        }
    }
    
    // ✅ ОПТИМИЗИРОВАННАЯ ФУНКЦИЯ: 1 запрос вместо 2-х для счетчиков
    window.updateFavoritesCounters = async function() {
        console.log('⚡ updateFavoritesCounters: НАЧАЛО (1 запрос)');
        
        try {
            const response = await fetch('/api/favorites/all');
            if (!response.ok) {
                throw new Error(`HTTP ${response.status}`);
            }
            
            const data = await response.json();
            const propCount = data.properties?.length || 0;
            const complexCount = data.complexes?.length || 0;
            
            console.log('⚡ Загружено за 1 запрос - квартиры:', propCount, 'ЖК:', complexCount);
            
            // Обновляем счетчик квартир
            const countElement = document.getElementById('favorites-count');
            if (countElement) {
                countElement.textContent = propCount;
            }
            
            // Обновляем счетчик ЖК
            const complexCountElement = document.getElementById('complex-favorites-count');
            if (complexCountElement) {
                complexCountElement.textContent = complexCount;
            }
            
            console.log('✅ Счетчики обновлены за 1 запрос!');
            
        } catch (error) {
            console.error('❌ Ошибка обновления счетчиков:', error);
        }
    }
    
    // ⭐ НОВАЯ ФУНКЦИЯ ДЛЯ НОВОГО ТАБА: Простое избранное
    window.loadMyFavorites = async function() {
        console.log('⭐⭐⭐ loadMyFavorites() ЗАПУЩЕНА ДЛЯ НОВОГО ТАБА!');
        
        const loading = document.getElementById('my-fav-loading');
        const grid = document.getElementById('my-fav-grid');
        const empty = document.getElementById('my-fav-empty');
        const counter = document.getElementById('my-fav-count');
        
        if (!loading || !grid || !empty) {
            console.error('❌ Элементы нового таба не найдены!');
            alert('❌ Ошибка: элементы не найдены');
            return;
        }
        
        console.log('✅ Элементы нового таба найдены, начинаем загрузку...');
        
        // Показываем загрузку
        loading.classList.remove('hidden');
        empty.classList.add('hidden');
        grid.innerHTML = '';
        
        let totalCount = 0;
        
        try {
            // Загружаем квартиры
            console.log('📡 [НОВЫЙ ТАБ] Загружаю квартиры...');
            const propResponse = await fetch('/api/favorites/list');
            console.log('📡 [НОВЫЙ ТАБ] Response квартир status:', propResponse.status);
            
            if (propResponse.ok) {
                const propData = await propResponse.json();
                console.log('🏠 [НОВЫЙ ТАБ] Данные квартир:', propData);
                
                if (propData.success && propData.favorites && propData.favorites.length > 0) {
                    propData.favorites.forEach((item, index) => {
                        console.log(`🏠 [НОВЫЙ ТАБ] Создаю карточку квартиры ${index + 1}:`, item.title);
                        const card = createMyFavCard(item, 'квартира');
                        grid.appendChild(card);
                        totalCount++;
                    });
                }
            }
            
            // Загружаем ЖК
            console.log('📡 [НОВЫЙ ТАБ] Загружаю ЖК...');
            const complexResponse = await fetch('/api/complexes/favorites/list');
            console.log('📡 [НОВЫЙ ТАБ] Response ЖК status:', complexResponse.status);
            
            if (complexResponse.ok) {
                const complexData = await complexResponse.json();
                console.log('🏢 [НОВЫЙ ТАБ] Данные ЖК:', complexData);
                
                if (complexData.complexes && complexData.complexes.length > 0) {
                    complexData.complexes.forEach((item, index) => {
                        console.log(`🏢 [НОВЫЙ ТАБ] Создаю карточку ЖК ${index + 1}:`, item.name);
                        const card = createMyFavCard(item, 'жк');
                        grid.appendChild(card);
                        totalCount++;
                    });
                }
            }
            
        } catch (error) {
            console.error('❌ [НОВЫЙ ТАБ] Критическая ошибка:', error);
        }
        
        // Показываем результат
        loading.classList.add('hidden');
        
        if (totalCount > 0) {
            console.log('🎉 [НОВЫЙ ТАБ] Отображено карточек:', totalCount);
            if (counter) counter.textContent = totalCount;
            alert(`🎉 В новом табе показано ${totalCount} объектов избранного!`);
        } else {
            empty.classList.remove('hidden');
            console.log('📭 [НОВЫЙ ТАБ] Нет данных для отображения');
            alert('📭 Нет данных в новом табе');
        }
    }
    
    // ⭐ СОЗДАНИЕ КАРТОЧЕК ДЛЯ НОВОГО ТАБА
    function createMyFavCard(item, type) {
        const card = document.createElement('div');
        card.className = 'bg-gradient-to-br from-white to-gray-50 border border-gray-200 rounded-xl p-6 shadow-lg hover:shadow-xl transition-all duration-300 hover:-translate-y-1';
        
        const isProperty = type === 'квартира';
        const title = isProperty ? item.title : item.name;
        const price = isProperty ? 
            (item.price ? item.price.toLocaleString('ru-RU') + ' ₽' : 'Цена уточняется') :
            (item.min_price ? 'от ' + item.min_price.toLocaleString('ru-RU') + ' ₽' : 'Цена уточняется');
        
        const typeIcon = isProperty ? '🏠' : '🏢';
        const typeText = isProperty ? 'Квартира' : 'ЖК';
        const location = isProperty ? item.complex : item.address;
        
        card.innerHTML = `
            <div class="flex flex-col h-full">
                <div class="relative mb-4">
                    <img src="${item.image || '/static/images/default-property.jpg'}" 
                         alt="${title}" 
                         class="w-full h-48 object-cover rounded-lg">
                    <span class="absolute top-2 right-2 bg-green-600 text-white text-xs px-3 py-1 rounded-full font-medium">
                        ${typeIcon} ${typeText}
                    </span>
                </div>
                
                <div class="flex-1 flex flex-col">
                    <h4 class="font-bold text-gray-900 text-lg mb-2 line-clamp-2">${title}</h4>
                    <p class="text-sm text-gray-600 mb-3 flex-1">${location}</p>
                    <div class="border-t pt-4">
                        <p class="text-xl font-bold text-green-600 mb-3">${price}</p>
                        <button class="w-full bg-green-600 text-white py-2 px-4 rounded-lg hover:bg-green-700 transition-colors font-medium">
                            Подробнее
                        </button>
                    </div>
                </div>
            </div>
        `;
        
        return card;
    }
    
    // ✅ ИСПРАВЛЕНО: PostgreSQL + localStorage поддержка для внешних URL
    window.loadComparisonContent = async function loadComparisonContent() {
        let comparisonProperties = [];
        let comparisonComplexes = [];
        
        try {
            // 🔥 НОВОЕ: Сначала пытаемся загрузить из PostgreSQL API
            const isManager = Boolean(window.manager_authenticated);
            const endpoint = isManager ? '/api/manager/comparison/load' : '/api/user/comparison/load';
            const response = await fetch(endpoint);
            const data = await response.json();
            
            if (data.success) {
                comparisonProperties = (data.properties || []).map(p => String(p));
                comparisonComplexes = (data.complexes || []).map(c => String(c));
                console.log('✅ Дашборд: Загружено из PostgreSQL - квартиры:', comparisonProperties.length, 'ЖК:', comparisonComplexes.length);
            } else {
                throw new Error('API не вернул успешный результат');
            }
        } catch (error) {
            console.log('ℹ️ Дашборд: PostgreSQL недоступен, используем localStorage fallback');
            
            // 📦 FALLBACK: Используем localStorage если API недоступен
            comparisonProperties = JSON.parse(localStorage.getItem('comparisons') || '[]');
            
            // Fallback to comparison-data format if comparisons is empty
            if (comparisonProperties.length === 0) {
                const comparisonData = JSON.parse(localStorage.getItem('comparison-data') || '{"properties": [], "complexes": []}');
                comparisonProperties = comparisonData.properties || [];
            }
            
            // Last fallback to old format
            if (comparisonProperties.length === 0) {
                comparisonProperties = JSON.parse(localStorage.getItem('comparison_properties') || '[]');
            }
            
            comparisonComplexes = JSON.parse(localStorage.getItem('comparison_complexes') || '[]');
        }
        
        const propertiesComparisonList = document.getElementById('properties-comparison-list');
        const complexesComparisonList = document.getElementById('complexes-comparison-list');
        const quickComparisonGrid = document.getElementById('quickComparisonGrid');
        const detailedComparisonContainer = document.getElementById('detailedComparisonContainer');
        
        console.log('Loading comparison content - properties:', comparisonProperties.length, 'complexes:', comparisonComplexes.length);
        
        // Handle quick comparison grid (for comparison.js compatibility)
        if (quickComparisonGrid && detailedComparisonContainer) {
            loadQuickComparisonContent(comparisonProperties, quickComparisonGrid, detailedComparisonContainer);
        }
        
        // Properties comparison content with detailed cards
        if (propertiesComparisonList) {
            if (comparisonProperties.length > 0) {
                loadPropertiesComparisonData(comparisonProperties, propertiesComparisonList);
            } else {
                propertiesComparisonList.innerHTML = `
                    <div class="text-center py-8">
                        <svg class="w-16 h-16 mx-auto text-gray-300 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"></path>
                        </svg>
                        <p class="text-gray-500 text-sm mb-2">Пока вы не добавили объекты в сравнение</p>
                        <p class="text-gray-400 text-xs">Добавьте объекты из каталога для их сравнения</p>
                    </div>
                `;
            }
        }
        
        // Complexes comparison content
        if (complexesComparisonList) {
            if (comparisonComplexes.length > 0) {
                loadComplexesComparisonData(comparisonComplexes, complexesComparisonList);
            } else {
                complexesComparisonList.innerHTML = `
                    <div class="text-center py-8">
                        <svg class="w-16 h-16 mx-auto text-gray-300 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"></path>
                        </svg>
                        <p class="text-gray-500 text-sm mb-2">Пока вы не добавили ЖК в сравнение</p>
                        <p class="text-gray-400 text-xs">Добавьте жилые комплексы для их сравнения</p>
                    </div>
                `;
            }
        }
    }
    
    // New function for quick comparison content
    async function loadQuickComparisonContent(propertyIds, quickGrid, detailedContainer) {
        if (propertyIds.length === 0) {
            quickGrid.innerHTML = '<div class="col-span-full text-center py-8 text-gray-500">Объекты для сравнения не найдены<br><small class="text-xs mt-2">Добавьте объекты в сравнение на странице каталога</small></div>';
            detailedContainer.innerHTML = '<div class="text-center py-8 text-gray-500">Объекты для сравнения не найдены</div>';
            return;
        }
        
        // Show loading state
        quickGrid.innerHTML = '<div class="col-span-full text-center py-4 text-gray-500">Загружается...</div>';
        
        try {
            // Load properties from API
            const propertyPromises = propertyIds.map(async (propertyId) => {
                try {
                    console.log(`Loading property ${propertyId} from API...`);
                    const response = await fetch(`/api/property/${propertyId}`);
                    console.log(`Property ${propertyId} response status:`, response.status);
                    if (response.ok) {
                        const data = await response.json();
                        console.log(`Property ${propertyId} data loaded:`, data.title || 'no title');
                        // Wrap in expected format
                        return {
                            success: true,
                            property: data
                        };
                    }
                    console.warn(`Property ${propertyId} not found (${response.status})`);
                    return null;
                } catch (e) {
                    console.error(`Error loading property ${propertyId}:`, e);
                    return null;
                }
            });
            
            const properties = await Promise.all(propertyPromises);
            const validProperties = properties.filter(p => p && p.success && p.property);
            
            console.log('Loaded valid properties for comparison:', validProperties.length, 'of', propertyIds.length);
            
            if (validProperties.length === 0) {
                quickGrid.innerHTML = `
                    <div class="col-span-full text-center py-8 text-gray-500">
                        <p>Объекты не найдены</p>
                        <small class="text-xs block mt-2">Возможно объекты были удалены или данные устарели</small>
                        <button onclick="clearOldComparisonData()" class="mt-4 px-4 py-2 bg-red-500 text-white rounded text-sm hover:bg-red-600 transition-colors">
                            Очистить старые данные
                        </button>
                    </div>
                `;
                detailedContainer.innerHTML = '<div class="text-center py-8 text-gray-500">Объекты не найдены</div>';
                return;
            }
            
            // Render quick comparison cards in complex-comparison style
            quickGrid.innerHTML = validProperties.map(item => {
                const property = item.property;
                const cashback = property.cashback || 0; // Используем динамический кэшбек из calculate_cashback()
                const complexName = (property.residential_complex || property.complex_name || 'Не указан')
                    .replace(/^ЖК\s+ЖК\s+/, 'ЖК ')  // Remove duplicate "ЖК ЖК"
                    .replace(/^ЖК\s+«?/, 'ЖК «')     // Normalize quotes
                    .replace(/«?$/, '»');            // Ensure closing quote
                
                return `
                    <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6 relative hover:shadow-md transition-all duration-200">
                        <button onclick="removeFromComparison('${property.id}')" 
                                class="absolute top-3 right-3 w-8 h-8 bg-red-50 text-red-500 rounded-full flex items-center justify-center hover:bg-red-100 transition-colors text-sm font-medium">
                            ×
                        </button>
                        
                        <div class="mb-4">
                            <img src="${property.image || '/static/images/no-image.jpg'}" 
                                 alt="${property.title}"
                                 class="w-full h-40 object-cover rounded-lg">
                        </div>
                        
                        <div class="space-y-3">
                            <div>
                                <h4 class="font-bold text-lg text-gray-900 leading-tight">${property.title}</h4>
                                <p class="text-sm text-gray-600 mt-1">${complexName}</p>
                            </div>
                            
                            <div class="space-y-2">
                                <div class="flex items-center justify-between">
                                    <span class="text-sm text-gray-600">Цена:</span>
                                    <span class="font-bold text-lg text-[#0088CC]">${property.price?.toLocaleString() || 'По запросу'} ₽</span>
                                </div>
                                
                                <div class="flex items-center justify-between">
                                    <span class="text-sm text-gray-600">Площадь:</span>
                                    <span class="font-medium text-gray-900">${property.area || 'Не указана'} м²</span>
                                </div>
                                
                                <div class="flex items-center justify-between">
                                    <span class="text-sm text-gray-600">Этаж:</span>
                                    <span class="font-medium text-gray-900">${property.object_min_floor || property.floor || 'Не указан'}${property.object_max_floor || property.total_floors ? ' из ' + (property.object_max_floor || property.total_floors) : ''}</span>
                                </div>
                                
                                <div class="pt-2 border-t border-gray-100">
                                    <div class="flex items-center justify-between">
                                        <span class="text-sm text-gray-600">Кешбек:</span>
                                        <span class="font-bold text-green-600">${cashback.toLocaleString()} ₽</span>
                                    </div>
                                    <p class="text-xs text-gray-500 mt-1">Кешбек от застройщика</p>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
            
            // Render detailed comparison (if function exists)
            if (typeof renderDetailedComparison === 'function') {
                detailedContainer.innerHTML = renderDetailedComparison(validProperties.map(item => item.property));
            } else {
                detailedContainer.innerHTML = '<div class="text-center py-8 text-gray-500">Детальное сравнение доступно</div>';
            }
            
        } catch (error) {
            console.error('Error loading quick comparison:', error);
            quickGrid.innerHTML = '<div class="col-span-full text-center py-8 text-red-500">Ошибка загрузки</div>';
        }
    }
    
    // Load properties comparison data with real data from API
    async function loadPropertiesComparisonData(propertyIds, container) {
        if (propertyIds.length === 0) {
            container.innerHTML = `
                <div class="text-center py-8 text-gray-500">
                    <p>Объекты для сравнения не найдены</p>
                    <small class="text-xs mt-2">Добавьте объекты в сравнение на странице каталога</small>
                </div>
            `;
            return;
        }

        try {
            // Load properties from API
            const propertyPromises = propertyIds.map(async (propertyId) => {
                try {
                    const response = await fetch(`/api/property/${propertyId}`);
                    if (response.ok) {
                        return await response.json();
                    }
                    return null;
                } catch (e) {
                    return null;
                }
            });
            
            const properties = await Promise.all(propertyPromises);
            const validProperties = properties.filter(p => p !== null);
            
            let html = '';
            
            if (validProperties.length === 0) {
                html = `
                    <div class="text-center py-8 text-gray-500">
                        <p>Объекты не найдены</p>
                        <small class="text-xs block mt-2">Возможно объекты были удалены или данные устарели</small>
                        <button onclick="clearOldComparisonData()" class="mt-4 px-4 py-2 bg-red-500 text-white rounded text-sm hover:bg-red-600 transition-colors">
                            Очистить старые данные
                        </button>
                    </div>
                `;
            } else {
                validProperties.forEach(property => {
                    const priceFormatted = property.price ? (property.price / 1000000).toFixed(1) + ' млн ₽' : 'Цена по запросу';
                    const cashbackAmount = property.cashback || 0;
                    const roomsText = property.object_rooms ? `${property.object_rooms}-комн` : 'Студия';
                    
                    const complexName = (property.residential_complex || 'Без названия')
                        .replace(/^ЖК\s+ЖК\s+/, 'ЖК ')  // Remove duplicate "ЖК ЖК"
                        .replace(/^ЖК\s+«?/, 'ЖК «')     // Normalize quotes
                        .replace(/«?$/, '»');            // Ensure closing quote

                    html += `
                        <div class="flex items-center justify-between p-4 border border-gray-200 rounded-lg bg-white hover:bg-gray-50 transition-colors">
                            <div class="flex-1">
                                <h5 class="font-semibold text-gray-900 text-sm">${roomsText}, ${complexName}</h5>
                                <p class="text-xs text-gray-600 mt-1">${priceFormatted} • +${cashbackAmount.toLocaleString()} ₽ кешбек</p>
                            </div>
                            <button class="text-red-500 hover:text-red-700 text-sm px-2 py-1 rounded hover:bg-red-50 transition-colors" onclick="removeFromComparison(${property.id})">
                                ✕
                            </button>
                        </div>
                    `;
                });
            }
            
            container.innerHTML = html;
            
        } catch (error) {
            console.error('Error loading properties comparison data:', error);
            container.innerHTML = `
                <div class="text-center py-8 text-gray-500">
                    <p>Ошибка загрузки данных объектов</p>
                    <p class="text-xs mt-2">${error.message}</p>
                    <button onclick="clearOldComparisonData()" class="mt-3 px-4 py-2 bg-red-500 text-white rounded text-sm hover:bg-red-600">
                        Очистить данные
                    </button>
                </div>
            `;
        }
    }

    // Load complexes comparison data by fetching each complex individually
    async function loadComplexesComparisonData(complexIds, container) {
        try {
            if (complexIds.length === 0) {
                container.innerHTML = '<div class="text-center py-4 text-gray-500 text-sm">Добавьте ЖК в сравнение</div>';
                return;
            }
            
            container.innerHTML = '<div class="text-center py-4 text-gray-500 text-sm">Загрузка...</div>';
            
            let html = '';
            
            // Load each complex individually
            const complexPromises = complexIds.map(async (complexId) => {
                try {
                    const response = await fetch(`/api/complex/${complexId}`);
                    if (response.ok) {
                        const data = await response.json();
                        // Save original ID for deletion
                        data.original_id = complexId;
                        return data;
                    }
                    console.warn(`Complex ${complexId} not found`);
                    return null;
                } catch (e) {
                    console.error(`Error loading complex ${complexId}:`, e);
                    return null;
                }
            });
            
            const complexes = await Promise.all(complexPromises);
            const validComplexes = complexes.filter(c => c !== null);
            
            if (validComplexes.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-8 text-gray-500">
                        <p>ЖК не найдены</p>
                        <p class="text-xs mt-2">Возможно данные устарели</p>
                        <button onclick="clearOldComparisonData()" class="mt-3 px-4 py-2 bg-red-500 text-white rounded text-sm hover:bg-red-600">
                            Очистить данные
                        </button>
                    </div>
                `;
                return;
            }
            
            // Render complexes
            for (const complex of validComplexes) {
                const priceFrom = complex.min_price || complex.price_from || 5000000;
                const priceFromMillions = (priceFrom / 1000000).toFixed(1);
                const cashbackPercent = complex.cashback_rate || complex.cashback_percent || 5; // ✅ Динамический кэшбек из БД
                const cashback = Math.round(priceFrom * cashbackPercent / 100);
                
                html += `
                    <div class="flex items-center justify-between p-3 border border-gray-200 rounded-lg bg-gray-50 hover:bg-gray-100 transition-colors">
                        <div class="flex-1">
                            <h5 class="font-medium text-gray-900 text-sm">${complex.name}</h5>
                            <p class="text-xs text-gray-600">от ${priceFromMillions} млн ₽ • кешбек ${cashbackPercent}% • ${complex.properties_count || complex.apartments_count || 0} объектов</p>
                        </div>
                        <button class="text-red-600 hover:text-red-800 text-xs px-2 py-1 hover:bg-red-50 rounded transition-colors" onclick="removeFromComplexComparison('${complex.original_id}')">
                            ✕
                        </button>
                    </div>
                `;
            }
            
            container.innerHTML = html;
        } catch (error) {
            console.error('Error loading complexes comparison data:', error);
            container.innerHTML = `
                <div class="text-center py-8 text-gray-500">
                    <p>Ошибка загрузки данных ЖК</p>
                    <p class="text-xs mt-2">${error.message}</p>
                    <button onclick="loadComparisonContent()" class="mt-3 px-4 py-2 bg-blue-500 text-white rounded text-sm hover:bg-blue-600">
                        Повторить попытку
                    </button>
                </div>
            `;
        }
    }
    
    // Global functions for removing items from comparison
    window.removeFromComparison = async function(propertyId) {
        console.log('🗑️ Удаление объекта из сравнения:', propertyId, 'тип:', typeof propertyId);
        
        // ✅ ИСПРАВЛЕНО: Удаляем из PostgreSQL БД через API
        try {
            const response = await fetch('/api/user/comparison/property/remove', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                credentials: 'same-origin',
                body: JSON.stringify({ property_id: String(propertyId) })
            });
            
            const result = await response.json();
            if (!result.success) {
                console.error('Failed to remove property from DB:', result);
            } else {
                console.log('✅ Property removed from PostgreSQL DB:', propertyId);
            }
        } catch (error) {
            console.error('Error calling API to remove property:', error);
        }
        
        // Remove from comparison.js localStorage format
        try {
            const comparisons = JSON.parse(localStorage.getItem('comparisons') || '[]');
            console.log('Список до удаления (comparisons):', comparisons);
            const newComparisons = comparisons.filter(id => String(id) !== String(propertyId));
            console.log('Список после удаления (comparisons):', newComparisons);
            localStorage.setItem('comparisons', JSON.stringify(newComparisons));
        } catch (e) {
            console.error('Error removing from comparison:', e);
        }
        
        // Also remove from old format
        try {
            const oldComparisons = JSON.parse(localStorage.getItem('comparison_properties') || '[]');
            console.log('Список до удаления (old format):', oldComparisons);
            const newOldComparisons = oldComparisons.filter(id => String(id) !== String(propertyId));
            console.log('Список после удаления (old format):', newOldComparisons);
            localStorage.setItem('comparison_properties', JSON.stringify(newOldComparisons));
        } catch (e) {
            console.error('Error removing from old comparison format:', e);
        }
        
        // Update UI
        updateDashboardCounters();
        loadComparisonContent();
        
        // Update comparison manager if available
        if (window.comparisonManager) {
            window.comparisonManager.updateComparisonUI();
        }
    };
    
    window.removeFromComplexComparison = async function(complexId) {
        console.log('🗑️ Удаление ЖК из сравнения:', complexId, 'тип:', typeof complexId);
        
        // ✅ ИСПРАВЛЕНО: Удаляем из PostgreSQL БД через API
        try {
            const response = await fetch('/api/user/comparison/complex/remove', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                credentials: 'same-origin',
                body: JSON.stringify({ complex_id: String(complexId) })
            });
            
            const result = await response.json();
            if (!result.success) {
                console.error('Failed to remove complex from DB:', result);
            } else {
                console.log('✅ Complex removed from PostgreSQL DB:', complexId);
            }
        } catch (error) {
            console.error('Error calling API to remove complex:', error);
        }
        
        const complexes = JSON.parse(localStorage.getItem('comparison_complexes') || '[]');
        console.log('Список ЖК до удаления:', complexes);
        const newComplexes = complexes.filter(id => String(id) !== String(complexId));
        console.log('Список ЖК после удаления:', newComplexes);
        localStorage.setItem('comparison_complexes', JSON.stringify(newComplexes));
        
        // Reload comparison content
        loadComparisonContent();
        updateDashboardCounters();
    };
    
    // Function to clear old comparison data
    window.clearOldComparisonData = function() {
        try {
            localStorage.removeItem('comparisons');
            localStorage.removeItem('comparison_properties');
            localStorage.removeItem('comparison_complexes');
            console.log('Cleared old comparison data from localStorage');
            
            // Reload comparison content and counters
            updateDashboardCounters();
            loadComparisonContent();
            
            // Show success message
            alert('Старые данные сравнения очищены! Теперь вы можете добавлять объекты в сравнение с главной страницы каталога.');
        } catch (e) {
            console.error('Error clearing comparison data:', e);
            alert('Ошибка при очистке данных');
        }
    };
    
    // Guard flag to prevent duplicate initialization
    let dashboardInitialized = false;
    
    // Initialize dashboard content when everything is loaded
    function initializeDashboard() {
        if (dashboardInitialized) {
            console.log('Dashboard already initialized, skipping...');
            return;
        }
        dashboardInitialized = true;
        console.log('Initializing dashboard...');
        
        updateDashboardCounters();
        loadFavoritesContent();
        loadComparisonContent();
        initializeCashbackCalculator();
        initializeSavedSearchActions();
        
        // ✅ ОТКЛЮЧЕНО: Автоматическое обновление счетчиков каждые 5 секунд
        // Счетчики обновляются при загрузке страницы, переключении вкладок и действиях пользователя
        // setInterval(updateDashboardCounters, 5000);
        
        // ✅ ОТКЛЮЧЕНО: Слишком частые API запросы каждые 10 секунд
        // Счетчики обновляются при загрузке и при переключении вкладок
        // setInterval(updateTopMenuCounters, 10000);
        
        // ✅ Обновляем счетчики при загрузке
        updateTopMenuCounters();
    }
    
    function initializeCashbackCalculator() {
        const priceInput = document.getElementById('cashback-price');
        const typeSelect = document.getElementById('cashback-type');
        const resultElement = document.getElementById('cashback-result');
        
        if (!priceInput || !typeSelect || !resultElement) return;
        
        function calculateCashback() {
            const price = parseFloat(priceInput.value) || 3500000;
            const percentage = parseFloat(typeSelect.value) || 5;
            const cashback = Math.round(price * percentage / 100);
            
            resultElement.textContent = cashback.toLocaleString('ru-RU') + ' ₽';
        }
        
        priceInput.addEventListener('input', calculateCashback);
        typeSelect.addEventListener('change', calculateCashback);
        
        // Initialize with default values
        calculateCashback();
    }
    
    function initializeSavedSearchActions() {
        // Apply search buttons
        document.querySelectorAll('.apply-search-btn').forEach(button => {
            button.addEventListener('click', function(e) {
                e.preventDefault();
                let searchId = this.dataset.searchId;
                
                // Check if this is a manager's sent search (has "sent-" prefix)
                if (searchId && searchId.startsWith('sent-')) {
                    // Remove "sent-" prefix and get actual search ID
                    const actualId = searchId.replace('sent-', '');
                    
                    let isRedirecting = false;
                    
                    // Load filters for this sent search and redirect to properties
                    fetch(`/api/manager/sent-search/${actualId}`)
                        .then(response => {
                            if (!response.ok) {
                                throw new Error('Failed to load search');
                            }
                            return response.json();
                        })
                        .then(data => {
                            if (data.success && data.search) {
                                // Build URL with filters
                                const filters = data.search.additional_filters || {};
                                const params = new URLSearchParams();
                                
                                // Helper function to check if value is valid (not null/undefined/empty string)
                                const isValidValue = (val) => val !== undefined && val !== null && val !== '';
                                
                                // Add filters to params - filter out empty values but allow 0
                                if (isValidValue(filters.complex_name)) {
                                    params.append('complex', filters.complex_name);
                                }
                                if (filters.rooms !== undefined && filters.rooms !== null) {
                                    params.append('rooms', filters.rooms);
                                }
                                if (filters.priceFrom !== undefined && filters.priceFrom !== null && filters.priceFrom !== '') {
                                    params.append('price_min', filters.priceFrom);
                                }
                                if (filters.priceTo !== undefined && filters.priceTo !== null && filters.priceTo !== '') {
                                    params.append('price_max', filters.priceTo);
                                }
                                if (filters.areaFrom !== undefined && filters.areaFrom !== null && filters.areaFrom !== '') {
                                    params.append('area_min', filters.areaFrom);
                                }
                                if (filters.areaTo !== undefined && filters.areaTo !== null && filters.areaTo !== '') {
                                    params.append('area_max', filters.areaTo);
                                }
                                if (isValidValue(filters.district)) {
                                    params.append('district', filters.district);
                                }
                                
                                // Set flag before redirect
                                isRedirecting = true;
                                
                                // Redirect to properties with filters
                                const queryString = params.toString();
                                window.location.href = queryString ? `/properties?${queryString}` : '/properties';
                            } else {
                                alert('Не удалось загрузить поиск от менеджера');
                            }
                        })
                        .catch(error => {
                            console.error('Error loading sent search:', error);
                            // Only show alert if we haven't started redirecting
                            if (!isRedirecting) {
                                alert('Ошибка при применении поиска');
                            }
                        });
                } else if (searchId && window.savedSearchesManager) {
                    // Use the saved searches manager to apply the search properly
                    window.savedSearchesManager.applySavedSearch(searchId);
                } else if (searchId) {
                    // Fallback to old method if manager not available
                    window.location.href = `/properties?search_id=${searchId}`;
                }
            });
        });
        
        // Delete search buttons - handled by SavedSearchesManager in saved_searches.js
    }
    
    window.viewRecommendation = function(recommendationId) {
        // Mark recommendation as viewed first
        fetch(`/api/recommendations/${recommendationId}/viewed`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Find the recommendation element to get property details
                const recElement = document.querySelector(`[onclick="viewRecommendation(${recommendationId})"]`);
                if (recElement) {
                    const recCard = recElement.closest('.border');
                    const propertyId = recCard.dataset.propertyId;
                    if (propertyId && propertyId !== '') {
                        // Navigate to property page
                        window.location.href = `/object/${propertyId}`;
                    } else {
                        // For other recommendation types, just mark as viewed and refresh
                        console.log('Рекомендация просмотрена');
                        location.reload();
                    }
                } else {
                    console.log('Рекомендация просмотрена');
                    location.reload();
                }
            } else {
                console.error('Ошибка при просмотре рекомендации');
            }
        })
        .catch(error => {
            console.error('Error:', error);
        });
    }
    
    window.dismissRecommendation = function(recommendationId) {
        if (confirm('Скрыть эту рекомендацию?')) {
            fetch(`/api/recommendations/${recommendationId}/dismiss`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    location.reload();
                } else {
                    alert('Ошибка при скрытии рекомендации');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Ошибка при скрытии рекомендации');
            });
        }
    }
    
    window.applySearchRecommendation = function(searchId) {
        console.log('Applying saved search:', 'sent-' + searchId);
        
        // Use the same logic as apply-search-btn for manager searches
        const actualId = searchId;
        let isRedirecting = false;
        
        // Get CSRF token
        const csrfToken = document.querySelector('meta[name="csrf-token"]')?.content;
        
        // Mark search as applied and get filters
        fetch(`/api/recommendations/search_${searchId}/apply`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrfToken
            }
        })
        .then(response => {
            if (!response.ok) {
                throw new Error('Failed to apply search');
            }
            return response.json();
        })
        .then(data => {
            if (data.success && data.filters) {
                // Build URL with filters
                const filters = data.filters || {};
                const params = new URLSearchParams();
                
                // Helper function to check if value is valid (not null/undefined/empty string)
                const isValidValue = (val) => val !== undefined && val !== null && val !== '';
                
                // Add filters to params - filter out empty values but allow 0
                if (isValidValue(filters.complex_name)) {
                    params.append('complex', filters.complex_name);
                }
                if (filters.rooms !== undefined && filters.rooms !== null) {
                    params.append('rooms', filters.rooms);
                }
                if (filters.priceFrom !== undefined && filters.priceFrom !== null && filters.priceFrom !== '') {
                    params.append('price_min', filters.priceFrom);
                }
                if (filters.priceTo !== undefined && filters.priceTo !== null && filters.priceTo !== '') {
                    params.append('price_max', filters.priceTo);
                }
                if (filters.areaFrom !== undefined && filters.areaFrom !== null && filters.areaFrom !== '') {
                    params.append('area_min', filters.areaFrom);
                }
                if (filters.areaTo !== undefined && filters.areaTo !== null && filters.areaTo !== '') {
                    params.append('area_max', filters.areaTo);
                }
                if (isValidValue(filters.district)) {
                    params.append('district', filters.district);
                }
                
                // Set flag before redirect
                isRedirecting = true;
                
                // Redirect to properties with filters
                const queryString = params.toString();
                window.location.href = queryString ? `/properties?${queryString}` : '/properties';
            } else if (data.success) {
                // Fallback to properties page if no filters
                isRedirecting = true;
                window.location.href = '/properties';
            } else {
                console.error('Ошибка при применении поиска');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            // Only show alert if we haven't started redirecting
            if (!isRedirecting) {
                alert('Ошибка при применении поиска');
            }
        });
    }
    
    // Category filtering functions
    window.filterByCategory = function(categoryId) {
        const categoryFilter = document.getElementById('categoryFilter');
        if (categoryFilter) {
            categoryFilter.value = categoryId;
            filterRecommendations();
        }
    }
    
    function filterRecommendations() {
        const categoryFilter = document.getElementById('categoryFilter');
        const selectedCategory = categoryFilter ? categoryFilter.value : '';
        const recommendations = document.querySelectorAll('.recommendation-item');
        const categoryCards = document.querySelectorAll('.category-card');
        
        // Update category cards highlighting
        categoryCards.forEach(card => {
            if (selectedCategory && card.dataset.categoryId === selectedCategory) {
                card.classList.add('ring-2', 'ring-blue-500', 'bg-blue-50');
            } else {
                card.classList.remove('ring-2', 'ring-blue-500', 'bg-blue-50');
            }
        });
        
        // Filter recommendations
        recommendations.forEach(rec => {
            const recCategoryId = rec.dataset.categoryId;
            
            if (!selectedCategory || recCategoryId === selectedCategory) {
                rec.style.display = 'block';
            } else {
                rec.style.display = 'none';
            }
        });
        
        // Update showing count
        const visibleCount = document.querySelectorAll('.recommendation-item[style*="display: block"], .recommendation-item:not([style*="display: none"])').length;
        console.log(`Показано рекомендаций: ${visibleCount}`);
    }
    
    // Initialize category filter
    document.addEventListener('DOMContentLoaded', function() {
        const categoryFilter = document.getElementById('categoryFilter');
        if (categoryFilter) {
            categoryFilter.addEventListener('change', filterRecommendations);
        }
    });
    
    // Guide toggle function
    window.toggleGuide = function() {
        const guide = document.getElementById('cashbackGuide');
        const button = event.target;
        
        if (guide.style.display === 'none') {
            guide.style.display = 'grid';
            button.textContent = 'Скрыть';
        } else {
            guide.style.display = 'none';
            button.textContent = 'Показать';
        }
    }
    
    // Phone binding functions
    window.bindPhone = function() {
        const phoneInput = document.getElementById('phoneInput');
        const phone = phoneInput.value.trim();
        
        if (!phone) {
            alert('Введите номер телефона');
            return;
        }
        
        // Basic phone validation
        const phonePattern = /^(\+7|7|8)?[\s\-]?\(?[489][0-9]{2}\)?[\s\-]?[0-9]{3}[\s\-]?[0-9]{2}[\s\-]?[0-9]{2}$/;
        if (!phonePattern.test(phone.replace(/[\s\-\(\)]/g, ''))) {
            alert('Введите корректный номер телефона');
            return;
        }
        
        // Send verification request
        fetch('/api/bind-phone', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ phone: phone })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert('Код подтверждения отправлен на указанный номер');
                // Show verification code input
                showVerificationInput();
            } else {
                alert(data.error || 'Ошибка отправки кода');
            }
        })
        .catch(error => {
            alert('Ошибка сети. Попробуйте позже.');
        });
    }
    
    window.changePhone = function() {
        if (confirm('Вы хотите изменить номер телефона?')) {
            // Allow phone change
            location.reload();
        }
    }
    
    function showVerificationInput() {
        // This would show a verification code input modal
        const code = prompt('Введите код подтверждения из SMS:');
        if (code) {
            verifyPhone(code);
        }
    }
    
    function verifyPhone(code) {
        fetch('/api/verify-phone', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ code: code })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert('Номер телефона успешно подтвержден!');
                location.reload();
            } else {
                alert(data.error || 'Неверный код');
            }
        });
    }
    
    // Cashback checker function
    window.checkCashback = function() {
        const urlInput = document.getElementById('cashbackUrlInput');
        const resultDiv = document.getElementById('cashbackResult');
        const contentDiv = document.getElementById('cashbackContent');
        
        const url = urlInput.value.trim();
        if (!url) {
            alert('Пожалуйста, введите ссылку на объект');
            return;
        }
        
        // Show loading state
        resultDiv.classList.remove('hidden');
        contentDiv.innerHTML = '<div class="flex items-center space-x-2"><div class="w-4 h-4 border-2 border-blue-500 border-t-transparent rounded-full animate-spin"></div><span>Проверяем кешбек...</span></div>';
        
        // Try to extract property ID from URL
        let propertyId = null;
        const urlPatterns = [
            /\/order\/(\d+)/,
            /\/property\/(\d+)/,
            /\/object\/(\d+)/,
            /id=(\d+)/,
            /property_id=(\d+)/
        ];
        
        for (const pattern of urlPatterns) {
            const match = url.match(pattern);
            if (match) {
                propertyId = match[1];
                break;
            }
        }
        
        if (propertyId) {
            // Check if property exists in our system
            fetch(`/api/property/${propertyId}/cashback`)
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        contentDiv.innerHTML = `
                            <div class="space-y-3">
                                <div class="flex items-center justify-between">
                                    <span class="font-medium text-gray-900">${data.property_name}</span>
                                    <span class="px-2 py-1 bg-green-100 text-green-800 rounded-full text-sm font-medium">${data.cashback_percent}% кешбек</span>
                                </div>
                                <div class="text-lg font-semibold text-green-600">Кешбек: ${data.cashback_amount.toLocaleString()} ₽</div>
                                <div class="text-sm text-gray-600">Цена: ${data.property_price.toLocaleString()} ₽</div>
                                <a href="/property/${propertyId}" class="inline-block mt-2 px-4 py-2 bg-[#0088CC] text-white rounded-lg hover:bg-[#006699] transition-colors">Посмотреть объект</a>
                            </div>
                        `;
                    } else {
                        contentDiv.innerHTML = `
                            <div class="text-center py-4">
                                <div class="text-gray-600 mb-2">Объект не найден в нашей базе</div>
                                <div class="text-sm text-gray-500">Свяжитесь с менеджером для уточнения условий кешбека</div>
                                <button onclick="openApplicationModal()" class="mt-2 px-4 py-2 bg-[#0088CC] text-white rounded-lg hover:bg-[#006699] transition-colors">Связаться с менеджером</button>
                            </div>
                        `;
                    }
                })
                .catch(error => {
                    contentDiv.innerHTML = `
                        <div class="text-center py-4">
                            <div class="text-red-600 mb-2">Ошибка при проверке кешбека</div>
                            <div class="text-sm text-gray-500">Попробуйте еще раз или свяжитесь с поддержкой</div>
                        </div>
                    `;
                });
        } else {
            contentDiv.innerHTML = `
                <div class="text-center py-4">
                    <div class="text-yellow-600 mb-2">Не удалось определить ID объекта</div>
                    <div class="text-sm text-gray-500">Проверьте формат ссылки или свяжитесь с менеджером</div>
                    <button onclick="openApplicationModal()" class="mt-2 px-4 py-2 bg-[#0088CC] text-white rounded-lg hover:bg-[#006699] transition-colors">Связаться с менеджером</button>
                </div>
            `;
        }
    }
    
    // Cashback calculator functionality
    let cashbackData = {
        complexes: [],
        selectedComplex: null,
        currentPrice: 0,
        currentCashback: 0
    };

    // Load residential complexes for cashback calculator
    async function loadResidentialComplexes() {
        try {
            const response = await fetch('/api/residential-complexes');
            const data = await response.json();
            cashbackData.complexes = data.complexes || [];
            
            console.log('Loaded complexes for cashback:', cashbackData.complexes.length);
            
            // Initialize search functionality
            initializeCashbackComplexSearch();
            
        } catch (error) {
            console.error('Error loading residential complexes:', error);
        }
    }
    
    // Initialize complex search functionality
    function initializeCashbackComplexSearch() {
        const searchInput = document.getElementById('cashback-complex-search');
        const hiddenInput = document.getElementById('cashback-complex');
        const dropdown = document.getElementById('cashback-complex-dropdown');
        
        if (!searchInput || !hiddenInput || !dropdown) return;
        
        // Filter and show complexes
        function filterComplexes(query) {
            const filtered = cashbackData.complexes.filter(complex => 
                complex.name.toLowerCase().includes(query.toLowerCase())
            );
            
            dropdown.innerHTML = '';
            
            if (filtered.length === 0 && query) {
                dropdown.innerHTML = '<div class="p-3 text-gray-500 text-sm">Ничего не найдено</div>';
            } else {
                filtered.forEach(complex => {
                    const item = document.createElement('div');
                    item.className = 'p-3 hover:bg-gray-50 cursor-pointer border-b border-gray-100 last:border-b-0';
                    item.innerHTML = `
                        <div class="font-medium text-gray-900">${complex.name}</div>
                        <div class="text-sm text-gray-500">Кешбек: ${complex.cashback_rate}% • ${complex.district || 'Краснодар'}</div>
                    `;
                    
                    item.addEventListener('click', () => {
                        searchInput.value = complex.name;
                        hiddenInput.value = complex.id;
                        dropdown.classList.add('hidden');
                        
                        // Update rate info
                        const rateInfo = document.getElementById('complex-rate-info');
                        if (rateInfo) {
                            rateInfo.textContent = `Процент кешбека: ${complex.cashback_rate}%`;
                        }
                        
                        calculateCashback();
                    });
                    
                    dropdown.appendChild(item);
                });
            }
            
            dropdown.classList.remove('hidden');
        }
        
        // Search input events
        searchInput.addEventListener('input', (e) => {
            const query = e.target.value.trim();
            if (query.length > 0) {
                filterComplexes(query);
            } else {
                dropdown.classList.add('hidden');
                hiddenInput.value = '';
                document.getElementById('complex-rate-info').textContent = '';
            }
        });
        
        searchInput.addEventListener('focus', (e) => {
            if (e.target.value.length > 0) {
                filterComplexes(e.target.value);
            }
        });
        
        // Hide dropdown when clicking outside
        document.addEventListener('click', (e) => {
            if (!searchInput.contains(e.target) && !dropdown.contains(e.target)) {
                dropdown.classList.add('hidden');
            }
        });
    }

    // Calculate cashback
    async function calculateCashback() {
        const complexHiddenInput = document.getElementById('cashback-complex');
        const priceInput = document.getElementById('cashback-price');
        const resultDiv = document.getElementById('cashback-result');
        const rateDisplay = document.getElementById('cashback-rate-display');
        const detailsDiv = document.getElementById('cashback-details');
        const applyBtn = document.getElementById('apply-cashback-btn');
        
        if (!complexHiddenInput || !priceInput || !resultDiv) return;
        
        const complexId = complexHiddenInput.value;
        const price = parseFloat(priceInput.value);
        
        if (!complexId || !price || price < 1000000) {
            resultDiv.textContent = complexId ? 'Введите стоимость' : 'Выберите ЖК';
            if (rateDisplay) rateDisplay.textContent = '';
            if (detailsDiv) detailsDiv.textContent = 'Заполните данные для расчета';
            if (applyBtn) applyBtn.disabled = true;
            return;
        }

        try {
            // Try multiple ways to get CSRF token
            let csrfToken = document.querySelector('meta[name="csrf-token"]')?.getAttribute('content');
            if (!csrfToken || csrfToken === 'no-token') {
                csrfToken = document.querySelector('input[name="csrf_token"]')?.value;
            }
            
            const response = await fetch('/api/cashback/calculate', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    ...(csrfToken && {'X-CSRFToken': csrfToken})
                },
                body: JSON.stringify({
                    price: price,
                    complex_id: complexId
                })
            });

            const data = await response.json();
            
            if (data.error) {
                resultDiv.textContent = 'Ошибка расчета';
                if (rateDisplay) rateDisplay.textContent = data.error;
                if (applyBtn) applyBtn.disabled = true;
                return;
            }

            // Update UI
            resultDiv.textContent = `${data.formatted_amount} ₽`;
            if (rateDisplay) rateDisplay.textContent = `Ставка: ${data.cashback_rate}%`;
            
            if (detailsDiv) {
                if (data.cashback_amount >= 500000) {
                    detailsDiv.textContent = 'Максимальный кешбек 500 000 ₽';
                } else {
                    detailsDiv.textContent = `${data.cashback_rate}% от ${parseInt(price).toLocaleString('ru-RU')} ₽`;
                }
            }
            
            // Store current calculation
            cashbackData.currentPrice = price;
            cashbackData.currentCashback = data.cashback_amount;
            cashbackData.selectedComplex = {
                id: complexId,
                name: complexSelect.options[complexSelect.selectedIndex].dataset.name,
                rate: data.cashback_rate
            };
            
            if (applyBtn) applyBtn.disabled = false;
            
        } catch (error) {
            console.error('Error calculating cashback:', error);
            resultDiv.textContent = 'Ошибка сети';
            if (applyBtn) applyBtn.disabled = true;
        }
    }

    // Open cashback application modal
    function openCashbackModal() {
        if (!cashbackData.selectedComplex || !cashbackData.currentCashback) {
            alert('Сначала рассчитайте кешбек');
            return;
        }
        
        // Update modal content
        const amountEl = document.getElementById('modal-cashback-amount');
        const infoEl = document.getElementById('modal-complex-info');
        
        if (amountEl) {
            amountEl.textContent = `${parseInt(cashbackData.currentCashback).toLocaleString('ru-RU')} ₽`;
        }
        if (infoEl) {
            infoEl.textContent = `${cashbackData.selectedComplex.name} • ${cashbackData.selectedComplex.rate}% • ${parseInt(cashbackData.currentPrice).toLocaleString('ru-RU')} ₽`;
        }
        
        // Show modal
        const modal = document.getElementById('cashback-modal');
        if (modal) modal.classList.remove('hidden');
    }

    // Close cashback modal
    function closeCashbackModal() {
        const modal = document.getElementById('cashback-modal');
        if (modal) modal.classList.add('hidden');
    }

    // Submit cashback application
    let isSubmittingCashback = false;  // Флаг для предотвращения дублирования
    
    async function submitCashbackApplication(event) {
        event.preventDefault();
        
        // Проверка на дублирование запроса
        if (isSubmittingCashback) {
            console.log('Заявка уже отправляется, пожалуйста подождите');
            return;
        }
        
        const name = document.getElementById('cashback-name')?.value.trim();
        const phone = document.getElementById('cashback-phone')?.value.trim();
        const submitBtn = event.target.querySelector('button[type="submit"]');
        
        if (!name || !phone) {
            alert('Заполните все обязательные поля');
            return;
        }
        
        // Валидация номера телефона
        const phoneRegex = /^(\+7|8)?[\s\-]?\(?[489]\d{2}\)?[\s\-]?\d{3}[\s\-]?\d{2}[\s\-]?\d{2}$/;
        const cleanPhone = phone.replace(/[\s\-\(\)]/g, '');
        
        if (!phoneRegex.test(phone) || cleanPhone.length < 10) {
            alert('Введите корректный номер телефона в формате +7 (XXX) XXX-XX-XX');
            return;
        }
        
        // Блокируем повторные отправки
        isSubmittingCashback = true;
        if (submitBtn) {
            submitBtn.disabled = true;
            submitBtn.textContent = 'Отправка...';
        }
        
        try {
            // Try multiple ways to get CSRF token
            let csrfToken = document.querySelector('meta[name="csrf-token"]')?.getAttribute('content');
            if (!csrfToken || csrfToken === 'no-token') {
                csrfToken = document.querySelector('input[name="csrf_token"]')?.value;
            }
            
            const response = await fetch('/api/cashback/apply', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    ...(csrfToken && {'X-CSRFToken': csrfToken})
                },
                body: JSON.stringify({
                    price: cashbackData.currentPrice,
                    complex_id: cashbackData.selectedComplex.id,
                    complex_name: cashbackData.selectedComplex.name,
                    cashback_amount: cashbackData.currentCashback,
                    name: name,
                    phone: phone
                })
            });

            const data = await response.json();
            
            if (data.success) {
                alert(data.message);
                closeCashbackModal();
                // Reset form
                const form = document.getElementById('cashback-application-form');
                if (form) form.reset();
            } else {
                alert(data.error || 'Ошибка при отправке заявки');
            }
            
        } catch (error) {
            console.error('Error submitting application:', error);
            alert('Ошибка сети. Попробуйте еще раз.');
        } finally {
            // Разблокируем кнопку после завершения
            isSubmittingCashback = false;
            if (submitBtn) {
                submitBtn.disabled = false;
                submitBtn.textContent = 'Подать заявку';
            }
        }
    }

    // Global functions for cashback modal
    window.openCashbackModal = openCashbackModal;
    window.closeCashbackModal = closeCashbackModal;

    // Initialize new slider-based cashback calculator
    function initializeCashbackCalculator() {
        const priceSlider = document.getElementById('price-slider');
        const rateSlider = document.getElementById('rate-slider');
        const priceDisplay = document.getElementById('price-display');
        const rateDisplay = document.getElementById('rate-display');
        const cashbackAmount = document.getElementById('cashback-amount');
        const summaryPrice = document.getElementById('summary-price');
        const applyBtn = document.getElementById('apply-cashback-btn');
        const form = document.getElementById('cashback-application-form');
        
        // Функция форматирования числа с разделителями
        function formatNumber(num) {
            return num.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ' ');
        }
        
        // Функция расчета кешбека
        function updateCalculation() {
            if (!priceSlider || !rateSlider || !priceDisplay || !rateDisplay || !cashbackAmount || !summaryPrice) return;
            
            const price = parseFloat(priceSlider.value);
            const rate = parseFloat(rateSlider.value);
            const cashback = Math.round(price * rate / 100);
            
            // Обновляем визуальный прогресс слайдеров
            const priceProgress = ((price - parseFloat(priceSlider.min)) / (parseFloat(priceSlider.max) - parseFloat(priceSlider.min))) * 100;
            const rateProgress = ((rate - parseFloat(rateSlider.min)) / (parseFloat(rateSlider.max) - parseFloat(rateSlider.min))) * 100;
            
            priceSlider.style.setProperty('--slider-progress', priceProgress + '%');
            rateSlider.style.setProperty('--slider-progress', rateProgress + '%');
            
            // Обновляем отображения
            priceDisplay.textContent = formatNumber(price) + ' ₽';
            rateDisplay.textContent = rate + '%';
            cashbackAmount.textContent = formatNumber(cashback) + ' ₽';
            summaryPrice.textContent = formatNumber(price) + ' ₽';
        }
        
        // Event listeners для ползунков
        if (priceSlider) {
            priceSlider.addEventListener('input', updateCalculation);
        }
        
        if (rateSlider) {
            rateSlider.addEventListener('input', updateCalculation);
        }
        
        // Обработчик кнопки "Получить кешбек"
        if (applyBtn) {
            applyBtn.addEventListener('click', function() {
                const price = parseFloat(priceSlider?.value || 0);
                const rate = parseFloat(rateSlider?.value || 0);
                const cashback = Math.round(price * rate / 100);
                
                // Обновляем cashbackData для отправки формы
                cashbackData.currentPrice = price;
                cashbackData.currentCashback = cashback;
                cashbackData.selectedComplex = {
                    id: null,
                    name: 'Калькулятор кешбека'
                };
                
                // Открываем модальное окно с заявкой
                openCashbackModal(price, rate, cashback);
            });
        }
        
        if (form) {
            form.addEventListener('submit', submitCashbackApplication);
        }
        
        // Автоматическое форматирование номера телефона
        const phoneInput = document.getElementById('cashback-phone');
        if (phoneInput) {
            phoneInput.addEventListener('input', function(e) {
                let value = e.target.value.replace(/\D/g, ''); // Удаляем все нецифровые символы
                
                // Обработка разных форматов ввода
                if (value.startsWith('8') && value.length === 11) {
                    // 8XXXXXXXXXX -> 7XXXXXXXXXX
                    value = '7' + value.substring(1);
                } else if (value.startsWith('9') && value.length === 10) {
                    // 9XXXXXXXXX -> 79XXXXXXXXX
                    value = '7' + value;
                } else if (!value.startsWith('7') && value.length === 10) {
                    // XXXXXXXXXX -> 7XXXXXXXXXX (для номеров начинающихся с других цифр кроме 7,8,9)
                    value = '7' + value;
                } else if (value.startsWith('7') && value.length > 11) {
                    // Обрезаем до 11 цифр
                    value = value.substring(0, 11);
                } else if (value.length > 11) {
                    // Обрезаем до 11 цифр
                    value = value.substring(0, 11);
                }
                
                // Форматируем по маске +7 (XXX) XXX-XX-XX
                let formatted = '';
                if (value.length > 0) {
                    formatted = '+7';
                    if (value.length > 1) {
                        formatted += ' (' + value.substring(1, 4);
                    }
                    if (value.length >= 4) {
                        formatted += ') ' + value.substring(4, 7);
                    }
                    if (value.length >= 7) {
                        formatted += '-' + value.substring(7, 9);
                    }
                    if (value.length >= 9) {
                        formatted += '-' + value.substring(9, 11);
                    }
                }
                
                e.target.value = formatted;
            });
            
            // При фокусе добавляем префикс +7, если поле пустое
            phoneInput.addEventListener('focus', function(e) {
                if (!e.target.value) {
                    e.target.value = '+7 ';
                }
            });
        }
        
        // Инициализация с начальными значениями
        updateCalculation();
    }
    
    // Обновленная функция открытия модального окна
    function openCashbackModal(price = 0, rate = 0, cashback = 0) {
        const modal = document.getElementById('cashback-modal');
        const modalAmount = document.getElementById('modal-cashback-amount');
        const modalInfo = document.getElementById('modal-complex-info');
        
        if (modal) {
            modal.classList.remove('hidden');
            
            if (modalAmount) {
                modalAmount.textContent = formatNumber(cashback) + ' ₽';
            }
            
            if (modalInfo) {
                modalInfo.textContent = `При покупке квартиры за ${formatNumber(price)} ₽ (${rate}% кешбек)`;
            }
        }
    }
    
    // Функция форматирования для глобального использования
    function formatNumber(num) {
        return num.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ' ');
    }

    // Wait for all modules to load
    let checkModules = setInterval(function() {
        if (window.favoritesManager && window.savedSearchesManager) {
            clearInterval(checkModules);
            initializeDashboard();
            initializeCashbackCalculator();
        }
    }, 100);
    
    // Fallback initialization after 3 seconds
    setTimeout(function() {
        if (checkModules) {
            clearInterval(checkModules);
            initializeDashboard();
            initializeCashbackCalculator();
        }
    }, 3000);
    
    // Initialize comparison system without overwriting user data
    console.log('Initializing comparison system...');
    const currentComparisons = JSON.parse(localStorage.getItem('comparisons') || '[]');
    console.log('Current comparison IDs:', currentComparisons);
    
    // Update counters without overwriting user data
    if (typeof updateDashboardCounters === 'function') {
        updateDashboardCounters();
    }
})();

// Load user data functions for dashboard
window.loadUserRecommendations = async function() {
    try {
        const response = await fetch('/api/user/recommendations');
        const data = await response.json();
        
        if (data.success) {
            console.log('Loaded recommendations:', data.recommendations.length);
            updateRecommendationsDisplay(data.recommendations);
            
            // Update recommendations count badge
            const countBadge = document.getElementById('recommendations-count');
            if (countBadge) {
                if (data.recommendations.length > 0) {
                    countBadge.textContent = data.recommendations.length;
                    countBadge.classList.remove('hidden');
                } else {
                    countBadge.classList.add('hidden');
                }
            }
        }
    } catch (error) {
        console.error('Error loading recommendations:', error);
    }
};

window.loadUserCollections = async function() {
    try {
        const response = await fetch('/api/user/collections');
        const data = await response.json();
        
        if (data.success) {
            console.log('Loaded collections:', data.collections.length);
            updateCollectionsDisplay(data.collections);
            
            // Update recommendations count badge
            const countBadge = document.getElementById('recommendations-count');
            if (countBadge) {
                if (data.collections.length > 0) {
                    countBadge.textContent = data.collections.length;
                    countBadge.classList.remove('hidden');
                } else {
                    countBadge.classList.add('hidden');
                }
            }
        }
    } catch (error) {
        console.error('Error loading collections:', error);
    }
};

// loadUserSavedSearches removed - now handled by SavedSearchesManager in saved_searches.js

function updateRecommendationsDisplay(recommendations) {
    // Update recommendations section with dynamic data
    const recommendationsSection = document.getElementById('recommendations');
    if (!recommendationsSection) return;
    
    // Find the recommendations list container
    const listContainer = recommendationsSection.querySelector('.space-y-4, .grid');
    if (!listContainer) return;
    
    // Clear existing dynamic items
    const existingItems = listContainer.querySelectorAll('.recommendation-item');
    existingItems.forEach(item => item.remove());
    
    // Add new recommendations
    recommendations.forEach(rec => {
        const recElement = createRecommendationCard(rec);
        listContainer.appendChild(recElement);
    });
    
    if (recommendations.length === 0) {
        listContainer.innerHTML = '<div class="text-center py-8 text-gray-500">Новых рекомендаций нет</div>';
    }
}

function createRecommendationCard(rec) {
    const div = document.createElement('div');
    div.className = 'recommendation-item bg-white border border-gray-200 rounded-lg p-6 hover:shadow-md transition-shadow';
    div.setAttribute('data-category-id', rec.category_id || '');
    
    const statusClass = rec.status === 'sent' ? 'bg-blue-100 text-blue-800' : 
                       rec.status === 'viewed' ? 'bg-green-100 text-green-800' : 
                       'bg-gray-100 text-gray-800';
    
    div.innerHTML = `
        <div class="flex justify-between items-start mb-4">
            <div class="flex-1">
                <h3 class="text-lg font-semibold text-gray-900 mb-2">${rec.title}</h3>
                <p class="text-gray-600 mb-3">${rec.description}</p>
                <div class="flex items-center space-x-4 text-sm text-gray-500">
                    <span>От: ${rec.manager_name || 'Менеджер'}</span>
                    <span>${rec.created_at}</span>
                </div>
            </div>
            <div class="flex flex-col items-end space-y-2">
                <span class="px-3 py-1 ${statusClass} text-xs font-medium rounded-full">
                    ${rec.status === 'sent' ? 'Отправлено' : rec.status === 'viewed' ? 'Просмотрено' : 'Новое'}
                </span>
            </div>
        </div>
        <div class="flex justify-between items-center">
            <div class="space-x-3">
                ${rec.recommendation_type === 'property' ? 
                    `<button onclick="viewProperty(${rec.item_id})" class="px-4 py-2 bg-[#0088CC] text-white rounded-lg hover:bg-[#006699] transition-colors text-sm">
                        Посмотреть объект
                    </button>` :
                    `<button onclick="applySearchRecommendation(${rec.item_id})" class="px-4 py-2 bg-[#0088CC] text-white rounded-lg hover:bg-[#006699] transition-colors text-sm">
                        Применить поиск
                    </button>`
                }
            </div>
            <button onclick="hideRecommendation(${rec.id})" class="text-gray-400 hover:text-red-600 transition-colors" title="Скрыть">
                <i class="fas fa-times"></i>
            </button>
        </div>
    `;
    
    return div;
}

function updateCollectionsDisplay(collections) {
    const presentationsList = document.getElementById('presentationsList');
    if (!presentationsList) {
        console.log('Collections loaded but no display section found');
        return;
    }
    
    // Clear existing presentations
    presentationsList.innerHTML = '';
    
    // Update counters in hero section
    const newCount = collections.filter(c => c.status === 'Отправлена').length;
    const totalCount = collections.length;
    
    const newCountEl = document.getElementById('presentations-new-count');
    const totalCountEl = document.getElementById('presentations-total-count');
    
    if (newCountEl) newCountEl.textContent = newCount;
    if (totalCountEl) totalCountEl.textContent = totalCount;
    
    if (collections.length === 0) {
        presentationsList.innerHTML = `
            <div class="text-center py-12">
                <div class="inline-flex items-center justify-center w-16 h-16 bg-gray-100 rounded-full mb-4">
                    <svg class="w-8 h-8 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 13V6a2 2 0 00-2-2H6a2 2 0 00-2 2v7m16 0v5a2 2 0 01-2 2H6a2 2 0 01-2-2v-5m16 0h-2.586a1 1 0 00-.707.293l-2.414 2.414a1 1 0 01-.707.293h-3.172a1 1 0 01-.707-.293l-2.414-2.414A1 1 0 006.586 13H4" />
                    </svg>
                </div>
                <p class="text-gray-600 text-lg">Новых презентаций пока нет</p>
                <p class="text-gray-500 text-sm mt-2">Ваш менеджер пришлёт вам подборки объектов</p>
            </div>
        `;
        return;
    }
    
    collections.forEach(collection => {
        const card = document.createElement('div');
        const isNew = collection.status === 'Отправлена';
        card.className = `border border-gray-200 rounded-xl p-6 hover:border-blue-300 transition-all duration-200 ${isNew ? 'border-l-4 border-l-[#0088CC] bg-blue-50/30' : ''}`;
        
        // Create properties preview
        let propertiesPreview = '';
        if (collection.properties && collection.properties.length > 0) {
            propertiesPreview = `
                <div class="flex items-center space-x-2 mb-4">
                    <div class="flex -space-x-2">
                        ${collection.properties.slice(0, 4).map(prop => `
                            <div class="w-20 h-20 rounded-lg overflow-hidden border-2 border-white shadow-sm">
                                ${prop.image ? 
                                    `<img src="${prop.image}" alt="${prop.title}" class="w-full h-full object-cover">` :
                                    `<div class="w-full h-full bg-gray-200 flex items-center justify-center">
                                        <svg class="w-8 h-8 text-gray-400" fill="currentColor" viewBox="0 0 20 20">
                                            <path d="M10.707 2.293a1 1 0 00-1.414 0l-7 7a1 1 0 001.414 1.414L4 10.414V17a1 1 0 001 1h2a1 1 0 001-1v-2a1 1 0 011-1h2a1 1 0 011 1v2a1 1 0 001 1h2a1 1 0 001-1v-6.586l.293.293a1 1 0 001.414-1.414l-7-7z"/>
                                        </svg>
                                    </div>`
                                }
                            </div>
                        `).join('')}
                    </div>
                    ${collection.properties_count > 4 ? 
                        `<div class="flex items-center justify-center w-20 h-20 bg-gray-100 rounded-lg text-gray-600 font-semibold">
                            +${collection.properties_count - 4}
                        </div>` : ''
                    }
                </div>
            `;
        }
        
        card.innerHTML = `
            <!-- Header with Manager Info -->
            <div class="flex items-center justify-between mb-4">
                <div class="flex items-center space-x-3">
                    ${collection.manager_avatar && collection.manager_avatar.startsWith('http') && !collection.manager_avatar.includes('randomuser.me') ? 
                        `<img src="${collection.manager_avatar}" alt="${collection.manager_name}" class="w-10 h-10 rounded-full object-cover">` : 
                        `<div class="w-10 h-10 bg-gradient-to-br from-[#0088CC] to-[#006699] rounded-full flex items-center justify-center">
                            <span class="text-white font-bold text-sm">${collection.manager_avatar && !collection.manager_avatar.startsWith('http') ? collection.manager_avatar : 'М'}</span>
                        </div>`
                    }
                    <div>
                        <p class="text-sm font-medium text-gray-900">${collection.manager_name || 'Менеджер'}</p>
                        <p class="text-xs text-gray-500">${collection.created_at}</p>
                    </div>
                </div>
                ${isNew ? `
                <span class="px-3 py-1 bg-blue-100 text-blue-800 text-xs font-medium rounded-full">
                    Новая
                </span>` : ''}
            </div>
            
            <!-- Title and Description -->
            <div class="mb-4">
                <h3 class="font-semibold text-gray-900 text-lg mb-2">${collection.title}</h3>
                <p class="text-gray-600 text-sm">${collection.description || ''}</p>
            </div>
            
            <!-- Properties Preview -->
            ${propertiesPreview}
            
            <!-- Footer with Actions -->
            <div class="flex items-center justify-between pt-4 border-t border-gray-200">
                <div class="flex items-center text-sm text-gray-600">
                    <svg class="w-5 h-5 mr-2 text-[#0088CC]" fill="currentColor" viewBox="0 0 20 20">
                        <path d="M10.707 2.293a1 1 0 00-1.414 0l-7 7a1 1 0 001.414 1.414L4 10.414V17a1 1 0 001 1h2a1 1 0 001-1v-2a1 1 0 011-1h2a1 1 0 011 1v2a1 1 0 001 1h2a1 1 0 001-1v-6.586l.293.293a1 1 0 001.414-1.414l-7-7z"/>
                    </svg>
                    <span class="font-medium">${collection.properties_count} ${collection.properties_count === 1 ? 'объект' : collection.properties_count < 5 ? 'объекта' : 'объектов'}</span>
                </div>
                <div class="flex items-center space-x-2">
                    <a href="/presentation/modern/${collection.unique_url}" target="_blank" 
                       data-collection-id="${collection.id}"
                       data-is-new="${isNew}"
                       onclick="markPresentationViewed(event, ${collection.id})"
                       class="px-4 py-2 bg-gradient-to-r from-[#0088CC] to-[#006699] text-white rounded-lg hover:shadow-lg transition-all duration-200 text-sm font-medium flex items-center space-x-2">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" />
                        </svg>
                        <span>Открыть презентацию</span>
                    </a>
                    <button onclick="deletePresentation(${collection.id})" 
                            class="px-4 py-2 bg-red-500 text-white rounded-lg hover:bg-red-600 transition-colors text-sm font-medium flex items-center space-x-2">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                        </svg>
                        <span>Удалить</span>
                    </button>
                </div>
            </div>
        `;
        
        presentationsList.appendChild(card);
    });
    
    console.log(`Displayed ${collections.length} presentations with manager avatars and property previews`);
}

// updateSavedSearchesDisplay and createSavedSearchCard removed - now handled by SavedSearchesManager in saved_searches.js

function formatSearchFilters(filters) {
    const formatted = [];
    
    // Helper to check if value is not empty
    const hasValue = (val) => {
        if (Array.isArray(val)) return val.length > 0;
        if (typeof val === 'string') return val.trim() !== '';
        return val !== null && val !== undefined;
    };
    
    // Process each filter
    Object.entries(filters).forEach(([key, value]) => {
        if (!hasValue(value)) return;
        
        const label = getFilterLabel(key);
        let formattedValue = value;
        
        // Format specific fields
        if (key === 'rooms' && Array.isArray(value)) {
            formattedValue = value.map(r => r === '0' ? 'Студия' : `${r}-комн`).join(', ');
        } else if ((key === 'priceTo' || key === 'price_max') && value) {
            formattedValue = `${value} млн ₽`;
        } else if ((key === 'priceFrom' || key === 'price_min') && value) {
            formattedValue = `${value} млн ₽`;
        } else if ((key === 'areaTo' || key === 'area_max') && value) {
            formattedValue = `${value} м²`;
        } else if ((key === 'areaFrom' || key === 'area_min') && value) {
            formattedValue = `${value} м²`;
        } else if (Array.isArray(value)) {
            formattedValue = value.join(', ');
        }
        
        formatted.push({ label, value: formattedValue });
    });
    
    return formatted;
}

function getFilterLabel(key) {
    const labels = {
        // New format
        'district': 'Район',
        'developer': 'Застройщик', 
        'rooms': 'Комнаты',
        'price_min': 'Цена от',
        'price_max': 'Цена до',
        'area_min': 'Площадь от',
        'area_max': 'Площадь до',
        // Old format (compatibility)
        'priceFrom': 'Цена от',
        'priceTo': 'Цена до',
        'areaFrom': 'Площадь от',
        'areaTo': 'Площадь до',
        'districts': 'Районы',
        'developers': 'Застройщики',
        'completion': 'Срок сдачи',
        'propertyClass': 'Класс',
        'wallMaterial': 'Материал стен',
        'floorsTotal': 'Этажей в доме'
    };
    return labels[key] || key;
}

// Load data when DOM is ready
document.addEventListener('DOMContentLoaded', function() {
    // Load user data after a short delay
    setTimeout(() => {
        if (typeof loadUserRecommendations === 'function') loadUserRecommendations();
        if (typeof loadUserCollections === 'function') loadUserCollections(); 
        // Removed loadUserSavedSearches() - handled by SavedSearchesManager in saved_searches.js
        
        // Load data management stats if on that tab
        if (document.getElementById('data-management')) {
            loadDataStats();
        }
    }, 1500);
});

// ========== DATA MANAGEMENT FUNCTIONS ==========

// Load current data statistics
function loadDataStats() {
    fetch('/admin/data-stats')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                document.querySelector('#data-stats-properties .text-2xl').textContent = data.properties;
                document.querySelector('#data-stats-complexes .text-2xl').textContent = data.complexes;
                document.querySelector('#data-stats-developers .text-2xl').textContent = data.developers;
                document.querySelector('#data-stats-columns .text-2xl').textContent = data.columns;
            }
        })
        .catch(error => console.error('Error loading stats:', error));
}

// Excel file upload functionality
document.addEventListener('DOMContentLoaded', function() {
    const uploadForm = document.getElementById('excel-upload-form');
    const fileInput = document.getElementById('excel-file');
    const uploadArea = document.getElementById('upload-area');
    const progressDiv = document.getElementById('upload-progress');
    const progressBar = document.getElementById('progress-bar');
    const progressPercent = document.getElementById('progress-percent');
    const uploadBtn = document.getElementById('upload-btn');
    
    if (!uploadForm) return; // Not on data management page
    
    // Drag and drop functionality
    uploadArea.addEventListener('dragover', function(e) {
        e.preventDefault();
        uploadArea.classList.add('border-purple-400', 'bg-purple-50');
    });
    
    uploadArea.addEventListener('dragleave', function(e) {
        e.preventDefault();
        uploadArea.classList.remove('border-purple-400', 'bg-purple-50');
    });
    
    uploadArea.addEventListener('drop', function(e) {
        e.preventDefault();
        uploadArea.classList.remove('border-purple-400', 'bg-purple-50');
        
        const files = e.dataTransfer.files;
        if (files.length > 0) {
            fileInput.files = files;
            uploadArea.querySelector('span').textContent = files[0].name;
        }
    });
    
    // File input change
    fileInput.addEventListener('change', function(e) {
        if (e.target.files.length > 0) {
            uploadArea.querySelector('span').textContent = e.target.files[0].name;
        }
    });
    
    // Form submission
    uploadForm.addEventListener('submit', function(e) {
        e.preventDefault();
        
        if (!fileInput.files.length) {
            alert('Пожалуйста, выберите файл для загрузки');
            return;
        }
        
        const formData = new FormData();
        formData.append('excel_file', fileInput.files[0]);
        formData.append('replace_data', document.getElementById('replace-data').checked);
        formData.append('auto_sync', document.getElementById('auto-sync').checked);
        
        // Show progress
        progressDiv.classList.remove('hidden');
        uploadBtn.disabled = true;
        uploadBtn.querySelector('span').innerHTML = `
            <svg class="w-5 h-5 mr-2 animate-spin" fill="currentColor" viewBox="0 0 20 20">
                <path d="M4 2a2 2 0 00-2 2v12a2 2 0 002 2h12a2 2 0 002-2V4a2 2 0 00-2-2H4z"/>
            </svg>
            Обрабатывается...
        `;
        
        // Simulate progress
        let progress = 0;
        const progressInterval = setInterval(() => {
            progress += Math.random() * 20;
            if (progress > 90) progress = 90;
            progressBar.style.width = progress + '%';
            progressPercent.textContent = Math.round(progress) + '%';
        }, 500);
        
        fetch('/admin/upload-excel', {
            method: 'POST',
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            clearInterval(progressInterval);
            progressBar.style.width = '100%';
            progressPercent.textContent = '100%';
            
            setTimeout(() => {
                progressDiv.classList.add('hidden');
                uploadBtn.disabled = false;
                uploadBtn.querySelector('span').innerHTML = `
                    <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zM6.293 6.707a1 1 0 010-1.414l3-3a1 1 0 011.414 0l3 3a1 1 0 01-1.414 1.414L11 5.414V13a1 1 0 11-2 0V5.414L7.707 6.707a1 1 0 01-1.414 0z" clip-rule="evenodd"/>
                    </svg>
                    Загрузить и обработать
                `;
                
                // Show results
                showUploadResults(data);
                
                // Reload stats
                loadDataStats();
                
                // Reset form
                uploadForm.reset();
                uploadArea.querySelector('span').textContent = 'Перетащите Excel файл сюда или выберите файл';
                
            }, 1000);
        })
        .catch(error => {
            clearInterval(progressInterval);
            console.error('Upload error:', error);
            
            progressDiv.classList.add('hidden');
            uploadBtn.disabled = false;
            uploadBtn.querySelector('span').innerHTML = `
                <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zM6.293 6.707a1 1 0 010-1.414l3-3a1 1 0 011.414 0l3 3a1 1 0 01-1.414 1.414L11 5.414V13a1 1 0 11-2 0V5.414L7.707 6.707a1 1 0 01-1.414 0z" clip-rule="evenodd"/>
                </svg>
                Загрузить и обработать
            `;
            
            showUploadResults({success: false, error: 'Ошибка загрузки файла'});
        });
    });
});

// Testing functions
function runFullSystemTest() {
    runTest('/admin/test-system', 'Полная проверка системы');
}

function testColumnMapping() {
    runTest('/admin/test-columns', 'Проверка 77 колонок Excel');
}

function testNewDataCreation() {
    runTest('/admin/test-new-data', 'Тест создания новых данных');
}

function validateDataIntegrity() {
    runTest('/admin/test-system', 'Проверка целостности данных');
}

function runTest(endpoint, testName) {
    const testResults = document.getElementById('test-results');
    const testLog = document.getElementById('test-log');
    
    // Show test area
    testResults.classList.remove('hidden');
    testLog.textContent = `🔄 Запуск теста: ${testName}\n\nОжидайте результатов...`;
    
    // Scroll to results
    testResults.scrollIntoView({ behavior: 'smooth' });
    
    fetch(endpoint, { method: 'POST' })
        .then(response => response.json())
        .then(data => {
            let result = `✅ ТЕСТ ЗАВЕРШЕН: ${testName}\n`;
            result += `═════════════════════════════════════════\n\n`;
            
            if (data.success) {
                result += `✅ РЕЗУЛЬТАТ: УСПЕШНО\n\n`;
                result += `📋 ДЕТАЛИ:\n${data.output}`;
            } else {
                result += `❌ РЕЗУЛЬТАТ: ОШИБКА\n\n`;
                result += `📋 ДЕТАЛИ:\n${data.error || data.output}`;
            }
            
            testLog.textContent = result;
            
            // Reload stats after test
            loadDataStats();
        })
        .catch(error => {
            testLog.textContent = `❌ ОШИБКА ВЫПОЛНЕНИЯ ТЕСТА: ${testName}\n\nОшибка: ${error.message}`;
        });
}

function showUploadResults(data) {
    const uploadResults = document.getElementById('upload-results');
    const uploadLog = document.getElementById('upload-log');
    
    uploadResults.classList.remove('hidden');
    
    if (data.success) {
        uploadLog.innerHTML = `
            <div class="flex items-center mb-3">
                <svg class="w-6 h-6 text-green-600 mr-2" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"/>
                </svg>
                <h4 class="text-lg font-semibold text-green-800">Файл успешно загружен!</h4>
            </div>
            <p class="text-gray-700">${data.message}</p>
        `;
    } else {
        uploadLog.innerHTML = `
            <div class="flex items-center mb-3">
                <svg class="w-6 h-6 text-red-600 mr-2" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd"/>
                </svg>
                <h4 class="text-lg font-semibold text-red-800">Ошибка загрузки</h4>
            </div>
            <p class="text-gray-700">${data.error}</p>
        `;
    }
    
    // Scroll to results
    uploadResults.scrollIntoView({ behavior: 'smooth' });
}

// =============================
// DEALS FUNCTIONALITY
// =============================

// Global deals data
let currentDeals = [];
let currentDealsFilter = 'all';

// Load deals when deals tab is opened
function loadDeals() {
    const loadingState = document.getElementById('deals-loading-state');
    const emptyState = document.getElementById('deals-empty-state');
    const dealsList = document.getElementById('deals-list');
    
    // Show loading state
    loadingState.classList.remove('hidden');
    emptyState.classList.add('hidden');
    dealsList.innerHTML = '';
    
    fetch('/api/deals', {
        method: 'GET',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': document.querySelector('meta[name="csrf-token"]').content
        }
    })
    .then(response => response.json())
    .then(data => {
        loadingState.classList.add('hidden');
        
        if (data.success && data.deals && data.deals.length > 0) {
            currentDeals = data.deals;
            updateDealsStats(currentDeals);
            renderDeals(currentDeals);
            updateDealsCount(currentDeals.length);
        } else {
            currentDeals = [];
            updateDealsStats([]);
            emptyState.classList.remove('hidden');
            updateDealsCount(0);
        }
    })
    .catch(error => {
        console.error('Error loading deals:', error);
        loadingState.classList.add('hidden');
        emptyState.classList.remove('hidden');
        updateDealsCount(0);
    });
}

// Update deals statistics
function updateDealsStats(deals) {
    const totalCount = deals.length;
    const activeCount = deals.filter(d => ['new', 'object_reserved', 'mortgage'].includes(d.status)).length;
    const completedCount = deals.filter(d => d.status === 'successful').length;
    const totalCashback = deals.reduce((sum, d) => sum + (d.cashback_amount || 0), 0);
    
    document.getElementById('deals-total-count').textContent = totalCount;
    document.getElementById('deals-active-count').textContent = activeCount;
    document.getElementById('deals-completed-count').textContent = completedCount;
    document.getElementById('deals-cashback-total').textContent = formatPrice(totalCashback);
}

// Render deals cards
function renderDeals(deals) {
    const dealsList = document.getElementById('deals-list');
    const template = document.getElementById('deal-card-template');
    
    dealsList.innerHTML = '';
    
    deals.forEach(deal => {
        const cardClone = template.cloneNode(true);
        cardClone.id = `deal-${deal.id}`;
        cardClone.classList.remove('hidden');
        
        // Fill in deal data
        const numberShort = deal.deal_number.replace('DL', '');
        cardClone.querySelector('.deal-number-short').textContent = numberShort.slice(-3);
        cardClone.querySelector('.deal-number').textContent = `Сделка ${deal.deal_number}`;
        cardClone.querySelector('.deal-created-at').textContent = formatDate(deal.created_at);
        
        // Status badge
        const statusBadge = cardClone.querySelector('.deal-status-badge');
        statusBadge.textContent = deal.status_display;
        statusBadge.className = `status-badge status-${deal.status}`;
        
        // Property details
        cardClone.querySelector('.deal-complex-name').textContent = deal.complex_name;
        cardClone.querySelector('.deal-property-description').textContent = deal.property_description || 'Описание не указано';
        
        // Property specs
        const specs = [];
        if (deal.property_area) specs.push(`${deal.property_area} м²`);
        if (deal.property_rooms) specs.push(`${deal.property_rooms} комн.`);
        if (deal.property_floor) specs.push(`${deal.property_floor} этаж`);
        
        cardClone.querySelector('.deal-property-area').textContent = specs[0] || '';
        cardClone.querySelector('.deal-property-rooms').textContent = specs[1] || '';
        cardClone.querySelector('.deal-property-floor').textContent = specs[2] || '';
        
        // Price and cashback
        cardClone.querySelector('.deal-price').textContent = formatPrice(deal.property_price);
        cardClone.querySelector('.deal-cashback').textContent = formatPrice(deal.cashback_amount);
        cardClone.querySelector('.deal-cashback-percent').textContent = `${deal.cashback_percentage.toFixed(1)}%`;
        
        // Client notes
        if (deal.client_notes) {
            cardClone.querySelector('.deal-client-notes-section').classList.remove('hidden');
            cardClone.querySelector('.deal-client-notes').textContent = deal.client_notes;
        }
        
        dealsList.appendChild(cardClone);
    });
}

// Filter deals by status
function filterDeals(statusFilter) {
    currentDealsFilter = statusFilter;
    
    // Update filter buttons
    document.querySelectorAll('.deals-filter-btn').forEach(btn => {
        btn.classList.remove('active');
    });
    document.querySelector(`[data-status="${statusFilter}"]`).classList.add('active');
    
    // Filter deals
    let filteredDeals = currentDeals;
    if (statusFilter !== 'all') {
        const statusArray = statusFilter.split(',');
        filteredDeals = currentDeals.filter(deal => statusArray.includes(deal.status));
    }
    
    // Render filtered deals
    if (filteredDeals.length > 0) {
        document.getElementById('deals-empty-state').classList.add('hidden');
        renderDeals(filteredDeals);
    } else {
        document.getElementById('deals-list').innerHTML = '';
        document.getElementById('deals-empty-state').classList.remove('hidden');
    }
}

// Update deals count in tab
function updateDealsCount(count) {
    const countElement = document.getElementById('deals-count');
    if (countElement) {
        countElement.textContent = count;
        countElement.classList.toggle('hidden', count === 0);
    }
}

// Format price helper
function formatPrice(price) {
    if (!price) return '0 ₽';
    return new Intl.NumberFormat('ru-RU', {
        style: 'currency',
        currency: 'RUB',
        minimumFractionDigits: 0,
        maximumFractionDigits: 0
    }).format(price);
}

// Format date helper
function formatDate(dateString) {
    const date = new Date(dateString);
    return date.toLocaleDateString('ru-RU', {
        day: '2-digit',
        month: '2-digit',
        year: 'numeric'
    });
}

// Initialize deals filter event listeners
document.addEventListener('DOMContentLoaded', function() {
    // Add event listeners for filter buttons
    document.querySelectorAll('.deals-filter-btn').forEach(button => {
        button.addEventListener('click', function() {
            const status = this.getAttribute('data-status');
            filterDeals(status);
        });
    });
    
    // Add deals loading to tab click events
    document.addEventListener('click', function(e) {
        const target = e.target.closest('[data-page="deals"]');
        if (target) {
            // Small delay to ensure page is shown first
            setTimeout(() => {
                console.log('🤝 Loading deals after tab click...');
                loadDeals();
            }, 100);
        }
    });
    
    // Also hook into existing showPage function if it exists
    const originalShowPage = window.showPage;
    window.showPage = function(pageId) {
        // Call original function first
        if (originalShowPage) {
            originalShowPage(pageId);
        }
        
        // Load deals when deals page is shown
        if (pageId === 'deals') {
            console.log('🤝 Loading deals via showPage...');
            loadDeals();
        }
    };
});

// Mark presentation as viewed
async function markPresentationViewed(event, collectionId) {
    console.log(`📋 markPresentationViewed called for collection ${collectionId}`);
    
    const isNew = event.currentTarget.getAttribute('data-is-new') === 'true';
    console.log(`📋 Is new status: ${isNew}`);
    
    // If already viewed, just open
    if (!isNew) {
        console.log(`📋 Already viewed, skipping mark as viewed`);
        return true;
    }
    
    try {
        console.log(`📋 Sending mark-viewed request...`);
        // Send request to mark as viewed
        const response = await fetch(`/collection/${collectionId}/mark-viewed`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCsrfToken()
            }
        });
        
        console.log(`📋 Mark-viewed response status: ${response.status}`);
        
        if (response.ok) {
            // Find and remove the "Новая" badge
            const card = event.currentTarget.closest('.border');
            const badge = card.querySelector('.bg-blue-100.text-blue-800');
            if (badge) {
                console.log(`📋 Found badge, removing...`);
                badge.style.transition = 'all 0.3s ease-out';
                badge.style.opacity = '0';
                badge.style.transform = 'scale(0.8)';
                setTimeout(() => badge.remove(), 300);
            } else {
                console.log(`📋 No badge found`);
            }
            
            // Update data attribute
            event.currentTarget.setAttribute('data-is-new', 'false');
            
            console.log(`✅ Презентация ${collectionId} отмечена как просмотренная`);
        } else {
            console.error(`❌ Mark-viewed failed with status ${response.status}`);
        }
    } catch (error) {
        console.error('❌ Ошибка при отметке презентации:', error);
    }
    
    // Continue opening presentation
    return true;
}

// Delete presentation
async function deletePresentation(collectionId) {
    if (!confirm('Вы уверены, что хотите удалить эту презентацию? Это действие нельзя отменить.')) {
        return;
    }
    
    try {
        const response = await fetch(`/api/user/presentation/${collectionId}/delete`, {
            method: 'DELETE',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCsrfToken()
            }
        });
        
        const data = await response.json();
        
        if (data.success) {
            // Remove card from DOM with animation
            const card = event.target.closest('.border');
            if (card) {
                card.style.opacity = '0';
                card.style.transform = 'scale(0.95)';
                card.style.transition = 'all 0.3s ease-out';
                setTimeout(() => {
                    card.remove();
                    // Reload page if no more presentations
                    const remaining = document.querySelectorAll('#presentationsList .border').length;
                    if (remaining === 0) {
                        location.reload();
                    }
                }, 300);
            }
            
            // Show success notification
            const notification = document.createElement('div');
            notification.className = 'fixed top-4 right-4 bg-green-500 text-white px-6 py-3 rounded-lg shadow-lg z-50';
            notification.textContent = 'Презентация удалена';
            document.body.appendChild(notification);
            setTimeout(() => notification.remove(), 3000);
        } else {
            alert(data.error || 'Ошибка при удалении презентации');
        }
    } catch (error) {
        console.error('Error deleting presentation:', error);
        alert('Ошибка при удалении презентации');
    }
}

// Send presentation to manager
async function sendPresentationToManager(collectionId) {
    if (!confirm('Отправить ответ менеджеру? Это уведомит вашего менеджера о просмотре презентации.')) {
        return;
    }
    
    try {
        const response = await fetch(`/api/collection/${collectionId}/notify-manager`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCsrfToken()
            }
        });
        
        const data = await response.json();
        
        if (response.ok) {
            alert('Уведомление отправлено менеджеру!');
        } else {
            alert(data.error || 'Ошибка при отправке уведомления');
        }
    } catch (error) {
        console.error('Error sending notification:', error);
        alert('Ошибка при отправке уведомления');
    }
}

// =============================
// PHONE VERIFICATION
// =============================

async function bindPhone() {
    const phone = document.getElementById('phoneInput').value.trim();
    
    if (!phone) {
        alert('Пожалуйста, введите номер телефона');
        return;
    }
    
    try {
        const response = await fetch('/api/user/phone/send-verification', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCsrfToken()
            },
            body: JSON.stringify({ phone })
        });
        
        const data = await response.json();
        
        if (data.success) {
            showVerificationCodeModal(phone);
        } else {
            alert(data.message || 'Ошибка отправки кода');
        }
    } catch (error) {
        console.error('Error sending verification code:', error);
        alert('Ошибка отправки кода. Попробуйте позже.');
    }
}

function changePhone() {
    location.reload();
}

function showVerificationCodeModal(phone) {
    const modal = document.createElement('div');
    modal.id = 'verification-modal';
    modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
    modal.innerHTML = `
        <div class="bg-white rounded-xl p-6 max-w-md w-full mx-4">
            <h3 class="text-xl font-bold text-gray-900 mb-4">Подтверждение телефона</h3>
            <p class="text-gray-600 mb-4">Введите код из SMS, отправленный на номер ${phone}</p>
            <input 
                type="text" 
                id="verification-code"
                maxlength="6"
                placeholder="Код из SMS"
                class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[#0088CC] focus:border-[#0088CC] mb-4"
            />
            <div class="flex space-x-3">
                <button 
                    onclick="verifyPhoneCode()" 
                    class="flex-1 px-4 py-2 bg-gradient-to-r from-[#0088CC] to-[#006699] text-white font-medium rounded-lg hover:from-[#006699] hover:to-[#004466] transition-all"
                >
                    Подтвердить
                </button>
                <button 
                    onclick="closeVerificationModal()" 
                    class="flex-1 px-4 py-2 bg-gray-200 text-gray-700 font-medium rounded-lg hover:bg-gray-300 transition-colors"
                >
                    Отмена
                </button>
            </div>
        </div>
    `;
    document.body.appendChild(modal);
    document.getElementById('verification-code').focus();
}

async function verifyPhoneCode() {
    const code = document.getElementById('verification-code').value.trim();
    
    if (!code) {
        alert('Введите код');
        return;
    }
    
    try {
        const response = await fetch('/api/user/phone/verify-code', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCsrfToken()
            },
            body: JSON.stringify({ code })
        });
        
        const data = await response.json();
        
        if (data.success) {
            alert('Телефон успешно подтвержден!');
            closeVerificationModal();
            location.reload();
        } else {
            alert(data.message || 'Неверный код');
        }
    } catch (error) {
        console.error('Error verifying code:', error);
        alert('Ошибка проверки кода. Попробуйте позже.');
    }
}

function closeVerificationModal() {
    const modal = document.getElementById('verification-modal');
    if (modal) {
        modal.remove();
    }
}

</script>

<!-- Load PostgreSQL comparison functionality -->
<script src="{{ url_for('static', filename='js/properties-comparison-fix.js') }}"></script>
{% endblock %}
