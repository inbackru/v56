{% extends "base.html" %}

{% block title %}–ü–∞–Ω–µ–ª—å –º–µ–Ω–µ–¥–∂–µ—Ä–∞ | InBack{% endblock %}

{% block content %}
<style>
.content-section {
    display: none;
}

.content-section.active {
    display: block;
}

.tab-button.active {
    color: #0088CC !important;
    border-color: #0088CC !important;
}

.tab-button:hover {
    color: #374151 !important;
    border-color: #D1D5DB !important;
}

/* Internal favorites tabs */
.favorites-tab-content {
    display: none;
}

.favorites-tab-content.active {
    display: block;
}

.favorites-tab-button.active {
    color: #0088CC !important;
    border-color: #0088CC !important;
}
</style>

<!-- Tab Navigation under main header -->
<div class="bg-white border-b border-gray-200">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
        <div class="flex items-center justify-between py-4">
            <div class="flex items-center space-x-4">
                <div class="flex items-center space-x-3">
                    <div class="w-10 h-10 rounded-full bg-gradient-to-br from-[#0088CC] to-[#006699] flex items-center justify-center">
                        <span class="text-white font-semibold">{{ current_manager.full_name[0] }}</span>
                    </div>
                    <div>
                        <p class="text-lg font-semibold text-gray-900">{{ current_manager.full_name }}</p>
                        <p class="text-sm text-gray-500">–ú–µ–Ω–µ–¥–∂–µ—Ä –Ω–µ–¥–≤–∏–∂–∏–º–æ—Å—Ç–∏
                            {% if current_manager.email.startswith('demo') %}
                                <span class="inline-block ml-2 px-2 py-1 text-xs bg-gradient-to-r from-[#0088CC] to-[#006699] text-white rounded-full">–î–ï–ú–û</span>
                            {% endif %}
                        </p>
                    </div>
                </div>
            </div>
            <div class="flex items-center space-x-4">
                <a href="/logout" class="text-gray-500 hover:text-gray-700 text-sm">–í—ã–π—Ç–∏</a>
                <a href="/" class="text-[#0088CC] hover:text-[#006699] text-sm flex items-center">
                    <svg class="w-4 h-4 mr-1" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M9.707 16.707a1 1 0 01-1.414 0l-6-6a1 1 0 010-1.414l6-6a1 1 0 011.414 1.414L5.414 9H17a1 1 0 110 2H5.414l4.293 4.293a1 1 0 010 1.414z" clip-rule="evenodd"/>
                    </svg>
                    –ù–∞ —Å–∞–π—Ç
                </a>
            </div>
        </div>
        <div class="overflow-x-auto">
            <nav class="flex space-x-8" aria-label="Tabs">
                <a class="flex items-center px-1 py-4 text-sm font-medium border-b-2 border-[#0088CC] text-[#0088CC] whitespace-nowrap tab-button active" href="#" data-page="dashboard">
                    <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20">
                        <path d="M10 2L3 7v11h3v-6h8v6h3V7l-7-5z"/>
                    </svg>
                    –ì–ª–∞–≤–Ω–∞—è
                </a>
                <a class="flex items-center px-1 py-4 text-sm font-medium border-b-2 border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 whitespace-nowrap tab-button" href="#" data-page="clients">
                    <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20">
                        <path d="M9 6a3 3 0 11-6 0 3 3 0 016 0zM17 6a3 3 0 11-6 0 3 3 0 016 0zM12.93 17c.046-.327.07-.66.07-1a6.97 6.97 0 00-1.5-4.33A5 5 0 0119 16v1h-6.07zM6 11a5 5 0 015 5v1H1v-1a5 5 0 015-5z"/>
                    </svg>
                    –ö–ª–∏–µ–Ω—Ç—ã
                    <span class="ml-2 bg-gradient-to-r from-blue-500 to-blue-600 text-white text-xs px-2 py-1 rounded-full font-medium" id="clients-count">{{ total_clients }}</span>
                </a>
                <a class="flex items-center px-1 py-4 text-sm font-medium border-b-2 border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 whitespace-nowrap tab-button" href="#" data-page="presentations">
                    <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20">
                        <path d="M3 4a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zM3 10a1 1 0 011-1h6a1 1 0 110 2H4a1 1 0 01-1-1zM3 16a1 1 0 011-1h6a1 1 0 110 2H4a1 1 0 01-1-1z"/>
                        <path d="M16 5a1 1 0 011 1v8a1 1 0 01-1 1h-4V5h4z"/>
                    </svg>
                    –ü—Ä–µ–∑–µ–Ω—Ç–∞—Ü–∏–∏
                    <span class="ml-2 bg-gradient-to-r from-purple-500 to-purple-600 text-white text-xs px-2 py-1 rounded-full font-medium" id="presentations-count">{{ presentations_count }}</span>
                </a>
                <a class="flex items-center px-1 py-4 text-sm font-medium border-b-2 border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 whitespace-nowrap tab-button" href="#" data-page="saved-searches">
                    <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M8 4a4 4 0 100 8 4 4 0 000-8zM2 8a6 6 0 1110.89 3.476l4.817 4.817a1 1 0 01-1.414 1.414l-4.816-4.816A6 6 0 012 8z" clip-rule="evenodd"/>
                    </svg>
                    –°–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–µ –ø–æ–∏—Å–∫–∏
                    <span class="ml-2 bg-gradient-to-r from-green-500 to-green-600 text-white text-xs px-2 py-1 rounded-full font-medium" id="saved-searches-count" style="display: none;">0</span>
                </a>
                <a class="flex items-center px-1 py-4 text-sm font-medium border-b-2 border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 whitespace-nowrap" href="{{ url_for('manager_favorites') }}">
                    <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20">
                        <path d="M3.172 5.172a4 4 0 015.656 0L10 6.343l1.172-1.171a4 4 0 115.656 5.656L10 17.657l-6.828-6.829a4 4 0 010-5.656z"/>
                    </svg>
                    –ò–∑–±—Ä–∞–Ω–Ω–æ–µ
                    <span class="ml-2 bg-gradient-to-r from-red-500 to-red-600 text-white text-xs px-2 py-1 rounded-full font-medium" id="favorites-total-count">0</span>
                </a>
                <a class="flex items-center px-1 py-4 text-sm font-medium border-b-2 border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 whitespace-nowrap" href="{{ url_for('manager_property_comparison') }}">
                    <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20">
                        <path d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z"/>
                    </svg>
                    –°—Ä–∞–≤–Ω–µ–Ω–∏–µ
                    <span class="ml-2 bg-gradient-to-r from-orange-500 to-orange-600 text-white text-xs px-2 py-1 rounded-full font-medium" id="comparison-count">0</span>
                </a>
                <a class="flex items-center px-1 py-4 text-sm font-medium border-b-2 border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 whitespace-nowrap tab-button" href="#" data-page="deals">
                    <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20">
                        <path d="M13 6a3 3 0 11-6 0 3 3 0 016 0zM18 8a2 2 0 11-4 0 2 2 0 014 0zM14 15a4 4 0 108 0v-1a6 6 0 00-6-6H4a6 6 0 00-6 6v1a4 4 0 108 0z"/>
                    </svg>
                    ü§ù –°–î–ï–õ–ö–ò
                    <span class="ml-2 bg-gradient-to-r from-red-500 to-red-600 text-white text-xs px-2 py-1 rounded-full font-medium" id="deals-count">0</span>
                </a>
            </nav>
        </div>
    </div>
</div>

<!-- Main Content Area - Full Width -->
<div class="bg-gradient-to-b from-white to-gray-50 min-h-screen">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <!-- Dashboard Section (Default) -->
        <div class="content-section active" id="dashboard">
            <div class="bg-white rounded-xl shadow-sm p-6 mb-8">
                <div class="text-center bg-gradient-to-br from-blue-50 to-blue-100 rounded-xl p-8 mb-8">
                    <div class="inline-flex items-center justify-center w-16 h-16 bg-gradient-to-br from-[#0088CC] to-[#006699] rounded-full mb-4" id="welcome-icon">
                        <svg class="w-8 h-8 text-white" fill="currentColor" viewBox="0 0 20 20">
                            <path d="M9 6a3 3 0 11-6 0 3 3 0 016 0zM17 6a3 3 0 11-6 0 3 3 0 016 0zM12.93 17c.046-.327.07-.66.07-1a6.97 6.97 0 00-1.5-4.33A5 5 0 0119 16v1h-6.07zM6 11a5 5 0 015 5v1H1v-1a5 5 0 015-5z"/>
                        </svg>
                    </div>
                    <div id="welcome-message-container">
                        <h2 class="text-3xl font-bold text-gray-900 mb-2" id="welcome-title">–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å, {{ current_manager.full_name.split()[0] }}!</h2>
                        <div id="welcome-messages" class="space-y-2 mb-6">
                            <p class="text-lg text-gray-600">–ü–∞–Ω–µ–ª—å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –º–µ–Ω–µ–¥–∂–µ—Ä–∞ –Ω–µ–¥–≤–∏–∂–∏–º–æ—Å—Ç–∏</p>
                        </div>
                    </div>
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4 text-center">
                        <div class="bg-white rounded-lg p-4 shadow-sm">
                            <div class="text-2xl font-bold text-[#0088CC]">{{ total_clients }}</div>
                            <div class="text-sm text-gray-600">–ö–ª–∏–µ–Ω—Ç–æ–≤</div>
                        </div>
                        <div class="bg-white rounded-lg p-4 shadow-sm">
                            <div class="text-2xl font-bold text-green-600">{{ collections_count }}</div>
                            <div class="text-sm text-gray-600">–ü–æ–¥–±–æ—Ä–æ–∫</div>
                        </div>
                        <div class="bg-white rounded-lg p-4 shadow-sm">
                            <div class="text-2xl font-bold text-blue-600">{{ presentations_count }}</div>
                            <div class="text-sm text-gray-600">–ü—Ä–µ–∑–µ–Ω—Ç–∞—Ü–∏–π</div>
                        </div>
                        <div class="bg-white rounded-lg p-4 shadow-sm">
                            <div class="text-2xl font-bold text-purple-600">{{ deals_count }}</div>
                            <div class="text-sm text-gray-600">–°–¥–µ–ª–æ–∫</div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Quick Actions -->
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 mb-8">
                <!-- Create Collection -->
                <div class="bg-white rounded-xl shadow-sm p-6 hover:shadow-md transition-shadow cursor-pointer" onclick="showSection('create-collection')">
                    <div class="flex items-center mb-4">
                        <div class="w-12 h-12 bg-gradient-to-br from-[#0088CC] to-[#006699] rounded-lg flex items-center justify-center mr-4">
                            <svg class="w-6 h-6 text-white" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-11a1 1 0 10-2 0v2H7a1 1 0 100 2h2v2a1 1 0 102 0v-2h2a1 1 0 100-2h-2V7z" clip-rule="evenodd"/>
                            </svg>
                        </div>
                        <div>
                            <h3 class="text-lg font-semibold text-gray-900">–°–æ–∑–¥–∞—Ç—å –ø–æ–¥–±–æ—Ä–∫—É</h3>
                            <p class="text-sm text-gray-600">–ü–æ–¥–±–µ—Ä–∏—Ç–µ –Ω–µ–¥–≤–∏–∂–∏–º–æ—Å—Ç—å –¥–ª—è –∫–ª–∏–µ–Ω—Ç–∞</p>
                        </div>
                    </div>
                    <div class="flex items-center justify-between">
                        <span class="text-sm text-gray-500">–ù–∞–∂–º–∏—Ç–µ –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è</span>
                        <svg class="w-5 h-5 text-gray-400" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clip-rule="evenodd"/>
                        </svg>
                    </div>
                </div>
                
                <!-- Manage Clients -->
                <div class="bg-white rounded-xl shadow-sm p-6 hover:shadow-md transition-shadow cursor-pointer" onclick="showSection('clients')">
                    <div class="flex items-center mb-4">
                        <div class="w-12 h-12 bg-gradient-to-br from-green-500 to-green-600 rounded-lg flex items-center justify-center mr-4">
                            <svg class="w-6 h-6 text-white" fill="currentColor" viewBox="0 0 20 20">
                                <path d="M9 6a3 3 0 11-6 0 3 3 0 016 0zM17 6a3 3 0 11-6 0 3 3 0 016 0zM12.93 17c.046-.327.07-.66.07-1a6.97 6.97 0 00-1.5-4.33A5 5 0 0119 16v1h-6.07zM6 11a5 5 0 015 5v1H1v-1a5 5 0 015-5z"/>
                            </svg>
                        </div>
                        <div>
                            <h3 class="text-lg font-semibold text-gray-900">–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∫–ª–∏–µ–Ω—Ç–∞–º–∏</h3>
                            <p class="text-sm text-gray-600">{{ total_clients }} –∞–∫—Ç–∏–≤–Ω—ã—Ö –∫–ª–∏–µ–Ω—Ç–æ–≤</p>
                        </div>
                    </div>
                    <div class="flex items-center justify-between">
                        <span class="text-sm text-gray-500">–ü—Ä–æ—Å–º–æ—Ç—Ä –∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ</span>
                        <svg class="w-5 h-5 text-gray-400" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clip-rule="evenodd"/>
                        </svg>
                    </div>
                </div>

                <!-- View Collections -->
                <div class="bg-white rounded-xl shadow-sm p-6 hover:shadow-md transition-shadow cursor-pointer" onclick="showSection('collections')">
                    <div class="flex items-center mb-4">
                        <div class="w-12 h-12 bg-gradient-to-br from-blue-500 to-blue-600 rounded-lg flex items-center justify-center mr-4">
                            <svg class="w-6 h-6 text-white" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M3 4a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm0 4a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm0 4a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1z" clip-rule="evenodd"/>
                            </svg>
                        </div>
                        <div>
                            <h3 class="text-lg font-semibold text-gray-900">–ú–æ–∏ –ø–æ–¥–±–æ—Ä–∫–∏</h3>
                            <p class="text-sm text-gray-600">{{ collections_count }} —Å–æ–∑–¥–∞–Ω–Ω—ã—Ö –ø–æ–¥–±–æ—Ä–æ–∫</p>
                        </div>
                    </div>
                    <div class="flex items-center justify-between">
                        <span class="text-sm text-gray-500">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ –æ—Ç–ø—Ä–∞–≤–∫–∞</span>
                        <svg class="w-5 h-5 text-gray-400" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clip-rule="evenodd"/>
                        </svg>
                    </div>
                </div>

                <!-- New Favorite Properties -->
                <div class="bg-white rounded-xl shadow-sm p-6 hover:shadow-md transition-shadow cursor-pointer" onclick="showSection('favorites')">
                    <div class="flex items-center mb-4">
                        <div class="w-12 h-12 bg-gradient-to-br from-pink-500 to-pink-600 rounded-lg flex items-center justify-center mr-4">
                            <svg class="w-6 h-6 text-white" fill="currentColor" viewBox="0 0 20 20">
                                <path d="M3.172 5.172a4 4 0 015.656 0L10 6.343l1.172-1.171a4 4 0 115.656 5.656L10 17.657l-6.828-6.829a4 4 0 010-5.656z"/>
                            </svg>
                        </div>
                        <div>
                            <h3 class="text-lg font-semibold text-gray-900">–ò–∑–±—Ä–∞–Ω–Ω—ã–µ –æ–±—ä–µ–∫—Ç—ã</h3>
                            <p class="text-sm text-gray-600"><span id="new-properties-count">0</span> —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã—Ö –æ–±—ä–µ–∫—Ç–æ–≤</p>
                        </div>
                    </div>
                    <div class="flex items-center justify-between">
                        <span class="text-sm text-gray-500">–ü—Ä–æ—Å–º–æ—Ç—Ä –∏ —ç–∫—Å–ø–æ—Ä—Ç</span>
                        <svg class="w-5 h-5 text-gray-400" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clip-rule="evenodd"/>
                        </svg>
                    </div>
                </div>

                <!-- New Favorite Complexes -->
                <div class="bg-white rounded-xl shadow-sm p-6 hover:shadow-md transition-shadow cursor-pointer" onclick="showSection('favorite-complexes')">
                    <div class="flex items-center mb-4">
                        <div class="w-12 h-12 bg-gradient-to-br from-purple-500 to-purple-600 rounded-lg flex items-center justify-center mr-4">
                            <svg class="w-6 h-6 text-white" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M4 3a2 2 0 00-2 2v10a2 2 0 002 2h12a2 2 0 002-2V5a2 2 0 00-2-2H4zm12 12H4l4-8 3 6 2-4 3 6z" clip-rule="evenodd"/>
                            </svg>
                        </div>
                        <div>
                            <h3 class="text-lg font-semibold text-gray-900">–ò–∑–±—Ä–∞–Ω–Ω—ã–µ –ñ–ö</h3>
                            <p class="text-sm text-gray-600"><span id="new-complexes-count">0</span> –∂–∏–ª—ã—Ö –∫–æ–º–ø–ª–µ–∫—Å–æ–≤</p>
                        </div>
                    </div>
                    <div class="flex items-center justify-between">
                        <span class="text-sm text-gray-500">–ü—Ä–æ—Å–º–æ—Ç—Ä –∏ –∞–Ω–∞–ª–∏–∑</span>
                        <svg class="w-5 h-5 text-gray-400" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clip-rule="evenodd"/>
                        </svg>
                    </div>
                </div>

                <!-- Property Comparison -->
                <div class="bg-white rounded-xl shadow-sm p-6 hover:shadow-md transition-shadow cursor-pointer" onclick="window.location.href='/manager/property-comparison'">
                    <div class="flex items-center mb-4">
                        <div class="w-12 h-12 bg-gradient-to-br from-orange-500 to-orange-600 rounded-lg flex items-center justify-center mr-4">
                            <svg class="w-6 h-6 text-white" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M3 4a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm0 4a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm0 4a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1z" clip-rule="evenodd"/>
                                <path d="M9 2a1 1 0 000 2h2a1 1 0 100-2H9z"/>
                                <path fill-rule="evenodd" d="M4 5a2 2 0 012-2v1a1 1 0 001 1h6a1 1 0 001-1V3a2 2 0 012 2v6a2 2 0 01-2 2H6a2 2 0 01-2-2V5z" clip-rule="evenodd"/>
                            </svg>
                        </div>
                        <div>
                            <h3 class="text-lg font-semibold text-gray-900">–°—Ä–∞–≤–Ω–µ–Ω–∏–µ –æ–±—ä–µ–∫—Ç–æ–≤</h3>
                            <p class="text-sm text-gray-600">–ê–Ω–∞–ª–∏–∑ –∏ —Å—Ä–∞–≤–Ω–µ–Ω–∏–µ –Ω–µ–¥–≤–∏–∂–∏–º–æ—Å—Ç–∏</p>
                        </div>
                    </div>
                    <div class="flex items-center justify-between">
                        <span class="text-sm text-gray-500">–°–æ–∑–¥–∞–Ω–∏–µ –ø–æ–¥–±–æ—Ä–æ–∫</span>
                        <svg class="w-5 h-5 text-gray-400" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clip-rule="evenodd"/>
                        </svg>
                    </div>
                </div>
            </div>
            
            <!-- Recent Activity -->
            <div class="bg-white rounded-xl shadow-sm p-6">
                <h3 class="text-lg font-semibold text-gray-900 mb-4">–ü–æ—Å–ª–µ–¥–Ω—è—è –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å</h3>
                <div id="recent-recommendations" class="space-y-3">
                    <div class="text-gray-500 text-sm">–ó–∞–≥—Ä—É–∑–∫–∞ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏...</div>
                </div>
            </div>
        </div>

        <!-- Clients Section -->
        <div class="content-section" id="clients">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
                <div class="bg-white rounded-xl shadow-sm p-6 mb-6">
                <div class="flex items-center justify-between mb-6">
                    <h3 class="text-xl font-semibold text-gray-900">–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∫–ª–∏–µ–Ω—Ç–∞–º–∏</h3>
                    <button onclick="showAddClientModal()" class="bg-gradient-to-r from-[#0088CC] to-[#006699] hover:from-[#006699] hover:to-[#004466] text-white px-4 py-2 rounded-lg text-sm font-medium transition-all">
                        <svg class="w-4 h-4 mr-2 inline" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M10 3a1 1 0 011 1v5h5a1 1 0 110 2h-5v5a1 1 0 11-2 0v-5H4a1 1 0 110-2h5V4a1 1 0 011-1z" clip-rule="evenodd"/>
                        </svg>
                        –î–æ–±–∞–≤–∏—Ç—å –∫–ª–∏–µ–Ω—Ç–∞
                    </button>
                </div>
                
                <!-- Clients Table -->
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">–ò–º—è</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Email</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">–¢–µ–ª–µ—Ñ–æ–Ω</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">–°—Ç–∞—Ç—É—Å</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">–î–µ–π—Å—Ç–≤–∏—è</th>
                            </tr>
                        </thead>
                        <tbody id="clients-table-body" class="bg-white divide-y divide-gray-200">
                            <tr><td colspan="5" class="px-6 py-4 text-center text-gray-500">–ó–∞–≥—Ä—É–∑–∫–∞ –∫–ª–∏–µ–Ω—Ç–æ–≤...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
            </div>
        </div>

        <!-- Create Collection Section -->
        <div class="content-section" id="create-collection">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
                <div class="bg-white rounded-xl shadow-sm p-6">
                    <h2 class="text-2xl font-bold text-gray-800 mb-6">–°–æ–∑–¥–∞—Ç—å –ø–æ–¥–±–æ—Ä–∫—É –Ω–µ–¥–≤–∏–∂–∏–º–æ—Å—Ç–∏</h2>
                    
                    <!-- Collection Form -->
                    <form id="collection-form" class="space-y-6">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">–ù–∞–∑–≤–∞–Ω–∏–µ –ø–æ–¥–±–æ—Ä–∫–∏</label>
                                <input type="text" id="collection-name" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[#0088cc] focus:border-transparent" placeholder="–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –ø–æ–¥–±–æ—Ä–∫–∏">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">–ö–ª–∏–µ–Ω—Ç</label>
                                <div class="flex space-x-2">
                                    <select id="collection-client" class="flex-1 px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[#0088cc] focus:border-transparent">
                                        <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –∫–ª–∏–µ–Ω—Ç–∞</option>
                                    </select>
                                    <button type="button" id="add-client-btn" class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 text-sm whitespace-nowrap">
                                        + –î–æ–±–∞–≤–∏—Ç—å
                                    </button>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Property Search Section -->
                        <div class="border-t pt-6">
                            <h3 class="text-lg font-semibold text-gray-800 mb-4">–ü–æ–∏—Å–∫ –Ω–µ–¥–≤–∏–∂–∏–º–æ—Å—Ç–∏</h3>
                            <div class="space-y-4" id="property-search-container">
                                <!-- –û—Å–Ω–æ–≤–Ω—ã–µ —Ñ–∏–ª—å—Ç—Ä—ã -->
                                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-4">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">–†–∞–π–æ–Ω</label>
                                        <select id="filter-district" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[#0088cc] focus:border-transparent">
                                            <option value="">–í—Å–µ —Ä–∞–π–æ–Ω—ã</option>
                                            {% for district in districts %}
                                            <option value="{{ district }}">{{ district }}</option>
                                            {% endfor %}
                                        </select>
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">–ó–∞—Å—Ç—Ä–æ–π—â–∏–∫</label>
                                        <select id="filter-developer" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[#0088cc] focus:border-transparent">
                                            <option value="">–í—Å–µ –∑–∞—Å—Ç—Ä–æ–π—â–∏–∫–∏</option>
                                            {% for developer in developers %}
                                            <option value="{{ developer }}">{{ developer }}</option>
                                            {% endfor %}
                                        </select>
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">–ö–æ–º–Ω–∞—Ç—ã</label>
                                        <select id="filter-rooms" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[#0088cc] focus:border-transparent">
                                            <option value="">–õ—é–±–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ</option>
                                            <option value="—Å—Ç—É–¥–∏—è">–°—Ç—É–¥–∏—è</option>
                                            <option value="1">1 –∫–æ–º–Ω–∞—Ç–∞</option>
                                            <option value="2">2 –∫–æ–º–Ω–∞—Ç—ã</option>
                                            <option value="3">3 –∫–æ–º–Ω–∞—Ç—ã</option>
                                            <option value="4">4+ –∫–æ–º–Ω–∞—Ç</option>
                                        </select>
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">–ñ–∏–ª–æ–π –∫–æ–º–ø–ª–µ–∫—Å</label>
                                        <select id="filter-complex" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[#0088cc] focus:border-transparent">
                                            <option value="">–í—Å–µ –ñ–ö</option>
                                        </select>
                                    </div>
                                </div>

                                <!-- –¶–µ–Ω–∞ –∏ –ø–ª–æ—â–∞–¥—å -->
                                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-4">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">–¶–µ–Ω–∞ –æ—Ç</label>
                                        <input type="number" id="filter-price-min" placeholder="–û—Ç, ‚ÇΩ" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[#0088cc] focus:border-transparent">
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">–¶–µ–Ω–∞ –¥–æ</label>
                                        <input type="number" id="filter-price-max" placeholder="–î–æ, ‚ÇΩ" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[#0088cc] focus:border-transparent">
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">–ü–ª–æ—â–∞–¥—å –æ—Ç</label>
                                        <input type="number" id="filter-area-min" placeholder="–û—Ç, –º¬≤" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[#0088cc] focus:border-transparent">
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">–ü–ª–æ—â–∞–¥—å –¥–æ</label>
                                        <input type="number" id="filter-area-max" placeholder="–î–æ, –º¬≤" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[#0088cc] focus:border-transparent">
                                    </div>
                                </div>

                                <!-- –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —Ñ–∏–ª—å—Ç—Ä—ã (—Å–∫—Ä—ã—Ç—ã–µ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é) -->
                                <div class="border-t pt-4">
                                    <button id="toggle-advanced-filters" class="text-[#0088cc] hover:text-[#006699] text-sm font-medium mb-4">
                                        + –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —Ñ–∏–ª—å—Ç—Ä—ã
                                    </button>
                                    <div id="advanced-filters" class="manager-favorites-hidden space-y-4">
                                        <!-- –≠—Ç–∞–∂–∏ –∏ —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏ -->
                                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-4">
                                            <div>
                                                <label class="block text-sm font-medium text-gray-700 mb-2">–≠—Ç–∞–∂ –æ—Ç</label>
                                                <input type="number" id="filter-floor-min" placeholder="–û—Ç" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[#0088cc] focus:border-transparent">
                                            </div>
                                            <div>
                                                <label class="block text-sm font-medium text-gray-700 mb-2">–≠—Ç–∞–∂ –¥–æ</label>
                                                <input type="number" id="filter-floor-max" placeholder="–î–æ" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[#0088cc] focus:border-transparent">
                                            </div>
                                            <div>
                                                <label class="block text-sm font-medium text-gray-700 mb-2">–°—Ç–∞—Ç—É—Å</label>
                                                <select id="filter-status" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[#0088cc] focus:border-transparent">
                                                    <option value="">–õ—é–±–æ–π —Å—Ç–∞—Ç—É—Å</option>
                                                    <option value="—Å—Ç—Ä–æ–∏—Ç–µ–ª—å—Å—Ç–≤–æ">–°—Ç—Ä–æ–∏—Ç–µ–ª—å—Å—Ç–≤–æ</option>
                                                    <option value="—Å–¥–∞–Ω">–°–¥–∞–Ω</option>
                                                </select>
                                            </div>
                                            <div>
                                                <label class="block text-sm font-medium text-gray-700 mb-2">–û—Ç–¥–µ–ª–∫–∞</label>
                                                <select id="filter-finishing" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[#0088cc] focus:border-transparent">
                                                    <option value="">–õ—é–±–∞—è –æ—Ç–¥–µ–ª–∫–∞</option>
                                                    <option value="—á–µ—Ä–Ω–æ–≤–∞—è">–ß–µ—Ä–Ω–æ–≤–∞—è</option>
                                                    <option value="—á–∏—Å—Ç–æ–≤–∞—è">–°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–∞—è</option>
                                                    <option value="–ø–æ–¥ –∫–ª—é—á">–ü—Ä–µ–º–∏—É–º</option>
                                                </select>
                                            </div>
                                        </div>
                                        
                                        <!-- –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏ -->
                                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-4">
                                            <div>
                                                <label class="block text-sm font-medium text-gray-700 mb-2">–ö–ª–∞—Å—Å –¥–æ–º–∞</label>
                                                <select id="filter-class" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[#0088cc] focus:border-transparent">
                                                    <option value="">–õ—é–±–æ–π –∫–ª–∞—Å—Å</option>
                                                    <option value="—ç–∫–æ–Ω–æ–º">–≠–∫–æ–Ω–æ–º</option>
                                                    <option value="–∫–æ–º—Ñ–æ—Ä—Ç">–ö–æ–º—Ñ–æ—Ä—Ç</option>
                                                    <option value="–±–∏–∑–Ω–µ—Å">–ë–∏–∑–Ω–µ—Å</option>
                                                    <option value="—ç–ª–∏—Ç–Ω—ã–π">–≠–ª–∏—Ç–Ω—ã–π</option>
                                                </select>
                                            </div>
                                            <div>
                                                <label class="block text-sm font-medium text-gray-700 mb-2">–ú–∞—Ç–µ—Ä–∏–∞–ª —Å—Ç–µ–Ω</label>
                                                <select id="filter-material" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[#0088cc] focus:border-transparent">
                                                    <option value="">–õ—é–±–æ–π –º–∞—Ç–µ—Ä–∏–∞–ª</option>
                                                    <option value="–∫–∏—Ä–ø–∏—á">–ö–∏—Ä–ø–∏—á</option>
                                                    <option value="–º–æ–Ω–æ–ª–∏—Ç">–ú–æ–Ω–æ–ª–∏—Ç</option>
                                                    <option value="–ø–∞–Ω–µ–ª—å">–ü–∞–Ω–µ–ª—å</option>
                                                </select>
                                            </div>
                                            <div>
                                                <label class="block text-sm font-medium text-gray-700 mb-2">–í—ã—Å–æ—Ç–∞ –ø–æ—Ç–æ–ª–∫–æ–≤ –æ—Ç</label>
                                                <input type="number" id="filter-ceiling-min" placeholder="–û—Ç, –º" step="0.1" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[#0088cc] focus:border-transparent">
                                            </div>
                                            <div>
                                                <label class="block text-sm font-medium text-gray-700 mb-2">–í—ã—Å–æ—Ç–∞ –ø–æ—Ç–æ–ª–∫–æ–≤ –¥–æ</label>
                                                <input type="number" id="filter-ceiling-max" placeholder="–î–æ, –º" step="0.1" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[#0088cc] focus:border-transparent">
                                            </div>
                                        </div>
                                        
                                        <!-- –£–¥–æ–±—Å—Ç–≤–∞ -->
                                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-4">
                                            <div>
                                                <label class="flex items-center text-sm text-gray-700">
                                                    <input type="checkbox" id="filter-balcony" class="mr-2 text-[#0088cc]">
                                                    –ë–∞–ª–∫–æ–Ω/–õ–æ–¥–∂–∏—è
                                                </label>
                                            </div>
                                            <div>
                                                <label class="flex items-center text-sm text-gray-700">
                                                    <input type="checkbox" id="filter-parking" class="mr-2 text-[#0088cc]">
                                                    –ü–∞—Ä–∫–æ–≤–∫–∞
                                                </label>
                                            </div>
                                            <div>
                                                <label class="flex items-center text-sm text-gray-700">
                                                    <input type="checkbox" id="filter-view" class="mr-2 text-[#0088cc]">
                                                    –ö—Ä–∞—Å–∏–≤—ã–π –≤–∏–¥
                                                </label>
                                            </div>
                                            <div>
                                                <label class="flex items-center text-sm text-gray-700">
                                                    <input type="checkbox" id="filter-penthouse" class="mr-2 text-[#0088cc]">
                                                    –ü–µ–Ω—Ç—Ö–∞—É—Å
                                                </label>
                                            </div>
                                        </div>
                                        
                                        <!-- –ò–ø–æ—Ç–µ–∫–∞ -->
                                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                                            <div>
                                                <label class="flex items-center text-sm text-gray-700">
                                                    <input type="checkbox" id="filter-family-mortgage" class="mr-2 text-[#0088cc]">
                                                    –°–µ–º–µ–π–Ω–∞—è –∏–ø–æ—Ç–µ–∫–∞
                                                </label>
                                            </div>
                                            <div>
                                                <label class="flex items-center text-sm text-gray-700">
                                                    <input type="checkbox" id="filter-it-mortgage" class="mr-2 text-[#0088cc]">
                                                    IT –∏–ø–æ—Ç–µ–∫–∞
                                                </label>
                                            </div>
                                            <div>
                                                <label class="flex items-center text-sm text-gray-700">
                                                    <input type="checkbox" id="filter-military-mortgage" class="mr-2 text-[#0088cc]">
                                                    –í–æ–µ–Ω–Ω–∞—è –∏–ø–æ—Ç–µ–∫–∞
                                                </label>
                                            </div>
                                            <div>
                                                <label class="flex items-center text-sm text-gray-700">
                                                    <input type="checkbox" id="filter-rural-mortgage" class="mr-2 text-[#0088cc]">
                                                    –°–µ–ª—å—Å–∫–∞—è –∏–ø–æ—Ç–µ–∫–∞
                                                </label>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –ø–æ–∏—Å–∫–∞ -->
                                <div class="mt-6">
                                    <div class="flex justify-between items-center mb-4">
                                        <div class="flex items-center space-x-4">
                                            <h4 class="text-lg font-medium text-gray-800">–†–µ–∑—É–ª—å—Ç–∞—Ç—ã –ø–æ–∏—Å–∫–∞</h4>
                                            <span id="results-count" class="text-sm text-gray-500">0 –∫–≤–∞—Ä—Ç–∏—Ä</span>
                                        </div>
                                        <div class="flex gap-2">
                                            <button onclick="saveCurrentSearch()" class="px-3 py-2 bg-green-600 text-white rounded text-sm hover:bg-green-700">
                                                <i class="fas fa-save"></i> –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –ø–æ–∏—Å–∫
                                            </button>
                                            <button onclick="showSavedSearches()" class="px-3 py-2 bg-[#0088CC] text-white rounded text-sm hover:bg-[#006699]">
                                                <i class="fas fa-folder"></i> –°–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã–µ –ø–æ–∏—Å–∫–∏
                                            </button>
                                        </div>
                                    </div>
                                        <div class="flex items-center space-x-3">
                                            <!-- View toggle -->
                                            <div class="flex border border-gray-300 rounded-lg">
                                                <button type="button" id="view-grid-btn" class="px-3 py-2 text-sm bg-[#0088cc] text-white rounded-l-lg">
                                                    <i class="fas fa-th"></i>
                                                </button>
                                                <button type="button" id="view-list-btn" class="px-3 py-2 text-sm bg-white text-gray-600 border-l border-gray-300 rounded-r-lg hover:bg-gray-50">
                                                    <i class="fas fa-list"></i>
                                                </button>
                                            </div>
                                            <button type="button" id="search-apartments-btn" class="px-4 py-2 bg-[#0088cc] text-white rounded-lg hover:bg-[#006699] transition-colors">
                                                –ù–∞–π—Ç–∏ –∫–≤–∞—Ä—Ç–∏—Ä—ã
                                            </button>
                                        </div>
                                    </div>
                                    <div id="properties-results" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                                        <p class="text-gray-500 col-span-full text-center py-8">–ù–∞–∂–º–∏—Ç–µ "–ù–∞–π—Ç–∏ –∫–≤–∞—Ä—Ç–∏—Ä—ã" –¥–ª—è –ø–æ–∏—Å–∫–∞</p>
                                    </div>
                                </div>

                                <!-- –í—ã–±—Ä–∞–Ω–Ω—ã–µ –æ–±—ä–µ–∫—Ç—ã -->
                                <div class="mt-6">
                                    <div class="flex justify-between items-center mb-4">
                                        <h4 class="text-lg font-medium text-gray-800">–í—ã–±—Ä–∞–Ω–Ω—ã–µ –æ–±—ä–µ–∫—Ç—ã –¥–ª—è –ø–æ–¥–±–æ—Ä–∫–∏</h4>
                                        <span id="selected-count" class="text-sm text-gray-500">0 –æ–±—ä–µ–∫—Ç–æ–≤</span>
                                    </div>
                                    <div id="selected-properties" class="space-y-3">
                                        <p class="text-gray-500 text-center py-4">–û–±—ä–µ–∫—Ç—ã –Ω–µ –≤—ã–±—Ä–∞–Ω—ã</p>
                                    </div>
                                    <div class="flex justify-between mt-6">
                                        <button type="button" id="clear-selection-btn" class="px-4 py-2 bg-gray-500 text-white rounded-lg hover:bg-gray-600 transition-colors" disabled>
                                            –û—á–∏—Å—Ç–∏—Ç—å –≤—ã–±–æ—Ä
                                        </button>
                                        <div class="space-x-3">
                                            <button type="button" id="save-collection-btn" class="px-6 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors" disabled>
                                                –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –ø–æ–¥–±–æ—Ä–∫—É
                                            </button>
                                            <button type="button" id="send-collection-btn" class="px-6 py-2 bg-[#0088CC] text-white rounded-lg hover:bg-[#006699] transition-colors" disabled>
                                                –û—Ç–ø—Ä–∞–≤–∏—Ç—å –∫–ª–∏–µ–Ω—Ç—É
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Clients Section -->
            <div class="content-section" id="clients">
                <div class="bg-white rounded-xl shadow-sm p-1">
                    <div class="flex justify-between items-center mb-2 px-2 pt-2">
                        <h2 class="text-2xl font-bold text-gray-800">–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∫–ª–∏–µ–Ω—Ç–∞–º–∏</h2>
                        <button id="add-client-btn" class="px-4 py-2 bg-[#0088cc] text-white rounded-lg hover:bg-[#006699] transition-colors">
                            <i class="fas fa-plus mr-2"></i>–î–æ–±–∞–≤–∏—Ç—å –∫–ª–∏–µ–Ω—Ç–∞
                        </button>
                    </div>
                    
                    <!-- Clients list -->
                    <div class="overflow-x-auto px-1">
                        <table class="w-full">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">–ö–ª–∏–µ–Ω—Ç</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Email</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">–¢–µ–ª–µ—Ñ–æ–Ω</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">–°—Ç–∞—Ç—É—Å</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">–î–µ–π—Å—Ç–≤–∏—è</th>
                                </tr>
                            </thead>
                            <tbody id="clients-table-body" class="bg-white divide-y divide-gray-200">
                                <tr>
                                    <td colspan="5" class="px-6 py-4 text-center text-gray-500">–ó–∞–≥—Ä—É–∑–∫–∞ –∫–ª–∏–µ–Ω—Ç–æ–≤...</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Collections Section -->
            <div class="content-section" id="collections">
                <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
                    <div class="bg-white rounded-xl shadow-sm p-6">
                        <div class="flex justify-between items-center mb-6">
                            <h2 class="text-2xl font-bold text-gray-800">–ú–æ–∏ –ø–æ–¥–±–æ—Ä–∫–∏</h2>
                            <button onclick="showSection('create-collection')" class="px-4 py-2 bg-[#0088cc] text-white rounded-lg hover:bg-[#006699] transition-colors">
                                <i class="fas fa-plus mr-2"></i>–°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—É—é
                            </button>
                        </div>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6" id="collections-grid">
                        <div class="text-center py-8 col-span-full">
                            <p class="text-gray-500">–ó–∞–≥—Ä—É–∑–∫–∞ –ø–æ–¥–±–æ—Ä–æ–∫...</p>
                        </div>
                    </div>
                </div>
            </div>
            </div>

            <!-- Presentations Section -->
            <div class="content-section" id="presentations">
                <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
                    <!-- Presentations List View -->
                    <div id="presentations-list-view" class="bg-white rounded-xl shadow-sm p-6">
                        <div class="flex justify-between items-center mb-6">
                            <h2 class="text-2xl font-bold text-gray-800">–ü—Ä–µ–∑–µ–Ω—Ç–∞—Ü–∏–∏</h2>
                            <button onclick="showCreatePresentationModal()" class="px-4 py-2 bg-gray-600 hover:bg-gray-700 text-white rounded-lg transition-colors">
                                <i class="fas fa-plus mr-2"></i>–°–æ–∑–¥–∞—Ç—å –ø—Ä–µ–∑–µ–Ω—Ç–∞—Ü–∏—é
                            </button>
                        </div>
                        
                        <!-- Presentations Grid -->
                        <div id="presentations-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                            <div class="text-center py-8 col-span-full">
                                <p class="text-gray-500">–ó–∞–≥—Ä—É–∑–∫–∞ –ø—Ä–µ–∑–µ–Ω—Ç–∞—Ü–∏–π...</p>
                            </div>
                        </div>
                    </div>

                    <!-- Presentation Viewer (Hidden by default) -->
                    <div id="presentation-viewer" class="hidden bg-white rounded-xl shadow-sm p-6">
                        <!-- Back to list button -->
                        <div class="flex items-center justify-between mb-6">
                            <button onclick="showPresentationsList()" class="flex items-center px-4 py-2 text-gray-600 hover:text-gray-800 transition-colors">
                                <i class="fas fa-arrow-left mr-2"></i>
                                –ù–∞–∑–∞–¥ –∫ —Å–ø–∏—Å–∫—É
                            </button>
                            <div id="presentation-viewer-actions" class="flex space-x-3">
                                <!-- Actions will be populated dynamically -->
                            </div>
                        </div>
                        
                        <!-- Presentation content will be loaded here -->
                        <div id="presentation-content">
                            <div class="text-center py-8">
                                <p class="text-gray-500">–ó–∞–≥—Ä—É–∑–∫–∞ –ø—Ä–µ–∑–µ–Ω—Ç–∞—Ü–∏–∏...</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Recommendations Section -->
            <div class="content-section" id="recommendations">
                <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
                    <div class="bg-white rounded-xl shadow-sm p-6">
                        <div class="flex justify-between items-center mb-6">
                            <h2 class="text-2xl font-bold text-gray-800">–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –∫–ª–∏–µ–Ω—Ç–∞–º</h2>
                        <div class="flex gap-2">
                            <button onclick="loadRecommendations()" class="px-4 py-2 bg-[#0088cc] text-white rounded-lg hover:bg-[#0077bb] transition">
                                <i class="fas fa-sync mr-2"></i>
                                –û–±–Ω–æ–≤–∏—Ç—å
                            </button>
                        </div>
                    </div>

                    <!-- Stats Cards -->
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
                        <div class="bg-gradient-to-r from-blue-50 to-blue-100 p-4 rounded-lg">
                            <div class="flex items-center">
                                <i class="fas fa-paper-plane text-2xl text-[#0088CC] mr-3"></i>
                                <div>
                                    <p class="text-sm text-gray-600">–û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ</p>
                                    <p class="text-2xl font-bold text-gray-800" id="recommendations-sent">0</p>
                                </div>
                            </div>
                        </div>
                        <div class="bg-gradient-to-r from-green-50 to-green-100 p-4 rounded-lg">
                            <div class="flex items-center">
                                <i class="fas fa-eye text-2xl text-green-600 mr-3"></i>
                                <div>
                                    <p class="text-sm text-gray-600">–ü—Ä–æ—Å–º–æ—Ç—Ä–µ–Ω–æ</p>
                                    <p class="text-2xl font-bold text-gray-800" id="recommendations-viewed">0</p>
                                </div>
                            </div>
                        </div>
                        <div class="bg-gradient-to-r from-purple-50 to-purple-100 p-4 rounded-lg">
                            <div class="flex items-center">
                                <i class="fas fa-heart text-2xl text-[#0088CC] mr-3"></i>
                                <div>
                                    <p class="text-sm text-gray-600">–ó–∞–∏–Ω—Ç–µ—Ä–µ—Å–æ–≤–∞–Ω—ã</p>
                                    <p class="text-2xl font-bold text-gray-800" id="recommendations-interested">0</p>
                                </div>
                            </div>
                        </div>
                        <div class="bg-gradient-to-r from-orange-50 to-orange-100 p-4 rounded-lg">
                            <div class="flex items-center">
                                <i class="fas fa-calendar text-2xl text-[#0088CC] mr-3"></i>
                                <div>
                                    <p class="text-sm text-gray-600">–ü—Ä–æ—Å–º–æ—Ç—Ä—ã –Ω–∞–∑–Ω–∞—á–µ–Ω—ã</p>
                                    <p class="text-2xl font-bold text-gray-800" id="recommendations-scheduled">0</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Filters -->
                    <div class="bg-gray-50 p-4 rounded-lg mb-6">
                        <div class="grid grid-cols-1 md:grid-cols-5 gap-4">
                            <select id="rec-filter-client" class="px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[#0088cc] focus:border-transparent">
                                <option value="">–í—Å–µ –∫–ª–∏–µ–Ω—Ç—ã</option>
                            </select>
                            <select id="rec-filter-status" class="px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[#0088cc] focus:border-transparent">
                                <option value="">–í—Å–µ —Å—Ç–∞—Ç—É—Å—ã</option>
                                <option value="sent">–û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ</option>
                                <option value="viewed">–ü—Ä–æ—Å–º–æ—Ç—Ä–µ–Ω–æ</option>
                                <option value="interested">–ó–∞–∏–Ω—Ç–µ—Ä–µ—Å–æ–≤–∞–Ω—ã</option>
                                <option value="not_interested">–ù–µ –∑–∞–∏–Ω—Ç–µ—Ä–µ—Å–æ–≤–∞–Ω—ã</option>
                                <option value="scheduled_viewing">–ü—Ä–æ—Å–º–æ—Ç—Ä –Ω–∞–∑–Ω–∞—á–µ–Ω</option>
                            </select>
                            <select id="rec-filter-type" class="px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[#0088cc] focus:border-transparent">
                                <option value="">–í—Å–µ —Ç–∏–ø—ã</option>
                                <option value="property">–ö–≤–∞—Ä—Ç–∏—Ä—ã</option>
                                <option value="complex">–ñ–ö</option>
                            </select>
                            <select id="rec-filter-priority" class="px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[#0088cc] focus:border-transparent">
                                <option value="">–í—Å–µ –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç—ã</option>
                                <option value="urgent">–°—Ä–æ—á–Ω–æ</option>
                                <option value="high">–í—ã—Å–æ–∫–∏–π</option>
                                <option value="normal">–û–±—ã—á–Ω—ã–π</option>
                            </select>
                            <button onclick="loadRecommendations()" class="px-4 py-2 bg-[#0088cc] text-white rounded-lg hover:bg-[#0077bb] transition">
                                –ü—Ä–∏–º–µ–Ω–∏—Ç—å —Ñ–∏–ª—å—Ç—Ä—ã
                            </button>
                        </div>
                    </div>

                    <!-- Recommendations List -->
                    <div id="recommendations-container" class="space-y-4">
                        <div class="text-center py-8 text-gray-500">
                            <i class="fas fa-paper-plane text-4xl mb-4"></i>
                            <p>–ó–∞–≥—Ä—É–∑–∫–∞ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–π...</p>
                        </div>
                    </div>
                </div>
            </div>
            </div>

            <!-- Saved Searches Section -->
            <div class="content-section" id="saved-searches">
                <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
                    <div class="bg-white rounded-xl shadow-sm p-6">
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-2xl font-bold text-gray-800">–°–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã–µ –ø–æ–∏—Å–∫–∏</h2>
                        <div class="flex space-x-3">
                            <button onclick="createNewSearch()" class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors">
                                <i class="fas fa-plus mr-2"></i>–°–æ–∑–¥–∞—Ç—å –ø–æ–∏—Å–∫
                            </button>
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6" id="saved-searches-grid">
                        <div class="text-center py-8 col-span-full">
                            <p class="text-gray-500">–ó–∞–≥—Ä—É–∑–∫–∞ —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã—Ö –ø–æ–∏—Å–∫–æ–≤...</p>
                        </div>
                    </div>
                </div>
            </div>
            </div>

            <!-- Collections Section -->
            <div class="content-section" id="collections">
                <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
                    <div class="bg-white rounded-xl shadow-sm p-6">
                        <h2 class="text-2xl font-bold text-gray-800 mb-6">–ú–æ–∏ –ø–æ–¥–±–æ—Ä–∫–∏</h2>
                    <div id="collections-container" class="space-y-4">
                        <div class="text-gray-500 text-center py-8">–ó–∞–≥—Ä—É–∑–∫–∞ –ø–æ–¥–±–æ—Ä–æ–∫...</div>
                    </div>
                </div>
            </div>
            </div>

            <!-- Recommendations Section -->
            <div class="content-section" id="recommendations">
                <div class="bg-white rounded-xl shadow-sm p-6">
                    <div class="flex items-center justify-between mb-6">
                        <h2 class="text-2xl font-bold text-gray-800">–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –∫–ª–∏–µ–Ω—Ç–∞–º</h2>
                        <div class="flex space-x-2">
                            <select id="recommendations-client-filter" class="px-3 py-2 border border-gray-300 rounded-lg text-sm">
                                <option value="">–í—Å–µ –∫–ª–∏–µ–Ω—Ç—ã</option>
                            </select>
                            <select id="recommendations-status-filter" class="px-3 py-2 border border-gray-300 rounded-lg text-sm">
                                <option value="">–í—Å–µ —Å—Ç–∞—Ç—É—Å—ã</option>
                                <option value="sent">–û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ</option>
                                <option value="viewed">–ü—Ä–æ—Å–º–æ—Ç—Ä–µ–Ω–æ</option>
                                <option value="interested">–ó–∞–∏–Ω—Ç–µ—Ä–µ—Å–æ–≤–∞–Ω—ã</option>
                                <option value="not_interested">–ù–µ –∑–∞–∏–Ω—Ç–µ—Ä–µ—Å–æ–≤–∞–Ω—ã</option>
                                <option value="scheduled_viewing">–ü—Ä–æ—Å–º–æ—Ç—Ä –Ω–∞–∑–Ω–∞—á–µ–Ω</option>
                            </select>
                        </div>
                    </div>
                    
                    <!-- Stats cards -->
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
                        <div class="bg-gray-50 rounded-lg p-4">
                            <div class="text-2xl font-bold text-gray-900" id="recommendations-sent">0</div>
                            <div class="text-sm text-gray-600">–û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ</div>
                        </div>
                        <div class="bg-gray-50 rounded-lg p-4">
                            <div class="text-2xl font-bold text-green-600" id="recommendations-viewed">0</div>
                            <div class="text-sm text-gray-600">–ü—Ä–æ—Å–º–æ—Ç—Ä–µ–Ω–æ</div>
                        </div>
                        <div class="bg-gray-50 rounded-lg p-4">
                            <div class="text-2xl font-bold text-purple-600" id="recommendations-interested">0</div>
                            <div class="text-sm text-gray-600">–ó–∞–∏–Ω—Ç–µ—Ä–µ—Å–æ–≤–∞–Ω—ã</div>
                        </div>
                        <div class="bg-gray-50 rounded-lg p-4">
                            <div class="text-2xl font-bold text-orange-600" id="recommendations-scheduled">0</div>
                            <div class="text-sm text-gray-600">–ü—Ä–æ—Å–º–æ—Ç—Ä—ã –Ω–∞–∑–Ω–∞—á–µ–Ω—ã</div>
                        </div>
                    </div>
                    
                    <div id="recommendations-container" class="space-y-4">
                        <div class="text-gray-500 text-center py-8">–ó–∞–≥—Ä—É–∑–∫–∞ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–π...</div>
                    </div>
                </div>
            </div>
            </div>

            <!-- Deals Section -->
            <div class="content-section" id="deals">
                <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
                    <!-- Header -->
                    <div class="mb-6">
                        <div class="flex justify-between items-center">
                            <div>
                                <h1 class="text-3xl font-bold text-gray-900">–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å–¥–µ–ª–∫–∞–º–∏</h1>
                                <p class="mt-2 text-gray-600">–û—Ç—Å–ª–µ–∂–∏–≤–∞–π—Ç–µ –∏ —É–ø—Ä–∞–≤–ª—è–π—Ç–µ —Å–¥–µ–ª–∫–∞–º–∏ —Å –∫–ª–∏–µ–Ω—Ç–∞–º–∏</p>
                            </div>
                            <button onclick="openCreateDealModal()" 
                                    class="bg-[#059669] hover:bg-[#047857] text-white px-6 py-3 rounded-lg font-medium transition-colors">
                                <i class="fas fa-plus mr-2"></i>–°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—É—é —Å–¥–µ–ª–∫—É
                            </button>
                        </div>
                    </div>

                    <!-- Stats Cards -->
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
                        <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6">
                            <div class="flex items-center">
                                <div class="p-3 bg-blue-100 rounded-lg">
                                    <i class="fas fa-handshake text-blue-600"></i>
                                </div>
                                <div class="ml-4">
                                    <p class="text-sm font-medium text-gray-500">–ê–∫—Ç–∏–≤–Ω—ã—Ö —Å–¥–µ–ª–æ–∫</p>
                                    <p class="text-2xl font-bold text-gray-900" id="active-deals-count">0</p>
                                </div>
                            </div>
                        </div>
                        
                        <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6">
                            <div class="flex items-center">
                                <div class="p-3 bg-green-100 rounded-lg">
                                    <i class="fas fa-check-circle text-green-600"></i>
                                </div>
                                <div class="ml-4">
                                    <p class="text-sm font-medium text-gray-500">–ó–∞–≤–µ—Ä—à–µ–Ω–æ</p>
                                    <p class="text-2xl font-bold text-gray-900" id="completed-deals-count">0</p>
                                </div>
                            </div>
                        </div>
                        
                        <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6">
                            <div class="flex items-center">
                                <div class="p-3 bg-yellow-100 rounded-lg">
                                    <i class="fas fa-clock text-yellow-600"></i>
                                </div>
                                <div class="ml-4">
                                    <p class="text-sm font-medium text-gray-500">–í –ø—Ä–æ—Ü–µ—Å—Å–µ</p>
                                    <p class="text-2xl font-bold text-gray-900" id="in-progress-deals-count">0</p>
                                </div>
                            </div>
                        </div>
                        
                        <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6">
                            <div class="flex items-center">
                                <div class="p-3 bg-[#059669]/10 rounded-lg">
                                    <i class="fas fa-ruble-sign text-[#059669]"></i>
                                </div>
                                <div class="ml-4">
                                    <p class="text-sm font-medium text-gray-500">–û–±—â–∏–π –∫–µ—à–±–µ–∫</p>
                                    <p class="text-2xl font-bold text-gray-900" id="total-cashback">0 ‚ÇΩ</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Filters and Search -->
                    <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6 mb-6">
                        <div class="flex flex-wrap items-center gap-4">
                            <div class="flex-1 min-w-64">
                                <input type="text" id="search-deals" placeholder="–ü–æ–∏—Å–∫ –ø–æ –Ω–æ–º–µ—Ä—É —Å–¥–µ–ª–∫–∏ –∏–ª–∏ –∫–ª–∏–µ–Ω—Ç—É..."
                                       class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[#059669] focus:border-transparent">
                            </div>
                            
                            <div class="flex items-center space-x-2">
                                <span class="text-sm font-medium text-gray-700">–°—Ç–∞—Ç—É—Å:</span>
                                <select id="status-filter" 
                                        class="px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[#059669] focus:border-transparent">
                                    <option value="">–í—Å–µ</option>
                                    <option value="new">–ù–æ–≤—ã–µ</option>
                                    <option value="object_reserved">–û–±—ä–µ–∫—Ç –∑–∞—Ä–µ–∑–µ—Ä–≤–∏—Ä–æ–≤–∞–Ω</option>
                                    <option value="mortgage">–ò–ø–æ—Ç–µ–∫–∞</option>
                                    <option value="successful">–ó–∞–≤–µ—Ä—à–µ–Ω—ã</option>
                                    <option value="rejected">–û—Ç–∫–ª–æ–Ω–µ–Ω—ã</option>
                                </select>
                            </div>
                            
                            <button onclick="applyFilters()" 
                                    class="bg-[#059669] hover:bg-[#047857] text-white px-4 py-2 rounded-lg transition-colors">
                                <i class="fas fa-filter mr-2"></i>–ü—Ä–∏–º–µ–Ω–∏—Ç—å
                            </button>
                            
                            <button onclick="clearFilters()" 
                                    class="bg-gray-100 hover:bg-gray-200 text-gray-700 px-4 py-2 rounded-lg transition-colors">
                                <i class="fas fa-times mr-2"></i>–°–±—Ä–æ—Å–∏—Ç—å
                            </button>
                        </div>
                    </div>

                    <!-- Deals Table -->
                    <div class="bg-white rounded-lg shadow-sm border border-gray-200 overflow-hidden">
                        <div class="overflow-x-auto">
                            <table class="w-full" id="deals-table">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th class="px-6 py-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                            –ù–æ–º–µ—Ä —Å–¥–µ–ª–∫–∏
                                        </th>
                                        <th class="px-6 py-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                            –ö–ª–∏–µ–Ω—Ç
                                        </th>
                                        <th class="px-6 py-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                            –ñ–ö
                                        </th>
                                        <th class="px-6 py-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                            –°—Ç–æ–∏–º–æ—Å—Ç—å
                                        </th>
                                        <th class="px-6 py-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                            –ö–µ—à–±–µ–∫
                                        </th>
                                        <th class="px-6 py-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                            –°—Ç–∞—Ç—É—Å
                                        </th>
                                        <th class="px-6 py-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                            –î–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∏—è
                                        </th>
                                        <th class="px-6 py-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                            –î–µ–π—Å—Ç–≤–∏—è
                                        </th>
                                    </tr>
                                </thead>
                                <tbody class="bg-white divide-y divide-gray-200" id="deals-tbody">
                                    <tr id="no-deals-row">
                                        <td colspan="8" class="px-6 py-12 text-center">
                                            <div class="text-gray-400">
                                                <i class="fas fa-handshake text-6xl mb-4"></i>
                                                <p class="text-xl font-medium mb-2">–ù–µ—Ç —Å–¥–µ–ª–æ–∫</p>
                                                <p>–°–æ–∑–¥–∞–π—Ç–µ –ø–µ—Ä–≤—É—é —Å–¥–µ–ª–∫—É —Å –∫–ª–∏–µ–Ω—Ç–æ–º</p>
                                            </div>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

           

            <!-- Combined Favorites Section -->
            <div class="content-section" id="favorites">
                <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
                    <div class="bg-white rounded-xl shadow-sm p-6">
                        <!-- Main Header -->
                        <div class="flex justify-between items-center mb-6">
                            <div>
                                <h2 class="text-2xl font-bold text-gray-900 flex items-center gap-3">
                                    <svg class="w-8 h-8 text-red-500" fill="currentColor" viewBox="0 0 20 20">
                                        <path d="M3.172 5.172a4 4 0 015.656 0L10 6.343l1.172-1.171a4 4 0 115.656 5.656L10 17.657l-6.828-6.829a4 4 0 010-5.656z"/>
                                    </svg>
                                    –ò–∑–±—Ä–∞–Ω–Ω–æ–µ
                                    <span class="bg-red-500 text-white px-3 py-1 rounded-full text-lg font-medium ml-2" id="favorites-total-count">0</span>
                                </h2>
                                <p class="text-gray-600 mt-1">–°–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–µ –æ–±—ä–µ–∫—Ç—ã –∏ –∂–∏–ª—ã–µ –∫–æ–º–ø–ª–µ–∫—Å—ã</p>
                            </div>
                        </div>

                        <!-- Internal Horizontal Tabs -->
                        <div class="border-b border-gray-200 mb-6">
                            <nav class="-mb-px flex space-x-8" aria-label="Tabs">
                                <button class="border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 whitespace-nowrap py-2 px-1 border-b-2 font-medium text-sm favorites-tab-button active" data-tab="properties">
                                    <svg class="w-5 h-5 mr-2 inline" fill="currentColor" viewBox="0 0 20 20">
                                        <path d="M3.172 5.172a4 4 0 015.656 0L10 6.343l1.172-1.171a4 4 0 115.656 5.656L10 17.657l-6.828-6.829a4 4 0 010-5.656z"/>
                                    </svg>
                                    –ò–∑–±—Ä–∞–Ω–Ω—ã–µ –æ–±—ä–µ–∫—Ç—ã
                                    <span class="ml-2 bg-gradient-to-r from-red-500 to-red-600 text-white text-xs px-2 py-1 rounded-full font-medium" id="favorites-properties-count">0</span>
                                </button>
                                <button class="border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 whitespace-nowrap py-2 px-1 border-b-2 font-medium text-sm favorites-tab-button" data-tab="complexes">
                                    <svg class="w-5 h-5 mr-2 inline" fill="currentColor" viewBox="0 0 20 20">
                                        <path d="M10.707 2.293a1 1 0 00-1.414 0l-7 7a1 1 0 001.414 1.414L4 10.414V17a1 1 0 001 1h2a1 1 0 001-1v-2a1 1 0 011-1h2a1 1 0 011 1v2a1 1 0 001 1h2a1 1 0 001-1v-6.586l.293.293a1 1 0 001.414-1.414l-7-7z"/>
                                        <path d="M3.172 5.172a4 4 0 015.656 0L10 6.343l1.172-1.171a4 4 0 115.656 5.656L10 17.657l-6.828-6.829a4 4 0 010-5.656z"/>
                                    </svg>
                                    –ò–∑–±—Ä–∞–Ω–Ω—ã–µ –ñ–ö
                                    <span class="ml-2 bg-gradient-to-r from-pink-500 to-pink-600 text-white text-xs px-2 py-1 rounded-full font-medium" id="favorites-complexes-count">0</span>
                                </button>
                            </nav>
                        </div>

                        <!-- Properties Tab Content -->
                        <div id="favorites-properties-tab" class="favorites-tab-content active">
                            <!-- Properties Empty State -->
                            <div id="empty-properties" class="text-center py-12">
                                <div class="w-16 h-16 mx-auto mb-4 text-gray-300">
                                    <svg class="w-full h-full" fill="currentColor" viewBox="0 0 20 20">
                                        <path d="M3.172 5.172a4 4 0 015.656 0L10 6.343l1.172-1.171a4 4 0 115.656 5.656L10 17.657l-6.828-6.829a4 4 0 010-5.656z"/>
                                    </svg>
                                </div>
                                <p class="text-gray-500 text-lg mb-4">–£ –≤–∞—Å –ø–æ–∫–∞ –Ω–µ—Ç –∏–∑–±—Ä–∞–Ω–Ω—ã—Ö –æ–±—ä–µ–∫—Ç–æ–≤</p>
                                <p class="text-gray-400 text-sm">–î–æ–±–∞–≤—å—Ç–µ –æ–±—ä–µ–∫—Ç—ã –≤ –∏–∑–±—Ä–∞–Ω–Ω–æ–µ –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ –¥–æ—Å—Ç—É–ø–∞ –∫ –Ω–∏–º</p>
                            </div>

                            <!-- Properties Grid -->
                            <div id="properties-container" class="manager-favorites-hidden">
                                <div id="properties-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                                    <!-- Property cards will be inserted here by JavaScript -->
                                </div>
                            </div>
                        </div>

                        <!-- Complexes Tab Content -->
                        <div id="favorites-complexes-tab" class="favorites-tab-content">
                            <!-- Complexes Empty State -->
                            <div id="empty-complexes" class="text-center py-12">
                                <div class="w-16 h-16 mx-auto mb-4 text-gray-300">
                                    <svg class="w-full h-full" fill="currentColor" viewBox="0 0 20 20">
                                        <path fill-rule="evenodd" d="M4 3a2 2 0 00-2 2v10a2 2 0 002 2h12a2 2 0 002-2V5a2 2 0 00-2-2H4zm12 12H4l4-8 3 6 2-4 3 6z" clip-rule="evenodd"/>
                                    </svg>
                                </div>
                                <p class="text-gray-500 text-lg mb-4">–£ –≤–∞—Å –ø–æ–∫–∞ –Ω–µ—Ç –∏–∑–±—Ä–∞–Ω–Ω—ã—Ö –ñ–ö</p>
                                <p class="text-gray-400 text-sm">–î–æ–±–∞–≤—å—Ç–µ –∂–∏–ª—ã–µ –∫–æ–º–ø–ª–µ–∫—Å—ã –≤ –∏–∑–±—Ä–∞–Ω–Ω–æ–µ –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è –Ω–æ–≤—ã—Ö –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–π</p>
                            </div>

                            <!-- Complexes Grid -->
                            <div id="favorite-complexes-container">
                                <div id="favorite-complexes-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                                    <!-- Complex cards will be inserted here by JavaScript -->
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

        </div>
    </div>
</div>

<script>
// IMMEDIATELY DEFINE CRITICAL FUNCTIONS AT TOP
console.log('üöÄ Defining critical functions FIRST...');

// Internal favorites tabs functionality
function switchFavoriteTab(tabName) {
    console.log('üîÑ Switching favorites tab to:', tabName);
    
    // Update tab buttons
    const tabButtons = document.querySelectorAll('.favorites-tab-button');
    tabButtons.forEach(button => {
        const isActive = button.dataset.tab === tabName;
        button.classList.toggle('active', isActive);
    });
    
    // Update tab content
    const tabContents = document.querySelectorAll('.favorites-tab-content');
    tabContents.forEach(content => {
        const isActive = content.id === `favorites-${tabName}-tab`;
        content.classList.toggle('active', isActive);
        content.classList.toggle('hidden', !isActive);
    });
    
    // Load content based on tab
    if (tabName === 'properties' && document.getElementById('properties-grid').children.length === 0) {
        loadFavoriteProperties();
    } else if (tabName === 'complexes' && document.getElementById('favorite-complexes-grid').children.length === 0) {
        loadFavoriteComplexes();
    }
    
    console.log('‚úÖ Switched to', tabName, 'tab');
}

// Add event listeners for internal tabs
document.addEventListener('DOMContentLoaded', function() {
    const tabButtons = document.querySelectorAll('.favorites-tab-button');
    tabButtons.forEach(button => {
        button.addEventListener('click', function(e) {
            e.preventDefault();
            switchFavoriteTab(this.dataset.tab);
        });
    });
});

// ===== NEW OPTIMIZED DASHBOARD LOADER =====
// Makes ONE API call instead of 7-8 sequential calls
window.loadDashboardData = function() {
    const startTime = performance.now();
    console.log('üöÄ Loading ALL dashboard data from single API call...');
    
    fetch('/api/manager/dashboard/all')
        .then(response => {
            if (!response.ok) {
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }
            return response.json();
        })
        .then(data => {
            if (!data.success) {
                throw new Error(data.error || 'Unknown error');
            }
            
            console.log('üì¶ Received dashboard data:', data);
            
            // ===== 1. UPDATE CLIENTS =====
            if (data.clients) {
                const clientsCountElement = document.getElementById('clients-count');
                if (clientsCountElement) {
                    clientsCountElement.textContent = data.clients.length;
                }
                
                const tableBody = document.getElementById('clients-table-body');
                if (tableBody) {
                    if (data.clients.length === 0) {
                        tableBody.innerHTML = '<tr><td colspan="5" class="px-6 py-4 text-center text-gray-500">–ö–ª–∏–µ–Ω—Ç—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</td></tr>';
                    } else {
                        tableBody.innerHTML = data.clients.map(client => `
                            <tr>
                                <td class="px-6 py-4 whitespace-nowrap">
                                    <div class="text-sm font-medium text-gray-900">${client.full_name || '–ù–µ —É–∫–∞–∑–∞–Ω–æ'}</div>
                                </td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${client.email || '–ù–µ —É–∫–∞–∑–∞–Ω–æ'}</td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${client.phone || '-'}</td>
                                <td class="px-6 py-4 whitespace-nowrap">
                                    <span class="px-2 py-1 text-xs font-semibold rounded-full bg-green-100 text-green-800">
                                        –ê–∫—Ç–∏–≤–µ–Ω
                                    </span>
                                </td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                                    <button onclick="editClient(${client.id})" class="text-[#0088cc] hover:text-[#006699] mr-3">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</button>
                                    <button onclick="deleteClient(${client.id}, '${client.full_name}')" class="text-red-600 hover:text-red-900">–£–¥–∞–ª–∏—Ç—å</button>
                                </td>
                            </tr>
                        `).join('');
                    }
                }
                console.log('‚úÖ Clients updated:', data.clients.length);
            }
            
            // ===== 2. UPDATE WELCOME MESSAGE =====
            if (data.welcome && data.welcome.messages) {
                const container = document.getElementById('welcome-messages');
                const titleElement = document.getElementById('welcome-title');
                
                if (titleElement && data.welcome.messages[0]) {
                    titleElement.textContent = data.welcome.messages[0];
                }
                
                if (container && data.welcome.messages.length > 1) {
                    const messagesHtml = data.welcome.messages.slice(1).map((message, index) => {
                        const className = index === 0 ? 'text-lg text-gray-600' : 'text-base text-gray-500';
                        return `<p class="${className}">${message}</p>`;
                    }).join('');
                    container.innerHTML = messagesHtml;
                }
                console.log('‚úÖ Welcome message updated');
            }
            
            // ===== 3. UPDATE ACTIVITY FEED (RECENT RECOMMENDATIONS) =====
            if (data.activities) {
                const container = document.getElementById('recent-recommendations');
                if (container) {
                    if (data.activities.length === 0) {
                        container.innerHTML = '<div class="text-gray-500 text-sm">–ê–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ –ø–æ–∫–∞ –Ω–µ—Ç</div>';
                    } else {
                        const html = data.activities.slice(0, 5).map(activity => {
                            let iconClass = 'fas fa-info-circle text-blue-600';
                            let bgColor = 'bg-blue-50';
                            
                            if (activity.type === 'presentation_view' || activity.icon === 'eye') {
                                iconClass = 'fas fa-eye text-purple-600';
                                bgColor = 'bg-purple-50';
                            } else if (activity.type === 'recommendation' || activity.icon === 'paper-plane') {
                                iconClass = 'fas fa-paper-plane text-blue-600';
                                bgColor = 'bg-blue-50';
                            } else if (activity.icon === 'user-plus') {
                                iconClass = 'fas fa-user-plus text-green-600';
                                bgColor = 'bg-green-50';
                            }
                            
                            return `
                                <div class="flex items-start space-x-3 p-3 ${bgColor} rounded-lg">
                                    <div class="flex-shrink-0 mt-0.5">
                                        <i class="${iconClass}"></i>
                                    </div>
                                    <div class="flex-1 min-w-0">
                                        <p class="font-medium text-sm text-gray-900">${activity.title}</p>
                                        <p class="text-xs text-gray-600 mt-1">${activity.description}</p>
                                        <span class="text-xs text-gray-500">${activity.time_ago}</span>
                                    </div>
                                </div>
                            `;
                        }).join('');
                        container.innerHTML = html;
                    }
                }
                console.log('‚úÖ Activity feed updated:', data.activities.length, 'activities');
            }
            
            // ===== 4. UPDATE FAVORITES COUNTS =====
            if (data.favorites) {
                const totalCount = data.favorites.total_count || 
                                 (data.favorites.properties_count + data.favorites.complexes_count);
                
                const favoritesTotalElement = document.getElementById('favorites-total-count');
                if (favoritesTotalElement) {
                    favoritesTotalElement.textContent = totalCount;
                }
                
                const propertiesCountElement = document.getElementById('favorites-properties-count');
                if (propertiesCountElement) {
                    propertiesCountElement.textContent = data.favorites.properties_count || 0;
                }
                
                const complexesCountElement = document.getElementById('favorites-complexes-count');
                if (complexesCountElement) {
                    complexesCountElement.textContent = data.favorites.complexes_count || 0;
                }
                
                console.log('‚úÖ Favorites counts updated:', totalCount);
            }
            
            // ===== 5. UPDATE SAVED SEARCHES COUNT =====
            if (data.saved_searches) {
                const savedSearchesCountElement = document.getElementById('saved-searches-count');
                if (savedSearchesCountElement && data.saved_searches.count > 0) {
                    savedSearchesCountElement.textContent = data.saved_searches.count;
                    savedSearchesCountElement.style.display = 'inline-block';
                }
                console.log('‚úÖ Saved searches count updated:', data.saved_searches.count);
            }
            
            // ===== 6. UPDATE DEALS COUNT =====
            if (typeof data.deals_count !== 'undefined') {
                const dealsCountElement = document.getElementById('deals-count');
                if (dealsCountElement) {
                    dealsCountElement.textContent = data.deals_count;
                }
                console.log('‚úÖ Deals count updated:', data.deals_count);
            }
            
            // ===== 7. UPDATE COMPARISON COUNTS =====
            if (data.comparison) {
                const totalCount = data.comparison.total_count || 
                                 (data.comparison.properties_count + data.comparison.complexes_count);
                
                const comparisonCountElement = document.getElementById('comparison-count');
                if (comparisonCountElement) {
                    comparisonCountElement.textContent = totalCount;
                }
                console.log('‚úÖ Comparison count updated:', totalCount);
            }
            
            // ===== SUCCESS - LOG PERFORMANCE =====
            const loadTime = Math.round(performance.now() - startTime);
            console.log(`‚úÖ Dashboard loaded in ${loadTime}ms from single API call`);
            console.log(`‚ö° Performance improvement: ~27000ms ‚Üí ${loadTime}ms (${Math.round((27000 - loadTime) / 270)}% faster)`);
            
        })
        .catch(error => {
            const loadTime = Math.round(performance.now() - startTime);
            console.error('‚ùå Error loading dashboard data:', error);
            console.error('‚ùå Error message:', error.message);
            console.error('‚ùå Error stack:', error.stack);
            console.error(`Failed after ${loadTime}ms`);
            
            // Fallback to individual calls if aggregated call fails
            console.warn('‚ö†Ô∏è Falling back to individual API calls due to error');
            if (typeof window.loadClients === 'function') window.loadClients();
            if (typeof window.loadWelcomeMessage === 'function') window.loadWelcomeMessage();
            if (typeof window.loadRecentRecommendations === 'function') window.loadRecentRecommendations();
        });
};

console.log('‚úÖ loadDashboardData function defined');

// Define loadClients function IMMEDIATELY
window.loadClients = function() {
    console.log('üîÑ Loading clients NOW...');
    const tableBody = document.getElementById('clients-table-body');
    
    if (!tableBody) {
        console.error('‚ùå clients-table-body not found');
        return;
    }
    
    tableBody.innerHTML = '<tr><td colspan="5" class="px-6 py-4 text-center text-gray-500">–ó–∞–≥—Ä—É–∑–∫–∞ –∫–ª–∏–µ–Ω—Ç–æ–≤...</td></tr>';
    
    fetch('/api/manager/clients')
        .then(response => {
            console.log('üì° Response status:', response.status);
            return response.json();
        })
        .then(data => {
            console.log('üìä Clients data received:', data);
            if (data.success) {
                console.log('‚úÖ Success! Displaying', data.clients.length, 'clients');
                
                // Update clients count in tab
                const clientsCountElement = document.getElementById('clients-count');
                if (clientsCountElement) {
                    clientsCountElement.textContent = data.clients.length;
                    console.log('‚úÖ Updated clients count to:', data.clients.length);
                }
                
                const tbody = document.getElementById('clients-table-body');
                if (!data.clients || data.clients.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="5" class="px-6 py-4 text-center text-gray-500">–ö–ª–∏–µ–Ω—Ç—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</td></tr>';
                } else {
                    tbody.innerHTML = data.clients.map(client => `
                        <tr>
                            <td class="px-6 py-4 whitespace-nowrap">
                                <div class="text-sm font-medium text-gray-900">${client.full_name || '–ù–µ —É–∫–∞–∑–∞–Ω–æ'}</div>
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${client.email || '–ù–µ —É–∫–∞–∑–∞–Ω–æ'}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${client.phone || '-'}</td>
                            <td class="px-6 py-4 whitespace-nowrap">
                                <span class="px-2 py-1 text-xs font-semibold rounded-full bg-green-100 text-green-800">
                                    –ê–∫—Ç–∏–≤–µ–Ω
                                </span>
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                                <button onclick="editClient(${client.id})" class="text-[#0088cc] hover:text-[#006699] mr-3">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</button>
                                <button onclick="deleteClient(${client.id}, '${client.full_name}')" class="text-red-600 hover:text-red-900">–£–¥–∞–ª–∏—Ç—å</button>
                            </td>
                        </tr>
                    `).join('');
                }
            } else {
                console.error('‚ùå API returned error:', data.error);
                tableBody.innerHTML = 
                    `<tr><td colspan="5" class="px-6 py-4 text-center text-red-500">–û—à–∏–±–∫–∞: ${data.error}</td></tr>`;
            }
        })
        .catch(error => {
            console.error('üí• Network error loading clients:', error);
            tableBody.innerHTML = 
                '<tr><td colspan="5" class="px-6 py-4 text-center text-red-500">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∫–ª–∏–µ–Ω—Ç–æ–≤</td></tr>';
        });
};

console.log('‚úÖ loadClients function defined at top:', typeof window.loadClients);

// Define loadRecommendations function IMMEDIATELY
window.loadRecommendations = function() {
    console.log('üîÑ Loading recommendations NOW...');
    const container = document.getElementById('recommendations-container');
    
    if (!container) {
        console.error('‚ùå recommendations-container not found');
        return;
    }
    
    container.innerHTML = '<div class="text-center py-8 text-gray-500">–ó–∞–≥—Ä—É–∑–∫–∞ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–π...</div>';
    
    fetch('/api/manager/recommendations')
        .then(response => {
            console.log('üì° Recommendations response status:', response.status);
            return response.json();
        })
        .then(data => {
            console.log('üìä Recommendations data received:', data);
            if (data.success) {
                console.log('‚úÖ Success! Found', data.recommendations.length, 'recommendations');
                
                // Update recommendations count in tab
                const recommendationsCountElement = document.getElementById('recommendations-count');
                if (recommendationsCountElement) {
                    recommendationsCountElement.textContent = data.recommendations.length;
                    console.log('‚úÖ Updated recommendations count to:', data.recommendations.length);
                }
                
                // Update stats
                if (data.stats) {
                    document.getElementById('recommendations-sent').textContent = data.stats.sent || 0;
                    document.getElementById('recommendations-viewed').textContent = data.stats.viewed || 0;
                    document.getElementById('recommendations-interested').textContent = data.stats.interested || 0;
                    document.getElementById('recommendations-scheduled').textContent = data.stats.scheduled || 0;
                }
                
                if (!data.recommendations || data.recommendations.length === 0) {
                    container.innerHTML = '<div class="text-center py-8 text-gray-500">–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</div>';
                } else {
                    container.innerHTML = data.recommendations.map(rec => `
                        <div class="bg-gray-50 rounded-lg p-4">
                            <div class="flex justify-between items-start mb-2">
                                <div>
                                    <h4 class="font-medium text-gray-900">${rec.property_title || rec.title || '–û–±—ä–µ–∫—Ç –Ω–µ–¥–≤–∏–∂–∏–º–æ—Å—Ç–∏'}</h4>
                                    <p class="text-sm text-gray-600">–ö–ª–∏–µ–Ω—Ç: ${rec.client_name}</p>
                                </div>
                                <span class="px-2 py-1 text-xs font-semibold rounded-full bg-blue-100 text-blue-800">
                                    ${rec.status || '–û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ'}
                                </span>
                            </div>
                            <p class="text-sm text-gray-600 mb-2">${rec.message || '–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞'}</p>
                            <div class="text-xs text-gray-500">
                                –û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ: ${new Date(rec.created_at || rec.sent_at).toLocaleDateString('ru-RU')}
                            </div>
                        </div>
                    `).join('');
                }
            } else {
                console.error('‚ùå API returned error:', data.error);
                container.innerHTML = `<div class="text-center py-8 text-red-500">–û—à–∏–±–∫–∞: ${data.error}</div>`;
            }
        })
        .catch(error => {
            console.error('üí• Network error loading recommendations:', error);
            container.innerHTML = '<div class="text-center py-8 text-red-500">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–π</div>';
        });
};

console.log('‚úÖ loadRecommendations function defined at top:', typeof window.loadRecommendations);

// Define loadManagerSavedSearches function IMMEDIATELY  
window.loadManagerSavedSearches = function() {
    console.log('üîÑ Loading manager saved searches NOW...');
    const container = document.getElementById('saved-searches-grid');
    
    if (!container) {
        console.error('‚ùå saved-searches-grid not found');
        return;
    }
    
    container.innerHTML = '<div class="text-center py-8 col-span-full"><p class="text-gray-500">–ó–∞–≥—Ä—É–∑–∫–∞ —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã—Ö –ø–æ–∏—Å–∫–æ–≤...</p></div>';
    
    fetch('/api/manager/saved-searches')
        .then(response => {
            console.log('üì° Saved searches response status:', response.status);
            if (!response.ok) {
                console.error('‚ùå Saved searches API error - Status:', response.status);
                return response.text().then(text => {
                    console.error('‚ùå Response text:', text.substring(0, 200));
                    throw new Error(`HTTP ${response.status}: ${text.substring(0, 100)}`);
                });
            }
            return response.json();
        })
        .then(data => {
            console.log('üìä Saved searches data received:', data);
            if (data.success) {
                console.log('‚úÖ Success! Found', data.searches.length, 'saved searches');
                
                if (!data.searches || data.searches.length === 0) {
                    container.innerHTML = `
                        <div class="text-center py-8 col-span-full">
                            <div class="text-gray-400 mb-4">
                                <svg class="w-16 h-16 mx-auto" fill="currentColor" viewBox="0 0 20 20">
                                    <path fill-rule="evenodd" d="M8 4a4 4 0 100 8 4 4 0 000-8zM2 8a6 6 0 1110.89 3.476l4.817 4.817a1 1 0 01-1.414 1.414l-4.816-4.816A6 6 0 012 8z" clip-rule="evenodd"/>
                                </svg>
                            </div>
                            <p class="text-gray-500 text-lg">–°–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã–µ –ø–æ–∏—Å–∫–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</p>
                            <p class="text-gray-400 text-sm mt-2">–°–æ–∑–¥–∞–π—Ç–µ –ø–æ–∏—Å–∫ –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ "–ù–µ–¥–≤–∏–∂–∏–º–æ—Å—Ç—å" –∏ —Å–æ—Ö—Ä–∞–Ω–∏—Ç–µ –µ–≥–æ</p>
                        </div>
                    `;
                } else {
                    container.innerHTML = data.searches.map(search => {
                        // Parse filters to get meaningful description
                        let filtersDescription = '–í—Å–µ –æ–±—ä–µ–∫—Ç—ã';
                        let activeFiltersCount = 0;
                        
                        if (search.additional_filters) {
                            try {
                                const filters = JSON.parse(search.additional_filters);
                                const parts = [];
                                
                                if (filters.rooms && filters.rooms.length > 0) {
                                    parts.push(filters.rooms.join(', '));
                                    activeFiltersCount++;
                                }
                                
                                if (filters.priceFrom || filters.priceTo) {
                                    const from = filters.priceFrom || '0';
                                    const to = filters.priceTo || '‚àû';
                                    parts.push(`${from}-${to} –º–ª–Ω`);
                                    activeFiltersCount++;
                                }
                                
                                if (filters.districts && filters.districts.length > 0) {
                                    parts.push(filters.districts.join(', '));
                                    activeFiltersCount++;
                                }
                                
                                if (filters.developers && filters.developers.length > 0) {
                                    parts.push(filters.developers.join(', '));
                                    activeFiltersCount++;
                                }
                                
                                if (parts.length > 0) {
                                    filtersDescription = parts.join(' ‚Ä¢ ');
                                }
                            } catch (e) {
                                console.error('Error parsing filters:', e);
                            }
                        }
                        
                        return `
                            <div class="bg-white border border-gray-200 rounded-lg p-4 hover:shadow-md transition-shadow">
                                <div class="flex justify-between items-start mb-3">
                                    <div class="flex-1">
                                        <h3 class="font-medium text-gray-900 mb-1">${search.name || '–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è'}</h3>
                                        <p class="text-sm text-gray-600">${filtersDescription}</p>
                                    </div>
                                    <span class="px-2 py-1 text-xs rounded-full bg-blue-50 text-blue-700 border border-blue-200">
                                        ${activeFiltersCount} ${activeFiltersCount === 1 ? '—Ñ–∏–ª—å—Ç—Ä' : activeFiltersCount < 5 ? '—Ñ–∏–ª—å—Ç—Ä–∞' : '—Ñ–∏–ª—å—Ç—Ä–æ–≤'}
                                    </span>
                                </div>
                                
                                <div class="text-xs text-gray-500 mb-3">
                                    ${new Date(search.created_at).toLocaleDateString('ru-RU')}
                                </div>
                                
                                <div class="flex gap-2">
                                    <button onclick="viewSearch(${search.id})" class="flex-1 px-3 py-2 bg-[#0088cc] text-white rounded text-sm hover:bg-[#006699] transition-colors">
                                        –ü—Ä–æ—Å–º–æ—Ç—Ä
                                    </button>
                                    <button onclick="sendSearchToClient(${search.id})" class="flex-1 px-3 py-2 bg-green-600 text-white rounded text-sm hover:bg-green-700 transition-colors">
                                        –û—Ç–ø—Ä–∞–≤–∏—Ç—å
                                    </button>
                                    <button onclick="deleteSearch(${search.id})" class="px-3 py-2 bg-gray-100 text-gray-600 rounded text-sm hover:bg-red-50 hover:text-red-600 transition-colors">
                                        <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                                            <path fill-rule="evenodd" d="M9 2a1 1 0 000 2h2a1 1 0 100-2H9zM4 5a2 2 0 012-2h8a2 2 0 012 2v6a2 2 0 01-2 2H6a2 2 0 01-2-2V5zM8 11a1 1 0 102 0v2a1 1 0 11-2 0v-2zm4 0a1 1 0 102 0v2a1 1 0 11-2 0v-2z" clip-rule="evenodd"/>
                                        </svg>
                                    </button>
                                </div>
                            </div>
                        `;
                    }).join('');
                }
            } else {
                console.error('‚ùå API returned error:', data.error);
                container.innerHTML = `<div class="text-center py-8 col-span-full"><p class="text-red-500">–û—à–∏–±–∫–∞: ${data.error}</p></div>`;
            }
        })
        .catch(error => {
            console.error('üí• Network error loading saved searches:', error);
            container.innerHTML = '<div class="text-center py-8 col-span-full"><p class="text-red-500">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã—Ö –ø–æ–∏—Å–∫–æ–≤</p></div>';
        });
};

console.log('‚úÖ loadManagerSavedSearches function defined at top:', typeof window.loadManagerSavedSearches);

// Define missing functions for saved searches
window.viewSearch = function(searchId) {
    console.log('üîç View search:', searchId);
    
    // Find the search data to extract filters
    fetch(`/api/manager/saved-searches`)
        .then(response => {
            if (!response.ok) {
                console.error('‚ùå View search API error - Status:', response.status);
                throw new Error(`HTTP ${response.status}`);
            }
            return response.json();
        })
        .then(data => {
            if (data.success) {
                const search = data.searches.find(s => s.id === searchId);
                if (search && search.additional_filters) {
                    try {
                        const filters = JSON.parse(search.additional_filters);
                        
                        // Build URL parameters from filters
                        const params = new URLSearchParams();
                        
                        if (filters.rooms && filters.rooms.length > 0) {
                            params.append('rooms', filters.rooms.join(','));
                        }
                        if (filters.districts && filters.districts.length > 0) {
                            params.append('district', filters.districts.join(','));
                        }
                        if (filters.developers && filters.developers.length > 0) {
                            params.append('developer', filters.developers.join(','));
                        }
                        if (filters.priceFrom && filters.priceFrom !== '') {
                            // Convert millions to rubles (multiply by 1,000,000)
                            const priceFromRubles = parseFloat(filters.priceFrom) * 1000000;
                            params.append('price_min', priceFromRubles.toString());
                        }
                        if (filters.priceTo && filters.priceTo !== '') {
                            // Convert millions to rubles (multiply by 1,000,000)
                            const priceToRubles = parseFloat(filters.priceTo) * 1000000;
                            params.append('price_max', priceToRubles.toString());
                        }
                        if (filters.areaFrom && filters.areaFrom !== '') {
                            params.append('area_min', filters.areaFrom);
                        }
                        if (filters.areaTo && filters.areaTo !== '') {
                            params.append('area_max', filters.areaTo);
                        }
                        
                        const url = `/properties?${params.toString()}`;
                        console.log('üîç Opening search with filters:', url);
                        window.open(url, '_blank');
                    } catch (e) {
                        console.error('Error parsing filters:', e);
                        window.open(`/properties`, '_blank');
                    }
                } else {
                    window.open(`/properties`, '_blank');
                }
            }
        })
        .catch(error => {
            console.error('Error loading search filters:', error);
            window.open(`/properties`, '_blank');
        });
};

window.sendSearchToClient = function(searchId) {
    console.log('üìß Send search to client:', searchId);
    
    // Show client selection modal
    const modalHTML = `
        <div id="send-search-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
            <div class="bg-white rounded-lg p-6 w-full max-w-md mx-4">
                <h3 class="text-lg font-semibold mb-4">–û—Ç–ø—Ä–∞–≤–∏—Ç—å –ø–æ–∏—Å–∫ –∫–ª–∏–µ–Ω—Ç—É</h3>
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">–í—ã–±–µ—Ä–∏—Ç–µ –∫–ª–∏–µ–Ω—Ç–∞</label>
                        <select id="client-select" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[#0088cc]">
                            <option value="">–ó–∞–≥—Ä—É–∑–∫–∞ –∫–ª–∏–µ–Ω—Ç–æ–≤...</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">–°–æ–æ–±—â–µ–Ω–∏–µ (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)</label>
                        <textarea id="search-message" rows="3" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[#0088cc]" placeholder="–î–æ–±–∞–≤—å—Ç–µ –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ..."></textarea>
                    </div>
                </div>
                <div class="flex gap-2 mt-6">
                    <button onclick="closeSendSearchModal()" class="flex-1 px-4 py-2 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50">
                        –û—Ç–º–µ–Ω–∞
                    </button>
                    <button onclick="confirmSendSearch(${searchId})" class="flex-1 px-4 py-2 bg-[#0088cc] text-white rounded-lg hover:bg-[#006699]">
                        –û—Ç–ø—Ä–∞–≤–∏—Ç—å
                    </button>
                </div>
            </div>
        </div>
    `;
    
    document.body.insertAdjacentHTML('beforeend', modalHTML);
    
    // Load clients for selection
    fetch('/api/manager/clients')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                const select = document.getElementById('client-select');
                select.innerHTML = '<option value="">–í—ã–±–µ—Ä–∏—Ç–µ –∫–ª–∏–µ–Ω—Ç–∞</option>' + 
                    data.clients.map(client => 
                        `<option value="${client.id}">${client.full_name} (${client.email})</option>`
                    ).join('');
            }
        });
};

window.closeSendSearchModal = function() {
    const modal = document.getElementById('send-search-modal');
    if (modal) modal.remove();
};

window.confirmSendSearch = function(searchId) {
    const clientId = document.getElementById('client-select').value;
    const message = document.getElementById('search-message').value;
    
    if (!clientId) {
        alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ –∫–ª–∏–µ–Ω—Ç–∞');
        return;
    }
    
    fetch('/api/manager/send-search', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-Requested-With': 'XMLHttpRequest'
        },
        body: JSON.stringify({
            search_id: searchId,
            client_id: clientId,
            message: message
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('–ü–æ–∏—Å–∫ —É—Å–ø–µ—à–Ω–æ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω –∫–ª–∏–µ–Ω—Ç—É!');
            closeSendSearchModal();
        } else {
            alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ: ' + (data.error || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'));
        }
    })
    .catch(error => {
        console.error('Error sending search:', error);
        alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ –ø–æ–∏—Å–∫–∞');
    });
};

window.deleteSearch = function(searchId) {
    if (!confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —ç—Ç–æ—Ç —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã–π –ø–æ–∏—Å–∫?')) {
        return;
    }
    
    fetch(`/api/manager/saved-searches/${searchId}`, {
        method: 'DELETE',
        headers: {
            'X-Requested-With': 'XMLHttpRequest'
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('–ü–æ–∏—Å–∫ —É—Å–ø–µ—à–Ω–æ —É–¥–∞–ª—ë–Ω!');
            // Reload saved searches
            loadManagerSavedSearches();
        } else {
            alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏: ' + (data.error || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'));
        }
    })
    .catch(error => {
        console.error('Error deleting search:', error);
        alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ –ø–æ–∏—Å–∫–∞');
    });
};

console.log('‚úÖ Saved searches functions defined');

// Navigation functionality - Global scope
window.showSection = function(sectionId) {
    console.log('üéØ showSection called with:', sectionId);
    
    // Hide all sections
    document.querySelectorAll('.content-section').forEach(section => {
        section.classList.remove('active');
    });
    
    // Remove active class from all tab buttons
    document.querySelectorAll('.tab-button').forEach(tab => {
        tab.classList.remove('active');
        tab.classList.remove('border-[#0088CC]', 'text-[#0088CC]');
        tab.classList.add('border-transparent', 'text-gray-500');
    });
    
    // Show selected section with debugging
    console.log('üîç Available sections:', Array.from(document.querySelectorAll('.content-section')).map(s => s.id));
    const targetSection = document.getElementById(sectionId);
    console.log('üîç Target section found:', targetSection, 'for ID:', sectionId);
    
    if (targetSection) {
        targetSection.classList.add('active');
        console.log('‚úÖ Section activated:', sectionId);
    } else {
        console.error('‚ùå Section not found:', sectionId);
        console.log('üîç DOM ready state:', document.readyState);
        console.log('üîç All elements with deals:', document.querySelectorAll('[id*="deals"]'));
    }
    
    // Add active class to corresponding tab button
    const activeTab = document.querySelector(`[data-page="${sectionId}"]`);
    if (activeTab) {
        activeTab.classList.add('active');
        activeTab.classList.remove('border-transparent', 'text-gray-500');
        activeTab.classList.add('border-[#0088CC]', 'text-[#0088CC]');
    }
    
    // Load section-specific data
    if (sectionId === 'clients') {
        console.log('üéØ Clients section selected - calling loadClients');
        if (typeof window.loadClients === 'function') {
            window.loadClients();
        } else {
            console.error('‚ùå window.loadClients is not a function');
        }
    } else if (sectionId === 'collections') {
        loadCollections();
    } else if (sectionId === 'saved-searches') {
        loadManagerSavedSearches();
    } else if (sectionId === 'deals') {
        console.log('ü§ù Deals section selected - loading real data');
        if (typeof window.loadStaticDealsData === 'function') {
            window.loadStaticDealsData();
        }
    } else if (sectionId === 'presentations') {
        console.log('üéØ Presentations section selected - calling loadPresentations');
        if (typeof window.loadPresentations === 'function') {
            window.loadPresentations();
        } else if (typeof loadPresentations === 'function') {
            loadPresentations();
        } else {
            console.error('‚ùå loadPresentations function not found');
        }
    } else if (sectionId === 'recommendations') {
        console.log('üéØ Recommendations section selected - calling loadRecommendations');
        if (typeof window.loadRecommendations === 'function') {
            window.loadRecommendations();
        } else {
            console.error('‚ùå window.loadRecommendations is not a function');
        }
    } else if (sectionId === 'favorites') {
        console.log('üéØ Favorite properties section selected - calling loadFavoriteProperties');
        if (typeof window.loadFavoriteProperties === 'function') {
            window.loadFavoriteProperties();
        } else {
            console.error('‚ùå window.loadFavoriteProperties is not a function');
        }
        
        // Also trigger count update to sync UI
        updateFavoritesCounts();
    } else if (sectionId === 'favorite-complexes') {
        console.log('üéØ Favorite complexes section selected - calling loadFavoriteComplexes');
        if (typeof window.loadFavoriteComplexes === 'function') {
            window.loadFavoriteComplexes();
        } else {
            console.error('‚ùå window.loadFavoriteComplexes is not a function');
        }
        
        // Also trigger count update to sync UI
        updateFavoritesCounts();
    } else if (sectionId === 'overview' || sectionId === 'dashboard') {
        console.log('üéØ Dashboard overview selected - data already loaded by loadDashboardData');
        // Don't reload data here - it's already loaded by loadDashboardData in DOMContentLoaded
        // This prevents duplicate API calls
    }
}

// Add click handlers to tab buttons  
document.querySelectorAll('.tab-button[data-page]').forEach(item => {
    item.addEventListener('click', function(e) {
        e.preventDefault();
        e.stopPropagation();
        const page = e.currentTarget.dataset.page;
        if (page) {
            window.showSection(page);
        }
    });
});

// Alias for backward compatibility
window.switchToSection = window.showSection;

// User menu toggle (only if element exists)
const userMenuButton = document.getElementById('user-menu-button');
if (userMenuButton) {
    userMenuButton.addEventListener('click', function() {
        const menu = document.getElementById('user-menu');
        if (menu) {
            menu.classList.toggle('hidden');
        }
    });
}

// Property search functionality - Make functions global
let selectedProperties = [];
let currentView = 'grid'; // grid or list
let collections = [];
let complexes = {};

// Global functions
window.searchApartments = function() {
    const district = document.getElementById('filter-district').value;
    const developer = document.getElementById('filter-developer').value;
    const rooms = document.getElementById('filter-rooms').value;
    const complex = document.getElementById('filter-complex').value;
    const priceMin = document.getElementById('filter-price-min').value;
    const priceMax = document.getElementById('filter-price-max').value;
    const areaMin = document.getElementById('filter-area-min').value;
    const areaMax = document.getElementById('filter-area-max').value;
    const floorMin = document.getElementById('filter-floor-min').value;
    const floorMax = document.getElementById('filter-floor-max').value;
    const status = document.getElementById('filter-status').value;
    const finishing = document.getElementById('filter-finishing').value;
    
    const searchParams = new URLSearchParams();
    if (district) searchParams.append('district', district);
    if (developer) searchParams.append('developer', developer);
    if (rooms) searchParams.append('rooms', rooms);
    if (complex) searchParams.append('complex', complex);
    if (priceMin) searchParams.append('price_min', priceMin);
    if (priceMax) searchParams.append('price_max', priceMax);
    if (areaMin) searchParams.append('area_min', areaMin);
    if (areaMax) searchParams.append('area_max', areaMax);
    if (floorMin) searchParams.append('floor_min', floorMin);
    if (floorMax) searchParams.append('floor_max', floorMax);
    if (status) searchParams.append('status', status);
    if (finishing) searchParams.append('finishing', finishing);
    
    // Show loading state
    document.getElementById('properties-results').innerHTML = 
        '<p class="text-gray-500 col-span-full text-center py-8">–ü–æ–∏—Å–∫ –∫–≤–∞—Ä—Ç–∏—Ä...</p>';
    
    // Load the EXACT same data that properties.html uses
    console.log('Loading properties using same method as properties.html...');
    
    // First try to get the data from the same endpoint properties.html uses
    fetch('/properties')
        .then(response => response.text())
        .then(html => {
            const parser = new DOMParser();
            const doc = parser.parseFromString(html, 'text/html');
            
            // Extract the allProperties array from the script tag
            const scriptTags = doc.querySelectorAll('script');
            let allProperties = [];
            
            for (let script of scriptTags) {
                if (script.textContent.includes('let allProperties = ')) {
                    const match = script.textContent.match(/let allProperties = (\[.*?\]);/s);
                    if (match) {
                        try {
                            allProperties = JSON.parse(match[1]);
                            console.log('Successfully extracted properties from properties.html:', allProperties.length);
                            break;
                        } catch (e) {
                            console.error('Failed to parse properties from properties.html:', e);
                        }
                    }
                }
            }
            
            if (allProperties.length === 0) {
                console.log('Could not extract from properties.html, trying JSON endpoint...');
                return fetch('/data/properties_expanded.json').then(r => r.json());
            }
            
            return allProperties;
        })
        .then(allProperties => {
            console.log('Final properties data:', allProperties.length);
            console.log('Sample property:', allProperties[0]);
            
            // Apply filtering exactly like properties.html
            let filteredProperties = allProperties.filter(property => {
                // District filter
                if (district && property.district && !property.district.toLowerCase().includes(district.toLowerCase())) {
                    return false;
                }
                
                // Developer filter
                if (developer && property.developer && !property.developer.toLowerCase().includes(developer.toLowerCase())) {
                    return false;
                }
                
                // Rooms filter - exactly like properties.html
                if (rooms) {
                    const propertyType = property.type || '';
                    const propertyRooms = property.rooms || 0;
                    
                    if (rooms === '—Å—Ç—É–¥–∏—è' && propertyType !== '—Å—Ç—É–¥–∏—è') return false;
                    if (rooms === '1' && propertyRooms !== 1) return false;
                    if (rooms === '2' && propertyRooms !== 2) return false;
                    if (rooms === '3' && propertyRooms !== 3) return false;
                    if (rooms === '4+' && propertyRooms < 4 && propertyType !== '–¥–æ–º') return false;
                }
                
                // Complex filter (–ñ–ö filter)
                if (complex && complex !== '–í—Å–µ –ñ–ö' && property.complex_name && !property.complex_name.toLowerCase().includes(complex.toLowerCase())) {
                    return false;
                }
                
                // Price filter (in millions like properties.html)
                if (priceMin && property.price < (parseFloat(priceMin) * 1000000)) return false;
                if (priceMax && property.price > (parseFloat(priceMax) * 1000000)) return false;
                
                // Area filter
                if (areaMin && property.area < parseFloat(areaMin)) return false;
                if (areaMax && property.area > parseFloat(areaMax)) return false;
                
                // Floor filter
                if (floorMin && property.floor < parseInt(floorMin)) return false;
                if (floorMax && property.floor > parseInt(floorMax)) return false;
                
                return true;
            });
            
            console.log('Filtered properties:', filteredProperties.length);
            
            // Show filtered results - limit to 20 for performance
            const displayProps = filteredProperties.slice(0, 20);
            displayApartments(displayProps);
            document.getElementById('results-count').textContent = `${filteredProperties.length} –∫–≤–∞—Ä—Ç–∏—Ä (–ø–æ–∫–∞–∑–∞–Ω–æ ${displayProps.length})`;
        })
        .catch(error => {
            console.error('Error loading properties:', error);
            document.getElementById('properties-results').innerHTML = 
                '<p class="text-red-500 col-span-full text-center py-8">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö</p>';
            document.getElementById('results-count').textContent = '0 –∫–≤–∞—Ä—Ç–∏—Ä';
        });
}

function filterProperties(properties, filters) {
    const { 
        district, developer, rooms, complex, priceMin, priceMax, areaMin, areaMax, 
        floorMin, floorMax, status, finishing, buildingClass, material, ceilingMin, ceilingMax,
        hasBalcony, hasParking, hasView, isPenthouse, familyMortgage, itMortgage, militaryMortgage, ruralMortgage
    } = filters;
    
    return properties.filter(property => {
        // District filter
        if (district && property.district && !property.district.toLowerCase().includes(district.toLowerCase())) {
            return false;
        }
        
        // Developer filter
        if (developer && property.developer && !property.developer.toLowerCase().includes(developer.toLowerCase())) {
            return false;
        }
        
        // Rooms filter - fix to match property data structure
        if (rooms) {
            const propertyType = property.type || '';
            const propertyRooms = property.rooms || 0;
            
            if (rooms === '—Å—Ç—É–¥–∏—è' && propertyType !== '—Å—Ç—É–¥–∏—è') return false;
            if (rooms === '1' && propertyRooms !== 1) return false;
            if (rooms === '2' && propertyRooms !== 2) return false;
            if (rooms === '3' && propertyRooms !== 3) return false;
            if (rooms === '4+' && propertyRooms < 4 && propertyType !== '–¥–æ–º') return false;
        }
        
        // Complex filter
        if (complex && property.complex_id && property.complex_id != complex) {
            return false;
        }
        
        // Price filter (in millions)
        if (priceMin && property.price < (parseFloat(priceMin) * 1000000)) return false;
        if (priceMax && property.price > (parseFloat(priceMax) * 1000000)) return false;
        
        // Area filter
        if (areaMin && property.area < parseFloat(areaMin)) return false;
        if (areaMax && property.area > parseFloat(areaMax)) return false;
        
        // Floor filter
        if (floorMin && property.floor < parseInt(floorMin)) return false;
        if (floorMax && property.floor > parseInt(floorMax)) return false;
        
        // Status filter
        if (status) {
            const completionDate = property.completion_date || '';
            if (status === '—Å–¥–∞–Ω' && !completionDate.toLowerCase().includes('—Å–¥–∞–Ω')) return false;
            if (status === '—Å—Ç—Ä–æ–∏—Ç–µ–ª—å—Å—Ç–≤–æ' && completionDate.toLowerCase().includes('—Å–¥–∞–Ω')) return false;
        }
        
        // Finishing filter  
        if (finishing) {
            const finishType = property.finish_type || '';
            if (finishing === '—á–µ—Ä–Ω–æ–≤–∞—è' && !finishType.toLowerCase().includes('—á–µ—Ä–Ω–æ–≤–∞—è')) return false;
            if (finishing === '—á–∏—Å—Ç–æ–≤–∞—è' && !finishType.toLowerCase().includes('—á–∏—Å—Ç–æ–≤–∞—è')) return false;
            if (finishing === '–ø–æ–¥ –∫–ª—é—á' && !finishType.toLowerCase().includes('–ø—Ä–µ–º–∏—É–º')) return false;
        }
        
        // Building class filter
        if (buildingClass && property.building_class && !property.building_class.toLowerCase().includes(buildingClass.toLowerCase())) {
            return false;
        }
        
        // Material filter
        if (material && property.wall_material && !property.wall_material.toLowerCase().includes(material.toLowerCase())) {
            return false;
        }
        
        // Ceiling height filter
        if (ceilingMin && property.ceiling_height && property.ceiling_height < parseFloat(ceilingMin)) return false;
        if (ceilingMax && property.ceiling_height && property.ceiling_height > parseFloat(ceilingMax)) return false;
        
        // Amenities filters
        if (hasBalcony && !property.has_balcony) return false;
        if (hasParking && !property.has_parking) return false;
        if (hasView && !property.has_view) return false;
        if (isPenthouse && !property.is_penthouse) return false;
        
        // Mortgage filters
        if (familyMortgage && !property.family_mortgage) return false;
        if (itMortgage && !property.it_mortgage) return false;
        if (militaryMortgage && !property.military_mortgage) return false;
        if (ruralMortgage && !property.rural_mortgage) return false;
        
        return true;
    });
}

function displayApartments(apartments) {
    const container = document.getElementById('properties-results');
    
    if (apartments.length === 0) {
        container.innerHTML = '<p class="text-gray-500 col-span-full text-center py-8">–ö–≤–∞—Ä—Ç–∏—Ä—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</p>';
        return;
    }
    
    if (currentView === 'grid') {
        // Grid view
        container.className = 'grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4';
        container.innerHTML = apartments.map(apartment => {
            const images = apartment.gallery || [apartment.image] || [];
            const mainImage = images[0] || 'https://images.unsplash.com/photo-1560448204-e02f11c3d0e2?ixlib=rb-4.0.3&auto=format&fit=crop&w=400&h=300&q=80';
            const cashback = Math.round(apartment.price * 0.05); // 5% cashback
            
            return `
                <div class="border border-gray-200 rounded-lg overflow-hidden hover:shadow-lg transition-shadow ${selectedProperties.includes(apartment.id) ? 'border-green-500 bg-green-50' : ''}">
                    <div class="relative">
                        <img src="${mainImage}" alt="${apartment.title || apartment.complex_name}" class="w-full h-48 object-cover">
                        <div class="absolute top-2 right-2 bg-green-500 text-white px-2 py-1 rounded text-xs font-medium">
                            –ö–µ—à–±—ç–∫ ‚ÇΩ${(cashback / 1000000).toFixed(1)}–ú
                        </div>
                        <div class="absolute bottom-2 left-2 bg-white px-2 py-1 rounded text-xs font-medium">
                            ${apartment.rooms === 0 ? '–°—Ç—É–¥–∏—è' : apartment.rooms + '-–∫–æ–º–Ω.'}
                        </div>
                    </div>
                    <div class="p-4">
                        <h5 class="font-medium text-gray-900 mb-1">${apartment.title || apartment.complex_name + ' ' + apartment.type}</h5>
                        <p class="text-sm text-gray-600 mb-2">${apartment.district} ‚Ä¢ ${apartment.developer}</p>
                        <div class="flex justify-between items-center mb-2">
                            <span class="text-xs text-gray-500">${apartment.area} –º¬≤</span>
                            <span class="text-xs text-gray-500">${apartment.floor}/${apartment.total_floors || apartment.max_floor || '–ù/–î'} —ç—Ç–∞–∂</span>
                        </div>
                        <p class="text-lg font-bold text-[#0088cc] mb-2">‚ÇΩ${apartment.price?.toLocaleString() || '–¶–µ–Ω–∞ –ø–æ –∑–∞–ø—Ä–æ—Å—É'}</p>
                        <p class="text-sm text-green-600 mb-3">–ö–µ—à–±–µ–∫: ‚ÇΩ${cashback.toLocaleString()}</p>
                        <div class="flex gap-2">
                            <button onclick="viewProperty(${apartment.id})" class="flex-1 px-3 py-2 bg-gray-100 text-gray-700 rounded hover:bg-gray-200 transition-colors text-sm">
                                –ü–æ–¥—Ä–æ–±–Ω–µ–µ
                            </button>
                            <button onclick="selectProperty(${apartment.id})" class="flex-1 px-3 py-2 ${selectedProperties.includes(apartment.id) ? 'bg-green-600 hover:bg-green-700' : 'bg-[#0088cc] hover:bg-[#006699]'} text-white rounded transition-colors text-sm">
                                ${selectedProperties.includes(apartment.id) ? '–î–æ–±–∞–≤–ª–µ–Ω–æ ‚úì' : '–î–æ–±–∞–≤–∏—Ç—å –≤ –ø–æ–¥–±–æ—Ä–∫—É'}
                            </button>
                        </div>
                    </div>
                </div>
            `;
        }).join('');
    } else {
        // List view
        container.className = 'space-y-4';
        container.innerHTML = apartments.map(apartment => {
            const complex = complexes[apartment.complex_id] || {};
            const images = apartment.images || complex.images || [];
            const mainImage = images[0] || 'https://images.unsplash.com/photo-1560448204-e02f11c3d0e2?ixlib=rb-4.0.3&auto=format&fit=crop&w=200&h=150&q=80';
            
            return `
                <div class="border border-gray-200 rounded-lg p-4 hover:shadow-md transition-shadow ${selectedProperties.includes(apartment.id) ? 'border-green-500 bg-green-50' : ''}">
                    <div class="flex gap-4">
                        <img src="${mainImage}" alt="${apartment.complex_name}" class="w-32 h-24 object-cover rounded flex-shrink-0">
                        <div class="flex-1">
                            <div class="flex justify-between items-start mb-2">
                                <div>
                                    <h5 class="font-medium text-gray-900">${apartment.title || apartment.complex_name + ' ' + apartment.type}</h5>
                                    <p class="text-sm text-gray-600">${apartment.district} ‚Ä¢ ${apartment.developer}</p>
                                </div>
                                <div class="text-right">
                                    <p class="text-lg font-bold text-[#0088cc]">${apartment.price.toLocaleString()} ‚ÇΩ</p>
                                    <p class="text-sm text-green-600">–ö–µ—à–±–µ–∫: ${apartment.cashback.toLocaleString()} ‚ÇΩ</p>
                                </div>
                            </div>
                            <div class="flex justify-between items-center">
                                <div class="flex space-x-4 text-sm text-gray-500">
                                    <span>${apartment.type === '—Å—Ç—É–¥–∏—è' ? '–°—Ç—É–¥–∏—è' : apartment.rooms + '-–∫–æ–º–Ω.'}</span>
                                    <span>${apartment.area} –º¬≤</span>
                                    <span>${apartment.floor}/${apartment.max_floor} —ç—Ç–∞–∂</span>
                                </div>
                                <div class="flex gap-2">
                                    <button onclick="viewProperty(${apartment.id})" class="px-3 py-2 bg-gray-100 text-gray-700 rounded hover:bg-gray-200 transition-colors text-sm">
                                        –ü–æ–¥—Ä–æ–±–Ω–µ–µ
                                    </button>
                                    <button onclick="selectProperty(${apartment.id})" class="px-4 py-2 ${selectedProperties.includes(apartment.id) ? 'bg-green-600 hover:bg-green-700' : 'bg-[#0088cc] hover:bg-[#006699]'} text-white rounded transition-colors text-sm">
                                        ${selectedProperties.includes(apartment.id) ? '–î–æ–±–∞–≤–ª–µ–Ω–æ ‚úì' : '–î–æ–±–∞–≤–∏—Ç—å –≤ –ø–æ–¥–±–æ—Ä–∫—É'}
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }).join('');
    }
}

// Make all functions global
window.selectProperty = function(propertyId) {
    // Toggle selection
    if (selectedProperties.includes(propertyId)) {
        // Remove from selection
        const index = selectedProperties.indexOf(propertyId);
        selectedProperties.splice(index, 1);
    } else {
        // Add to selection
        selectedProperties.push(propertyId);
    }
    
    updateSelectedProperties();
    updateButtons();
    
    // Update visual state in search results
    const searchContainer = document.getElementById('properties-results');
    if (searchContainer) {
        searchApartments(); // Refresh to update visual state
    }
}

window.updateSelectedProperties = function() {
    const container = document.getElementById('selected-properties');
    const countElement = document.getElementById('selected-count');
    
    countElement.textContent = `${selectedProperties.length} –æ–±—ä–µ–∫—Ç–æ–≤`;
    
    if (selectedProperties.length === 0) {
        container.innerHTML = '<p class="text-gray-500 text-center py-4">–û–±—ä–µ–∫—Ç—ã –Ω–µ –≤—ã–±—Ä–∞–Ω—ã</p>';
        return;
    }
    
    // Fetch selected properties details
    Promise.all(selectedProperties.map(id => 
        fetch(`/api/properties/${id}`).then(r => r.json())
    )).then(responses => {
        const totalCashback = responses.reduce((sum, response) => {
            return sum + (response.success ? response.property.cashback : 0);
        }, 0);
        
        container.innerHTML = `
            <div class="bg-blue-50 p-4 rounded-lg mb-4">
                <div class="flex justify-between items-center">
                    <span class="font-medium text-blue-900">–û–±—â–∏–π –∫–µ—à–±–µ–∫ –ø–æ –ø–æ–¥–±–æ—Ä–∫–µ:</span>
                    <span class="text-xl font-bold text-blue-900">${totalCashback.toLocaleString()} ‚ÇΩ</span>
                </div>
            </div>
        ` + responses.map((response, index) => {
            if (!response.success) return '';
            const property = response.property;
            return `
                <div class="flex justify-between items-center p-3 bg-gray-50 rounded-lg border">
                    <div class="flex-1">
                        <h6 class="font-medium">${property.complex_name}</h6>
                        <p class="text-sm text-gray-600">${property.district} ‚Ä¢ ${property.developer}</p>
                        <p class="text-sm text-gray-600">${property.rooms}-–∫–æ–º–Ω. ‚Ä¢ ${property.area} –º¬≤ ‚Ä¢ ${property.price.toLocaleString()} ‚ÇΩ</p>
                        <p class="text-sm text-green-600">–ö–µ—à–±–µ–∫: ${property.cashback.toLocaleString()} ‚ÇΩ</p>
                    </div>
                    <button onclick="removeProperty(${index})" class="ml-3 text-red-500 hover:text-red-700 p-2">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            `;
        }).join('');
    });
}

window.updateButtons = function() {
    const hasSelection = selectedProperties.length > 0;
    document.getElementById('save-collection-btn').disabled = !hasSelection;
    document.getElementById('send-collection-btn').disabled = !hasSelection;
    document.getElementById('clear-selection-btn').disabled = !hasSelection;
}

window.removeProperty = function(index) {
    selectedProperties.splice(index, 1);
    updateSelectedProperties();
    updateButtons();
    
    // Refresh search results to update visual state
    const searchContainer = document.getElementById('properties-results');
    if (searchContainer && searchContainer.innerHTML !== '<p class="text-gray-500 col-span-full text-center py-8">–ù–∞–∂–º–∏—Ç–µ "–ù–∞–π—Ç–∏ –∫–≤–∞—Ä—Ç–∏—Ä—ã" –¥–ª—è –ø–æ–∏—Å–∫–∞</p>') {
        searchApartments();
    }
}

// Save search with client-compatible format
window.saveCurrentSearch = function() {
    openSaveSearchModal();
};

// Create save search modal
function openSaveSearchModal() {
    const modalHTML = `
        <div id="save-search-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
            <div class="bg-white rounded-lg p-6 w-full max-w-md mx-4">
                <h3 class="text-lg font-semibold mb-4">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –ø–æ–∏—Å–∫</h3>
                <form id="save-search-form">
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-2">–ù–∞–∑–≤–∞–Ω–∏–µ –ø–æ–∏—Å–∫–∞</label>
                        <input type="text" id="manager-search-name" required 
                               class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-[#0088cc]"
                               placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: 2-–∫–æ–º–Ω –≤ —Ü–µ–Ω—Ç—Ä–µ –¥–æ 10–º–ª–Ω">
                    </div>
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Email –∫–ª–∏–µ–Ω—Ç–∞</label>
                        <input type="email" id="manager-client-email" 
                               class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-[#0088cc]"
                               placeholder="client@example.com">
                        <p class="text-xs text-gray-500 mt-1">–ï—Å–ª–∏ —É–∫–∞–∑–∞–Ω, –ø–æ–∏—Å–∫ –±—É–¥–µ—Ç –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω –∫–ª–∏–µ–Ω—Ç—É –∏ —Å–æ—Ö—Ä–∞–Ω—ë–Ω –≤ –µ–≥–æ –∞–∫–∫–∞—É–Ω—Ç–µ</p>
                    </div>
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-2">–û–ø–∏—Å–∞–Ω–∏–µ (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)</label>
                        <textarea id="manager-search-description" rows="2"
                                  class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-[#0088cc]"
                                  placeholder="–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –∑–∞–º–µ—Ç–∫–∏ –æ –ø–æ–∏—Å–∫–µ"></textarea>
                    </div>
                    <div class="flex justify-end space-x-3">
                        <button type="button" onclick="closeSaveSearchModal()" class="px-4 py-2 text-gray-600 border border-gray-300 rounded-md hover:bg-gray-50">
                            –û—Ç–º–µ–Ω–∞
                        </button>
                        <button type="submit" class="px-4 py-2 bg-[#0088cc] text-white rounded-md hover:bg-[#0077bb]">
                            –°–æ—Ö—Ä–∞–Ω–∏—Ç—å
                        </button>
                    </div>
                </form>
            </div>
        </div>
    `;

    document.body.insertAdjacentHTML('beforeend', modalHTML);
    
    // Auto-generate search name
    generateManagerSearchName();
    
    // Bind events
    document.getElementById('save-search-form').addEventListener('submit', handleSaveSearch);
}

function generateManagerSearchName() {
    const district = document.getElementById('filter-district').value;
    const developer = document.getElementById('filter-developer').value;
    const rooms = document.getElementById('filter-rooms').value;
    const priceMin = document.getElementById('filter-price-min').value;
    const priceMax = document.getElementById('filter-price-max').value;
    
    let name = '–ü–æ–∏—Å–∫ ';
    if (rooms) name += rooms + ' ';
    if (district) name += '–≤ ' + district + ' ';
    if (developer) name += '–æ—Ç ' + developer + ' ';
    if (priceMin || priceMax) {
        name += `${priceMin || '0'}-${priceMax || '‚àû'} –º–ª–Ω`;
    }
    
    document.getElementById('manager-search-name').value = name.trim() || '–ú–æ–π –ø–æ–∏—Å–∫';
}

function closeSaveSearchModal() {
    const modal = document.getElementById('save-search-modal');
    if (modal) modal.remove();
}

async function handleSaveSearch(e) {
    e.preventDefault();
    
    const searchName = document.getElementById('manager-search-name').value.trim();
    const clientEmail = document.getElementById('manager-client-email').value.trim();
    const description = document.getElementById('manager-search-description').value.trim();
    
    if (!searchName) {
        alert('–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –ø–æ–∏—Å–∫–∞');
        return;
    }
    
    // Convert manager filters to client-compatible format
    const clientFilters = convertManagerFiltersToClient();
    
    const searchData = {
        name: searchName,
        description: description,
        client_email: clientEmail,
        notify_new_matches: true,
        search_type: 'properties',
        ...clientFilters
    };
    
    try {
        const response = await fetch('/api/searches', {
            method: 'POST',
            headers: { 
                'Content-Type': 'application/json',
                'X-Requested-With': 'XMLHttpRequest'
            },
            credentials: 'same-origin',
            body: JSON.stringify(searchData)
        });
        
        const result = await response.json();
        
        if (result.success) {
            closeSaveSearchModal();
            if (clientEmail) {
                alert(`–ü–æ–∏—Å–∫ —É—Å–ø–µ—à–Ω–æ —Å–æ—Ö—Ä–∞–Ω—ë–Ω –∏ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω –∫–ª–∏–µ–Ω—Ç—É –Ω–∞ ${clientEmail}!`);
            } else {
                alert('–ü–æ–∏—Å–∫ —É—Å–ø–µ—à–Ω–æ —Å–æ—Ö—Ä–∞–Ω—ë–Ω!');
            }
        } else {
            alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ –ø–æ–∏—Å–∫–∞: ' + (result.error || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'));
        }
    } catch (error) {
        console.error('Error saving search:', error);
        alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ –ø–æ–∏—Å–∫–∞');
    }
}

// Convert manager filters to client-compatible format
function convertManagerFiltersToClient() {
    return {
        // Basic filters
        location: document.getElementById('filter-district').value || '',
        developer: document.getElementById('filter-developer').value || '',
        property_type: document.getElementById('filter-rooms').value || '',
        complex_name: document.getElementById('filter-complex').value || '',
        
        // Price (convert to client format)
        price_min: document.getElementById('filter-price-min').value ? 
                   parseFloat(document.getElementById('filter-price-min').value) * 1000000 : null,
        price_max: document.getElementById('filter-price-max').value ? 
                   parseFloat(document.getElementById('filter-price-max').value) * 1000000 : null,
        
        // Size
        size_min: document.getElementById('filter-area-min').value ? 
                  parseFloat(document.getElementById('filter-area-min').value) : null,
        size_max: document.getElementById('filter-area-max').value ? 
                  parseFloat(document.getElementById('filter-area-max').value) : null,
        
        // Floor
        floor_min: document.getElementById('filter-floor-min').value ? 
                   parseInt(document.getElementById('filter-floor-min').value) : null,
        floor_max: document.getElementById('filter-floor-max').value ? 
                   parseInt(document.getElementById('filter-floor-max').value) : null,
        
        // Additional filters as JSON
        additional_filters: JSON.stringify({
            status: document.getElementById('filter-status').value || '',
            finishing: document.getElementById('filter-finishing').value || '',
            buildingClass: document.getElementById('filter-class') ? document.getElementById('filter-class').value : '',
            material: document.getElementById('filter-material') ? document.getElementById('filter-material').value : '',
            ceilingMin: document.getElementById('filter-ceiling-min') ? document.getElementById('filter-ceiling-min').value : '',
            ceilingMax: document.getElementById('filter-ceiling-max') ? document.getElementById('filter-ceiling-max').value : '',
            hasBalcony: document.getElementById('filter-balcony') ? document.getElementById('filter-balcony').checked : false,
            hasParking: document.getElementById('filter-parking') ? document.getElementById('filter-parking').checked : false,
            hasView: document.getElementById('filter-view') ? document.getElementById('filter-view').checked : false,
            isPenthouse: document.getElementById('filter-penthouse') ? document.getElementById('filter-penthouse').checked : false,
            familyMortgage: document.getElementById('filter-family-mortgage') ? document.getElementById('filter-family-mortgage').checked : false,
            itMortgage: document.getElementById('filter-it-mortgage') ? document.getElementById('filter-it-mortgage').checked : false,
            militaryMortgage: document.getElementById('filter-military-mortgage') ? document.getElementById('filter-military-mortgage').checked : false,
            ruralMortgage: document.getElementById('filter-rural-mortgage') ? document.getElementById('filter-rural-mortgage').checked : false
        })
    };
};

// Show saved searches from server
window.showSavedSearches = function() {
    loadSavedSearchesPage();
};

async function loadSavedSearchesPage() {
    try {
        const response = await fetch('/api/searches', {
            method: 'GET',
            headers: { 
                'Content-Type': 'application/json',
                'X-Requested-With': 'XMLHttpRequest'
            },
            credentials: 'same-origin'
        });
        const result = await response.json();
        
        if (result.success) {
            displaySavedSearchesModal(result.searches);
        } else {
            alert('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã—Ö –ø–æ–∏—Å–∫–æ–≤');
        }
    } catch (error) {
        console.error('Error loading saved searches:', error);
        alert('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã—Ö –ø–æ–∏—Å–∫–æ–≤');
    }
}

function displaySavedSearchesModal(searches) {
    if (searches.length === 0) {
        alert('–£ –≤–∞—Å –Ω–µ—Ç —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã—Ö –ø–æ–∏—Å–∫–æ–≤');
        return;
    }
    
    const searchesHTML = searches.map(search => `
        <div class="border rounded-lg p-4 mb-3 bg-gray-50">
            <div class="flex justify-between items-start">
                <div class="flex-1">
                    <h4 class="font-semibold text-lg">${search.name}</h4>
                    <div class="text-sm text-gray-600 mt-1">
                        –°–æ–∑–¥–∞–Ω: ${search.created_at}
                    </div>
                    ${getSearchSummary(search)}
                </div>
                <div class="flex space-x-2 ml-4">
                    <button onclick="loadSavedSearch(${search.id})" class="px-3 py-1 bg-[#0088cc] text-white text-sm rounded hover:bg-[#0077bb]">
                        –ü—Ä–∏–º–µ–Ω–∏—Ç—å
                    </button>
                    <button onclick="deleteSavedSearch(${search.id})" class="px-3 py-1 bg-red-600 text-white text-sm rounded hover:bg-red-700">
                        –£–¥–∞–ª–∏—Ç—å
                    </button>
                </div>
            </div>
        </div>
    `).join('');
    
    const modalHTML = `
        <div id="saved-searches-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
            <div class="bg-white rounded-lg p-6 w-full max-w-2xl mx-4 max-h-[80vh] overflow-y-auto">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-lg font-semibold">–°–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã–µ –ø–æ–∏—Å–∫–∏</h3>
                    <button onclick="closeSavedSearchesModal()" class="text-gray-500 hover:text-gray-700">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                    </button>
                </div>
                <div id="searches-list">
                    ${searchesHTML}
                </div>
            </div>
        </div>
    `;
    
    document.body.insertAdjacentHTML('beforeend', modalHTML);
}

function closeSavedSearchesModal() {
    const modal = document.getElementById('saved-searches-modal');
    if (modal) modal.remove();
}

function getSearchSummary(search) {
    const parts = [];
    
    if (search.property_type) parts.push(search.property_type);
    if (search.location) parts.push('–≤ ' + search.location);
    if (search.price_min || search.price_max) {
        let priceRange = '';
        if (search.price_min) priceRange += `–æ—Ç ${formatPrice(search.price_min)}`;
        if (search.price_max) priceRange += ` –¥–æ ${formatPrice(search.price_max)}`;
        parts.push(priceRange);
    }
    if (search.developer) parts.push('–æ—Ç ' + search.developer);
    if (search.complex_name) parts.push('–ñ–ö ' + search.complex_name);

    if (parts.length === 0) return '';
    return `<div class="mt-2 text-sm text-gray-600">${parts.join(', ')}</div>`;
}

function formatPrice(price) {
    if (price >= 1000000) {
        return (price / 1000000).toFixed(1) + '–º–ª–Ω';
    }
    return price.toLocaleString() + '—Ä';
}

async function loadSavedSearch(searchId) {
    try {
        const response = await fetch(`/api/searches/${searchId}/apply`, {
            method: 'POST',
            headers: { 
                'Content-Type': 'application/json',
                'X-Requested-With': 'XMLHttpRequest'
            },
            credentials: 'same-origin'
        });
        
        const result = await response.json();
        
        if (result.success) {
            applySavedSearch(result.search);
            closeSavedSearchesModal();
            alert('–ü–æ–∏—Å–∫ –ø—Ä–∏–º–µ–Ω—ë–Ω');
        } else {
            alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏–∏ –ø–æ–∏—Å–∫–∞');
        }
    } catch (error) {
        console.error('Error applying search:', error);
        alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏–∏ –ø–æ–∏—Å–∫–∞');
    }
}

function applySavedSearch(search) {
    // Clear current filters
    document.getElementById('filter-district').value = '';
    document.getElementById('filter-developer').value = '';
    document.getElementById('filter-rooms').value = '';
    document.getElementById('filter-complex').value = '';
    document.getElementById('filter-price-min').value = '';
    document.getElementById('filter-price-max').value = '';
    document.getElementById('filter-area-min').value = '';
    document.getElementById('filter-area-max').value = '';
    
    // Apply basic filters
    if (search.location) document.getElementById('filter-district').value = search.location;
    if (search.developer) document.getElementById('filter-developer').value = search.developer;
    if (search.property_type) document.getElementById('filter-rooms').value = search.property_type;
    if (search.complex_name) document.getElementById('filter-complex').value = search.complex_name;
    
    // Apply price filters (convert from rubles to millions)
    if (search.price_min) document.getElementById('filter-price-min').value = (search.price_min / 1000000).toString();
    if (search.price_max) document.getElementById('filter-price-max').value = (search.price_max / 1000000).toString();
    
    // Apply size filters
    if (search.size_min) document.getElementById('filter-area-min').value = search.size_min.toString();
    if (search.size_max) document.getElementById('filter-area-max').value = search.size_max.toString();
    
    // Apply additional filters if available
    if (search.additional_filters) {
        try {
            const additionalFilters = JSON.parse(search.additional_filters);
            
            if (additionalFilters.status && document.getElementById('filter-status')) {
                document.getElementById('filter-status').value = additionalFilters.status;
            }
            if (additionalFilters.finishing && document.getElementById('filter-finishing')) {
                document.getElementById('filter-finishing').value = additionalFilters.finishing;
            }
            
            // Apply advanced filters
            if (document.getElementById('filter-class') && additionalFilters.buildingClass) {
                document.getElementById('filter-class').value = additionalFilters.buildingClass;
            }
            if (document.getElementById('filter-material') && additionalFilters.material) {
                document.getElementById('filter-material').value = additionalFilters.material;
            }
            
            // Apply checkboxes
            if (document.getElementById('filter-balcony')) document.getElementById('filter-balcony').checked = additionalFilters.hasBalcony || false;
            if (document.getElementById('filter-parking')) document.getElementById('filter-parking').checked = additionalFilters.hasParking || false;
            if (document.getElementById('filter-view')) document.getElementById('filter-view').checked = additionalFilters.hasView || false;
            if (document.getElementById('filter-penthouse')) document.getElementById('filter-penthouse').checked = additionalFilters.isPenthouse || false;
            
        } catch (e) {
            console.log('Could not parse additional filters:', e);
        }
    }
    
    // Execute search
    searchApartments();
}

async function deleteSavedSearch(searchId) {
    if (!confirm('–£–¥–∞–ª–∏—Ç—å —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã–π –ø–æ–∏—Å–∫?')) return;
    
    try {
        const response = await fetch(`/api/searches/${searchId}`, {
            method: 'DELETE',
            headers: { 
                'Content-Type': 'application/json',
                'X-Requested-With': 'XMLHttpRequest'
            },
            credentials: 'same-origin'
        });
        
        const result = await response.json();
        
        if (result.success) {
            // Reload the searches modal
            closeSavedSearchesModal();
            loadSavedSearchesPage();
        } else {
            alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ –ø–æ–∏—Å–∫–∞');
        }
    } catch (error) {
        console.error('Error deleting search:', error);
        alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ –ø–æ–∏—Å–∫–∞');
    }
};

// View property details
window.viewProperty = function(propertyId) {
    // Open property in new tab or modal
    window.open(`/property/${propertyId}`, '_blank');
};

// Load clients - Global scope - MAIN FUNCTION
window.loadClients = function() {
    console.log('üîÑ Loading clients...');
    const tableBody = document.getElementById('clients-table-body');
    
    if (!tableBody) {
        console.error('‚ùå clients-table-body not found');
        return;
    }
    
    tableBody.innerHTML = '<tr><td colspan="5" class="px-6 py-4 text-center text-gray-500">–ó–∞–≥—Ä—É–∑–∫–∞ –∫–ª–∏–µ–Ω—Ç–æ–≤...</td></tr>';
    
    fetch('/api/manager/clients')
        .then(response => {
            console.log('üì° Response status:', response.status);
            return response.json();
        })
        .then(data => {
            console.log('üìä Clients data received:', data);
            if (data.success) {
                console.log('‚úÖ Success! Displaying', data.clients.length, 'clients');
                displayClients(data.clients);
                updateClientSelect(data.clients);
                // Update count in tab
                const countElement = document.getElementById('clients-count');
                if (countElement) {
                    countElement.textContent = data.clients.length;
                }
            } else {
                console.error('‚ùå API returned error:', data.error);
                tableBody.innerHTML = 
                    `<tr><td colspan="5" class="px-6 py-4 text-center text-red-500">–û—à–∏–±–∫–∞: ${data.error}</td></tr>`;
            }
        })
        .catch(error => {
            console.error('üí• Network error loading clients:', error);
            tableBody.innerHTML = 
                '<tr><td colspan="5" class="px-6 py-4 text-center text-red-500">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∫–ª–∏–µ–Ω—Ç–æ–≤</td></tr>';
        });
}

// Ensure displayClients is available
window.displayClients = function(clients) {
    console.log('üìù Displaying clients:', clients);
    const tbody = document.getElementById('clients-table-body');
    if (!tbody) {
        console.error('‚ùå Table body not found');
        return;
    }
    
    if (!clients || clients.length === 0) {
        tbody.innerHTML = '<tr><td colspan="5" class="px-6 py-4 text-center text-gray-500">–ö–ª–∏–µ–Ω—Ç—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</td></tr>';
        return;
    }
    
    tbody.innerHTML = clients.map(client => `
        <tr>
            <td class="px-6 py-4 whitespace-nowrap">
                <div class="text-sm font-medium text-gray-900">${client.full_name || '–ù–µ —É–∫–∞–∑–∞–Ω–æ'}</div>
            </td>
            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${client.email || '–ù–µ —É–∫–∞–∑–∞–Ω–æ'}</td>
            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${client.phone || '-'}</td>
            <td class="px-6 py-4 whitespace-nowrap">
                <span class="px-2 py-1 text-xs font-semibold rounded-full bg-green-100 text-green-800">
                    –ê–∫—Ç–∏–≤–µ–Ω
                </span>
            </td>
            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                <button onclick="editClient(${client.id})" class="text-[#0088cc] hover:text-[#006699] mr-3">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</button>
                <button onclick="deleteClient(${client.id}, '${client.full_name}')" class="text-red-600 hover:text-red-900">–£–¥–∞–ª–∏—Ç—å</button>
            </td>
        </tr>
    `).join('');
}

// Removed duplicate - using window.displayClients above

function updateClientSelect(clients) {
    const select = document.getElementById('collection-client');
    select.innerHTML = '<option value="">–í—ã–±–µ—Ä–∏—Ç–µ –∫–ª–∏–µ–Ω—Ç–∞</option>' + 
        clients.map(client => `<option value="${client.id}">${client.full_name}</option>`).join('');
}

// Load recommendations - Global scope
window.loadRecommendations = function() {
    console.log('Loading recommendations...');
    fetch('/api/manager/recommendations')
        .then(response => response.json())
        .then(data => {
            console.log('Recommendations data received:', data);
            if (data.success) {
                displayRecommendations(data.recommendations);
                updateRecommendationsStats(data.stats || {});
            } else {
                console.error('Failed to load recommendations:', data.error);
                document.getElementById('recommendations-container').innerHTML = 
                    '<div class="text-center py-8 text-red-500">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–π</div>';
            }
        })
        .catch(error => {
            console.error('Error loading recommendations:', error);
            document.getElementById('recommendations-container').innerHTML = 
                '<div class="text-center py-8 text-red-500">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–π</div>';
        });
}

function displayRecommendations(recommendations) {
    const container = document.getElementById('recommendations-container');
    if (!recommendations || recommendations.length === 0) {
        container.innerHTML = '<div class="text-center py-8 text-gray-500">–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</div>';
        return;
    }
    
    container.innerHTML = recommendations.map(rec => `
        <div class="bg-gray-50 rounded-lg p-4">
            <div class="flex justify-between items-start mb-2">
                <div>
                    <h4 class="font-medium text-gray-900">${rec.property_title || '–û–±—ä–µ–∫—Ç –Ω–µ–¥–≤–∏–∂–∏–º–æ—Å—Ç–∏'}</h4>
                    <p class="text-sm text-gray-600">–ö–ª–∏–µ–Ω—Ç: ${rec.client_name}</p>
                </div>
                <span class="px-2 py-1 text-xs font-semibold rounded-full ${getStatusClass(rec.status)}">
                    ${getStatusText(rec.status)}
                </span>
            </div>
            <p class="text-sm text-gray-600 mb-2">${rec.message || '–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞'}</p>
            <div class="text-xs text-gray-500">
                –û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ: ${new Date(rec.created_at).toLocaleDateString('ru-RU')}
            </div>
        </div>
    `).join('');
}

function updateRecommendationsStats(stats) {
    document.getElementById('recommendations-sent').textContent = stats.sent || 0;
    document.getElementById('recommendations-viewed').textContent = stats.viewed || 0;
    document.getElementById('recommendations-interested').textContent = stats.interested || 0;
    document.getElementById('recommendations-scheduled').textContent = stats.scheduled || 0;
}

function getStatusClass(status) {
    const classes = {
        'sent': 'bg-blue-100 text-blue-800',
        'viewed': 'bg-green-100 text-green-800',
        'interested': 'bg-purple-100 text-purple-800',
        'not_interested': 'bg-gray-100 text-gray-800',
        'scheduled_viewing': 'bg-orange-100 text-orange-800'
    };
    return classes[status] || 'bg-gray-100 text-gray-800';
}

function getStatusText(status) {
    const texts = {
        'sent': '–û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ',
        'viewed': '–ü—Ä–æ—Å–º–æ—Ç—Ä–µ–Ω–æ',
        'interested': '–ó–∞–∏–Ω—Ç–µ—Ä–µ—Å–æ–≤–∞–Ω—ã',
        'not_interested': '–ù–µ –∑–∞–∏–Ω—Ç–µ—Ä–µ—Å–æ–≤–∞–Ω—ã',
        'scheduled_viewing': '–ü—Ä–æ—Å–º–æ—Ç—Ä –Ω–∞–∑–Ω–∞—á–µ–Ω'
    };
    return texts[status] || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ';
}

// Load complexes for filter
function loadComplexes() {
    fetch('/api/complexes')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                const select = document.getElementById('filter-complex');
                select.innerHTML = '<option value="">–í—Å–µ –ñ–ö</option>' + 
                    data.complexes.map(complex => `<option value="${complex.id}">${complex.name}</option>`).join('');
            }
        })
        .catch(error => console.error('Error loading complexes:', error));
}

// Edit client function
window.editClient = function(clientId) {
    // Find client data using correct endpoint
    fetch(`/manager/get-client/${clientId}`, {
        headers: {
            'X-Requested-With': 'XMLHttpRequest',
            'Content-Type': 'application/json'
        }
    })
        .then(response => response.json())
        .then(data => {
            console.log('Client data received:', data);
            if (data.success) {
                const client = data;
                
                // Create edit modal
                const modal = document.createElement('div');
                modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
                modal.innerHTML = `
                    <div class="bg-white rounded-lg p-6 w-full max-w-md">
                        <h3 class="text-lg font-semibold mb-4">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –∫–ª–∏–µ–Ω—Ç–∞</h3>
                        <form id="edit-client-form">
                            <div class="space-y-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">–ü–æ–ª–Ω–æ–µ –∏–º—è</label>
                                    <input type="text" id="edit-client-full-name" value="${client.full_name || ''}" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[#0088cc] focus:border-transparent" required>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Email</label>
                                    <input type="email" id="edit-client-email" value="${client.email}" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[#0088cc] focus:border-transparent" required>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">–¢–µ–ª–µ—Ñ–æ–Ω</label>
                                    <input type="tel" id="edit-client-phone" value="${client.phone || ''}" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[#0088cc] focus:border-transparent">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">–°—Ç–∞—Ç—É—Å</label>
                                    <select id="edit-client-status" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[#0088cc] focus:border-transparent">
                                        <option value="1" ${client.is_active ? 'selected' : ''}>–ê–∫—Ç–∏–≤–µ–Ω</option>
                                        <option value="0" ${!client.is_active ? 'selected' : ''}>–ù–µ–∞–∫—Ç–∏–≤–µ–Ω</option>
                                    </select>
                                </div>
                            </div>
                            <div class="flex justify-end space-x-3 mt-6">
                                <button type="button" onclick="closeEditModal()" class="px-4 py-2 bg-gray-300 text-gray-700 rounded-lg hover:bg-gray-400 transition-colors">–û—Ç–º–µ–Ω–∞</button>
                                <button type="submit" class="px-4 py-2 bg-[#0088cc] text-white rounded-lg hover:bg-[#006699] transition-colors">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
                            </div>
                        </form>
                    </div>
                `;
                
                document.body.appendChild(modal);
                
                // Handle form submission
                document.getElementById('edit-client-form').addEventListener('submit', function(e) {
                    e.preventDefault();
                    saveClientChanges(clientId);
                });
            } else {
                alert('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö –∫–ª–∏–µ–Ω—Ç–∞');
            }
        })
        .catch(error => {
            console.error('Error loading client:', error);
            alert('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö –∫–ª–∏–µ–Ω—Ç–∞');
        });
};

// Delete client function
window.deleteClient = function(clientId, clientName) {
    if (confirm(`–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å –∫–ª–∏–µ–Ω—Ç–∞ "${clientName}"?`)) {
        fetch(`/manager/delete-client`, {
            method: 'POST',
            headers: {
                'X-Requested-With': 'XMLHttpRequest',
                'Content-Type': 'application/x-www-form-urlencoded',
            },
            body: `client_id=${clientId}`
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert('–ö–ª–∏–µ–Ω—Ç —É—Å–ø–µ—à–Ω–æ —É–¥–∞–ª–µ–Ω');
                loadClients(); // Reload the clients list
            } else {
                alert(data.message || '–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ –∫–ª–∏–µ–Ω—Ç–∞');
            }
        })
        .catch(error => {
            console.error('Error deleting client:', error);
            alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ –∫–ª–∏–µ–Ω—Ç–∞');
        });
    }
};

// Close edit modal
window.closeEditModal = function() {
    const modal = document.querySelector('.fixed.inset-0');
    if (modal) {
        modal.remove();
    }
};

// Save client changes
function saveClientChanges(clientId) {
    const formData = new FormData();
    formData.append('client_id', clientId);
    formData.append('full_name', document.getElementById('edit-client-full-name').value);
    formData.append('email', document.getElementById('edit-client-email').value);
    formData.append('phone', document.getElementById('edit-client-phone').value);
    if (document.getElementById('edit-client-status').value === '1') {
        formData.append('is_active', 'on');
    }
    
    fetch(`/manager/edit-client`, {
        method: 'POST',
        headers: {
            'X-Requested-With': 'XMLHttpRequest'
        },
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('–î–∞–Ω–Ω—ã–µ –∫–ª–∏–µ–Ω—Ç–∞ –æ–±–Ω–æ–≤–ª–µ–Ω—ã');
            closeEditModal();
            loadClients(); // Reload the clients list
        } else {
            alert(data.message || '–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏');
        }
    })
    .catch(error => {
        console.error('Error saving client:', error);
        alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏');
    });
}

// Show add client modal
function showAddClientModal() {
    console.log('showAddClientModal called');
    const modal = document.createElement('div');
    modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
    modal.innerHTML = `
        <div class="bg-white rounded-lg p-6 w-full max-w-md">
            <h3 class="text-lg font-semibold mb-4">–î–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤–æ–≥–æ –∫–ª–∏–µ–Ω—Ç–∞</h3>
            <form id="add-client-form">
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">–ü–æ–ª–Ω–æ–µ –∏–º—è *</label>
                        <input type="text" id="add-client-full-name" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[#0088cc] focus:border-transparent" required minlength="2" maxlength="100">
                        <div class="text-xs text-gray-500 mt-1">–í–≤–µ–¥–∏—Ç–µ –∏–º—è –∏ —Ñ–∞–º–∏–ª–∏—é</div>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Email *</label>
                        <input type="email" id="add-client-email" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[#0088cc] focus:border-transparent" required>
                        <div class="text-xs text-gray-500 mt-1">–§–æ—Ä–º–∞—Ç: example@domain.com</div>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">–¢–µ–ª–µ—Ñ–æ–Ω</label>
                        <input type="tel" id="add-client-phone" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[#0088cc] focus:border-transparent" placeholder="+7-918-123-45-67">
                        <div class="text-xs text-gray-500 mt-1">–§–æ—Ä–º–∞—Ç: +7-918-123-45-67</div>
                    </div>
                    <div>
                        <label class="flex items-center">
                            <input type="checkbox" id="add-client-active" checked class="mr-2">
                            <span class="text-sm font-medium text-gray-700">–ê–∫—Ç–∏–≤–Ω—ã–π –∫–ª–∏–µ–Ω—Ç</span>
                        </label>
                    </div>
                </div>
                <div class="flex justify-end space-x-3 mt-6">
                    <button type="button" onclick="closeAddClientModal()" class="px-4 py-2 bg-gray-300 text-gray-700 rounded-lg hover:bg-gray-400 transition-colors">–û—Ç–º–µ–Ω–∞</button>
                    <button type="submit" class="px-4 py-2 bg-[#0088cc] text-white rounded-lg hover:bg-[#006699] transition-colors">–î–æ–±–∞–≤–∏—Ç—å</button>
                </div>
            </form>
        </div>
    `;
    
    document.body.appendChild(modal);
    
    // Add phone number formatting with better UX
    const phoneInput = document.getElementById('add-client-phone');
    phoneInput.addEventListener('input', function(e) {
        let cursorPosition = e.target.selectionStart;
        let value = e.target.value.replace(/\D/g, '');
        
        // Handle different input patterns
        if (value.startsWith('7')) {
            value = value.substring(1);
        } else if (value.startsWith('8')) {
            value = value.substring(1);
        }
        
        let formattedValue = '';
        if (value.length > 0) {
            formattedValue = '+7';
            if (value.length >= 1) {
                formattedValue += '-' + value.substring(0, Math.min(3, value.length));
            }
            if (value.length >= 4) {
                formattedValue += '-' + value.substring(3, Math.min(6, value.length));
            }
            if (value.length >= 7) {
                formattedValue += '-' + value.substring(6, Math.min(8, value.length));
            }
            if (value.length >= 9) {
                formattedValue += '-' + value.substring(8, Math.min(10, value.length));
            }
        }
        
        e.target.value = formattedValue;
        
        // Restore cursor position approximately
        if (cursorPosition <= formattedValue.length) {
            e.target.setSelectionRange(cursorPosition, cursorPosition);
        }
    });
    
    // Auto-start with +7- when user starts typing
    phoneInput.addEventListener('focus', function(e) {
        if (!e.target.value) {
            e.target.value = '+7-';
        }
    });
    
    // Clear placeholder text on empty
    phoneInput.addEventListener('blur', function(e) {
        if (e.target.value === '+7-' || e.target.value === '+7') {
            e.target.value = '';
        }
    });
    
    // Handle form submission
    document.getElementById('add-client-form').addEventListener('submit', function(e) {
        console.log('Form submit event triggered');
        e.preventDefault();
        console.log('Default prevented, calling validateAndSaveNewClient');
        validateAndSaveNewClient();
    });
}

// Close add client modal
function closeAddClientModal() {
    const modal = document.querySelector('.fixed.inset-0');
    if (modal) {
        modal.remove();
    }
}

// Validate and save new client
function validateAndSaveNewClient() {
    const fullName = document.getElementById('add-client-full-name').value.trim();
    const email = document.getElementById('add-client-email').value.trim();
    const phone = document.getElementById('add-client-phone').value.trim();
    
    console.log('Validating client data:', {fullName, email, phone});
    
    // Validation
    if (!fullName || fullName.length < 2) {
        alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–µ –ø–æ–ª–Ω–æ–µ –∏–º—è (–º–∏–Ω–∏–º—É–º 2 —Å–∏–º–≤–æ–ª–∞)');
        return;
    }
    
    // Email validation
    const emailRegex = /^[a-z0-9._%+-]+@[a-z0-9.-]+\.[a-z]{2,}$/i;
    if (!email || !emailRegex.test(email)) {
        alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π email –∞–¥—Ä–µ—Å');
        return;
    }
    
    // Phone validation (optional but must be correct format if provided)
    const phoneRegex = /^\+7-\d{3}-\d{3}-\d{2}-\d{2}$/;
    if (phone && !phoneRegex.test(phone)) {
        alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ —Ç–µ–ª–µ—Ñ–æ–Ω –≤ —Ñ–æ—Ä–º–∞—Ç–µ +7-918-123-45-67 –∏–ª–∏ –æ—Å—Ç–∞–≤—å—Ç–µ –ø–æ–ª–µ –ø—É—Å—Ç—ã–º');
        return;
    }
    
    console.log('Validation passed, calling saveNewClient');
    saveNewClient(fullName, email, phone);
}

// Save new client
function saveNewClient(fullName, email, phone) {
    const requestData = {
        full_name: fullName,
        email: email,
        phone: phone || null,
        is_active: document.getElementById('add-client-active').checked
    };
    
    console.log('Sending client data:', requestData);
    
    fetch('/api/manager/add-client', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-Requested-With': 'XMLHttpRequest'
        },
        body: JSON.stringify(requestData)
    })
    .then(response => {
        console.log('Response status:', response.status);
        return response.json();
    })
    .then(data => {
        console.log('Response data:', data);
        if (data.success) {
            alert(`–ö–ª–∏–µ–Ω—Ç "${fullName}" —É—Å–ø–µ—à–Ω–æ –¥–æ–±–∞–≤–ª–µ–Ω!`);
            closeAddClientModal();
            
            // Force reload clients with a small delay to ensure server processing
            setTimeout(() => {
                loadClients();
                // Also update the client select dropdown
                loadClientsForCollectionSelect();
            }, 500);
        } else {
            alert(data.error || '–û—à–∏–±–∫–∞ –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ –∫–ª–∏–µ–Ω—Ç–∞');
        }
    })
    .catch(error => {
        console.error('Error adding client:', error);
        alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ –∫–ª–∏–µ–Ω—Ç–∞. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç—É.');
    });
}

// Load clients for collection select dropdown
function loadClientsForCollectionSelect() {
    fetch('/api/manager/clients')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                const select = document.getElementById('collection-client');
                if (select) {
                    select.innerHTML = '<option value="">–í—ã–±–µ—Ä–∏—Ç–µ –∫–ª–∏–µ–Ω—Ç–∞</option>' + 
                        data.clients.map(client => `<option value="${client.id}">${client.full_name}</option>`).join('');
                }
            }
        })
        .catch(error => console.error('Error loading clients for collection select:', error));
}

// Event listeners
// Remove application modal functionality - causes unwanted popups
function removeApplicationModals() {
    // Remove any existing application modals
    const modals = document.querySelectorAll('.modal, [id*="application"], [id*="Application"]');
    modals.forEach(modal => {
        if (modal.id !== 'user-menu' && !modal.closest('.content-section')) {
            modal.remove();
        }
    });
    
    // Disable any application form handlers
    const forms = document.querySelectorAll('form[action*="application"]');
    forms.forEach(form => form.style.display = 'none');
}

document.addEventListener('DOMContentLoaded', function() {
    // Remove unwanted application modals first
    removeApplicationModals();
    // No auto-activation - let other handler manage initial section
    
    // Toggle advanced filters (only if element exists)
    const toggleFiltersButton = document.getElementById('toggle-advanced-filters');
    if (toggleFiltersButton) {
        toggleFiltersButton.addEventListener('click', function() {
            const advancedFilters = document.getElementById('advanced-filters');
            const button = this;
            
            if (advancedFilters && advancedFilters.classList.contains('manager-favorites-hidden')) {
                advancedFilters.classList.remove('manager-favorites-hidden');
                button.textContent = '- –°–∫—Ä—ã—Ç—å –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —Ñ–∏–ª—å—Ç—Ä—ã';
            } else if (advancedFilters) {
                advancedFilters.classList.add('manager-favorites-hidden');
                button.textContent = '+ –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —Ñ–∏–ª—å—Ç—Ä—ã';
            }
        });
    }

    // View toggle buttons (only if elements exist)
    const viewGridBtn = document.getElementById('view-grid-btn');
    const viewListBtn = document.getElementById('view-list-btn');
    
    if (viewGridBtn) {
        viewGridBtn.addEventListener('click', function(e) {
            e.preventDefault();
            e.stopPropagation();
            currentView = 'grid';
            this.classList.add('bg-[#0088cc]', 'text-white');
            this.classList.remove('bg-white', 'text-gray-600');
            if (viewListBtn) {
                viewListBtn.classList.remove('bg-[#0088cc]', 'text-white');
                viewListBtn.classList.add('bg-white', 'text-gray-600');
            }
            
            // Re-render if we have results
            const container = document.getElementById('properties-results');
            if (container && container.children.length > 0 && !container.querySelector('p')) {
                searchApartments();
            }
        });
    }

    if (viewListBtn) {
        viewListBtn.addEventListener('click', function(e) {
            e.preventDefault();
            e.stopPropagation();
            currentView = 'list';
            this.classList.add('bg-[#0088cc]', 'text-white');
            this.classList.remove('bg-white', 'text-gray-600');
            if (viewGridBtn) {
                viewGridBtn.classList.remove('bg-[#0088cc]', 'text-white');
                viewGridBtn.classList.add('bg-white', 'text-gray-600');
            }
            
            // Re-render if we have results
            const container = document.getElementById('properties-results');
            if (container && container.children.length > 0 && !container.querySelector('p')) {
                searchApartments();
            }
        });
    }
    
    // Search apartments button
    document.getElementById('search-apartments-btn').addEventListener('click', function(e) {
        e.preventDefault();
        e.stopPropagation();
        searchApartments();
    });
    
    // Add filter change listeners to trigger search
    ['filter-district', 'filter-developer', 'filter-rooms', 'filter-complex', 'filter-price-min', 'filter-price-max', 'filter-area-min', 'filter-area-max', 'filter-floor-min', 'filter-floor-max', 'filter-status', 'filter-finishing'].forEach(id => {
        const element = document.getElementById(id);
        if (element) {
            element.addEventListener('change', function() {
                // Only search if we already have results
                const container = document.getElementById('properties-results');
                if (container && !container.querySelector('p')) {
                    searchApartments();
                }
            });
        }
    });

    // Load complexes for filter
    loadComplexes();
    
    // Add client button
    document.getElementById('add-client-btn').addEventListener('click', function() {
        showAddClientModal();
    });
    
    // Clear selection button
    document.getElementById('clear-selection-btn').addEventListener('click', function(e) {
        e.preventDefault();
        e.stopPropagation();
        selectedProperties = [];
        updateSelectedProperties();
        updateButtons();
        
        // Refresh search results
        const searchContainer = document.getElementById('properties-results');
        if (searchContainer && searchContainer.innerHTML !== '<p class="text-gray-500 col-span-full text-center py-8">–ù–∞–∂–º–∏—Ç–µ "–ù–∞–π—Ç–∏ –∫–≤–∞—Ä—Ç–∏—Ä—ã" –¥–ª—è –ø–æ–∏—Å–∫–∞</p>') {
            searchApartments();
        }
    });
    
    // Save collection button
    document.getElementById('save-collection-btn').addEventListener('click', function(e) {
        e.preventDefault();
        e.stopPropagation();
        const name = document.getElementById('collection-name').value;
        const clientId = document.getElementById('collection-client').value;
        
        if (!name || !clientId || selectedProperties.length === 0) {
            alert('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è –∏ –≤—ã–±–µ—Ä–∏—Ç–µ –æ–±—ä–µ–∫—Ç—ã');
            return;
        }
        
        fetch('/api/manager/collections', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({
                name: name,
                client_id: clientId,
                property_ids: selectedProperties
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert('–ü–æ–¥–±–æ—Ä–∫–∞ —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω–∞!');
                // Reset form
                document.getElementById('collection-name').value = '';
                document.getElementById('collection-client').value = '';
                selectedProperties = [];
                updateSelectedProperties();
                updateButtons();
                // Clear search results
                document.getElementById('properties-results').innerHTML = 
                    '<p class="text-gray-500 col-span-full text-center py-8">–ù–∞–∂–º–∏—Ç–µ "–ù–∞–π—Ç–∏ –∫–≤–∞—Ä—Ç–∏—Ä—ã" –¥–ª—è –ø–æ–∏—Å–∫–∞</p>';
            } else {
                alert('–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –ø–æ–¥–±–æ—Ä–∫–∏: ' + data.error);
            }
        })
        .catch(error => {
            console.error('Error saving collection:', error);
            alert('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –ø–æ–¥–±–æ—Ä–∫–∏');
        });
    });
    
    // Send collection button
    document.getElementById('send-collection-btn').addEventListener('click', function(e) {
        e.preventDefault();
        e.stopPropagation();
        const name = document.getElementById('collection-name').value;
        const clientId = document.getElementById('collection-client').value;
        
        if (!name || !clientId || selectedProperties.length === 0) {
            alert('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è –∏ –≤—ã–±–µ—Ä–∏—Ç–µ –æ–±—ä–µ–∫—Ç—ã');
            return;
        }
        
        if (confirm('–û—Ç–ø—Ä–∞–≤–∏—Ç—å –ø–æ–¥–±–æ—Ä–∫—É –∫–ª–∏–µ–Ω—Ç—É –ø–æ email?')) {
            fetch('/api/manager/send-collection', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    name: name,
                    client_id: clientId,
                    property_ids: selectedProperties
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert('–ü–æ–¥–±–æ—Ä–∫–∞ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞ –∫–ª–∏–µ–Ω—Ç—É!');
                    // Reset form
                    document.getElementById('collection-name').value = '';
                    document.getElementById('collection-client').value = '';
                    selectedProperties = [];
                    updateSelectedProperties();
                    updateButtons();
                    // Clear search results
                    document.getElementById('properties-results').innerHTML = 
                        '<p class="text-gray-500 col-span-full text-center py-8">–ù–∞–∂–º–∏—Ç–µ "–ù–∞–π—Ç–∏ –∫–≤–∞—Ä—Ç–∏—Ä—ã" –¥–ª—è –ø–æ–∏—Å–∫–∞</p>';
                } else {
                    alert('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏: ' + data.error);
                }
            })
            .catch(error => {
                console.error('Error sending collection:', error);
                alert('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –ø–æ–¥–±–æ—Ä–∫–∏');
            });
        }
    });
    
    // Load initial data based on active section
    loadClients();
    
    // Clean up any remaining unwanted modals periodically
    setInterval(removeApplicationModals, 5000);
});

// Manager Saved Searches functionality
window.loadManagerSavedSearches = async function() {
    try {
        const response = await fetch('/api/manager/saved-searches');
        if (!response.ok) {
            console.error('‚ùå Saved searches API error - Status:', response.status);
            const text = await response.text();
            console.error('‚ùå Response text:', text.substring(0, 200));
            throw new Error(`HTTP ${response.status}: ${text.substring(0, 100)}`);
        }
        const data = await response.json();
        
        const grid = document.getElementById('saved-searches-grid');
        if (!data.success || !data.searches.length) {
            grid.innerHTML = `
                <div class="text-center py-12 col-span-full">
                    <div class="w-16 h-16 mx-auto mb-4 text-gray-300">
                        <i class="fas fa-search text-4xl"></i>
                    </div>
                    <p class="text-gray-500 text-lg mb-4">–£ –≤–∞—Å –ø–æ–∫–∞ –Ω–µ—Ç —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã—Ö –ø–æ–∏—Å–∫–æ–≤</p>
                    <button onclick="createNewSearch()" class="px-6 py-3 bg-[#0088cc] text-white rounded-lg hover:bg-[#0077bb] transition-colors">
                        <i class="fas fa-plus mr-2"></i>–°–æ–∑–¥–∞—Ç—å –ø–µ—Ä–≤—ã–π –ø–æ–∏—Å–∫
                    </button>
                </div>
            `;
            return;
        }
        
        grid.innerHTML = data.searches.map(search => `
            <div class="bg-gray-50 rounded-lg border p-6 hover:shadow-md transition-shadow">
                <div class="flex justify-between items-start mb-4">
                    <div class="flex-1">
                        <h3 class="font-semibold text-lg text-gray-800 mb-1">${search.name}</h3>
                        ${search.description ? `<p class="text-sm text-gray-600 mb-2">${search.description}</p>` : ''}
                        <div class="flex flex-wrap gap-2 mb-3">
                            ${search.additional_filters ? formatSearchFilters(JSON.parse(search.additional_filters)) : ''}
                        </div>
                        <div class="flex items-center text-sm text-gray-500 space-x-4">
                            <span><i class="fas fa-calendar mr-1"></i>${formatDate(search.created_at)}</span>
                            <span><i class="fas fa-paper-plane mr-1"></i>–û—Ç–ø—Ä–∞–≤–ª–µ–Ω ${search.usage_count || 0} —Ä–∞–∑</span>
                        </div>
                    </div>
                </div>
                <div class="flex space-x-2">
                    <button onclick="sendSearchToClient(${search.id})" class="flex-1 px-3 py-2 bg-[#0088cc] text-white text-sm rounded-md hover:bg-[#0077bb] transition-colors">
                        <i class="fas fa-share mr-1"></i>–û—Ç–ø—Ä–∞–≤–∏—Ç—å –∫–ª–∏–µ–Ω—Ç—É
                    </button>
                    <button onclick="editManagerSearch(${search.id})" class="px-3 py-2 text-gray-600 border border-gray-300 text-sm rounded-md hover:bg-gray-50 transition-colors">
                        <i class="fas fa-edit"></i>
                    </button>
                    <button onclick="deleteManagerSearch(${search.id})" class="px-3 py-2 text-[#0088CC] border border-gray-300 text-sm rounded-md hover:bg-red-50 transition-colors">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            </div>
        `).join('');
        
        // Update saved searches count in menu
        const savedSearchesCount = document.getElementById('saved-searches-count');
        if (savedSearchesCount) {
            savedSearchesCount.textContent = data.searches.length;
            savedSearchesCount.style.display = data.searches.length > 0 ? 'inline' : 'none';
            console.log('üîÑ Updated saved searches count to:', data.searches.length);
        }
        
    } catch (error) {
        console.error('Error loading saved searches:', error);
        document.getElementById('saved-searches-grid').innerHTML = `
            <div class="text-center py-8 col-span-full">
                <p class="text-red-500">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã—Ö –ø–æ–∏—Å–∫–æ–≤</p>
            </div>
        `;
    }
};

window.createNewSearch = function() {
    window.open('/properties', '_blank');
};

window.sendSearchToClient = async function(searchId) {
    // Open modal to select client
    const modalHTML = `
        <div id="send-search-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
            <div class="bg-white rounded-lg p-6 w-full max-w-md mx-4">
                <h3 class="text-lg font-semibold mb-4">–û—Ç–ø—Ä–∞–≤–∏—Ç—å –ø–æ–∏—Å–∫ –∫–ª–∏–µ–Ω—Ç—É</h3>
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-2">–í—ã–±–µ—Ä–∏—Ç–µ –∫–ª–∏–µ–Ω—Ç–∞</label>
                    <select id="client-select" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-[#0088cc]">
                        <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –∫–ª–∏–µ–Ω—Ç–∞...</option>
                    </select>
                </div>
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-2">–°–æ–æ–±—â–µ–Ω–∏–µ (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)</label>
                    <textarea id="search-message" rows="3" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-[#0088cc]" placeholder="–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –¥–ª—è –∫–ª–∏–µ–Ω—Ç–∞..."></textarea>
                </div>
                <div class="flex justify-end space-x-3">
                    <button onclick="closeSendSearchModal()" class="px-4 py-2 text-gray-600 border border-gray-300 rounded-md hover:bg-gray-50">
                        –û—Ç–º–µ–Ω–∞
                    </button>
                    <button onclick="confirmSendSearch(${searchId})" class="px-4 py-2 bg-[#0088cc] text-white rounded-md hover:bg-[#0077bb]">
                        –û—Ç–ø—Ä–∞–≤–∏—Ç—å
                    </button>
                </div>
            </div>
        </div>
    `;
    
    document.body.insertAdjacentHTML('beforeend', modalHTML);
    
    // Load clients into select
    try {
        const response = await fetch('/api/manager/clients');
        const data = await response.json();
        
        const select = document.getElementById('client-select');
        if (data.success && data.clients.length > 0) {
            select.innerHTML = '<option value="">–í—ã–±–µ—Ä–∏—Ç–µ –∫–ª–∏–µ–Ω—Ç–∞...</option>' + 
                data.clients.map(client => `<option value="${client.id}">${client.full_name} (${client.email})</option>`).join('');
        } else {
            select.innerHTML = '<option value="">–ö–ª–∏–µ–Ω—Ç—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</option>';
        }
    } catch (error) {
        console.error('Error loading clients:', error);
    }
};

window.closeSendSearchModal = function() {
    const modal = document.getElementById('send-search-modal');
    if (modal) modal.remove();
};

window.confirmSendSearch = async function(searchId) {
    const clientId = document.getElementById('client-select').value;
    const message = document.getElementById('search-message').value.trim();
    
    if (!clientId) {
        alert('–í—ã–±–µ—Ä–∏—Ç–µ –∫–ª–∏–µ–Ω—Ç–∞');
        return;
    }
    
    try {
        const response = await fetch('/api/manager/send-search', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                search_id: searchId,
                client_id: clientId,
                message: message
            })
        });
        
        const data = await response.json();
        if (data.success) {
            alert('–ü–æ–∏—Å–∫ —É—Å–ø–µ—à–Ω–æ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω –∫–ª–∏–µ–Ω—Ç—É!');
            closeSendSearchModal();
            loadManagerSavedSearches(); // Refresh list
        } else {
            alert('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏: ' + data.error);
        }
    } catch (error) {
        console.error('Error sending search:', error);
        alert('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –ø–æ–∏—Å–∫–∞');
    }
};

window.deleteManagerSearch = async function(searchId) {
    if (!confirm('–£–¥–∞–ª–∏—Ç—å —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã–π –ø–æ–∏—Å–∫?')) return;
    
    try {
        const response = await fetch(`/api/manager/saved-search/${searchId}`, {
            method: 'DELETE'
        });
        
        const data = await response.json();
        if (data.success) {
            loadManagerSavedSearches(); // Refresh list
        } else {
            alert('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è: ' + data.error);
        }
    } catch (error) {
        console.error('Error deleting search:', error);
        alert('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è –ø–æ–∏—Å–∫–∞');
    }
};

function formatSearchFilters(filters) {
    const tags = [];
    if (filters.rooms && filters.rooms.length > 0) {
        tags.push(`<span class="px-2 py-1 bg-gray-100 text-gray-700 text-xs rounded-full">${filters.rooms.join(', ')}</span>`);
    }
    if (filters.districts && filters.districts.length > 0) {
        tags.push(`<span class="px-2 py-1 bg-gray-100 text-green-800 text-xs rounded-full">${filters.districts.join(', ')}</span>`);
    }
    if (filters.priceTo || filters.priceFrom) {
        const priceText = `${filters.priceFrom || '0'}-${filters.priceTo || '‚àû'} –º–ª–Ω`;
        tags.push(`<span class="px-2 py-1 bg-gray-100 text-yellow-800 text-xs rounded-full">${priceText}</span>`);
    }
    if (filters.developers && filters.developers.length > 0) {
        tags.push(`<span class="px-2 py-1 bg-gray-100 text-purple-800 text-xs rounded-full">${filters.developers[0]}${filters.developers.length > 1 ? '...' : ''}</span>`);
    }
    return tags.join('');
}

function formatDate(dateString) {
    return new Date(dateString).toLocaleDateString('ru-RU');
}

// Recommendations functionality - using global window.loadRecommendations

function updateRecommendationStats(recommendations) {
    const stats = {
        sent: recommendations.length,
        viewed: recommendations.filter(r => r.viewed_at).length,
        interested: recommendations.filter(r => r.client_response === 'interested').length,
        scheduled: recommendations.filter(r => r.viewing_scheduled_at).length
    };
    
    document.getElementById('recommendations-sent').textContent = stats.sent;
    document.getElementById('recommendations-viewed').textContent = stats.viewed;
    document.getElementById('recommendations-interested').textContent = stats.interested;
    document.getElementById('recommendations-scheduled').textContent = stats.scheduled;
}

function displayRecommendations(recommendations) {
    const container = document.getElementById('recommendations-container');
    
    if (recommendations.length === 0) {
        container.innerHTML = `
            <div class="text-center py-8 text-gray-500">
                <i class="fas fa-paper-plane text-4xl mb-4"></i>
                <p>–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</p>
                <p class="text-sm">–ü–µ—Ä–µ–π–¥–∏—Ç–µ –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—É –Ω–µ–¥–≤–∏–∂–∏–º–æ—Å—Ç–∏, —á—Ç–æ–±—ã –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –ø–µ—Ä–≤—É—é —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—é</p>
            </div>
        `;
        return;
    }
    
    const html = recommendations.map(rec => {
        const statusClass = getStatusClass(rec.status);
        const priorityClass = getPriorityClass(rec.priority_level);
        const createdAt = new Date(rec.created_at).toLocaleDateString('ru-RU');
        const viewedAt = rec.viewed_at ? new Date(rec.viewed_at).toLocaleDateString('ru-RU') : null;
        
        return `
            <div class="border border-gray-200 rounded-lg p-4 hover:shadow-md transition">
                <div class="flex justify-between items-start mb-3">
                    <div class="flex-1">
                        <h4 class="font-semibold text-lg text-gray-800 mb-1">${rec.title}</h4>
                        <p class="text-gray-600 text-sm mb-2">
                            <i class="fas ${rec.recommendation_type === 'property' ? 'fa-home' : 'fa-building'} mr-1"></i>
                            ${rec.recommendation_type === 'property' ? '–ö–≤–∞—Ä—Ç–∏—Ä–∞' : '–ñ–ö'}: ${rec.item_name}
                        </p>
                        <p class="text-gray-700 text-sm">
                            <i class="fas fa-user mr-1"></i>
                            –ö–ª–∏–µ–Ω—Ç: ${rec.client_name} (${rec.client_email})
                        </p>
                    </div>
                    <div class="flex flex-col items-end gap-1">
                        <span class="px-2 py-1 text-xs rounded-full ${statusClass}">
                            ${getStatusText(rec.status)}
                        </span>
                        <span class="px-2 py-1 text-xs rounded-full ${priorityClass}">
                            ${getPriorityText(rec.priority_level)}
                        </span>
                    </div>
                </div>
                
                ${rec.description ? `<p class="text-gray-600 mb-3">${rec.description}</p>` : ''}
                ${rec.manager_notes ? `<p class="text-sm text-gray-500 bg-gray-50 p-2 rounded mb-3"><strong>–í–∞—à–∏ –∑–∞–º–µ—Ç–∫–∏:</strong> ${rec.manager_notes}</p>` : ''}
                
                <div class="flex justify-between items-center text-sm text-gray-500">
                    <div>
                        <span>–û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ: ${createdAt}</span>
                        ${viewedAt ? ` ‚Ä¢ <span class="text-green-600">–ü—Ä–æ—Å–º–æ—Ç—Ä–µ–Ω–æ: ${viewedAt}</span>` : ''}
                    </div>
                    <div class="flex gap-2">
                        ${rec.recommendation_type === 'property' ? 
                            `<a href="/object/${rec.item_id}" target="_blank" class="text-[#0088cc] hover:underline">–ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å –æ–±—ä–µ–∫—Ç</a>` :
                            `<a href="/complex/${rec.item_id}" target="_blank" class="text-[#0088cc] hover:underline">–ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å –ñ–ö</a>`
                        }
                    </div>
                </div>
            </div>
        `;
    }).join('');
    
    container.innerHTML = html;
}

function getStatusClass(status) {
    const classes = {
        'sent': 'bg-gray-100 text-gray-700',
        'viewed': 'bg-gray-100 text-green-800', 
        'interested': 'bg-gray-100 text-purple-800',
        'not_interested': 'bg-gray-100 text-red-800',
        'scheduled_viewing': 'bg-gray-100 text-orange-800'
    };
    return classes[status] || 'bg-gray-100 text-gray-800';
}

function getPriorityClass(priority) {
    const classes = {
        'urgent': 'bg-gray-100 text-red-800',
        'high': 'bg-gray-100 text-orange-800',
        'normal': 'bg-gray-100 text-gray-800',
        'low': 'bg-gray-100 text-green-800'
    };
    return classes[priority] || 'bg-gray-100 text-gray-800';
}

function getStatusText(status) {
    const texts = {
        'sent': '–û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ',
        'viewed': '–ü—Ä–æ—Å–º–æ—Ç—Ä–µ–Ω–æ',
        'interested': '–ó–∞–∏–Ω—Ç–µ—Ä–µ—Å–æ–≤–∞–Ω—ã',
        'not_interested': '–ù–µ –∑–∞–∏–Ω—Ç–µ—Ä–µ—Å–æ–≤–∞–Ω—ã',
        'scheduled_viewing': '–ü—Ä–æ—Å–º–æ—Ç—Ä –Ω–∞–∑–Ω–∞—á–µ–Ω'
    };
    return texts[status] || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ';
}

function getPriorityText(priority) {
    const texts = {
        'urgent': '–°—Ä–æ—á–Ω–æ',
        'high': '–í—ã—Å–æ–∫–∏–π',
        'normal': '–û–±—ã—á–Ω—ã–π',
        'low': '–ù–∏–∑–∫–∏–π'
    };
    return texts[priority] || '–û–±—ã—á–Ω—ã–π';
}

// Adaptive welcome message function
window.loadWelcomeMessage = function() {
    console.log('üåü Loading adaptive welcome message...');
    fetch('/api/manager/welcome-message')
        .then(response => {
            console.log('üì° Welcome message response status:', response.status);
            return response.json();
        })
        .then(data => {
            console.log('üìä Welcome message data received:', data);
            if (data.success) {
                const container = document.getElementById('welcome-messages');
                const iconContainer = document.getElementById('welcome-icon');
                
                if (!container) {
                    console.error('‚ùå welcome-messages container not found');
                    return;
                }
                
                // Create messages HTML
                const messagesHtml = data.messages.map((message, index) => {
                    if (index === 0) {
                        // First message is the title
                        document.getElementById('welcome-title').textContent = message;
                        return '';
                    } else {
                        // Subsequent messages
                        const className = index === 1 ? 'text-lg text-gray-600' : 'text-base text-gray-500';
                        return `<p class="${className}">${message}</p>`;
                    }
                }).filter(html => html).join('');
                
                container.innerHTML = messagesHtml;
                
                // Update icon based on activity context
                if (data.context && iconContainer) {
                    const icon = iconContainer.querySelector('svg');
                    if (data.context.high_activity) {
                        // High activity - star icon
                        icon.innerHTML = '<path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"/>';
                        iconContainer.className = iconContainer.className.replace('from-[#0088CC] to-[#006699]', 'from-green-500 to-green-600');
                    } else if (data.context.needs_attention) {
                        // Needs attention - notification icon
                        icon.innerHTML = '<path d="M10 2a6 6 0 00-6 6v3.586l-.707.707A1 1 0 004 14h12a1 1 0 00.707-1.707L16 11.586V8a6 6 0 00-6-6zM10 18a3 3 0 01-3-3h6a3 3 0 01-3 3z"/>';
                        iconContainer.className = iconContainer.className.replace('from-[#0088CC] to-[#006699]', 'from-orange-500 to-orange-600');
                    } else if (data.context.new_day) {
                        // New day - sun icon
                        icon.innerHTML = '<path fill-rule="evenodd" d="M10 2a1 1 0 011 1v1a1 1 0 11-2 0V3a1 1 0 011-1zm4 8a4 4 0 11-8 0 4 4 0 018 0zm-.464 4.95l.707.707a1 1 0 001.414-1.414l-.707-.707a1 1 0 00-1.414 1.414zm2.12-10.607a1 1 0 010 1.414l-.706.707a1 1 0 11-1.414-1.414l.707-.707a1 1 0 011.414 0zM17 11a1 1 0 100-2h-1a1 1 0 100 2h1zm-7 4a1 1 0 011 1v1a1 1 0 11-2 0v-1a1 1 0 011-1zM5.05 6.464A1 1 0 106.465 5.05l-.708-.707a1 1 0 00-1.414 1.414l.707.707zm1.414 8.486l-.707.707a1 1 0 01-1.414-1.414l.707-.707a1 1 0 011.414 1.414zM4 11a1 1 0 100-2H3a1 1 0 000 2h1z" clip-rule="evenodd"/>';
                        iconContainer.className = iconContainer.className.replace('from-[#0088CC] to-[#006699]', 'from-yellow-500 to-yellow-600');
                    }
                }
                
                console.log('‚úÖ Welcome message loaded successfully');
            } else {
                console.error('‚ùå API returned error:', data.error);
            }
        })
        .catch(error => {
            console.error('üí• Error loading welcome message:', error);
        });
};

window.loadRecentRecommendations = function() {
    console.log('üîÑ Loading manager activity feed...');
    fetch('/api/manager/activity-feed')
        .then(response => {
            console.log('üì° Activity feed response status:', response.status);
            return response.json();
        })
        .then(data => {
            console.log('üìä Activity feed data received:', data);
            if (data.success) {
                const recentActivities = data.activities.slice(0, 5);
                const container = document.getElementById('recent-recommendations');
                
                if (!container) {
                    console.error('‚ùå recent-recommendations container not found');
                    return;
                }
                
                if (recentActivities.length === 0) {
                    container.innerHTML = '<div class="text-gray-500 text-sm">–ê–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ –ø–æ–∫–∞ –Ω–µ—Ç</div>';
                    return;
                }
                
                const html = recentActivities.map(activity => {
                    let iconClass = 'fas fa-info-circle text-blue-600';
                    let bgColor = 'bg-blue-50';
                    
                    if (activity.type === 'presentation_view') {
                        iconClass = 'fas fa-eye text-purple-600';
                        bgColor = 'bg-purple-50';
                    } else if (activity.type === 'recommendation') {
                        iconClass = 'fas fa-paper-plane text-blue-600';
                        bgColor = 'bg-blue-50';
                    }
                    
                    return `
                        <div class="flex items-start space-x-3 p-3 ${bgColor} rounded-lg">
                            <div class="flex-shrink-0 mt-0.5">
                                <i class="${iconClass}"></i>
                            </div>
                            <div class="flex-1 min-w-0">
                                <p class="font-medium text-sm text-gray-900">${activity.title}</p>
                                <p class="text-xs text-gray-600 mt-1">${activity.description}</p>
                                <span class="text-xs text-gray-500">${activity.time_ago}</span>
                            </div>
                        </div>
                    `;
                }).join('');
                
                container.innerHTML = html;
                console.log('‚úÖ Manager activity feed loaded successfully');
            } else {
                console.error('‚ùå API returned error:', data.error);
                const container = document.getElementById('recent-recommendations');
                if (container) {
                    container.innerHTML = '<div class="text-red-500 text-sm">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏</div>';
                }
            }
        })
        .catch(error => {
            console.error('üí• Error loading activity feed:', error);
            const container = document.getElementById('recent-recommendations');
            if (container) {
                container.innerHTML = '<div class="text-red-500 text-sm">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏</div>';
            }
        });
};

// Load recommendations function
function loadRecommendations() {
    // Get filter values
    const clientFilter = document.getElementById('rec-filter-client').value;
    const statusFilter = document.getElementById('rec-filter-status').value;
    const typeFilter = document.getElementById('rec-filter-type').value;
    const priorityFilter = document.getElementById('rec-filter-priority').value;
    
    // Build query params
    const params = new URLSearchParams();
    if (clientFilter) params.append('client_id', clientFilter);
    if (statusFilter) params.append('status', statusFilter);
    if (typeFilter) params.append('type', typeFilter);
    if (priorityFilter) params.append('priority', priorityFilter);
    
    const url = '/api/manager/recommendations' + (params.toString() ? '?' + params.toString() : '');
    
    fetch(url)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                const recommendations = data.recommendations;
                const stats = data.stats;
                
                // Update stats
                document.getElementById('recommendations-sent').textContent = stats.sent || 0;
                document.getElementById('recommendations-viewed').textContent = stats.viewed || 0;
                document.getElementById('recommendations-interested').textContent = stats.interested || 0;
                document.getElementById('recommendations-scheduled').textContent = stats.scheduled || 0;
                document.getElementById('sidebar-recommendations-count').textContent = stats.sent || 0;
                
                // Update recommendations list
                const container = document.getElementById('recommendations-container');
                if (recommendations.length === 0) {
                    container.innerHTML = `
                        <div class="text-center py-8 text-gray-500">
                            <i class="fas fa-paper-plane text-4xl mb-4"></i>
                            <p>–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</p>
                            <p class="text-sm mt-2">–û—Ç–ø—Ä–∞–≤—å—Ç–µ –ø–µ—Ä–≤—ã–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –∫–ª–∏–µ–Ω—Ç–∞–º —á–µ—Ä–µ–∑ —Å—Ç—Ä–∞–Ω–∏—Ü—É "–ù–µ–¥–≤–∏–∂–∏–º–æ—Å—Ç—å"</p>
                        </div>
                    `;
                    return;
                }
                
                const html = recommendations.map(rec => {
                    const statusClass = {
                        'sent': 'bg-gray-100 text-gray-700',
                        'viewed': 'bg-gray-100 text-green-800',
                        'interested': 'bg-gray-100 text-purple-800',
                        'not_interested': 'bg-gray-100 text-gray-800',
                        'scheduled_viewing': 'bg-gray-100 text-orange-800'
                    }[rec.status] || 'bg-gray-100 text-gray-800';
                    
                    const statusText = {
                        'sent': '–û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ',
                        'viewed': '–ü—Ä–æ—Å–º–æ—Ç—Ä–µ–Ω–æ',
                        'interested': '–ó–∞–∏–Ω—Ç–µ—Ä–µ—Å–æ–≤–∞–Ω—ã',
                        'not_interested': '–ù–µ –∑–∞–∏–Ω—Ç–µ—Ä–µ—Å–æ–≤–∞–Ω—ã',
                        'scheduled_viewing': '–ü—Ä–æ—Å–º–æ—Ç—Ä –Ω–∞–∑–Ω–∞—á–µ–Ω'
                    }[rec.status] || rec.status;
                    
                    return `
                        <div class="bg-white border border-gray-200 rounded-lg p-4 hover:shadow-md transition-shadow">
                            <div class="flex justify-between items-start mb-3">
                                <div class="flex-1">
                                    <h3 class="font-semibold text-gray-800 mb-1">${rec.title}</h3>
                                    <p class="text-sm text-gray-600">–¥–ª—è ${rec.client_name} (${rec.client_email})</p>
                                    <p class="text-xs text-gray-500 mt-1">${rec.item_name}</p>
                                </div>
                                <span class="px-2 py-1 text-xs rounded-full ${statusClass}">
                                    ${statusText}
                                </span>
                            </div>
                            
                            ${rec.description ? `<p class="text-sm text-gray-700 mb-3">${rec.description}</p>` : ''}
                            
                            <div class="flex justify-between items-center text-xs text-gray-500">
                                <span>–û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ: ${new Date(rec.sent_at).toLocaleDateString('ru-RU')}</span>
                                <div class="flex items-center gap-2">
                                    ${rec.viewed_at ? `<span>–ü—Ä–æ—Å–º–æ—Ç—Ä–µ–Ω–æ: ${new Date(rec.viewed_at).toLocaleDateString('ru-RU')}</span>` : ''}
                                    <button onclick="deleteRecommendation(${rec.id}, '${rec.title}')" 
                                            class="text-red-500 hover:text-red-700 p-1 rounded transition-colors" 
                                            title="–£–¥–∞–ª–∏—Ç—å —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—é">
                                        <i class="fas fa-trash text-xs"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    `;
                }).join('');
                
                container.innerHTML = html;
            }
        })
        .catch(error => {
            console.error('Error loading recommendations:', error);
            document.getElementById('recommendations-container').innerHTML = 
                '<div class="text-red-500 text-center py-8">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–π</div>';
        });
}

// Delete recommendation function
function deleteRecommendation(recommendationId, title) {
    if (!confirm(`–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—é "${title}"?`)) {
        return;
    }
    
    fetch(`/api/manager/recommendations/${recommendationId}`, {
        method: 'DELETE',
        headers: {
            'X-Requested-With': 'XMLHttpRequest'
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è —É—Å–ø–µ—à–Ω–æ —É–¥–∞–ª–µ–Ω–∞');
            loadRecommendations(); // Reload the list
        } else {
            alert(data.error || '–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏');
        }
    })
    .catch(error => {
        console.error('Error deleting recommendation:', error);
        alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏');
    });
}

// Load clients for filter
function loadClientsForFilter() {
    fetch('/api/manager/clients-list')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                const select = document.getElementById('rec-filter-client');
                select.innerHTML = '<option value="">–í—Å–µ –∫–ª–∏–µ–Ω—Ç—ã</option>' + 
                    data.clients.map(client => `<option value="${client.id}">${client.full_name}</option>`).join('');
            }
        })
        .catch(error => console.error('Error loading clients for filter:', error));
}

// Load collections function
function loadCollections() {
    console.log('Loading collections...');
    const container = document.getElementById('collections-grid');
    if (!container) return;
    
    container.innerHTML = '<div class="text-center py-8 col-span-full"><p class="text-gray-500">–ó–∞–≥—Ä—É–∑–∫–∞ –ø–æ–¥–±–æ—Ä–æ–∫...</p></div>';
    
    fetch('/api/manager/collections')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                const collections = data.collections || [];
                
                if (collections.length === 0) {
                    container.innerHTML = `
                        <div class="text-center py-8 col-span-full">
                            <i class="fas fa-folder-open text-4xl text-gray-400 mb-4"></i>
                            <p class="text-gray-500 mb-2">–£ –≤–∞—Å –ø–æ–∫–∞ –Ω–µ—Ç –ø–æ–¥–±–æ—Ä–æ–∫</p>
                            <button onclick="showSection('create-collection')" class="text-[#0088cc] hover:text-[#006699] font-medium">
                                –°–æ–∑–¥–∞—Ç—å –ø–µ—Ä–≤—É—é –ø–æ–¥–±–æ—Ä–∫—É
                            </button>
                        </div>
                    `;
                    return;
                }
                
                const html = collections.map(collection => `
                    <div class="bg-white border border-gray-200 rounded-lg p-4 hover:shadow-md transition-shadow">
                        <div class="flex justify-between items-start mb-3">
                            <h3 class="font-semibold text-gray-800">${collection.name}</h3>
                            <span class="px-2 py-1 text-xs rounded-full ${getStatusClass(collection.status)}">
                                ${collection.status}
                            </span>
                        </div>
                        <p class="text-sm text-gray-600 mb-2">–ö–ª–∏–µ–Ω—Ç: ${collection.client_name || '–ù–µ —É–∫–∞–∑–∞–Ω'}</p>
                        <p class="text-sm text-gray-500 mb-3">–û–±—ä–µ–∫—Ç–æ–≤: ${collection.properties_count || 0}</p>
                        <p class="text-xs text-gray-500">–°–æ–∑–¥–∞–Ω–æ: ${new Date(collection.created_at).toLocaleDateString('ru-RU')}</p>
                        <div class="mt-3 flex gap-2">
                            <button onclick="viewCollection(${collection.id})" class="text-[#0088cc] hover:text-[#006699] text-sm">
                                –ü—Ä–æ—Å–º–æ—Ç—Ä
                            </button>
                            <button onclick="editCollection(${collection.id})" class="text-gray-600 hover:text-gray-800 text-sm">
                                –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å
                            </button>
                        </div>
                    </div>
                `).join('');
                
                container.innerHTML = html;
            } else {
                container.innerHTML = '<div class="text-red-500 text-center py-8 col-span-full">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø–æ–¥–±–æ—Ä–æ–∫</div>';
            }
        })
        .catch(error => {
            console.error('Error loading collections:', error);
            container.innerHTML = '<div class="text-red-500 text-center py-8 col-span-full">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø–æ–¥–±–æ—Ä–æ–∫</div>';
        });
}

// Load applications function
function loadApplications() {
    console.log('Loading applications...');
    // For now, show a message that this section is under development
    const container = document.querySelector('#applications .overflow-x-auto table tbody');
    if (!container) {
        // If table body doesn't exist, find the applications section
        const appsSection = document.getElementById('applications');
        if (appsSection) {
            const tableContainer = appsSection.querySelector('.overflow-x-auto');
            if (tableContainer) {
                tableContainer.innerHTML = `
                    <div class="text-center py-8">
                        <i class="fas fa-file-alt text-4xl text-gray-400 mb-4"></i>
                        <p class="text-gray-500 mb-2">–ó–∞—è–≤–∫–∏ –Ω–∞ –∫–µ—à–±–µ–∫</p>
                        <p class="text-sm text-gray-400">–≠—Ç–∞ —Ñ—É–Ω–∫—Ü–∏—è –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –≤ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ</p>
                    </div>
                `;
            }
        }
        return;
    }
    
    // Show loading state
    container.innerHTML = `
        <tr>
            <td colspan="6" class="text-center py-8 text-gray-500">
                –ó–∞–≥—Ä—É–∑–∫–∞ –∑–∞—è–≤–æ–∫...
            </td>
        </tr>
    `;
    
    // For demo, show empty state after a delay
    setTimeout(() => {
        container.innerHTML = `
            <tr>
                <td colspan="6" class="text-center py-8 text-gray-500">
                    <i class="fas fa-file-alt text-2xl mb-2"></i>
                    <p>–ó–∞—è–≤–∫–∏ –Ω–∞ –∫–µ—à–±–µ–∫ –ø–æ–∫–∞ –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç</p>
                    <p class="text-sm mt-1">–ö–ª–∏–µ–Ω—Ç—ã —Å–º–æ–≥—É—Ç –ø–æ–¥–∞–≤–∞—Ç—å –∑–∞—è–≤–∫–∏ –ø–æ—Å–ª–µ –ø–æ–∫—É–ø–∫–∏ –Ω–µ–¥–≤–∏–∂–∏–º–æ—Å—Ç–∏</p>
                </td>
            </tr>
        `;
    }, 1000);
}

// Load deals function - –Ω–æ–≤–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è —Å–¥–µ–ª–æ–∫
function loadDeals() {
    console.log('ü§ù Loading deals...');
    
    const dealsSection = document.getElementById('deals');
    if (!dealsSection) {
        console.error('‚ùå Deals section not found');
        return;
    }
    
    // Show loading state
    dealsSection.innerHTML = `
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
            <div class="bg-white rounded-xl shadow-sm p-6">
                <div class="flex justify-between items-center mb-6">
                    <div>
                        <h2 class="text-2xl font-bold text-gray-800">ü§ù –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å–¥–µ–ª–∫–∞–º–∏</h2>
                        <p class="text-gray-600 mt-1">–û—Ç—Å–ª–µ–∂–∏–≤–∞–π—Ç–µ –∏ —É–ø—Ä–∞–≤–ª—è–π—Ç–µ —Å–¥–µ–ª–∫–∞–º–∏ —Å –∫–ª–∏–µ–Ω—Ç–∞–º–∏</p>
                    </div>
                    <button onclick="openCreateDealModal()" 
                            class="bg-[#0088CC] hover:bg-[#0077BB] text-white px-4 py-2 rounded-lg text-sm font-medium transition-colors">
                        <i class="fas fa-plus mr-2"></i>–ù–æ–≤–∞—è —Å–¥–µ–ª–∫–∞
                    </button>
                </div>
                
                <div class="text-center py-8">
                    <i class="fas fa-spinner fa-spin text-2xl text-gray-400 mb-4"></i>
                    <p class="text-gray-500">–ó–∞–≥—Ä—É–∑–∫–∞ —Å–¥–µ–ª–æ–∫...</p>
                </div>
            </div>
        </div>
    `;
    
    // Load deals from API
    fetch('/api/deals', {
        method: 'GET',
        headers: {
            'Content-Type': 'application/json'
        }
    })
    .then(response => response.json())
    .then(data => {
        console.log('üìä Deals data received:', data);
        
        // Update deals statistics counters
        updateStaticDealsStats(data);
        
        let dealsHtml = '';
        
        if (data.success && data.deals && data.deals.length > 0) {
            // Show deals table
            dealsHtml = `
                <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
                    <div class="bg-white rounded-xl shadow-sm p-6">
                        <div class="flex justify-between items-center mb-6">
                            <div>
                                <h2 class="text-2xl font-bold text-gray-800">ü§ù –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å–¥–µ–ª–∫–∞–º–∏</h2>
                                <p class="text-gray-600 mt-1">–ù–∞–π–¥–µ–Ω–æ —Å–¥–µ–ª–æ–∫: ${data.deals.length}</p>
                            </div>
                            <button onclick="openCreateDealModal()" 
                                    class="bg-[#0088CC] hover:bg-[#0077BB] text-white px-4 py-2 rounded-lg text-sm font-medium transition-colors">
                                <i class="fas fa-plus mr-2"></i>–ù–æ–≤–∞—è —Å–¥–µ–ª–∫–∞
                            </button>
                        </div>
                        
                        <div class="overflow-x-auto">
                            <table class="min-w-full divide-y divide-gray-200">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">–ö–ª–∏–µ–Ω—Ç</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">–ñ–ö</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">–°—É–º–º–∞</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">–ö–µ—à–±–µ–∫</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">–°—Ç–∞—Ç—É—Å</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">–î–∞—Ç–∞</th>
                                    </tr>
                                </thead>
                                <tbody class="bg-white divide-y divide-gray-200">
                                    ${data.deals.map(deal => {
                                        const statusColors = {
                                            'pending': 'bg-yellow-100 text-yellow-800',
                                            'approved': 'bg-green-100 text-green-800',
                                            'object_reserved': 'bg-blue-100 text-blue-800',
                                            'mortgage': 'bg-purple-100 text-purple-800',
                                            'successful': 'bg-green-100 text-green-800',
                                            'rejected': 'bg-red-100 text-red-800'
                                        };
                                        
                                        const statusText = {
                                            'pending': '–û–∂–∏–¥–∞–µ—Ç',
                                            'approved': '–û–¥–æ–±—Ä–µ–Ω–æ',
                                            'object_reserved': '–û–±—ä–µ–∫—Ç –∑–∞—Ä–µ–∑–µ—Ä–≤–∏—Ä–æ–≤–∞–Ω',
                                            'mortgage': '–ò–ø–æ—Ç–µ–∫–∞',
                                            'successful': '–£—Å–ø–µ—à–Ω–æ',
                                            'rejected': '–û—Ç–∫–ª–æ–Ω–µ–Ω–æ'
                                        };
                                        
                                        return `
                                            <tr class="hover:bg-gray-50">
                                                <td class="px-6 py-4 whitespace-nowrap">
                                                    <div class="text-sm font-medium text-gray-900">${deal.client_name || '–ù–µ —É–∫–∞–∑–∞–Ω'}</div>
                                                </td>
                                                <td class="px-6 py-4 whitespace-nowrap">
                                                    <div class="text-sm text-gray-900">${deal.complex_name || '–ù–µ —É–∫–∞–∑–∞–Ω'}</div>
                                                </td>
                                                <td class="px-6 py-4 whitespace-nowrap">
                                                    <div class="text-sm font-medium text-gray-900">${deal.property_price ? (parseFloat(deal.property_price).toLocaleString('ru-RU') + ' ‚ÇΩ') : '0 ‚ÇΩ'}</div>
                                                </td>
                                                <td class="px-6 py-4 whitespace-nowrap">
                                                    <div class="text-sm font-medium text-[#059669]">${deal.cashback_amount ? (parseFloat(deal.cashback_amount).toLocaleString('ru-RU') + ' ‚ÇΩ') : '0 ‚ÇΩ'}</div>
                                                </td>
                                                <td class="px-6 py-4 whitespace-nowrap">
                                                    <span class="inline-flex px-2 py-1 text-xs font-semibold rounded-full ${statusColors[deal.status] || 'bg-gray-100 text-gray-800'}">
                                                        ${statusText[deal.status] || deal.status}
                                                    </span>
                                                </td>
                                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                                                    ${new Date(deal.created_at).toLocaleDateString('ru-RU')}
                                                </td>
                                            </tr>
                                        `;
                                    }).join('')}
                                </tbody>
                            </table>
                        </div>
                        
                        <div class="mt-6 text-center">
                            <button onclick="openCreateDealModal()" 
                                    class="inline-flex items-center px-4 py-2 border border-[#0088CC] text-[#0088CC] hover:bg-[#0088CC] hover:text-white rounded-lg text-sm font-medium transition-colors">
                                <i class="fas fa-plus mr-2"></i>–°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—É—é —Å–¥–µ–ª–∫—É
                            </button>
                        </div>
                    </div>
                </div>
            `;
        } else {
            // Show empty state
            dealsHtml = `
                <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
                    <div class="bg-white rounded-xl shadow-sm p-6">
                        <div class="flex justify-between items-center mb-6">
                            <div>
                                <h2 class="text-2xl font-bold text-gray-800">ü§ù –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å–¥–µ–ª–∫–∞–º–∏</h2>
                                <p class="text-gray-600 mt-1">–°–∏—Å—Ç–µ–º–∞ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Å–¥–µ–ª–∫–∞–º–∏ —Å –∫–ª–∏–µ–Ω—Ç–∞–º–∏</p>
                            </div>
                        </div>
                        
                        <div class="text-center py-12">
                            <i class="fas fa-handshake text-4xl text-gray-400 mb-4"></i>
                            <h3 class="text-lg font-medium text-gray-900 mb-2">–°–¥–µ–ª–∫–∏ –ø–æ–∫–∞ –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç</h3>
                            <p class="text-gray-500 mb-6">–°–æ–∑–¥–∞–π—Ç–µ –ø–µ—Ä–≤—É—é —Å–¥–µ–ª–∫—É —Å –∫–ª–∏–µ–Ω—Ç–æ–º –¥–ª—è –Ω–∞—á–∞–ª–∞ —Ä–∞–±–æ—Ç—ã</p>
                            <button onclick="openCreateDealModal()" 
                                    class="inline-flex items-center px-6 py-3 bg-[#0088CC] hover:bg-[#0077BB] text-white rounded-lg font-medium transition-colors">
                                <i class="fas fa-plus mr-2"></i>–°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—É—é —Å–¥–µ–ª–∫—É
                            </button>
                        </div>
                    </div>
                </div>
            `;
        }
        
        dealsSection.innerHTML = dealsHtml;
        console.log('‚úÖ Deals loaded successfully');
    })
    .catch(error => {
        console.error('‚ùå Error loading deals:', error);
        dealsSection.innerHTML = `
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
                <div class="bg-white rounded-xl shadow-sm p-6">
                    <div class="flex justify-between items-center mb-6">
                        <div>
                            <h2 class="text-2xl font-bold text-gray-800">ü§ù –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å–¥–µ–ª–∫–∞–º–∏</h2>
                            <p class="text-red-600 mt-1">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö</p>
                        </div>
                        <button onclick="openCreateDealModal()" 
                                class="bg-[#0088CC] hover:bg-[#0077BB] text-white px-4 py-2 rounded-lg text-sm font-medium transition-colors">
                            <i class="fas fa-plus mr-2"></i>–ù–æ–≤–∞—è —Å–¥–µ–ª–∫–∞
                        </button>
                    </div>
                    
                    <div class="text-center py-12">
                        <i class="fas fa-exclamation-triangle text-4xl text-red-400 mb-4"></i>
                        <h3 class="text-lg font-medium text-gray-900 mb-2">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏</h3>
                        <p class="text-gray-500 mb-6">–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –æ —Å–¥–µ–ª–∫–∞—Ö</p>
                        <button onclick="loadDeals()" 
                                class="inline-flex items-center px-6 py-3 bg-gray-500 hover:bg-gray-600 text-white rounded-lg font-medium transition-colors">
                            <i class="fas fa-redo mr-2"></i>–ü–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å —Å–Ω–æ–≤–∞
                        </button>
                    </div>
                </div>
            </div>
        `;
    });
}

// Helper function for status classes
function getStatusClass(status) {
    const statusClasses = {
        '–ß–µ—Ä–Ω–æ–≤–∏–∫': 'bg-gray-100 text-gray-800',
        '–û—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞': 'bg-blue-100 text-blue-800',
        '–ü—Ä–æ—Å–º–æ—Ç—Ä–µ–Ω–∞': 'bg-green-100 text-green-800',
        '–ê—Ä—Ö–∏–≤': 'bg-red-100 text-red-800'
    };
    return statusClasses[status] || 'bg-gray-100 text-gray-800';
}

// Collection management functions
function viewCollection(collectionId) {
    // Redirect to collection view page
    window.location.href = `/manager/collection/${collectionId}`;
}

function editCollection(collectionId) {
    // For now, redirect to collection view
    viewCollection(collectionId);
}

// Ensure functions are available globally before initialization
window.showAddClientModal = function() {
    console.log('showAddClientModal called');
    const modal = document.getElementById('client-modal');
    if (modal) {
        modal.classList.remove('hidden');
    } else {
        console.error('Client modal not found');
    }
};

// Removed fallback functions - using main functions above

// Initialize on page load  
document.addEventListener('DOMContentLoaded', function() {
    console.log('Manager dashboard DOMContentLoaded - initializing...');
    
    // Setup initial view - only if no hash is present
    const hash = window.location.hash.replace('#', '');
    const initialSection = hash || 'dashboard';
    showSection(initialSection);
    
    // Load data with delay to ensure DOM is ready
    setTimeout(() => {
        console.log('üöÄ Starting OPTIMIZED dashboard load...');
        
        // ===== OPTIMIZED: Load all dashboard data with ONE API call =====
        if (typeof window.loadDashboardData === 'function') {
            window.loadDashboardData();
        } else {
            console.error('‚ùå loadDashboardData function not available - falling back to individual calls');
            // Fallback to individual calls if optimized function not available
            if (typeof window.loadClients === 'function') window.loadClients();
            if (typeof window.loadRecommendations === 'function') window.loadRecommendations();
            if (typeof window.loadRecentRecommendations === 'function') window.loadRecentRecommendations();
            if (typeof window.loadWelcomeMessage === 'function') window.loadWelcomeMessage();
        }
        
        // Load clients for filter dropdown (separate endpoint, not in aggregated call)
        if (typeof loadClientsForFilter === 'function') {
            loadClientsForFilter();
        }
    }, 500);
});

// Removed duplicate - now defined at top

// Presentation functions
function createPresentation() {
    const modal = document.createElement('div');
    modal.className = 'fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center';
    modal.innerHTML = `
        <div class="bg-white rounded-xl p-6 w-full max-w-md mx-4">
            <h3 class="text-xl font-bold text-gray-900 mb-4">–°–æ–∑–¥–∞—Ç—å –ø—Ä–µ–∑–µ–Ω—Ç–∞—Ü–∏—é</h3>
            <form id="presentation-form">
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-2">–ù–∞–∑–≤–∞–Ω–∏–µ –ø—Ä–µ–∑–µ–Ω—Ç–∞—Ü–∏–∏</label>
                    <input type="text" id="presentation-title" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-purple-500" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –ü–æ–¥–±–æ—Ä–∫–∞ –¥–ª—è —Å–µ–º—å–∏ –ò–≤–∞–Ω–æ–≤—ã—Ö" required>
                </div>
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-2">–ò–º—è –∫–ª–∏–µ–Ω—Ç–∞</label>
                    <input type="text" id="client-name" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-purple-500" placeholder="–ò–≤–∞–Ω –ü–µ—Ç—Ä–æ–≤">
                </div>
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-2">–¢–µ–ª–µ—Ñ–æ–Ω –∫–ª–∏–µ–Ω—Ç–∞</label>
                    <input type="tel" id="client-phone" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-purple-500" placeholder="+7 900 123 45 67">
                </div>
                <div class="mb-6">
                    <label class="block text-sm font-medium text-gray-700 mb-2">–û–ø–∏—Å–∞–Ω–∏–µ (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)</label>
                    <textarea id="presentation-description" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-purple-500" rows="3" placeholder="–ö—Ä–∞—Ç–∫–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ –ø—Ä–µ–∑–µ–Ω—Ç–∞—Ü–∏–∏"></textarea>
                </div>
                <div class="flex justify-end space-x-3">
                    <button type="button" onclick="closeModal()" class="px-4 py-2 text-gray-700 bg-gray-100 rounded-lg hover:bg-gray-200 transition-colors">–û—Ç–º–µ–Ω–∞</button>
                    <button type="submit" class="px-4 py-2 bg-gradient-to-r from-purple-500 to-purple-600 text-white rounded-lg hover:from-purple-600 hover:to-purple-700 transition-all">–°–æ–∑–¥–∞—Ç—å</button>
                </div>
            </form>
        </div>
    `;
    
    document.body.appendChild(modal);
    
    document.getElementById('presentation-form').addEventListener('submit', async function(e) {
        e.preventDefault();
        
        const title = document.getElementById('presentation-title').value;
        const clientName = document.getElementById('client-name').value;
        const clientPhone = document.getElementById('client-phone').value;
        const description = document.getElementById('presentation-description').value;
        
        try {
            const response = await fetch('/api/manager/presentation/create', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    title: title,
                    client_name: clientName,
                    client_phone: clientPhone,
                    description: description
                })
            });
            
            const data = await response.json();
            
            if (data.success) {
                closeModal();
                loadPresentations();
                showNotification('–ü—Ä–µ–∑–µ–Ω—Ç–∞—Ü–∏—è —Å–æ–∑–¥–∞–Ω–∞ —É—Å–ø–µ—à–Ω–æ!', 'success');
            } else {
                showNotification('–û—à–∏–±–∫–∞: ' + data.error, 'error');
            }
        } catch (error) {
            showNotification('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –ø—Ä–µ–∑–µ–Ω—Ç–∞—Ü–∏–∏', 'error');
        }
    });
}

function closeModal() {
    const modal = document.querySelector('.fixed.inset-0');
    if (modal) {
        modal.remove();
    }
}

// Show create presentation modal
function showCreatePresentationModal() {
    const modal = document.createElement('div');
    modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
    modal.setAttribute('data-modal', 'create-presentation');
    modal.innerHTML = `
        <div class="bg-white rounded-lg p-6 w-full max-w-md mx-4">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-semibold">–°–æ–∑–¥–∞—Ç—å –ø—Ä–µ–∑–µ–Ω—Ç–∞—Ü–∏—é</h3>
                <button onclick="closeCreatePresentationModal()" class="text-gray-500 hover:text-gray-700">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </button>
            </div>
            
            <form id="create-presentation-form">
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-2">–ù–∞–∑–≤–∞–Ω–∏–µ –ø—Ä–µ–∑–µ–Ω—Ç–∞—Ü–∏–∏</label>
                    <input type="text" id="presentation-title" required 
                           class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500"
                           placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –õ—É—á—à–∏–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è –¥–ª—è –ò–≤–∞–Ω–æ–≤–∞">
                </div>
                
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-2">–î–ª—è –∫–ª–∏–µ–Ω—Ç–∞ (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)</label>
                    <input type="text" id="presentation-client" 
                           class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500"
                           placeholder="–ò–º—è –∫–ª–∏–µ–Ω—Ç–∞">
                </div>
                
                <div class="mb-6">
                    <label class="block text-sm font-medium text-gray-700 mb-2">–û–ø–∏—Å–∞–Ω–∏–µ (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)</label>
                    <textarea id="presentation-description" rows="3"
                              class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500"
                              placeholder="–ö—Ä–∞—Ç–∫–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ –ø—Ä–µ–∑–µ–Ω—Ç–∞—Ü–∏–∏"></textarea>
                </div>
                
                <div class="flex justify-end space-x-3">
                    <button type="button" onclick="closeCreatePresentationModal()" 
                            class="px-4 py-2 text-gray-600 hover:text-gray-800 transition-colors">
                        –û—Ç–º–µ–Ω–∞
                    </button>
                    <button type="submit" 
                            class="px-4 py-2 bg-gradient-to-r from-purple-500 to-purple-600 hover:from-purple-600 hover:to-purple-700 text-white rounded-lg transition-colors">
                        –°–æ–∑–¥–∞—Ç—å
                    </button>
                </div>
            </form>
        </div>
    `;
    
    document.body.appendChild(modal);
    window.currentPresentationModal = modal;
    
    // Handle form submission
    document.getElementById('create-presentation-form').addEventListener('submit', async function(e) {
        e.preventDefault();
        
        const title = document.getElementById('presentation-title').value.trim();
        const client = document.getElementById('presentation-client').value.trim();
        const description = document.getElementById('presentation-description').value.trim();
        
        if (!title) {
            alert('–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –ø—Ä–µ–∑–µ–Ω—Ç–∞—Ü–∏–∏');
            return;
        }
        
        try {
            const response = await fetch('/api/manager/presentation/create', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': document.querySelector('meta[name=csrf-token]')?.getAttribute('content') || ''
                },
                body: JSON.stringify({
                    title: title,
                    client_name: client || null,
                    description: description || null
                })
            });
            
            const data = await response.json();
            
            if (data.success) {
                closeCreatePresentationModal();
                showNotification('–ü—Ä–µ–∑–µ–Ω—Ç–∞—Ü–∏—è —Å–æ–∑–¥–∞–Ω–∞ —É—Å–ø–µ—à–Ω–æ!', 'success');
                loadPresentations(); // Refresh the list
            } else {
                showNotification(`–û—à–∏–±–∫–∞: ${data.error}`, 'error');
            }
        } catch (error) {
            console.error('Error creating presentation:', error);
            showNotification('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –ø—Ä–µ–∑–µ–Ω—Ç–∞—Ü–∏–∏', 'error');
        }
    });
}

function closeCreatePresentationModal() {
    if (window.currentPresentationModal) {
        window.currentPresentationModal.remove();
        window.currentPresentationModal = null;
    }
}

function loadPresentations() {
    fetch('/api/manager/presentations', {
        method: 'GET',
        headers: {
            'Content-Type': 'application/json',
            'X-Requested-With': 'XMLHttpRequest'
        }
    })
        .then(response => {
            console.log('Response status:', response.status);
            return response.text();
        })
        .then(text => {
            console.log('Raw response:', text);
            // –ò–∑–≤–ª–µ–∫–∞–µ–º JSON –∏–∑ –æ—Ç–≤–µ—Ç–∞, –∏–≥–Ω–æ—Ä–∏—Ä—É—è HTML —Ä–µ–¥–∏—Ä–µ–∫—Ç
            const jsonStart = text.indexOf('{');
            if (jsonStart !== -1) {
                const jsonText = text.substring(jsonStart);
                const data = JSON.parse(jsonText);
                if (data.success) {
                    displayPresentations(data.presentations);
                } else {
                    console.error('Error loading presentations:', data.error);
                }
            } else {
                console.error('No JSON found in response:', text);
            }
        })
        .catch(error => {
            console.error('Error loading presentations:', error);
        });
}

function displayPresentations(presentations) {
    const container = document.getElementById('presentations-container');
    
    if (!container) return;
    
    if (presentations.length === 0) {
        // Clear container safely
        container.textContent = '';
        
        // Create empty state safely using DOM methods
        const emptyDiv = document.createElement('div');
        emptyDiv.className = 'text-center py-12 col-span-full';
        
        const svg = document.createElementNS('http://www.w3.org/2000/svg', 'svg');
        svg.setAttribute('class', 'mx-auto h-12 w-12 text-gray-400');
        svg.setAttribute('fill', 'none');
        svg.setAttribute('viewBox', '0 0 24 24');
        svg.setAttribute('stroke', 'currentColor');
        
        const path = document.createElementNS('http://www.w3.org/2000/svg', 'path');
        path.setAttribute('stroke-linecap', 'round');
        path.setAttribute('stroke-linejoin', 'round');
        path.setAttribute('stroke-width', '2');
        path.setAttribute('d', 'M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z');
        svg.appendChild(path);
        
        const title = document.createElement('h3');
        title.className = 'mt-2 text-sm font-medium text-gray-900';
        title.textContent = '–ù–µ—Ç –ø—Ä–µ–∑–µ–Ω—Ç–∞—Ü–∏–π';
        
        const subtitle = document.createElement('p');
        subtitle.className = 'mt-1 text-sm text-gray-500';
        subtitle.textContent = '–°–æ–∑–¥–∞–π—Ç–µ –ø–µ—Ä–≤—É—é –ø—Ä–µ–∑–µ–Ω—Ç–∞—Ü–∏—é –¥–ª—è –∫–ª–∏–µ–Ω—Ç–æ–≤';
        
        emptyDiv.appendChild(svg);
        emptyDiv.appendChild(title);
        emptyDiv.appendChild(subtitle);
        
        container.appendChild(emptyDiv);
        return;
    }
    
    // Clear container safely
    container.textContent = '';
    
    // Create presentations safely using DOM methods
    presentations.forEach(presentation => {
        const card = document.createElement('div');
        card.className = 'bg-white border border-gray-200 rounded-lg p-6 hover:shadow-md transition-shadow';
        
        // Header section
        const header = document.createElement('div');
        header.className = 'flex justify-between items-start mb-4';
        
        const headerLeft = document.createElement('div');
        
        const title = document.createElement('h4');
        title.className = 'text-lg font-semibold text-gray-900';
        title.textContent = presentation.title || '–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è';
        headerLeft.appendChild(title);
        
        if (presentation.client_name) {
            const clientInfo = document.createElement('p');
            clientInfo.className = 'text-sm text-gray-600';
            clientInfo.textContent = `–î–ª—è: ${presentation.client_name}`;
            headerLeft.appendChild(clientInfo);
        }
        
        if (presentation.description) {
            const desc = document.createElement('p');
            desc.className = 'text-sm text-gray-500 mt-1';
            desc.textContent = presentation.description;
            headerLeft.appendChild(desc);
        }
        
        const headerRight = document.createElement('div');
        headerRight.className = 'flex items-center space-x-2';
        
        const propertyBadge = document.createElement('span');
        propertyBadge.className = 'inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-purple-100 text-purple-800';
        propertyBadge.textContent = `${presentation.property_count || 0} –æ–±—ä–µ–∫—Ç–æ–≤`;
        
        const viewBadge = document.createElement('span');
        viewBadge.className = 'inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800';
        viewBadge.textContent = `${presentation.view_count || 0} –ø—Ä–æ—Å–º–æ—Ç—Ä–æ–≤`;
        
        headerRight.appendChild(propertyBadge);
        headerRight.appendChild(viewBadge);
        
        header.appendChild(headerLeft);
        header.appendChild(headerRight);
        
        // Date section
        const dateSection = document.createElement('div');
        dateSection.className = 'flex justify-between items-center text-sm text-gray-500 mb-4';
        
        const createdDate = document.createElement('span');
        createdDate.textContent = `–°–æ–∑–¥–∞–Ω–æ: ${new Date(presentation.created_at).toLocaleDateString('ru-RU')}`;
        dateSection.appendChild(createdDate);
        
        if (presentation.last_viewed_at) {
            const viewedDate = document.createElement('span');
            viewedDate.textContent = `–ü–æ—Å–ª–µ–¥–Ω–∏–π –ø—Ä–æ—Å–º–æ—Ç—Ä: ${new Date(presentation.last_viewed_at).toLocaleDateString('ru-RU')}`;
            dateSection.appendChild(viewedDate);
        }
        
        // Actions section
        const actions = document.createElement('div');
        actions.className = 'flex justify-end space-x-2';
        
        const shareBtn = document.createElement('button');
        shareBtn.className = 'flex items-center text-gray-600 hover:text-gray-700 text-xs font-medium bg-gray-100 hover:bg-gray-200 px-3 py-2 rounded-lg transition-colors';
        shareBtn.innerHTML = '<i class="fas fa-share mr-2"></i>–û—Ç–ø—Ä–∞–≤–∏—Ç—å';
        shareBtn.onclick = () => sharePresentation(presentation.id);
        
        const viewBtn = document.createElement('button');
        viewBtn.className = 'flex items-center text-gray-600 hover:text-gray-700 text-xs font-medium bg-gray-100 hover:bg-gray-200 px-3 py-2 rounded-lg transition-colors';
        viewBtn.innerHTML = '<i class="fas fa-eye mr-2"></i>–ü–æ–¥—Ä–æ–±–Ω–µ–µ';
        viewBtn.onclick = (event) => {
            event.stopPropagation(); // Prevent bubbling to parent elements
            showPresentationInDashboard(presentation.id);
        };
        
        actions.appendChild(shareBtn);
        actions.appendChild(viewBtn);
        
        card.appendChild(header);
        card.appendChild(dateSection);
        card.appendChild(actions);
        
        container.appendChild(card);
    });
}

function sharePresentation(presentationId) {
    console.log(`üöÄ Starting sharePresentation for ID: ${presentationId}`);
    
    fetch(`/api/manager/presentation/${presentationId}/share`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': document.querySelector('meta[name=csrf-token]')?.getAttribute('content') || ''
        },
        body: JSON.stringify({})
    })
    .then(response => {
        console.log(`üì° Response received:`, response);
        console.log(`üìä Response status: ${response.status}`);
        console.log(`üìù Response statusText: ${response.statusText}`);
        console.log(`üìã Response ok: ${response.ok}`);
        console.log(`üìÑ Response type: ${response.type}`);
        console.log(`üîó Response url: ${response.url}`);
        
        if (!response.ok) {
            console.error(`‚ùå Response not ok: ${response.status} ${response.statusText}`);
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        
        console.log(`‚úÖ Response ok, parsing JSON...`);
        return response.json();
    })
    .then(data => {
        console.log(`üì¶ JSON data received:`, data);
        
        if (data.success) {
            console.log(`‚úÖ Success! Share data:`, data.share_data);
            const shareData = data.share_data;
            
            // Create share modal
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center';
            modal.innerHTML = `
                <div class="bg-white rounded-xl p-6 w-full max-w-md mx-4">
                    <h3 class="text-xl font-bold text-gray-900 mb-4">–û—Ç–ø—Ä–∞–≤–∏—Ç—å –ø—Ä–µ–∑–µ–Ω—Ç–∞—Ü–∏—é</h3>
                    
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-2">–°—Å—ã–ª–∫–∞ –Ω–∞ –ø—Ä–µ–∑–µ–Ω—Ç–∞—Ü–∏—é</label>
                        <div class="flex">
                            <input type="text" id="presentation-url" value="${shareData.presentation_url}" class="flex-1 px-3 py-2 border border-gray-300 rounded-l-lg bg-gray-50" readonly>
                            <button onclick="copyToClipboard('presentation-url')" class="px-3 py-2 bg-blue-500 text-white rounded-r-lg hover:bg-blue-600">
                                <i class="fas fa-copy"></i>
                            </button>
                        </div>
                    </div>
                    
                    <div class="mb-6">
                        <label class="block text-sm font-medium text-gray-700 mb-2">–ì–æ—Ç–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ</label>
                        <textarea id="message-text" class="w-full px-3 py-2 border border-gray-300 rounded-lg bg-gray-50" rows="6" readonly>${shareData.message_text}</textarea>
                    </div>
                    
                    <div class="flex flex-col space-y-3">
                        <a href="${shareData.whatsapp_url}" target="_blank" class="flex items-center justify-center px-4 py-2 bg-green-500 text-white rounded-lg hover:bg-green-600 transition-colors">
                            <i class="fab fa-whatsapp mr-2"></i>–û—Ç–ø—Ä–∞–≤–∏—Ç—å –≤ WhatsApp
                        </a>
                        <a href="${shareData.telegram_url}" target="_blank" class="flex items-center justify-center px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition-colors">
                            <i class="fab fa-telegram mr-2"></i>–û—Ç–ø—Ä–∞–≤–∏—Ç—å –≤ Telegram
                        </a>
                        <button onclick="copyToClipboard('message-text')" class="flex items-center justify-center px-4 py-2 bg-gray-500 text-white rounded-lg hover:bg-gray-600 transition-colors">
                            <i class="fas fa-copy mr-2"></i>–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ
                        </button>
                    </div>
                    
                    <div class="mt-4 pt-4 border-t">
                        <button onclick="closeModal()" class="w-full px-4 py-2 text-gray-700 bg-gray-100 rounded-lg hover:bg-gray-200 transition-colors">–ó–∞–∫—Ä—ã—Ç—å</button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            console.log(`üéâ Modal added to DOM successfully!`);
        } else {
            console.error(`‚ùå API returned error:`, data.error);
            showNotification('–û—à–∏–±–∫–∞: ' + data.error, 'error');
        }
    })
    .catch(error => {
        console.error('‚ùå Error in sharePresentation:', error);
        console.error('üìç Error name:', error.name);
        console.error('üìù Error message:', error.message);
        console.error('üìö Error stack:', error.stack);
        
        if (error.message.includes('Authentication required') || error.message.includes('401')) {
            showNotification('–û—à–∏–±–∫–∞: –ù–µ–æ–±—Ö–æ–¥–∏–º–æ –≤–æ–π—Ç–∏ –≤ —Å–∏—Å—Ç–µ–º—É –∑–∞–Ω–æ–≤–æ', 'error');
            setTimeout(() => window.location.href = '/manager/login', 2000);
        } else {
            showNotification(`–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ —Å—Å—ã–ª–∫–∏: ${error.message}`, 'error');
        }
    });
}

// Show client selection modal
async function showClientSelectionModal(presentationId) {
    try {
        // Fetch manager's clients
        const response = await fetch('/api/manager/clients');
        const data = await response.json();
        
        if (!data.success || !data.clients || data.clients.length === 0) {
            showNotification('–£ –≤–∞—Å –Ω–µ—Ç –∑–∞–∫—Ä–µ–ø–ª–µ–Ω–Ω—ã—Ö –∫–ª–∏–µ–Ω—Ç–æ–≤', 'error');
            return;
        }
        
        // Create modal
        const modal = document.createElement('div');
        modal.id = 'client-selection-modal';
        modal.className = 'fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4';
        
        let clientsHTML = '';
        data.clients.forEach(client => {
            const searchText = `${client.full_name} ${client.email} ${client.phone || ''}`.toLowerCase();
            clientsHTML += `
                <div class="client-item border border-gray-200 rounded-lg p-4 hover:bg-gray-50 cursor-pointer transition-colors" 
                     data-search="${searchText}"
                     onclick="selectClient(${presentationId}, ${client.id}, '${client.full_name}')">
                    <div class="flex items-center justify-between">
                        <div>
                            <h4 class="font-semibold text-gray-900">${client.full_name}</h4>
                            <p class="text-sm text-gray-600">${client.email}</p>
                            ${client.phone ? `<p class="text-sm text-gray-500">${client.phone}</p>` : ''}
                        </div>
                        <i class="fas fa-chevron-right text-gray-400"></i>
                    </div>
                </div>
            `;
        });
        
        modal.innerHTML = `
            <div class="bg-white rounded-xl max-w-2xl w-full max-h-[80vh] flex flex-col" onclick="event.stopPropagation()">
                <div class="sticky top-0 bg-white border-b border-gray-200 p-6 flex-shrink-0">
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="text-xl font-bold text-gray-900">–í—ã–±–µ—Ä–∏—Ç–µ –∫–ª–∏–µ–Ω—Ç–∞</h3>
                        <button id="close-client-modal-btn" class="text-gray-400 hover:text-gray-600 transition-colors">
                            <i class="fas fa-times text-xl"></i>
                        </button>
                    </div>
                    <p class="text-sm text-gray-600 mb-4">–í—ã–±–µ—Ä–∏—Ç–µ –∫–ª–∏–µ–Ω—Ç–∞ –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ –ø—Ä–µ–∑–µ–Ω—Ç–∞—Ü–∏–∏ –≤ –µ–≥–æ –ª–∏—á–Ω—ã–π –∫–∞–±–∏–Ω–µ—Ç</p>
                    
                    <!-- Search Input -->
                    <div class="relative">
                        <i class="fas fa-search absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400"></i>
                        <input type="text" 
                               id="client-search-input" 
                               placeholder="–ü–æ–∏—Å–∫ –ø–æ –∏–º–µ–Ω–∏, email –∏–ª–∏ —Ç–µ–ª–µ—Ñ–æ–Ω—É..." 
                               class="w-full pl-10 pr-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[#0088CC] focus:border-[#0088CC] outline-none">
                    </div>
                    <div id="client-count" class="text-sm text-gray-500 mt-2">
                        –ö–ª–∏–µ–Ω—Ç–æ–≤: ${data.clients.length}
                    </div>
                </div>
                
                <div id="clients-list" class="p-6 space-y-3 overflow-y-auto flex-1">
                    ${clientsHTML}
                </div>
                
                <div id="no-results" class="hidden p-6 text-center text-gray-500">
                    <i class="fas fa-search text-4xl mb-3 text-gray-300"></i>
                    <p class="text-lg">–ö–ª–∏–µ–Ω—Ç—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</p>
                    <p class="text-sm">–ü–æ–ø—Ä–æ–±—É–π—Ç–µ –∏–∑–º–µ–Ω–∏—Ç—å –ø–æ–∏—Å–∫–æ–≤—ã–π –∑–∞–ø—Ä–æ—Å</p>
                </div>
            </div>
        `;
        
        document.body.appendChild(modal);
        
        // Add click handlers after modal is in DOM
        document.getElementById('close-client-modal-btn').addEventListener('click', closeClientSelectionModal);
        modal.addEventListener('click', closeClientSelectionModal); // Click on backdrop closes modal
        
        // Add search functionality
        const searchInput = document.getElementById('client-search-input');
        const clientsList = document.getElementById('clients-list');
        const noResults = document.getElementById('no-results');
        const clientCount = document.getElementById('client-count');
        const totalClients = data.clients.length;
        
        searchInput.addEventListener('input', function(e) {
            const searchTerm = e.target.value.toLowerCase().trim();
            const clientItems = clientsList.querySelectorAll('.client-item');
            let visibleCount = 0;
            
            clientItems.forEach(item => {
                const searchText = item.getAttribute('data-search');
                if (searchText.includes(searchTerm)) {
                    item.style.display = '';
                    visibleCount++;
                } else {
                    item.style.display = 'none';
                }
            });
            
            // Update count and show/hide no results message
            if (visibleCount === 0) {
                clientsList.classList.add('hidden');
                noResults.classList.remove('hidden');
                clientCount.textContent = '–ö–ª–∏–µ–Ω—Ç–æ–≤ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ';
            } else {
                clientsList.classList.remove('hidden');
                noResults.classList.add('hidden');
                clientCount.textContent = `–ü–æ–∫–∞–∑–∞–Ω–æ: ${visibleCount} –∏–∑ ${totalClients}`;
            }
        });
        
        // Auto-focus search input
        setTimeout(() => searchInput.focus(), 100);
        
    } catch (error) {
        console.error('Error loading clients:', error);
        showNotification('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–ø–∏—Å–∫–∞ –∫–ª–∏–µ–Ω—Ç–æ–≤', 'error');
    }
}

function closeClientSelectionModal() {
    const modal = document.getElementById('client-selection-modal');
    if (modal) {
        modal.remove();
    }
}

async function selectClient(presentationId, clientId, clientName) {
    closeClientSelectionModal();
    
    if (!confirm(`–û—Ç–ø—Ä–∞–≤–∏—Ç—å –ø—Ä–µ–∑–µ–Ω—Ç–∞—Ü–∏—é –∫–ª–∏–µ–Ω—Ç—É ${clientName}? –ö–ª–∏–µ–Ω—Ç –ø–æ–ª—É—á–∏—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –≤ –ª–∏—á–Ω–æ–º –∫–∞–±–∏–Ω–µ—Ç–µ.`)) {
        return;
    }
    
    try {
        const csrfToken = document.querySelector('meta[name="csrf-token"]')?.content || '';
        
        // First, assign client to presentation
        const assignResponse = await fetch(`/api/manager/collection/${presentationId}/assign-client`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrfToken
            },
            body: JSON.stringify({ client_id: clientId })
        });
        
        const assignData = await assignResponse.json();
        
        if (!assignData.success) {
            showNotification(assignData.error || '–û—à–∏–±–∫–∞ –ø—Ä–∏ –Ω–∞–∑–Ω–∞—á–µ–Ω–∏–∏ –∫–ª–∏–µ–Ω—Ç–∞', 'error');
            return;
        }
        
        // Then send to client dashboard
        const sendResponse = await fetch(`/api/manager/collection/${presentationId}/send-to-client`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrfToken
            }
        });
        
        const sendData = await sendResponse.json();
        
        if (sendData.success) {
            showNotification('–ü—Ä–µ–∑–µ–Ω—Ç–∞—Ü–∏—è —É—Å–ø–µ—à–Ω–æ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞ –∫–ª–∏–µ–Ω—Ç—É!', 'success');
            setTimeout(() => location.reload(), 1500);
        } else {
            showNotification(sendData.error || '–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ –ø—Ä–µ–∑–µ–Ω—Ç–∞—Ü–∏–∏', 'error');
        }
    } catch (error) {
        console.error('Error sending presentation to client:', error);
        showNotification('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ –ø—Ä–µ–∑–µ–Ω—Ç–∞—Ü–∏–∏', 'error');
    }
}

function copyToClipboard(elementId) {
    const element = document.getElementById(elementId);
    element.select();
    document.execCommand('copy');
    showNotification('–°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ –≤ –±—É—Ñ–µ—Ä –æ–±–º–µ–Ω–∞', 'success');
}

function viewPresentation(uniqueUrl) {
    window.open(`/presentation/modern/${uniqueUrl}`, '_blank');
}

function showNotification(message, type = 'info') {
    const notification = document.createElement('div');
    notification.className = `fixed top-4 right-4 p-4 rounded-lg text-white z-50 ${
        type === 'success' ? 'bg-green-500' : 
        type === 'error' ? 'bg-red-500' : 
        'bg-blue-500'
    }`;
    notification.textContent = message;
    
    document.body.appendChild(notification);
    
    setTimeout(() => {
        notification.remove();
    }, 3000);
// Enhanced notification with action button
function showNotificationWithAction(message, type = 'info', actionText = null, actionCallback = null) {
    const notification = document.createElement('div');
    notification.className = `fixed top-4 right-4 p-4 rounded-lg text-white z-50 shadow-lg ${
        type === 'success' ? 'bg-green-500' : 
        type === 'error' ? 'bg-red-500' : 
        type === 'warning' ? 'bg-yellow-500' :
        'bg-blue-500'
    }`;
    
    const messageDiv = document.createElement('div');
    messageDiv.className = 'flex items-center gap-3';
    
    // Icon
    const icon = document.createElement('span');
    icon.className = 'text-2xl';
    icon.textContent = type === 'error' ? '‚ö†Ô∏è' : type === 'warning' ? '‚è±Ô∏è' : '‚úì';
    messageDiv.appendChild(icon);
    
    // Message text
    const textDiv = document.createElement('div');
    textDiv.className = 'flex-1';
    textDiv.textContent = message;
    messageDiv.appendChild(textDiv);
    
    notification.appendChild(messageDiv);
    
    // Add action button if provided
    if (actionText && actionCallback) {
        const buttonDiv = document.createElement('div');
        buttonDiv.className = 'mt-3 flex gap-2';
        
        const actionButton = document.createElement('button');
        actionButton.className = 'px-4 py-2 bg-white text-gray-900 rounded hover:bg-gray-100 font-semibold';
        actionButton.textContent = actionText;
        actionButton.onclick = () => {
            actionCallback();
            notification.remove();
        };
        
        const dismissButton = document.createElement('button');
        dismissButton.className = 'px-4 py-2 bg-transparent border border-white rounded hover:bg-white hover:bg-opacity-20';
        dismissButton.textContent = '–ó–∞–∫—Ä—ã—Ç—å';
        dismissButton.onclick = () => notification.remove();
        
        buttonDiv.appendChild(actionButton);
        buttonDiv.appendChild(dismissButton);
        notification.appendChild(buttonDiv);
    }
    
    document.body.appendChild(notification);
    
    // Auto-remove after 8 seconds if no action
    if (!actionText) {
        setTimeout(() => {
            if (notification.parentNode) {
                notification.remove();
            }
        }, 3000);
    }
    
    return notification;
}

// Global authentication error handler
function handleAuthError(response) {
    console.log('üîí handleAuthError called with status:', response.status);
    
    if (response.status === 401 || response.status === 403) {
        console.log('‚ùå Authentication failed - showing notification');
        
        // Show notification with login button
        showNotificationWithAction(
            '–í–∞—à–∞ —Å–µ—Å—Å–∏—è –∏—Å—Ç–µ–∫–ª–∞. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–æ–π–¥–∏—Ç–µ —Å–Ω–æ–≤–∞.',
            'warning',
            '–í–æ–π—Ç–∏',
            () => {
                window.location.href = '/manager/login';
            }
        );
        
        // Auto-redirect after 5 seconds
        setTimeout(() => {
            window.location.href = '/manager/login';
        }, 5000);
        
        return true; // Error handled
    }
    
    return false; // Not an auth error
}

// Enhanced fetch wrapper with auth error handling
async function fetchWithAuth(url, options = {}) {
    try {
        console.log(`üåê fetchWithAuth: ${options.method || 'GET'} ${url}`);
        const response = await fetch(url, options);
        
        // Check for auth errors
        if (handleAuthError(response)) {
            throw new Error('Authentication required');
        }
        
        return response;
    } catch (error) {
        console.error('‚ùå fetchWithAuth error:', error);
        throw error;
    }
}
}

// Presentation viewer functions
function showPresentationInDashboard(presentationId) {
    console.log('üéØ NEW DEBUG v2.0 - Showing presentation in dashboard:', presentationId);
    
    // Hide list view
    const listView = document.getElementById('presentations-list-view');
    const viewerView = document.getElementById('presentation-viewer');
    
    console.log('üîç DOM elements check:', {
        listView: listView ? 'found' : 'NOT FOUND',
        viewerView: viewerView ? 'found' : 'NOT FOUND'
    });
    
    if (listView && viewerView) {
        console.log('‚úÖ Both elements found, hiding list and showing viewer');
        listView.style.display = 'none';
        viewerView.classList.remove('hidden');
        
        console.log('üìû About to call loadPresentationContent with ID:', presentationId);
        
        // Check if function exists
        if (typeof loadPresentationContent !== 'function') {
            console.error('‚ùå loadPresentationContent is not a function!');
            return;
        }
        
        console.log('‚úÖ loadPresentationContent function exists, calling it...');
        
        // Load presentation content
        try {
            loadPresentationContent(presentationId);
            console.log('üìû loadPresentationContent call completed successfully');
        } catch (error) {
            console.error('‚ùå Error calling loadPresentationContent:', error);
        }
    } else {
        console.error('‚ùå Required DOM elements not found!');
    }
}

function showPresentationsList() {
    console.log('üîô Returning to presentations list');
    
    // Show list view, hide viewer
    const listView = document.getElementById('presentations-list-view');
    const viewerView = document.getElementById('presentation-viewer');
    
    if (listView && viewerView) {
        listView.style.display = 'block';
        viewerView.classList.add('hidden');
        
        // Clear viewer content
        const content = document.getElementById('presentation-content');
        if (content) {
            content.innerHTML = '<div class="text-center py-8"><p class="text-gray-500">–ó–∞–≥—Ä—É–∑–∫–∞ –ø—Ä–µ–∑–µ–Ω—Ç–∞—Ü–∏–∏...</p></div>';
        }
    }
}

function loadPresentationContent(presentationId) {
    console.log('üì• Loading presentation content:', presentationId);
    
    const contentContainer = document.getElementById('presentation-content');
    const actionsContainer = document.getElementById('presentation-viewer-actions');
    
    if (!contentContainer) {
        console.error('‚ùå Presentation content container not found');
        return;
    }
    
    // Show loading
    contentContainer.innerHTML = '<div class="text-center py-8"><p class="text-gray-500">–ó–∞–≥—Ä—É–∑–∫–∞ –ø—Ä–µ–∑–µ–Ω—Ç–∞—Ü–∏–∏...</p></div>';
    
    // Fetch presentation data from the new JSON API
    fetch(`/api/manager/presentation/${presentationId}`)
        .then(response => response.json())
        .then(data => {
            console.log('üéØ API response data:', data);
            if (data.success) {
                const presentation = data.presentation;
                console.log('‚úÖ Presentation data:', presentation);
                console.log('üè† Properties count:', presentation.properties ? presentation.properties.length : 'no properties');
                
                // Generate presentation content in dashboard style
                const generatedHTML = generatePresentationHTML(presentation);
                console.log('üèóÔ∏è Generated HTML length:', generatedHTML.length);
                console.log('üìù Generated HTML preview:', generatedHTML.substring(0, 200));
                
                contentContainer.innerHTML = generatedHTML;
        console.log('üìã Content container after update:', contentContainer);
        console.log('üìã Container visible:', contentContainer.style.display);
        console.log('üìã Container HTML length:', contentContainer.innerHTML.length);
        
        // Force visibility
        contentContainer.style.display = 'block';
        contentContainer.style.visibility = 'visible';
        contentContainer.style.opacity = '1';
                
                // Add actions buttons
                if (actionsContainer) {
                    let buttonsHTML = `
                        <button onclick="sharePresentation('${presentationId}')" 
                                class="bg-gray-600 hover:bg-gray-700 text-white px-4 py-2 rounded-lg flex items-center">
                            <i class="fas fa-share mr-2"></i>–ü–æ–¥–µ–ª–∏—Ç—å—Å—è
                        </button>
                        <button onclick="showClientSelectionModal('${presentationId}')" 
                                class="bg-gradient-to-r from-green-600 to-green-700 hover:from-green-700 hover:to-green-800 text-white px-4 py-2 rounded-lg flex items-center">
                            <i class="fas fa-paper-plane mr-2"></i>–û—Ç–ø—Ä–∞–≤–∏—Ç—å –∫–ª–∏–µ–Ω—Ç—É –≤ –õ–ö
                        </button>
                        <button onclick="downloadAllPresentation('${presentationId}', '${presentation.title}')" 
                                class="bg-gray-600 hover:bg-gray-700 text-white px-4 py-2 rounded-lg flex items-center">
                            <i class="fas fa-download mr-2"></i>–°–∫–∞—á–∞—Ç—å –≤—Å–µ
                        </button>
                        <button onclick="sharePresentation('${presentationId}')" 
                                class="bg-gray-600 hover:bg-gray-700 text-white px-4 py-2 rounded-lg flex items-center">
                            <i class="fas fa-link mr-2"></i>–°—Å—ã–ª–∫–∞
                        </button>
                    `;
                    
                    actionsContainer.innerHTML = buttonsHTML;
                }
                
                console.log('‚úÖ Presentation loaded successfully in dashboard style');
                
            } else {
                contentContainer.innerHTML = `<div class="text-center py-8"><p class="text-red-500">–û—à–∏–±–∫–∞: ${data.error}</p></div>`;
            }
        })
        .catch(error => {
            console.error('‚ùå Error loading presentation:', error);
            contentContainer.innerHTML = '<div class="text-center py-8"><p class="text-red-500">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø—Ä–µ–∑–µ–Ω—Ç–∞—Ü–∏–∏</p></div>';
        });
}

// Function to count unique residential complexes in properties
function getUniqueComplexesCount(properties) {
    if (!properties || !Array.isArray(properties)) return 0;
    
    const uniqueComplexes = new Set();
    properties.forEach(property => {
        if (property.residential_complex || property.complex_name) {
            uniqueComplexes.add(property.residential_complex || property.complex_name);
        }
    });
    
    return uniqueComplexes.size;
}

function generatePresentationHTML(presentation) {
    // Generate presentation header
    let html = `
        <div class="mb-8">
            <div class="bg-gray-50 rounded-xl p-6">
                <h1 class="text-3xl font-bold text-gray-900 mb-2">${presentation.title || '–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è'}</h1>
                ${presentation.description ? `<p class="text-lg text-gray-600 mb-4">${presentation.description}</p>` : ''}
                
                <div class="grid grid-cols-2 md:grid-cols-4 gap-4 text-center">
                    <div class="bg-white rounded-lg p-4 shadow-sm">
                        <div class="text-2xl font-bold text-gray-600">${presentation.properties_count}</div>
                        <div class="text-sm text-gray-600">–û–±—ä–µ–∫—Ç–æ–≤</div>
                    </div>
                    <div class="bg-white rounded-lg p-4 shadow-sm">
                        <div class="text-2xl font-bold text-gray-600">${presentation.view_count || 0}</div>
                        <div class="text-sm text-gray-600">–ü—Ä–æ—Å–º–æ—Ç—Ä–æ–≤</div>
                    </div>
                    <div class="bg-white rounded-lg p-4 shadow-sm">
                        <div class="text-2xl font-bold text-gray-600">${presentation.client_name || '–ù–µ —É–∫–∞–∑–∞–Ω'}</div>
                        <div class="text-sm text-gray-600">–ö–ª–∏–µ–Ω—Ç</div>
                    </div>
                    <div class="bg-white rounded-lg p-4 shadow-sm">
                        <div class="text-2xl font-bold text-gray-600">
                            ${getUniqueComplexesCount(presentation.properties || [])}
                        </div>
                        <div class="text-sm text-gray-600">–ñ–ö</div>
                    </div>
                </div>
            </div>
        </div>
    `;
    
    // Generate properties grid
    if (presentation.properties && presentation.properties.length > 0) {
        html += `
            <div class="mb-6">
                <h2 class="text-xl font-semibold text-gray-900 mb-4">–û–±—ä–µ–∫—Ç—ã –Ω–µ–¥–≤–∏–∂–∏–º–æ—Å—Ç–∏</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
        `;
        
        presentation.properties.forEach(property => {
            html += generatePropertyCard(property, presentation.id);
        });
        
        html += `
                </div>
            </div>
        `;
    } else {
        html += `
            <div class="text-center py-12">
                <div class="text-gray-400 mb-4">
                    <i class="fas fa-home text-6xl"></i>
                </div>
                <h3 class="text-lg font-medium text-gray-900 mb-2">–ù–µ—Ç –æ–±—ä–µ–∫—Ç–æ–≤</h3>
                <p class="text-gray-500">–í —ç—Ç–æ–π –ø—Ä–µ–∑–µ–Ω—Ç–∞—Ü–∏–∏ –ø–æ–∫–∞ –Ω–µ—Ç –¥–æ–±–∞–≤–ª–µ–Ω–Ω—ã—Ö –æ–±—ä–µ–∫—Ç–æ–≤</p>
            </div>
        `;
    }
    
    return html;
}

function generatePropertyCard(property, presentationId) {
    const formatPrice = (price) => {
        return price ? price.toLocaleString('ru-RU') + ' ‚ÇΩ' : '–¶–µ–Ω–∞ –Ω–µ —É–∫–∞–∑–∞–Ω–∞';
    };
    
    const formatArea = (area) => {
        return area ? area + ' –º¬≤' : '–ù–µ —É–∫–∞–∑–∞–Ω–∞';
    };
    
    const formatRooms = (rooms) => {
        if (rooms === 0) return '–°—Ç—É–¥–∏—è';
        return rooms ? rooms + '-–∫–æ–º–Ω.' : '–ù–µ —É–∫–∞–∑–∞–Ω–æ';
    };
    
    return `
        <div class="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden hover:shadow-md transition-shadow">
            <!-- Property Image -->
            <div class="relative h-48">
                <img src="${property.main_image || '/static/images/no-photo.jpg'}" 
                     alt="${property.title || '–û–±—ä–µ–∫—Ç –Ω–µ–¥–≤–∏–∂–∏–º–æ—Å—Ç–∏'}"
                     class="w-full h-full object-cover">
                
                <!-- Badges -->
                <div class="absolute top-3 left-3">
                    ${property.rooms === 0 ? 
                        '<span class="bg-blue-600 text-white px-2 py-1 rounded text-xs font-medium">–°—Ç—É–¥–∏—è</span>' :
                        `<span class="bg-blue-600 text-white px-2 py-1 rounded text-xs font-medium">${property.rooms}-–∫–æ–º–Ω.</span>`
                    }
                </div>
                ${property.cashback && property.cashback > 0 ? `
                <div class="absolute top-3 right-3">
                    <span class="inline-flex items-center px-2.5 py-1 rounded-full text-xs font-medium bg-green-600 text-white shadow-sm">
                        <i class="fas fa-coins mr-1"></i>–ö—ç—à–±—ç–∫ ${property.cashback.toLocaleString('ru-RU')} ‚ÇΩ
                    </span>
                </div>` : ''}
                
                <!-- Manager Note -->
                ${property.manager_note ? 
                    `<div class="absolute bottom-3 left-3 right-3">
                        <div class="bg-white bg-opacity-90 backdrop-blur-sm rounded-lg p-2">
                            <p class="text-xs text-gray-700"><i class="fas fa-sticky-note mr-1"></i>${property.manager_note}</p>
                        </div>
                    </div>` : ''
                }
            </div>
            
            <!-- Property Info -->
            <div class="p-4">
                <h3 class="font-semibold text-gray-900 text-lg mb-2">${property.title || '–û–±—ä–µ–∫—Ç –Ω–µ–¥–≤–∏–∂–∏–º–æ—Å—Ç–∏'}</h3>
                
                <!-- Complex and Address -->
                <div class="text-sm text-gray-600 mb-3">
                    <div class="flex items-center mb-1">
                        <i class="fas fa-building mr-2 text-gray-400"></i>
                        <span>${property.complex_name || '–ñ–ö –Ω–µ —É–∫–∞–∑–∞–Ω'}</span>
                    </div>
                    ${property.address ? 
                        `<div class="flex items-center">
                            <i class="fas fa-map-marker-alt mr-2 text-gray-400"></i>
                            <span>${property.address}</span>
                        </div>` : ''
                    }
                </div>
                
                <!-- Key Info Grid -->
                <div class="grid grid-cols-2 gap-3 mb-4">
                    <div class="text-center bg-gray-50 rounded-lg p-2">
                        <div class="text-lg font-semibold text-gray-900">${formatPrice(property.price)}</div>
                        <div class="text-xs text-gray-500">–¶–µ–Ω–∞</div>
                    </div>
                    <div class="text-center bg-gray-50 rounded-lg p-2">
                        <div class="text-lg font-semibold text-gray-900">${formatArea(property.area)}</div>
                        <div class="text-xs text-gray-500">–ü–ª–æ—â–∞–¥—å</div>
                    </div>
                </div>
                
                <!-- Additional Info -->
                <div class="grid grid-cols-3 gap-2 text-xs text-gray-600 mb-4">
                    <div class="text-center">
                        <div class="font-medium">${property.floor}/${property.total_floors}</div>
                        <div>–≠—Ç–∞–∂</div>
                    </div>
                    <div class="text-center">
                        <div class="font-medium">${property.developer || '–ù–µ —É–∫–∞–∑–∞–Ω'}</div>
                        <div>–ó–∞—Å—Ç—Ä–æ–π—â–∏–∫</div>
                    </div>
                    <div class="text-center">
                        <div class="font-medium">${property.housing_class || '–ö–æ–º—Ñ–æ—Ä—Ç'}</div>
                        <div>–ö–ª–∞—Å—Å –∂–∏–ª—å—è</div>
                    </div>
                </div>
                
                <!-- Actions -->
                <div class="pt-3 border-t border-gray-100">
                    <!-- Compact Icon Actions Row -->
                    <div class="flex justify-center space-x-3 mb-3">
                        <button onclick="viewPropertyDetails('${property.id}')" 
                                class="w-8 h-8 flex items-center justify-center text-gray-500 hover:text-gray-700 hover:bg-gray-100 rounded transition-colors"
                                title="–ü–æ–¥—Ä–æ–±–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è">
                            <i class="fas fa-eye text-sm"></i>
                        </button>
                        <button onclick="printProperty('${presentationId}', '${property.id}')" 
                                class="w-8 h-8 flex items-center justify-center text-gray-500 hover:text-gray-700 hover:bg-gray-100 rounded transition-colors"
                                title="–†–∞—Å–ø–µ—á–∞—Ç–∞—Ç—å">
                            <i class="fas fa-print text-sm"></i>
                        </button>
                        <button onclick="downloadPropertyPDF('${presentationId}', '${property.id}')" 
                                class="w-8 h-8 flex items-center justify-center text-gray-500 hover:text-gray-700 hover:bg-gray-100 rounded transition-colors"
                                title="–°–∫–∞—á–∞—Ç—å PDF">
                            <i class="fas fa-download text-sm"></i>
                        </button>
                        <button onclick="sharePropertyLink('${presentationId}', '${property.id}')" 
                                class="w-8 h-8 flex items-center justify-center text-gray-500 hover:text-gray-700 hover:bg-gray-100 rounded transition-colors"
                                title="–ü–æ–¥–µ–ª–∏—Ç—å—Å—è">
                            <i class="fas fa-share text-sm"></i>
                        </button>
                        <button onclick="removePropertyFromPresentation('${presentationId}', '${property.property_id}')" 
                                class="w-8 h-8 flex items-center justify-center text-gray-500 hover:text-gray-700 hover:bg-gray-100 rounded transition-colors"
                                title="–£–¥–∞–ª–∏—Ç—å –∏–∑ –ø—Ä–µ–∑–µ–Ω—Ç–∞—Ü–∏–∏">
                            <i class="fas fa-trash text-sm"></i>
                        </button>
                    </div>
                    
                    <!-- Add Comment Button -->
                    <div class="pt-2 border-t border-gray-100">
                        <button onclick="addPropertyComment('${presentationId}', '${property.id}')" 
                                class="w-full text-gray-600 hover:text-gray-800 text-sm py-1 hover:bg-gray-50 rounded transition-colors">
                            –î–æ–±–∞–≤–∏—Ç—å –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π
                        </button>
                    </div>
                </div>
            </div>
        </div>
    `;
}

function viewPropertyDetails(propertyId) {
    // Open property in new tab
    window.open(`/object/${propertyId}`, '_blank');
}

function editPropertyNote(presentationId, propertyId) {
    const note = prompt('–í–≤–µ–¥–∏—Ç–µ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –∫ –æ–±—ä–µ–∫—Ç—É:');
    if (note !== null) {
        // Update property note via API
        fetch(`/api/manager/presentation/${presentationId}/property/${propertyId}/comment`, {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ comment: note })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showNotification('–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –æ–±–Ω–æ–≤–ª–µ–Ω', 'success');
                // Reload presentation content
                loadPresentationContent(presentationId);
            } else {
                showNotification('–û—à–∏–±–∫–∞: ' + data.error, 'error');
            }
        })
        .catch(error => {
            showNotification('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è', 'error');
        });
    }
}

function removePropertyFromPresentation(presentationId, propertyId) {
    console.log('üóëÔ∏è removePropertyFromPresentation called:', { presentationId, propertyId });
    if (confirm('–£–¥–∞–ª–∏—Ç—å –æ–±—ä–µ–∫—Ç –∏–∑ –ø—Ä–µ–∑–µ–Ω—Ç–∞—Ü–∏–∏?')) {
        console.log('‚úÖ User confirmed deletion');
        const url = `/api/manager/presentation/${presentationId}/property/${propertyId}/delete`;
        console.log('üåê Sending DELETE request to:', url);
        
        fetch(url, {
            method: 'DELETE',
            headers: {
                'Content-Type': 'application/json',
            }
        })
        .then(response => {
            console.log('üì° DELETE response received:', response.status, response.statusText);
            
            // Check for authentication errors FIRST
            if (handleAuthError(response)) {
                throw new Error('Authentication required');
            }
            
            // Check for other HTTP errors
            if (!response.ok) {
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }
            
            return response.json();
        })
        .then(data => {
            console.log('üì¶ DELETE response data:', data);
            if (data.success) {
                showNotification('–û–±—ä–µ–∫—Ç —É–¥–∞–ª–µ–Ω –∏–∑ –ø—Ä–µ–∑–µ–Ω—Ç–∞—Ü–∏–∏', 'success');
                // Reload presentation content
                loadPresentationContent(presentationId);
            } else {
                showNotification('–û—à–∏–±–∫–∞: ' + data.error, 'error');
            }
        })
        .catch(error => {
            console.error('‚ùå DELETE request failed:', error);
            // Don't show generic error if it's an auth error (already handled)
            if (error.message !== 'Authentication required') {
                showNotification('–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ –æ–±—ä–µ–∫—Ç–∞', 'error');
            }
        });
    } else {
        console.log('‚ùå User cancelled deletion');
    }
}
function downloadPropertyPDF(presentationId, propertyId) {
    const downloadUrl = `/api/presentation/${presentationId}/property/${propertyId}/download`;
    
    // Create download link
    const link = document.createElement('a');
    link.href = downloadUrl;
    link.download = `property_${propertyId}.pdf`;
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
    
    showNotification('PDF —Å–∫–∞—á–∏–≤–∞–µ—Ç—Å—è...', 'success');
}

// Print individual property
function printProperty(presentationId, propertyId) {
    const printUrl = `/api/presentation/${presentationId}/property/${propertyId}/print`;
    const printWindow = window.open(printUrl, '_blank', 'width=800,height=600');
    
    if (printWindow) {
        printWindow.focus();
    } else {
        showNotification('–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–∫—Ä—ã—Ç—å –æ–∫–Ω–æ –ø–µ—á–∞—Ç–∏', 'error');
    }
}

// Add comment to property
function addPropertyComment(presentationId, propertyId) {
    const comment = prompt('–í–≤–µ–¥–∏—Ç–µ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –∫ –æ–±—ä–µ–∫—Ç—É:');
    if (comment !== null && comment.trim()) {
        fetch(`/api/manager/presentation/${presentationId}/property/${propertyId}/comment`, {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ manager_note: comment.trim() })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showNotification('–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –¥–æ–±–∞–≤–ª–µ–Ω', 'success');
                // Reload presentation content
                loadPresentationContent(presentationId);
            } else {
                showNotification('–û—à–∏–±–∫–∞: ' + data.error, 'error');
            }
        })
        .catch(error => {
            showNotification('–û—à–∏–±–∫–∞ –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è', 'error');
        });
    }
}

// Share property link function
function sharePropertyLink(presentationId, propertyId) {
    const propertyUrl = `${window.location.origin}/object/${propertyId}`;
    
    // Copy to clipboard
    navigator.clipboard.writeText(propertyUrl).then(() => {
        showNotification('–°—Å—ã–ª–∫–∞ –Ω–∞ –æ–±—ä–µ–∫—Ç —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∞', 'success');
    }).catch(() => {
        // Fallback for older browsers
        const textArea = document.createElement('textarea');
        textArea.value = propertyUrl;
        document.body.appendChild(textArea);
        textArea.select();
        document.execCommand('copy');
        document.body.removeChild(textArea);
        showNotification('–°—Å—ã–ª–∫–∞ –Ω–∞ –æ–±—ä–µ–∫—Ç —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∞', 'success');
    });
}

// Toggle presentation status between –ß–µ—Ä–Ω–æ–≤–∏–∫ and –û–ø—É–±–ª–∏–∫–æ–≤–∞–Ω–æ
function togglePresentationStatus(presentationId, currentStatus) {
    // –û–ø—Ä–µ–¥–µ–ª—è–µ–º –Ω–æ–≤—ã–π —Å—Ç–∞—Ç—É—Å
    const newStatus = currentStatus === '–ß–µ—Ä–Ω–æ–≤–∏–∫' ? '–û–ø—É–±–ª–∏–∫–æ–≤–∞–Ω–æ' : '–ß–µ—Ä–Ω–æ–≤–∏–∫';
    
    // –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –¥–µ–π—Å—Ç–≤–∏—è
    if (!confirm(`–ò–∑–º–µ–Ω–∏—Ç—å —Å—Ç–∞—Ç—É—Å –Ω–∞ "${newStatus}"?`)) {
        return;
    }
    
    fetch(`/api/manager/presentation/${presentationId}/status`, {
        method: 'PUT',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCSRFToken(),
        },
        body: JSON.stringify({ status: newStatus })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showNotification(`–°—Ç–∞—Ç—É—Å –∏–∑–º–µ–Ω–µ–Ω –Ω–∞ "${data.status}"`, 'success');
            // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏—Ç—å —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ –ø—Ä–µ–∑–µ–Ω—Ç–∞—Ü–∏–∏
            loadPresentationContent(presentationId);
        } else {
            showNotification('–û—à–∏–±–∫–∞: ' + data.error, 'error');
        }
    })
    .catch(error => {
        console.error('Error updating presentation status:', error);
        showNotification('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ —Å—Ç–∞—Ç—É—Å–∞', 'error');
    });
}

function downloadAllPresentation(presentationId, title) {
    console.log(`üî• Starting downloadAllPresentation for ID: ${presentationId}`);
    
    // Create temporary link for download
    const link = document.createElement('a');
    link.href = `/api/manager/presentation/${presentationId}/download-all`;
    link.download = `${title || '–ü—Ä–µ–∑–µ–Ω—Ç–∞—Ü–∏—è'} - –í—Å–µ –º–∞—Ç–µ—Ä–∏–∞–ª—ã.zip`;
    link.style.display = 'none';
    
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
    
    showNotification('–°–∫–∞—á–∏–≤–∞–Ω–∏–µ –Ω–∞—á–∞—Ç–æ...', 'success');
}

function downloadPresentationPdf(presentationId, title) {
    console.log(`üî• Starting downloadPresentationPdf for ID: ${presentationId}`);
    
    // Create temporary link for download
    const link = document.createElement('a');
    link.href = `/api/presentation/pdf/${presentationId}`;
    link.download = `${title || '–ü—Ä–µ–∑–µ–Ω—Ç–∞—Ü–∏—è'}.pdf`;
    link.style.display = 'none';
    
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
    
    showNotification('–ì–µ–Ω–µ—Ä–∞—Ü–∏—è PDF –Ω–∞—á–∞—Ç–∞...', 'success');
}

function initializePresentationScripts() {
    // Initialize any additional functionality for presentation view
    console.log('‚úÖ Presentation scripts initialized');
}

// ============================================================================
// FAVORITES FUNCTIONALITY FOR MANAGER DASHBOARD
// ============================================================================

// Global favorites data
let managerFavoriteProperties = [];
let managerFavoriteComplexes = [];
let favoritesPropertiesFiltered = [];
let favoritesComplexesFiltered = [];

// Load favorite properties from API
window.loadFavoriteProperties = function() {
    console.log('üîÑ Loading favorite properties...');
    
    // Add delay to ensure DOM elements are available
    setTimeout(function() {
        const container = document.getElementById('properties-container');
        const emptyState = document.getElementById('empty-properties');
        const grid = document.getElementById('properties-grid');
        
        console.log('üîç DOM elements check:', {
            container: container ? 'found' : 'NOT FOUND',
            emptyState: emptyState ? 'found' : 'NOT FOUND', 
            grid: grid ? 'found' : 'NOT FOUND'
        });
        
        // If elements not found, try alternative approach
        if (!container || !emptyState || !grid) {
            console.warn('‚ö†Ô∏è Primary elements not found, trying alternative selectors...');
            
            // Try finding elements within the specific section
            const section = document.getElementById('favorites');
            if (section) {
                const altContainer = section.querySelector('[id*="container"]');
                const altEmptyState = section.querySelector('[id*="empty"]');
                const altGrid = section.querySelector('[id*="grid"]');
                
                console.log('üîç Alternative elements check:', {
                    section: 'found',
                    altContainer: altContainer ? 'found' : 'NOT FOUND',
                    altEmptyState: altEmptyState ? 'found' : 'NOT FOUND',
                    altGrid: altGrid ? 'found' : 'NOT FOUND'
                });
                
                if (!altContainer || !altEmptyState || !altGrid) {
                    console.error('‚ùå Could not find favorite properties elements after retries');
                    return;
                }
            } else {
                console.error('‚ùå Could not find favorite-properties section');
                return;
            }
        }
        
        // Show loading state
        if (container) container.classList.add('manager-favorites-hidden');
        if (emptyState) {
            emptyState.innerHTML = `
                <div class="text-center py-16">
                    <svg class="w-12 h-12 text-gray-400 mx-auto mb-4 animate-spin" fill="none" viewBox="0 0 24 24">
                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                    </svg>
                    <p class="text-gray-500">–ó–∞–≥—Ä—É–∑–∫–∞ –∏–∑–±—Ä–∞–Ω–Ω—ã—Ö –æ–±—ä–µ–∫—Ç–æ–≤...</p>
                </div>
            `;
            emptyState.classList.remove('manager-favorites-hidden');
        }
        
        // Load from API
        console.log('üåê Calling /api/manager/favorites/list');
        fetch('/api/manager/favorites/list')
            .then(response => response.json())
            .then(data => {
                console.log('üì¶ API response:', data);
                if (data.success) {
                    managerFavoriteProperties = data.favorites || [];
                    favoritesPropertiesFiltered = [...managerFavoriteProperties];
                    
                    console.log('‚úÖ Loaded', managerFavoriteProperties.length, 'favorite properties');
                    console.log('üìä Sample data:', managerFavoriteProperties.slice(0, 2));
                    
                    displayFavoriteProperties();
                    updateFavoritesCounts();
                    populatePropertiesFilters();
                } else {
                    console.error('‚ùå API error:', data.error);
                    showEmptyFavoriteProperties('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏: ' + (data.error || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'));
                }
            })
            .catch(error => {
                console.error('üí• Network error:', error);
                showEmptyFavoriteProperties('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –∏–∑–±—Ä–∞–Ω–Ω–æ–≥–æ');
            });
    }, 100); // 100ms delay to ensure DOM is ready
};

// Load favorite complexes from API
window.loadFavoriteComplexes = function() {
    console.log('üîÑ Loading favorite complexes...');
    
    const container = document.getElementById('favorite-complexes-container');
    const emptyState = document.getElementById('empty-favorite-complexes');
    const grid = document.getElementById('favorite-complexes-grid');
    
    if (!container || !emptyState || !grid) {
        console.error('‚ùå Favorite complexes elements not found');
        return;
    }
    
    // Show loading state
    container.classList.add('manager-favorites-hidden');
    emptyState.innerHTML = `
        <div class="text-center py-16">
            <svg class="w-12 h-12 text-gray-400 mx-auto mb-4 animate-spin" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
            <p class="text-gray-500">–ó–∞–≥—Ä—É–∑–∫–∞ –∏–∑–±—Ä–∞–Ω–Ω—ã—Ö –ñ–ö...</p>
        </div>
    `;
    emptyState.classList.remove('manager-favorites-hidden');
    
    // Load from API
    fetch('/api/manager/complexes/favorites/list')
        .then(response => response.json())
        .then(data => {
            console.log('üì¶ Complexes list API payload:', data);
            if (data.success) {
                // –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï: –¥–æ–±–∞–≤–∏—Ç—å fallback —á—Ç–µ–Ω–∏–µ —Å –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–æ–π
                const items = data.complexes || data.favorite_complexes || data.favorites || [];
                console.log('üîç Fallback reading result:', {
                    'data.complexes': data.complexes?.length || 0,
                    'data.favorite_complexes': data.favorite_complexes?.length || 0, 
                    'data.favorites': data.favorites?.length || 0,
                    'final_items_count': items.length
                });
                
                managerFavoriteComplexes = items;
                favoritesComplexesFiltered = [...managerFavoriteComplexes];
                
                console.log('‚úÖ Loaded', managerFavoriteComplexes.length, 'favorite complexes');
                if (managerFavoriteComplexes.length > 0) {
                    console.log('üìä Sample complex data:', managerFavoriteComplexes[0]);
                }
                
                displayFavoriteComplexes();
                updateFavoritesCounts();
                populateComplexesFilters();
            } else {
                console.error('‚ùå API error:', data.error);
                showEmptyFavoriteComplexes('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏: ' + (data.error || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'));
            }
        })
        .catch(error => {
            console.error('üí• Network error:', error);
            showEmptyFavoriteComplexes('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –∏–∑–±—Ä–∞–Ω–Ω–æ–≥–æ');
        });
};

// Display favorite properties
function displayFavoriteProperties() {
    console.log('üéØ displayFavoriteProperties called, data length:', favoritesPropertiesFiltered?.length);
    
    // First try direct element lookup
    let container = document.getElementById('properties-container');
    let emptyState = document.getElementById('empty-properties');
    let grid = document.getElementById('properties-grid');
    let totalCount = document.getElementById('favorites-properties-total-count');
    let clearBtn = document.getElementById('clear-all-properties');
    let exportBtn = document.getElementById('export-properties');
    
    console.log('üîç Display DOM elements check:', {
        container: container ? 'found' : 'NOT FOUND',
        emptyState: emptyState ? 'found' : 'NOT FOUND',
        grid: grid ? 'found' : 'NOT FOUND',
        totalCount: totalCount ? 'found' : 'NOT FOUND'
    });
    
    // If elements not found, try alternative approach
    if (!container || !emptyState || !grid) {
        console.warn('‚ö†Ô∏è Primary display elements not found, trying alternative selectors...');
        
        // Try finding elements within the specific section
        const section = document.getElementById('favorites');
        if (section) {
            if (!container) container = section.querySelector('[id*="container"]');
            if (!emptyState) emptyState = section.querySelector('[id*="empty"]');
            if (!grid) grid = section.querySelector('[id*="grid"]');
            if (!totalCount) totalCount = section.querySelector('[id*="total-count"]');
            if (!clearBtn) clearBtn = section.querySelector('[id*="clear-all"]');
            if (!exportBtn) exportBtn = section.querySelector('[id*="export"]');
            
            console.log('üîç Alternative display elements check:', {
                section: 'found',
                container: container ? 'found' : 'NOT FOUND',
                emptyState: emptyState ? 'found' : 'NOT FOUND',
                grid: grid ? 'found' : 'NOT FOUND'
            });
        }
        
        if (!container || !emptyState || !grid) {
            console.error('‚ùå Required display elements still not found after retries!');
            return;
        }
    }
    
    if (favoritesPropertiesFiltered.length === 0) {
        console.log('üì≠ No properties to display, showing empty state');
        showEmptyFavoriteProperties();
        return;
    }
    
    // Update counts and show controls
    if (totalCount) {
        totalCount.textContent = favoritesPropertiesFiltered.length;
        console.log('üìä Updated total count to:', favoritesPropertiesFiltered.length);
    }
    if (clearBtn) clearBtn.classList.remove('manager-favorites-hidden');
    if (exportBtn) exportBtn.classList.remove('manager-favorites-hidden');
    
    // Hide empty state and show container
    console.log('üëÄ Showing container and hiding empty state');
    emptyState.classList.add('manager-favorites-hidden');
    container.classList.remove('manager-favorites-hidden');
    
    // üîß FORCE SHOW CONTAINER - bypass CSS !important
    container.style.display = 'block';
    console.log('üîß Forced container visibility with style.display = block');
    
    // Generate property cards
    const cardsHTML = favoritesPropertiesFiltered.map(property => createPropertyCard(property)).join('');
    console.log('üèóÔ∏è Generated HTML length:', cardsHTML.length);
    console.log('üìù Sample HTML (first 200 chars):', cardsHTML.substring(0, 200));
    
    grid.innerHTML = cardsHTML;
    
    
    console.log('‚úÖ Displayed', favoritesPropertiesFiltered.length, 'properties');
    console.log('üßÆ Grid children count:', grid.children.length);
}

// Display favorite complexes
function displayFavoriteComplexes() {
    const container = document.getElementById('favorite-complexes-container');
    const emptyState = document.getElementById('empty-favorite-complexes');
    const grid = document.getElementById('favorite-complexes-grid');
    const totalCount = document.getElementById('favorites-complexes-total-count');
    const clearBtn = document.getElementById('clear-all-complexes');
    const exportBtn = document.getElementById('export-complexes');
    
    if (favoritesComplexesFiltered.length === 0) {
        showEmptyFavoriteComplexes();
        return;
    }
    
    // Update counts and show controls
    if (totalCount) totalCount.textContent = favoritesComplexesFiltered.length;
    if (clearBtn) clearBtn.classList.remove('manager-favorites-hidden');
    if (exportBtn) exportBtn.classList.remove('manager-favorites-hidden');
    
    // Hide empty state and show container
    emptyState.classList.add('manager-favorites-hidden');
    container.classList.remove('manager-favorites-hidden');
    
    // üîß FORCE SHOW CONTAINER - bypass CSS !important
    container.style.display = 'block';
    console.log('üîß Forced complexes container visibility with style.display = block');
    
    // Generate complex cards
    grid.innerHTML = favoritesComplexesFiltered.map(complex => createComplexCard(complex)).join('');
    
    console.log('‚úÖ Displayed', favoritesComplexesFiltered.length, 'complexes');
}

// Create property card HTML for manager dashboard
function createPropertyCard(property) {
    console.log('üèóÔ∏è Creating card for property:', property.id || property.property_id, property);
    
    // Use correct field names from API response
    const propertyId = property.id || property.property_id;
    const price = property.price || property.property_price || 0;
    const title = property.title || property.property_name || '–û–±—ä–µ–∫—Ç';
    const district = property.district || property.property_district || '';
    const complex = property.complex || property.property_complex || '';
    const cashback = property.cashback_amount || Math.floor(price * 0.05);
    const imageUrl = property.image || property.property_image_url || '/static/images/placeholder-property.jpg';
    const createdAt = property.created_at || property.added_at || '–ù–µ–¥–∞–≤–Ω–æ';
    const notes = property.notes || property.recommended_for || '';
    
    // Extract area from title if available (e.g. "–°—Ç—É–¥–∏—è, 22.82 –º¬≤")
    const areaMatch = title.match(/(\d+(?:\.\d+)?)\s*–º¬≤/);
    const area = areaMatch ? parseFloat(areaMatch[1]) : 0;
    const pricePerSqm = area > 0 ? Math.floor(price / area) : 0;
    
    return `
        <div class="bg-white rounded-xl shadow-sm hover:shadow-md transition-shadow property-favorite-card" data-property-id="${propertyId}">
            <div class="relative">
                <img src="${imageUrl}" alt="${title}" class="w-full h-48 object-cover rounded-t-xl" 
                     onerror="this.src='/static/images/placeholder-property.jpg'">
                <!-- Cashback Badge -->
                <div class="absolute top-3 left-3 bg-green-500 text-white px-2 py-1 rounded text-xs font-medium">
                    –ö—ç—à–±–µ–∫ ${cashback.toLocaleString('ru-RU')} ‚ÇΩ
                </div>
                
                <!-- Favorite Heart -->
                <div class="absolute top-3 right-3 favorite-heart favorited" data-property-id="${propertyId}" title="–£–¥–∞–ª–∏—Ç—å –∏–∑ –∏–∑–±—Ä–∞–Ω–Ω–æ–≥–æ">
                    <i class="fas fa-heart text-red-500"></i>
                </div>
            </div>
            
            <div class="p-4">
                <h3 class="font-semibold text-lg mb-2">${title}</h3>
                <p class="text-gray-600 text-sm mb-2">
                    <i class="fas fa-map-marker-alt mr-1 text-[#0088CC]"></i>
                    ${district}
                    ${complex ? ', ' + complex : ''}
                </p>
                
                <div class="flex justify-between items-center mb-4">
                    <div>
                        <div class="text-xl font-bold text-[#0088CC]">
                            ${price.toLocaleString('ru-RU')} ‚ÇΩ
                        </div>
                        ${pricePerSqm > 0 ? `
                        <div class="text-sm text-gray-500">
                            ${pricePerSqm.toLocaleString('ru-RU')} ‚ÇΩ/–º¬≤
                        </div>
                        ` : ''}
                    </div>
                    <div class="text-right text-sm text-gray-500">
                        –î–æ–±–∞–≤–ª–µ–Ω–æ: ${createdAt}
                    </div>
                </div>
                
                <div class="flex gap-2">
                    <a href="/object/${propertyId}" class="flex-1 bg-[#0088CC] text-white text-center py-2 rounded-lg hover:bg-[#0077BB] transition-colors text-sm">
                        –ü–æ–¥—Ä–æ–±–Ω–µ–µ
                    </a>
                    <button onclick="addToPresentation(${propertyId})" class="px-3 py-2 bg-green-500 text-white rounded-lg hover:bg-green-600 transition-colors text-sm" title="–í –ø—Ä–µ–∑–µ–Ω—Ç–∞—Ü–∏—é">
                        <i class="fas fa-plus"></i>
                    </button>
                    <button onclick="removeFromFavorites(${propertyId})" class="px-3 py-2 border border-red-500 text-red-500 rounded-lg hover:bg-red-50 transition-colors text-sm" title="–£–¥–∞–ª–∏—Ç—å">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
                
                ${notes ? `
                <div class="mt-3 p-2 bg-gray-50 rounded text-sm">
                    <strong>–ó–∞–º–µ—Ç–∫–∏:</strong> ${notes}
                </div>
                ` : ''}
            </div>
        </div>
    `;
}

// Create complex card HTML
function createComplexCard(complex) {
    const imageUrl = complex.complex_image_url || '/static/images/placeholder-complex.jpg';
    const district = complex.complex_district || '';
    const developer = complex.complex_developer || '';
    const status = complex.complex_status || '';
    const addedDate = complex.added_at ? new Date(complex.added_at).toLocaleDateString('ru-RU') : '';
    const priceFrom = complex.complex_price_from ? formatPrice(complex.complex_price_from) : '';
    
    const statusColors = {
        '—Å—Ç—Ä–æ–∏—Ç—Å—è': 'bg-yellow-100 text-yellow-800',
        '—Å–¥–∞–Ω': 'bg-green-100 text-green-800',
        '–ø—Ä–æ–µ–∫—Ç': 'bg-blue-100 text-blue-800'
    };
    const statusColor = statusColors[status.toLowerCase()] || 'bg-gray-100 text-gray-800';
    
    return `
        <div class="bg-white rounded-xl shadow-sm hover:shadow-md transition-shadow complex-favorite-card" data-complex-id="${complex.complex_id}">
            <div class="relative">
                <img src="${imageUrl}" alt="${complex.complex_name}" class="w-full h-48 object-cover rounded-t-xl">
                <div class="absolute top-3 right-3 flex gap-2">
                    <button onclick="removeFavoriteComplex('${complex.complex_id}')" 
                            class="bg-red-500 text-white p-2 rounded-full hover:bg-red-600 transition-colors"
                            title="–£–¥–∞–ª–∏—Ç—å –∏–∑ –∏–∑–±—Ä–∞–Ω–Ω–æ–≥–æ">
                        <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"/>
                        </svg>
                    </button>
                </div>
                ${status ? `<div class="absolute top-3 left-3 ${statusColor} px-2 py-1 rounded text-sm font-medium">${status}</div>` : ''}
            </div>
            <div class="p-4">
                <div class="flex justify-between items-start mb-2">
                    <h3 class="font-semibold text-gray-900 text-lg">${complex.complex_name || '–ñ–ö'}</h3>
                    <span class="text-xs text-gray-500">–î–æ–±–∞–≤–ª–µ–Ω–æ: ${addedDate}</span>
                </div>
                ${priceFrom ? `<p class="text-xl font-bold text-[#0088CC] mb-3">–æ—Ç ${priceFrom}</p>` : ''}
                
                <div class="space-y-2 text-sm text-gray-600 mb-4">
                    ${district ? `<div class="flex items-center gap-2"><svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M5.05 4.05a7 7 0 119.9 9.9L10 18.9l-4.95-4.95a7 7 0 010-9.9zM10 11a2 2 0 100-4 2 2 0 000 4z" clip-rule="evenodd"/></svg><span>${district}</span></div>` : ''}
                    ${developer ? `<div class="flex items-center gap-2"><svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20"><path d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/></svg><span>${developer}</span></div>` : ''}
                    ${complex.complex_properties_count ? `<div class="flex items-center gap-2"><svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20"><path d="M3 4a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zM3 10a1 1 0 011-1h6a1 1 0 110 2H4a1 1 0 01-1-1zM9 16a1 1 0 011-1h6a1 1 0 110 2h-6a1 1 0 01-1-1z"/></svg><span>${complex.complex_properties_count} –∫–≤–∞—Ä—Ç–∏—Ä</span></div>` : ''}
                </div>
                
                <div class="flex gap-2">
                    <button onclick="viewComplexDetails('${complex.complex_id}')" 
                            class="flex-1 bg-[#0088CC] text-white py-2 px-3 rounded-lg text-sm hover:bg-[#006699] transition-colors">
                        –ü–æ–¥—Ä–æ–±–Ω–µ–µ
                    </button>
                    <button onclick="searchComplexProperties('${complex.complex_id}')" 
                            class="flex-1 bg-purple-500 text-white py-2 px-3 rounded-lg text-sm hover:bg-purple-600 transition-colors">
                        –ö–≤–∞—Ä—Ç–∏—Ä—ã –≤ –ñ–ö
                    </button>
                </div>
                
                ${complex.manager_note ? `<div class="mt-3 p-2 bg-yellow-50 rounded text-sm"><strong>–ó–∞–º–µ—Ç–∫–∞:</strong> ${complex.manager_note}</div>` : ''}
            </div>
        </div>
    `;
}

// Show empty state for properties
function showEmptyFavoriteProperties(message = null) {
    const container = document.getElementById('properties-container');
    const emptyState = document.getElementById('empty-properties');
    const totalCount = document.getElementById('favorites-properties-total-count');
    const clearBtn = document.getElementById('clear-all-properties');
    const exportBtn = document.getElementById('export-properties');
    
    if (container) container.classList.add('manager-favorites-hidden');
    if (clearBtn) clearBtn.classList.add('manager-favorites-hidden');
    if (exportBtn) exportBtn.classList.add('manager-favorites-hidden');
    if (totalCount) totalCount.textContent = '0';
    
    if (message) {
        emptyState.innerHTML = `
            <div class="text-center py-16">
                <svg class="w-24 h-24 text-red-300 mx-auto mb-4" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7 4a1 1 0 11-2 0 1 1 0 012 0zm-1-9a1 1 0 00-1 1v4a1 1 0 102 0V6a1 1 0 00-1-1z" clip-rule="evenodd"/>
                </svg>
                <p class="text-red-600 text-lg font-medium">${message}</p>
            </div>
        `;
    }
    
    if (emptyState) emptyState.classList.remove('manager-favorites-hidden');
}

// Show empty state for complexes
function showEmptyFavoriteComplexes(message = null) {
    const container = document.getElementById('favorite-complexes-container');
    const emptyState = document.getElementById('empty-favorite-complexes');
    const totalCount = document.getElementById('favorites-complexes-total-count');
    const clearBtn = document.getElementById('clear-all-complexes');
    const exportBtn = document.getElementById('export-complexes');
    
    if (container) container.classList.add('manager-favorites-hidden');
    if (clearBtn) clearBtn.classList.add('manager-favorites-hidden');
    if (exportBtn) exportBtn.classList.add('manager-favorites-hidden');
    if (totalCount) totalCount.textContent = '0';
    
    if (message) {
        emptyState.innerHTML = `
            <div class="text-center py-16">
                <svg class="w-24 h-24 text-red-300 mx-auto mb-4" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7 4a1 1 0 11-2 0 1 1 0 012 0zm-1-9a1 1 0 00-1 1v4a1 1 0 102 0V6a1 1 0 00-1-1z" clip-rule="evenodd"/>
                </svg>
                <p class="text-red-600 text-lg font-medium">${message}</p>
            </div>
        `;
    }
    
    if (emptyState) emptyState.classList.remove('manager-favorites-hidden');
}

// Update favorites counts in navigation
function updateFavoritesCounts() {
    console.log('üî¢ updateFavoritesCounts called');
    
    const propertiesNavCount = document.getElementById('favorites-properties-count');
    const complexesNavCount = document.getElementById('favorites-complexes-count');
    
    console.log('üîç Count elements check:', {
        propertiesNavCount: propertiesNavCount ? 'found' : 'NOT FOUND',
        complexesNavCount: complexesNavCount ? 'found' : 'NOT FOUND'
    });
    
    // Update local counts first
    const propertiesCount = managerFavoriteProperties?.length || 0;
    const complexesCount = managerFavoriteComplexes?.length || 0;
    
    console.log('üìä Local counts - properties:', propertiesCount, 'complexes:', complexesCount);
    
    if (propertiesNavCount) {
        propertiesNavCount.textContent = propertiesCount;
        console.log('‚úÖ Updated properties nav count to:', propertiesCount);
    }
    if (complexesNavCount) {
        complexesNavCount.textContent = complexesCount;
        console.log('‚úÖ Updated complexes nav count to:', complexesCount);
    }
    
    // Also make API call to ensure sync
    console.log('üåê Making API call to /api/manager/favorites/count for sync');
    fetch('/api/manager/favorites/count')
        .then(response => response.json())
        .then(data => {
            console.log('üì¶ Count API response:', data);
            if (data.success) {
                // Update specific count elements
                if (propertiesNavCount) {
                    propertiesNavCount.textContent = data.properties_count;
                    console.log('üîÑ Synced properties count to:', data.properties_count);
                }
                if (complexesNavCount) {
                    complexesNavCount.textContent = data.complexes_count;
                    console.log('üîÑ Synced complexes count to:', data.complexes_count);
                }
                
                // Update total favorites count in horizontal menu
                const totalFavoritesCount = document.getElementById('favorites-total-count');
                if (totalFavoritesCount && data.total_count !== undefined) {
                    totalFavoritesCount.textContent = data.total_count;
                    console.log('üîÑ Synced total favorites count to:', data.total_count);
                }
            }
        })
        .catch(error => {
            console.error('Error fetching favorites count:', error);
        });
    
    // Also update comparison count
    console.log('üåê Making API call to /api/manager/comparison/count for comparison sync');
    fetch('/api/manager/comparison/count')
        .then(response => response.json())
        .then(data => {
            console.log('üìä Comparison API response:', data);
            if (data.success) {
                const comparisonCount = document.getElementById('comparison-count');
                if (comparisonCount && data.total_count !== undefined) {
                    comparisonCount.textContent = data.total_count;
                    console.log('üîÑ Synced comparison count to:', data.total_count);
                }
            }
        })
        .catch(error => {
            console.error('Error fetching comparison count:', error);
        });
    
    // Also update deals count
    console.log('üåê Making API call to /api/manager/deals for deals count sync');
    fetch('/api/manager/deals')
        .then(response => response.json())
        .then(data => {
            console.log('üìä Deals API response:', data);
            if (data.success && data.total !== undefined) {
                const dealsCount = document.getElementById('deals-count');
                if (dealsCount) {
                    dealsCount.textContent = data.total;
                    console.log('üîÑ Synced deals count to:', data.total);
                }
            }
        })
        .catch(error => {
            console.error('Error fetching deals count:', error);
        });
    
    // Also update saved searches count
    console.log('üåê Making API call to /api/manager/saved-searches for saved searches count sync');
    fetch('/api/manager/saved-searches')
        .then(response => {
            if (!response.ok) {
                console.error('‚ùå Saved searches API error - Status:', response.status);
                return response.text().then(text => {
                    console.error('‚ùå Response text:', text.substring(0, 200));
                    throw new Error(`HTTP ${response.status}: ${text.substring(0, 100)}`);
                });
            }
            return response.json();
        })
        .then(data => {
            console.log('üìä Saved searches API response:', data);
            if (data.success) {
                const savedSearchesCount = document.getElementById('saved-searches-count');
                if (savedSearchesCount) {
                    // Use count field from API, fallback to searches.length
                    const count = data.count !== undefined ? data.count : (data.searches ? data.searches.length : 0);
                    savedSearchesCount.textContent = count;
                    // Show the counter if there are saved searches
                    if (count > 0) {
                        savedSearchesCount.style.display = 'inline-flex';
                    } else {
                        savedSearchesCount.style.display = 'none';
                    }
                    console.log('üîÑ Synced saved searches count to:', count);
                }
            }
        })
        .catch(error => {
            console.error('‚ùå Error fetching saved searches count:', error);
        });
}

// Initialize favorites counts on page load
document.addEventListener('DOMContentLoaded', function() {
    // Load initial counts
    updateFavoritesCounts();
    
    // DISABLED - conflicts with presentation viewer 
    // setInterval(updateFavoritesCounts, 30000);
});

// Remove favorite property
window.removeFavoriteProperty = function(propertyId) {
    if (!confirm('–£–¥–∞–ª–∏—Ç—å —ç—Ç–æ—Ç –æ–±—ä–µ–∫—Ç –∏–∑ –∏–∑–±—Ä–∞–Ω–Ω–æ–≥–æ?')) {
        return;
    }
    
    fetch(`/api/manager/favorites/${propertyId}`, {
        method: 'DELETE'
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showNotification('–û–±—ä–µ–∫—Ç —É–¥–∞–ª–µ–Ω –∏–∑ –∏–∑–±—Ä–∞–Ω–Ω–æ–≥–æ', 'success');
            // Reload the favorites
            loadFavoriteProperties();
        } else {
            showNotification('–û—à–∏–±–∫–∞: ' + (data.error || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'), 'error');
        }
    })
    .catch(error => {
        console.error('Error removing favorite:', error);
        showNotification('–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ –∏–∑ –∏–∑–±—Ä–∞–Ω–Ω–æ–≥–æ', 'error');
    });
};

// Remove favorite complex
window.removeFavoriteComplex = function(complexId) {
    if (!confirm('–£–¥–∞–ª–∏—Ç—å —ç—Ç–æ—Ç –ñ–ö –∏–∑ –∏–∑–±—Ä–∞–Ω–Ω–æ–≥–æ?')) {
        return;
    }
    
    fetch(`/api/manager/complexes/favorites/${complexId}`, {
        method: 'DELETE'
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showNotification('–ñ–ö —É–¥–∞–ª–µ–Ω –∏–∑ –∏–∑–±—Ä–∞–Ω–Ω–æ–≥–æ', 'success');
            // Reload the favorites
            loadFavoriteComplexes();
        } else {
            showNotification('–û—à–∏–±–∫–∞: ' + (data.error || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'), 'error');
        }
    })
    .catch(error => {
        console.error('Error removing favorite complex:', error);
        showNotification('–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ –∏–∑ –∏–∑–±—Ä–∞–Ω–Ω–æ–≥–æ', 'error');
    });
};

// Clear all favorite properties
window.clearAllFavoriteProperties = function() {
    if (!confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å –≤—Å–µ –∏–∑–±—Ä–∞–Ω–Ω—ã–µ –æ–±—ä–µ–∫—Ç—ã? –≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–ª—å–∑—è –æ—Ç–º–µ–Ω–∏—Ç—å.')) {
        return;
    }
    
    // Remove all properties one by one
    const promises = managerFavoriteProperties.map(property => 
        fetch(`/api/manager/favorites/${property.property_id}`, { method: 'DELETE' })
    );
    
    Promise.all(promises)
        .then(responses => {
            const failedCount = responses.filter(r => !r.ok).length;
            if (failedCount === 0) {
                showNotification('–í—Å–µ –æ–±—ä–µ–∫—Ç—ã —É–¥–∞–ª–µ–Ω—ã –∏–∑ –∏–∑–±—Ä–∞–Ω–Ω–æ–≥–æ', 'success');
                loadFavoriteProperties();
            } else {
                showNotification(`–£–¥–∞–ª–µ–Ω–æ, –Ω–æ ${failedCount} –æ–±—ä–µ–∫—Ç–æ–≤ –Ω–µ —É–¥–∞–ª–æ—Å—å —É–¥–∞–ª–∏—Ç—å`, 'warning');
                loadFavoriteProperties();
            }
        })
        .catch(error => {
            console.error('Error clearing favorites:', error);
            showNotification('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—á–∏—Å—Ç–∫–µ –∏–∑–±—Ä–∞–Ω–Ω–æ–≥–æ', 'error');
        });
};

// Clear all favorite complexes
window.clearAllFavoriteComplexes = function() {
    if (!confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å –≤—Å–µ –∏–∑–±—Ä–∞–Ω–Ω—ã–µ –ñ–ö? –≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–ª—å–∑—è –æ—Ç–º–µ–Ω–∏—Ç—å.')) {
        return;
    }
    
    // Remove all complexes one by one
    const promises = managerFavoriteComplexes.map(complex => 
        fetch(`/api/manager/complexes/favorites/${complex.complex_id}`, { method: 'DELETE' })
    );
    
    Promise.all(promises)
        .then(responses => {
            const failedCount = responses.filter(r => !r.ok).length;
            if (failedCount === 0) {
                showNotification('–í—Å–µ –ñ–ö —É–¥–∞–ª–µ–Ω—ã –∏–∑ –∏–∑–±—Ä–∞–Ω–Ω–æ–≥–æ', 'success');
                loadFavoriteComplexes();
            } else {
                showNotification(`–£–¥–∞–ª–µ–Ω–æ, –Ω–æ ${failedCount} –ñ–ö –Ω–µ —É–¥–∞–ª–æ—Å—å —É–¥–∞–ª–∏—Ç—å`, 'warning');
                loadFavoriteComplexes();
            }
        })
        .catch(error => {
            console.error('Error clearing favorite complexes:', error);
            showNotification('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—á–∏—Å—Ç–∫–µ –∏–∑–±—Ä–∞–Ω–Ω–æ–≥–æ', 'error');
        });
};

// Filtering and sorting functions
window.filterFavoriteProperties = function() {
    const roomsFilter = document.getElementById('filter-favorite-rooms')?.value || '';
    const districtFilter = document.getElementById('filter-favorite-district')?.value || '';
    const priceFilter = document.getElementById('filter-favorite-price')?.value || '';
    
    favoritesPropertiesFiltered = managerFavoriteProperties.filter(property => {
        // Rooms filter
        if (roomsFilter && property.property_rooms && !property.property_rooms.toLowerCase().includes(roomsFilter.toLowerCase())) {
            return false;
        }
        
        // District filter
        if (districtFilter && property.property_district && !property.property_district.toLowerCase().includes(districtFilter.toLowerCase())) {
            return false;
        }
        
        // Price filter
        if (priceFilter && property.property_price) {
            const maxPrice = parseInt(priceFilter);
            if (property.property_price > maxPrice) {
                return false;
            }
        }
        
        return true;
    });
    
    displayFavoriteProperties();
};

window.filterFavoriteComplexes = function() {
    const statusFilter = document.getElementById('filter-complex-status')?.value || '';
    const districtFilter = document.getElementById('filter-complex-district')?.value || '';
    const developerFilter = document.getElementById('filter-complex-developer')?.value || '';
    
    favoritesComplexesFiltered = managerFavoriteComplexes.filter(complex => {
        // Status filter
        if (statusFilter && complex.complex_status && !complex.complex_status.toLowerCase().includes(statusFilter.toLowerCase())) {
            return false;
        }
        
        // District filter
        if (districtFilter && complex.complex_district && !complex.complex_district.toLowerCase().includes(districtFilter.toLowerCase())) {
            return false;
        }
        
        // Developer filter
        if (developerFilter && complex.complex_developer && !complex.complex_developer.toLowerCase().includes(developerFilter.toLowerCase())) {
            return false;
        }
        
        return true;
    });
    
    displayFavoriteComplexes();
};

window.sortFavoriteProperties = function() {
    const sortBy = document.getElementById('sort-favorite-properties')?.value || 'date_desc';
    
    favoritesPropertiesFiltered.sort((a, b) => {
        switch (sortBy) {
            case 'date_asc':
                return new Date(a.added_at) - new Date(b.added_at);
            case 'date_desc':
                return new Date(b.added_at) - new Date(a.added_at);
            case 'price_asc':
                return (a.property_price || 0) - (b.property_price || 0);
            case 'price_desc':
                return (b.property_price || 0) - (a.property_price || 0);
            case 'area_asc':
                return (a.property_area || 0) - (b.property_area || 0);
            case 'area_desc':
                return (b.property_area || 0) - (a.property_area || 0);
            default:
                return 0;
        }
    });
    
    displayFavoriteProperties();
};

window.sortFavoriteComplexes = function() {
    const sortBy = document.getElementById('sort-favorite-complexes')?.value || 'date_desc';
    
    favoritesComplexesFiltered.sort((a, b) => {
        switch (sortBy) {
            case 'date_asc':
                return new Date(a.added_at) - new Date(b.added_at);
            case 'date_desc':
                return new Date(b.added_at) - new Date(a.added_at);
            case 'name_asc':
                return (a.complex_name || '').localeCompare(b.complex_name || '');
            case 'price_asc':
                return (a.complex_price_from || 0) - (b.complex_price_from || 0);
            case 'price_desc':
                return (b.complex_price_from || 0) - (a.complex_price_from || 0);
            default:
                return 0;
        }
    });
    
    displayFavoriteComplexes();
};

// Populate filter dropdowns
function populatePropertiesFilters() {
    const districtFilter = document.getElementById('filter-favorite-district');
    
    if (districtFilter && managerFavoriteProperties.length > 0) {
        const districts = [...new Set(managerFavoriteProperties
            .map(p => p.property_district)
            .filter(d => d))];
        
        districtFilter.innerHTML = '<option value="">–í—Å–µ —Ä–∞–π–æ–Ω—ã</option>' +
            districts.map(district => `<option value="${district}">${district}</option>`).join('');
    }
}

function populateComplexesFilters() {
    const districtFilter = document.getElementById('filter-complex-district');
    const developerFilter = document.getElementById('filter-complex-developer');
    
    if (districtFilter && managerFavoriteComplexes.length > 0) {
        const districts = [...new Set(managerFavoriteComplexes
            .map(c => c.complex_district)
            .filter(d => d))];
        
        districtFilter.innerHTML = '<option value="">–í—Å–µ —Ä–∞–π–æ–Ω—ã</option>' +
            districts.map(district => `<option value="${district}">${district}</option>`).join('');
    }
    
    if (developerFilter && managerFavoriteComplexes.length > 0) {
        const developers = [...new Set(managerFavoriteComplexes
            .map(c => c.complex_developer)
            .filter(d => d))];
        
        developerFilter.innerHTML = '<option value="">–í—Å–µ –∑–∞—Å—Ç—Ä–æ–π—â–∏–∫–∏</option>' +
            developers.map(developer => `<option value="${developer}">${developer}</option>`).join('');
    }
}

// Action functions
window.viewPropertyDetails = function(propertyId) {
    window.open(`/object/${propertyId}`, '_blank');
};

window.viewComplexDetails = function(complexId) {
    window.open(`/complex/${complexId}`, '_blank');
};

window.addToCollection = function(propertyId) {
    // Show collection selection modal or redirect to create collection with pre-selected property
    showSection('create-collection');
    // TODO: Pre-select the property in collection creation form
    showNotification('–ü–µ—Ä–µ–π–¥–∏—Ç–µ –∫ —Å–æ–∑–¥–∞–Ω–∏—é –ø–æ–¥–±–æ—Ä–∫–∏ –∏ –¥–æ–±–∞–≤—å—Ç–µ —ç—Ç–æ—Ç –æ–±—ä–µ–∫—Ç', 'info');
};

window.searchComplexProperties = function(complexId) {
    window.open(`/properties?complex=${complexId}`, '_blank');
};

// Export functions
window.exportFavoriteProperties = function() {
    if (managerFavoriteProperties.length === 0) {
        showNotification('–ù–µ—Ç –æ–±—ä–µ–∫—Ç–æ–≤ –¥–ª—è —ç–∫—Å–ø–æ—Ä—Ç–∞', 'warning');
        return;
    }
    
    // Create CSV data
    const headers = ['–ù–∞–∑–≤–∞–Ω–∏–µ', '–¶–µ–Ω–∞', '–ü–ª–æ—â–∞–¥—å', '–ö–æ–º–Ω–∞—Ç—ã', '–†–∞–π–æ–Ω', '–ñ–ö', '–ó–∞—Å—Ç—Ä–æ–π—â–∏–∫', '–î–∞—Ç–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è'];
    const rows = managerFavoriteProperties.map(property => [
        property.property_name || '',
        property.property_price || '',
        property.property_area || '',
        property.property_rooms || '',
        property.property_district || '',
        property.property_complex || '',
        property.property_developer || '',
        property.added_at ? new Date(property.added_at).toLocaleDateString('ru-RU') : ''
    ]);
    
    const csvContent = [headers, ...rows]
        .map(row => row.map(cell => `"${cell}"`).join(','))
        .join('\n');
    
    // Download CSV
    const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
    const link = document.createElement('a');
    link.href = URL.createObjectURL(blob);
    link.download = `favorite-properties-${new Date().toISOString().split('T')[0]}.csv`;
    link.click();
    
    showNotification('–≠–∫—Å–ø–æ—Ä—Ç –∏–∑–±—Ä–∞–Ω–Ω—ã—Ö –æ–±—ä–µ–∫—Ç–æ–≤ –Ω–∞—á–∞—Ç', 'success');
};

window.exportFavoriteComplexes = function() {
    if (managerFavoriteComplexes.length === 0) {
        showNotification('–ù–µ—Ç –ñ–ö –¥–ª—è —ç–∫—Å–ø–æ—Ä—Ç–∞', 'warning');
        return;
    }
    
    // Create CSV data
    const headers = ['–ù–∞–∑–≤–∞–Ω–∏–µ', '–¶–µ–Ω–∞ –æ—Ç', '–†–∞–π–æ–Ω', '–ó–∞—Å—Ç—Ä–æ–π—â–∏–∫', '–°—Ç–∞—Ç—É—Å', '–î–∞—Ç–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è'];
    const rows = managerFavoriteComplexes.map(complex => [
        complex.complex_name || '',
        complex.complex_price_from || '',
        complex.complex_district || '',
        complex.complex_developer || '',
        complex.complex_status || '',
        complex.added_at ? new Date(complex.added_at).toLocaleDateString('ru-RU') : ''
    ]);
    
    const csvContent = [headers, ...rows]
        .map(row => row.map(cell => `"${cell}"`).join(','))
        .join('\n');
    
    // Download CSV
    const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
    const link = document.createElement('a');
    link.href = URL.createObjectURL(blob);
    link.download = `favorite-complexes-${new Date().toISOString().split('T')[0]}.csv`;
    link.click();
    
    showNotification('–≠–∫—Å–ø–æ—Ä—Ç –∏–∑–±—Ä–∞–Ω–Ω—ã—Ö –ñ–ö –Ω–∞—á–∞—Ç', 'success');
};

// ================================================
// NEW WORKING FAVORITES SECTIONS with Flexbox
// ================================================

// Load new favorite properties with simple layout
window.loadNewFavoriteProperties = async function() {
    console.log('üÜï Loading NEW favorite properties with Flexbox layout...');
    
    try {
        const response = await fetch('/api/manager/favorites/list');
        const data = await response.json();
        
        if (!data.success) {
            console.error('‚ùå Failed to load favorites:', data);
            return;
        }
        
        const properties = data.favorites || [];
        console.log(`üìä Loaded ${properties.length} properties for NEW section`);
        
        // Update count in navigation widget
        const countEl = document.getElementById('new-properties-count');
        if (countEl) countEl.textContent = properties.length;
        
        // Update count in section header
        const totalEl = document.getElementById('new-properties-total');
        if (totalEl) totalEl.textContent = properties.length;
        
        // Get containers
        const emptyState = document.getElementById('new-empty-properties');
        const container = document.getElementById('new-properties-container');
        const list = document.getElementById('new-properties-list');
        
        if (properties.length === 0) {
            emptyState.classList.remove('hidden');
            container.classList.add('hidden');
            return;
        }
        
        // Hide empty state, show container
        emptyState.classList.add('hidden');
        container.classList.remove('hidden');
        
        // Simple card creation with Flexbox
        list.innerHTML = properties.map(property => `
            <div class="bg-white rounded-lg shadow-sm border p-4 w-80 hover:shadow-md transition-shadow">
                <div class="relative mb-3">
                    <img src="${property.image || '/static/images/no-photo.jpg'}" 
                         alt="${property.title}" 
                         class="w-full h-48 object-cover rounded-lg"
                         onerror="this.src='/static/images/no-photo.jpg'">
                    <div class="absolute top-2 right-2 bg-green-500 text-white px-2 py-1 rounded text-sm">
                        ‚ÇΩ${Number(property.cashback_amount || 0).toLocaleString('ru-RU')}
                    </div>
                </div>
                <h3 class="font-semibold text-gray-900 mb-2 line-clamp-2">${property.title}</h3>
                <p class="text-sm text-gray-600 mb-2">${property.complex}</p>
                <p class="text-lg font-bold text-blue-600">‚ÇΩ${Number(property.price || 0).toLocaleString('ru-RU')}</p>
                <div class="mt-3 text-xs text-gray-500">
                    –î–æ–±–∞–≤–ª–µ–Ω–æ: ${property.created_at}
                </div>
            </div>
        `).join('');
        
        console.log(`‚úÖ NEW section displayed ${properties.length} properties successfully`);
        
    } catch (error) {
        console.error('‚ùå Error loading NEW favorite properties:', error);
    }
};

// Load new favorite complexes with simple layout
window.loadNewFavoriteComplexes = async function() {
    console.log('üÜï Loading NEW favorite complexes with Flexbox layout...');
    
    try {
        const response = await fetch('/api/manager/complexes/favorites/list');
        const data = await response.json();
        
        if (!data.success) {
            console.error('‚ùå Failed to load favorite complexes:', data);
            return;
        }
        
        const complexes = data.favorites || [];
        console.log(`üìä Loaded ${complexes.length} complexes for NEW section`);
        
        // Update count in navigation widget
        const countEl = document.getElementById('new-complexes-count');
        if (countEl) countEl.textContent = complexes.length;
        
        // Update count in section header
        const totalEl = document.getElementById('new-complexes-total');
        if (totalEl) totalEl.textContent = complexes.length;
        
        // Get containers
        const emptyState = document.getElementById('new-empty-complexes');
        const container = document.getElementById('new-complexes-container');
        const list = document.getElementById('new-complexes-list');
        
        if (complexes.length === 0) {
            emptyState.classList.remove('hidden');
            container.classList.add('hidden');
            return;
        }
        
        // Hide empty state, show container
        emptyState.classList.add('hidden');
        container.classList.remove('hidden');
        
        // Simple card creation with Flexbox
        list.innerHTML = complexes.map(complex => `
            <div class="bg-white rounded-lg shadow-sm border p-4 w-80 hover:shadow-md transition-shadow">
                <div class="relative mb-3">
                    <img src="${complex.image || '/static/images/no-photo.jpg'}" 
                         alt="${complex.name}" 
                         class="w-full h-48 object-cover rounded-lg"
                         onerror="this.src='/static/images/no-photo.jpg'">
                    <div class="absolute top-2 right-2 bg-blue-500 text-white px-2 py-1 rounded text-sm">
                        ${complex.status || '–ñ–ö'}
                    </div>
                </div>
                <h3 class="font-semibold text-gray-900 mb-2">${complex.name}</h3>
                <p class="text-sm text-gray-600 mb-1">${complex.developer}</p>
                <p class="text-sm text-gray-600 mb-2">${complex.district}</p>
                <div class="flex justify-between items-center">
                    <div class="text-sm">
                        ${complex.min_price ? `–æ—Ç ‚ÇΩ${Number(complex.min_price).toLocaleString('ru-RU')}` : '–¶–µ–Ω–∞ –Ω–µ —É–∫–∞–∑–∞–Ω–∞'}
                    </div>
                </div>
                <div class="mt-3 text-xs text-gray-500">
                    –î–æ–±–∞–≤–ª–µ–Ω–æ: ${complex.created_at}
                </div>
            </div>
        `).join('');
        
        console.log(`‚úÖ NEW section displayed ${complexes.length} complexes successfully`);
        
    } catch (error) {
        console.error('‚ùå Error loading NEW favorite complexes:', error);
    }
};

// Export functions for new sections
window.exportNewFavoriteProperties = function() {
    console.log('üìã Exporting from NEW properties section...');
    showNotification('–≠–∫—Å–ø–æ—Ä—Ç –∏–∑ –Ω–æ–≤–æ–π —Å–µ–∫—Ü–∏–∏ –æ–±—ä–µ–∫—Ç–æ–≤', 'info');
};

window.exportNewFavoriteComplexes = function() {
    console.log('üìã Exporting from NEW complexes section...');
    showNotification('–≠–∫—Å–ø–æ—Ä—Ç –∏–∑ –Ω–æ–≤–æ–π —Å–µ–∫—Ü–∏–∏ –ñ–ö', 'info');
};

// Load dashboard counts on page load
document.addEventListener('DOMContentLoaded', function() {
    console.log('‚úÖ Dashboard initialization started');
    
    // üéØ AUTO-SHOW FAVORITES: Show favorite-properties section by default if user has favorites
    // DISABLED AUTO-SWITCH TO FAVORITES - it conflicts with presentation viewer
    // setTimeout(() => {
    //     fetch('/api/manager/favorites/count')
    //         .then(response => response.json())
    //         .then(data => {
    //             if (data.success && data.properties_count > 0) {
    //                 console.log(`üéØ Auto-showing favorites section (${data.properties_count} properties found)`);
    //                 showSection('favorites');
    //             }
    //         })
    //         .catch(error => console.log('No auto-show for favorites:', error));
    // }, 1000);
    
    // üîÑ Load dashboard card counts
    console.log('üî¢ Loading dashboard card counts...');
    fetch('/api/manager/favorites/count')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Update dashboard card counts
                const newPropCount = document.getElementById('new-properties-count');
                const newComplexCount = document.getElementById('new-complexes-count');
                
                if (newPropCount) {
                    newPropCount.textContent = data.properties_count || 0;
                    console.log(`üìã Updated properties card: ${data.properties_count || 0}`);
                }
                if (newComplexCount) {
                    newComplexCount.textContent = data.complexes_count || 0;
                    console.log(`üìã Updated complexes card: ${data.complexes_count || 0}`);
                }
                
                // Update horizontal tab counts
                const tabPropCount = document.getElementById('favorites-properties-count');
                const tabComplexCount = document.getElementById('favorites-complexes-count');
                
                if (tabPropCount) {
                    tabPropCount.textContent = data.properties_count || 0;
                    console.log(`üîó Updated horizontal properties tab: ${data.properties_count || 0}`);
                }
                if (tabComplexCount) {
                    tabComplexCount.textContent = data.complexes_count || 0;
                    console.log(`üîó Updated horizontal complexes tab: ${data.complexes_count || 0}`);
                }
                
                console.log(`‚úÖ Dashboard cards updated successfully!`);
            }
        })
        .catch(error => console.error('‚ùå Error loading dashboard counts:', error));
});

// Utility functions
function formatPrice(price) {
    if (!price) return '';
    
    const numPrice = parseInt(price);
    if (numPrice >= 1000000) {
        return (numPrice / 1000000).toFixed(1) + ' –º–ª–Ω ‚ÇΩ';
    } else if (numPrice >= 1000) {
        return (numPrice / 1000).toFixed(0) + ' —Ç—ã—Å ‚ÇΩ';
    } else {
        return numPrice.toLocaleString('ru-RU') + ' ‚ÇΩ';
    }
}

// –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ñ–ª–∞–≥ –º–µ–Ω–µ–¥–∂–µ—Ä–∞ –¥–ª—è —Å–∏—Å—Ç–µ–º—ã —Å—Ä–∞–≤–Ω–µ–Ω–∏—è
sessionStorage.setItem('is_manager', 'true');
console.log('üîë Manager session flag set: true');

console.log('‚úÖ Manager Favorites functionality initialized');

// ===== DEALS MANAGEMENT FUNCTIONS =====
// Deal Management Functions for Dashboard
async function openCreateDealModal() {
    // Load clients dynamically before showing modal
    try {
        const response = await fetch('/api/manager/clients');
        const data = await response.json();
        
        if (data.success && data.clients) {
            const clientSelect = document.getElementById('client_id');
            // Clear existing options except the first one
            clientSelect.innerHTML = '<option value="">–í—ã–±–µ—Ä–∏—Ç–µ –∫–ª–∏–µ–Ω—Ç–∞</option>';
            
            // Add clients from API
            data.clients.forEach(client => {
                const option = document.createElement('option');
                option.value = client.id;  // Use client.id, not index!
                option.textContent = client.full_name || client.email;
                clientSelect.appendChild(option);
            });
            
            console.log(`‚úÖ Loaded ${data.clients.length} clients into select`);
        }
    } catch (error) {
        console.error('‚ùå Error loading clients:', error);
    }
    
    document.getElementById('createDealModal').classList.remove('hidden');
    if (typeof window.lockBodyScroll === 'function') window.lockBodyScroll();
}

function closeCreateDealModal() {
    document.getElementById('createDealModal').classList.add('hidden');
    if (typeof window.unlockBodyScroll === 'function') window.unlockBodyScroll();
    document.getElementById('createDealForm').reset();
}

function openEditStatusModal(dealId, currentStatus) {
    document.getElementById('edit-deal-id').value = dealId;
    document.getElementById('edit-status').value = currentStatus;
    document.getElementById('editStatusModal').classList.remove('hidden');
    if (typeof window.lockBodyScroll === 'function') window.lockBodyScroll();
}

function closeEditStatusModal() {
    document.getElementById('editStatusModal').classList.add('hidden');
    if (typeof window.unlockBodyScroll === 'function') window.unlockBodyScroll();
    document.getElementById('editStatusForm').reset();
}

// Handle status form submission
document.addEventListener('DOMContentLoaded', function() {
    const editStatusForm = document.getElementById('editStatusForm');
    if (editStatusForm) {
        editStatusForm.addEventListener('submit', function(e) {
            e.preventDefault();
            updateDealStatus();
        });
    }
});

// Update deal status function
function updateDealStatus() {
    const dealId = document.getElementById('edit-deal-id').value;
    const newStatus = document.getElementById('edit-status').value;
    const statusNotes = document.getElementById('status-notes').value;
    const csrfToken = document.querySelector('[name="csrf_token"]').value;
    
    console.log('üîÑ Updating deal status:', { dealId, newStatus, statusNotes });
    
    const updateBtn = document.getElementById('updateStatusBtn');
    updateBtn.disabled = true;
    updateBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>–û–±–Ω–æ–≤–ª—è–µ—Ç—Å—è...';
    
    fetch(`/api/deals/${dealId}`, {
        method: 'PUT',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': csrfToken
        },
        body: JSON.stringify({
            status: newStatus,
            notes: statusNotes
        })
    })
    .then(response => response.json())
    .then(data => {
        console.log('‚úÖ Status update response:', data);
        
        if (data.success) {
            closeEditStatusModal();
            // Reload deals data
            if (typeof loadStaticDealsData === 'function') {
                loadStaticDealsData();
            }
            // Show success message
            showSuccessMessage('–°—Ç–∞—Ç—É—Å —Å–¥–µ–ª–∫–∏ —É—Å–ø–µ—à–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω');
        } else {
            console.error('‚ùå Failed to update status:', data.error);
            alert('–û—à–∏–±–∫–∞: ' + (data.error || '–ù–µ —É–¥–∞–ª–æ—Å—å –æ–±–Ω–æ–≤–∏—Ç—å —Å—Ç–∞—Ç—É—Å'));
        }
    })
    .catch(error => {
        console.error('‚ùå Error updating status:', error);
        alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ —Å—Ç–∞—Ç—É—Å–∞');
    })
    .finally(() => {
        updateBtn.disabled = false;
        updateBtn.innerHTML = '<i class="fas fa-save mr-2"></i>–û–±–Ω–æ–≤–∏—Ç—å —Å—Ç–∞—Ç—É—Å';
    });
}

// View deal details function
window.viewDealDetails = function(dealId) {
    console.log('üëÅÔ∏è Opening deal details for ID:', dealId);
    
    fetch(`/api/deals/${dealId}`, {
        method: 'GET',
        headers: {
            'Content-Type': 'application/json'
        }
    })
    .then(response => response.json())
    .then(data => {
        console.log('üìÑ Deal details response:', data);
        
        if (data.success && data.deal) {
            openDealDetailsModal(data.deal);
        } else {
            console.error('‚ùå Failed to load deal details:', data.error);
            alert('–û—à–∏–±–∫–∞: ' + (data.error || '–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –¥–µ—Ç–∞–ª–∏ —Å–¥–µ–ª–∫–∏'));
        }
    })
    .catch(error => {
        console.error('‚ùå Error loading deal details:', error);
        alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –¥–µ—Ç–∞–ª–µ–π —Å–¥–µ–ª–∫–∏');
    });
}

// Open deal details modal
function openDealDetailsModal(deal) {
    const statusLabels = {
        'new': '–ù–æ–≤–∞—è',
        'object_reserved': '–û–±—ä–µ–∫—Ç –∑–∞—Ä–µ–∑–µ—Ä–≤–∏—Ä–æ–≤–∞–Ω', 
        'mortgage': '–ò–ø–æ—Ç–µ–∫–∞',
        'successful': '–£—Å–ø–µ—à–Ω–∞—è',
        'rejected': '–û—Ç–∫–ª–æ–Ω–µ–Ω–∞'
    };
    
    const statusColors = {
        'new': 'bg-blue-100 text-blue-800',
        'object_reserved': 'bg-orange-100 text-orange-800',
        'mortgage': 'bg-yellow-100 text-yellow-800', 
        'successful': 'bg-green-100 text-green-800',
        'rejected': 'bg-red-100 text-red-800'
    };
    
    const modalHtml = `
        <div id="dealDetailsModal" class="fixed inset-0 bg-black bg-opacity-50 z-50">
            <div class="flex items-center justify-center min-h-screen p-4">
                <div class="bg-white rounded-lg max-w-2xl w-full max-h-[90vh] overflow-y-auto">
                    <div class="flex items-center justify-between p-6 border-b">
                        <h3 class="text-lg font-semibold text-gray-900">–î–µ—Ç–∞–ª–∏ —Å–¥–µ–ª–∫–∏ #${deal.id}</h3>
                        <button onclick="closeDealDetailsModal()" class="text-gray-400 hover:text-gray-600 transition-colors">
                            <i class="fas fa-times text-xl"></i>
                        </button>
                    </div>
                    
                    <div class="p-6 space-y-6">
                        <!-- Deal Info -->
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">–ù–æ–º–µ—Ä —Å–¥–µ–ª–∫–∏</label>
                                <p class="text-lg font-semibold text-gray-900">#${deal.id}</p>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">–°—Ç–∞—Ç—É—Å</label>
                                <span class="inline-flex px-2 py-1 text-xs font-semibold rounded-full ${statusColors[deal.status] || 'bg-gray-100 text-gray-800'}">
                                    ${statusLabels[deal.status] || deal.status}
                                </span>
                            </div>
                        </div>
                        
                        <!-- Client Info -->
                        <div class="border-t pt-4">
                            <h4 class="text-md font-semibold text-gray-900 mb-3">–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –∫–ª–∏–µ–Ω—Ç–µ</h4>
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">–ò–º—è –∫–ª–∏–µ–Ω—Ç–∞</label>
                                    <p class="text-gray-900">${deal.client_name || '–ù–µ —É–∫–∞–∑–∞–Ω–æ'}</p>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Email</label>
                                    <p class="text-gray-900">${deal.client_email || '–ù–µ —É–∫–∞–∑–∞–Ω'}</p>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Property Info -->
                        <div class="border-t pt-4">
                            <h4 class="text-md font-semibold text-gray-900 mb-3">–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –Ω–µ–¥–≤–∏–∂–∏–º–æ—Å—Ç–∏</h4>
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">–ñ–ö</label>
                                    <p class="text-gray-900">${deal.complex_name || '–ù–µ —É–∫–∞–∑–∞–Ω'}</p>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">–°—Ç–æ–∏–º–æ—Å—Ç—å</label>
                                    <p class="text-lg font-semibold text-gray-900">${deal.property_price ? (parseFloat(deal.property_price).toLocaleString('ru-RU') + ' ‚ÇΩ') : '0 ‚ÇΩ'}</p>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Financial Info -->
                        <div class="border-t pt-4">
                            <h4 class="text-md font-semibold text-gray-900 mb-3">–§–∏–Ω–∞–Ω—Å–æ–≤–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è</h4>
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">–ö–µ—à–±–µ–∫</label>
                                    <p class="text-lg font-semibold text-[#059669]">${deal.cashback_amount ? (parseFloat(deal.cashback_amount).toLocaleString('ru-RU') + ' ‚ÇΩ') : '0 ‚ÇΩ'}</p>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">–î–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∏—è</label>
                                    <p class="text-gray-900">${deal.created_at ? new Date(deal.created_at).toLocaleDateString('ru-RU') : '–ù–µ–¥–∞–≤–Ω–æ'}</p>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Comments Section -->
                        <div class="border-t pt-4">
                            <h4 class="text-md font-semibold text-gray-900 mb-3">–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏</h4>
                            <div id="deal-comments" class="space-y-2 mb-4">
                                ${deal.notes ? `<p class="text-gray-700 bg-gray-50 p-3 rounded">${deal.notes}</p>` : '<p class="text-gray-500 italic">–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤ –ø–æ–∫–∞ –Ω–µ—Ç</p>'}
                            </div>
                            
                            <!-- Add Comment Form -->
                            <form id="addCommentForm" class="space-y-3">
                                <input type="hidden" id="detail-deal-id" value="${deal.id}">
                                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                                <div>
                                    <label for="new-comment" class="block text-sm font-medium text-gray-700 mb-1">
                                        –î–æ–±–∞–≤–∏—Ç—å –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π
                                    </label>
                                    <textarea id="new-comment" name="comment" rows="3"
                                              placeholder="–í–≤–µ–¥–∏—Ç–µ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π..."
                                              class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[#0088CC] focus:border-transparent resize-none"></textarea>
                                </div>
                                <button type="submit" id="addCommentBtn"
                                        class="px-4 py-2 bg-[#0088CC] text-white rounded-lg hover:bg-[#0077BB] transition-colors">
                                    <i class="fas fa-plus mr-2"></i>–î–æ–±–∞–≤–∏—Ç—å –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π
                                </button>
                            </form>
                        </div>
                    </div>
                    
                    <div class="flex justify-end space-x-4 p-6 border-t bg-gray-50">
                        <button onclick="openEditStatusModal(${deal.id}, '${deal.status}')" 
                                class="px-4 py-2 bg-orange-500 text-white rounded-lg hover:bg-orange-600 transition-colors">
                            <i class="fas fa-edit mr-2"></i>–ò–∑–º–µ–Ω–∏—Ç—å —Å—Ç–∞—Ç—É—Å
                        </button>
                        <button onclick="closeDealDetailsModal()" 
                                class="px-4 py-2 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 transition-colors">
                            –ó–∞–∫—Ä—ã—Ç—å
                        </button>
                    </div>
                </div>
            </div>
        </div>
    `;
    
    // Remove existing modal if any
    const existingModal = document.getElementById('dealDetailsModal');
    if (existingModal) {
        existingModal.remove();
    }
    
    // Add modal to body
    document.body.insertAdjacentHTML('beforeend', modalHtml);
    if (typeof window.lockBodyScroll === 'function') window.lockBodyScroll();
    
    // Add comment form submission handler
    document.getElementById('addCommentForm').addEventListener('submit', function(e) {
        e.preventDefault();
        addDealComment();
    });
}

// Close deal details modal
function closeDealDetailsModal() {
    const modal = document.getElementById('dealDetailsModal');
    if (modal) {
        modal.remove();
        if (typeof window.unlockBodyScroll === 'function') window.unlockBodyScroll();
    }
}

// Add comment to deal
function addDealComment() {
    const dealId = document.getElementById('detail-deal-id').value;
    const comment = document.getElementById('new-comment').value.trim();
    const csrfToken = document.querySelector('[name="csrf_token"]').value;
    
    if (!comment) {
        alert('–í–≤–µ–¥–∏—Ç–µ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π');
        return;
    }
    
    console.log('üí¨ Adding comment to deal:', { dealId, comment });
    
    const addBtn = document.getElementById('addCommentBtn');
    addBtn.disabled = true;
    addBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>–î–æ–±–∞–≤–ª—è–µ—Ç—Å—è...';
    
    fetch(`/api/deals/${dealId}`, {
        method: 'PUT',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': csrfToken
        },
        body: JSON.stringify({
            notes: comment
        })
    })
    .then(response => response.json())
    .then(data => {
        console.log('‚úÖ Comment added response:', data);
        
        if (data.success) {
            // Refresh the modal with updated data
            closeDealDetailsModal();
            viewDealDetails(dealId);
            showSuccessMessage('–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π —É—Å–ø–µ—à–Ω–æ –¥–æ–±–∞–≤–ª–µ–Ω');
        } else {
            console.error('‚ùå Failed to add comment:', data.error);
            alert('–û—à–∏–±–∫–∞: ' + (data.error || '–ù–µ —É–¥–∞–ª–æ—Å—å –¥–æ–±–∞–≤–∏—Ç—å –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π'));
        }
    })
    .catch(error => {
        console.error('‚ùå Error adding comment:', error);
        alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è');
    })
    .finally(() => {
        addBtn.disabled = false;
        addBtn.innerHTML = '<i class="fas fa-plus mr-2"></i>–î–æ–±–∞–≤–∏—Ç—å –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π';
    });
}

// Success message helper
function showSuccessMessage(message) {
    const notification = document.createElement('div');
    notification.className = 'fixed top-4 right-4 bg-green-500 text-white px-6 py-3 rounded-lg shadow-lg z-50';
    notification.innerHTML = `<i class="fas fa-check-circle mr-2"></i>${message}`;
    document.body.appendChild(notification);
    
    setTimeout(() => {
        notification.remove();
    }, 3000);
}

console.log('‚úÖ Deals modal functions defined');

// –ó–∞–≥—Ä—É–∑–∫–∞ —Å–¥–µ–ª–æ–∫ –¥–ª—è —Å—Ç–∞—Ç–∏—á–µ—Å–∫–æ–π —Å–µ–∫—Ü–∏–∏
function loadStaticDealsData() {
    console.log('üìä Loading deals for static section...');
    
    fetch('/api/deals', {
        method: 'GET',
        headers: {
            'Content-Type': 'application/json'
        }
    })
    .then(response => response.json())
    .then(data => {
        console.log('üìä Static deals data received:', data);
        updateStaticDealsSection(data);
        updateStaticDealsStats(data);
        
        // üéØ –ü–†–Ø–ú–û–ï –û–ë–ù–û–í–õ–ï–ù–ò–ï –°–ß–ï–¢–ß–ò–ö–ê –í –¢–ê–ë–ï
        if (data.success && data.deals) {
            const tabCounter = document.getElementById('deals-count');
            if (tabCounter) {
                tabCounter.textContent = data.deals.length;
                console.log(`üè∑Ô∏è DIRECT: Updated deals tab counter: ${data.deals.length}`);
            } else {
                console.warn(`‚ùå DIRECT: deals-count element not found!`);
            }
        }
    })
    .catch(error => {
        console.error('‚ùå Error loading static deals:', error);
    });
}

// –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç–∏—á–µ—Å–∫–æ–π —Å–µ–∫—Ü–∏–∏ —Å–¥–µ–ª–æ–∫
function updateStaticDealsSection(data) {
    const dealsTable = document.getElementById('deals-tbody');
    if (!dealsTable) {
        console.error('‚ùå Deals table body not found');
        return;
    }

    if (data.success && data.deals && data.deals.length > 0) {
        // –£–±–∏—Ä–∞–µ–º placeholder –∏ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–¥–µ–ª–∫–∏
        dealsTable.innerHTML = '';
        
        data.deals.forEach(deal => {
            const row = createDealRow(deal);
            dealsTable.appendChild(row);
        });
        
        console.log(`‚úÖ Loaded ${data.deals.length} deals into static section`);
        
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –ø–æ–∏—Å–∫ –ø–æ—Å–ª–µ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö
        initializeSearch();
    } else {
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º placeholder "–ù–µ—Ç —Å–¥–µ–ª–æ–∫"
        dealsTable.innerHTML = `
            <tr id="no-deals-row">
                <td colspan="8" class="px-6 py-12 text-center">
                    <div class="text-gray-400">
                        <i class="fas fa-handshake text-6xl mb-4"></i>
                        <p class="text-xl font-medium mb-2">–ù–µ—Ç —Å–¥–µ–ª–æ–∫</p>
                        <p>–°–æ–∑–¥–∞–π—Ç–µ –ø–µ—Ä–≤—É—é —Å–¥–µ–ª–∫—É —Å –∫–ª–∏–µ–Ω—Ç–æ–º</p>
                    </div>
                </td>
            </tr>
        `;
        console.log('‚ÑπÔ∏è No deals found - showing placeholder');
    }
}

// –°–æ–∑–¥–∞–Ω–∏–µ —Å—Ç—Ä–æ–∫–∏ —Ç–∞–±–ª–∏—Ü—ã –¥–ª—è —Å–¥–µ–ª–∫–∏
function createDealRow(deal) {
    const row = document.createElement('tr');
    row.className = 'hover:bg-gray-50';
    
    const statusColors = {
        'new': 'bg-yellow-100 text-yellow-800',
        'object_reserved': 'bg-blue-100 text-blue-800',
        'mortgage': 'bg-purple-100 text-purple-800',
        'successful': 'bg-green-100 text-green-800',
        'rejected': 'bg-red-100 text-red-800'
    };
    
    const statusLabels = {
        'new': '–ù–æ–≤–∞—è',
        'object_reserved': '–û–±—ä–µ–∫—Ç –∑–∞—Ä–µ–∑–µ—Ä–≤–∏—Ä–æ–≤–∞–Ω', 
        'mortgage': '–ò–ø–æ—Ç–µ–∫–∞',
        'successful': '–£—Å–ø–µ—à–Ω–∞—è',
        'rejected': '–û—Ç–∫–ª–æ–Ω–µ–Ω–∞'
    };
    
    const statusColor = statusColors[deal.status] || 'bg-gray-100 text-gray-800';
    const statusLabel = statusLabels[deal.status] || deal.status;
    
    const cashback = deal.cashback_amount ? deal.cashback_amount.toLocaleString() : '0';
    const price = deal.property_price ? deal.property_price.toLocaleString() : '0';
    
    row.innerHTML = `
        <td class="px-6 py-4 whitespace-nowrap">
            <div class="text-sm font-medium text-gray-900">#${deal.id}</div>
        </td>
        <td class="px-6 py-4 whitespace-nowrap">
            <div class="flex items-center">
                <div class="w-8 h-8 bg-gradient-to-r from-blue-500 to-purple-600 rounded-full flex items-center justify-center mr-3">
                    <span class="text-white text-xs font-medium">
                        ${deal.client_name ? deal.client_name[0] : '–ö'}
                    </span>
                </div>
                <div>
                    <div class="text-sm font-medium text-gray-900">${deal.client_name || '–ö–ª–∏–µ–Ω—Ç'}</div>
                    <div class="text-sm text-gray-500">${deal.client_email || ''}</div>
                </div>
            </div>
        </td>
        <td class="px-6 py-4 whitespace-nowrap">
            <div class="text-sm text-gray-900">${deal.complex_name || '–ù–µ —É–∫–∞–∑–∞–Ω'}</div>
        </td>
        <td class="px-6 py-4 whitespace-nowrap">
            <div class="text-sm font-medium text-gray-900">${price} ‚ÇΩ</div>
        </td>
        <td class="px-6 py-4 whitespace-nowrap">
            <div class="text-sm font-medium text-[#059669]">${cashback} ‚ÇΩ</div>
        </td>
        <td class="px-6 py-4 whitespace-nowrap">
            <span class="px-2 py-1 inline-flex text-xs leading-5 font-semibold rounded-full ${statusColor}" data-status="${deal.status}">
                ${statusLabel}
            </span>
        </td>
        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
            ${deal.created_at ? new Date(deal.created_at).toLocaleDateString('ru-RU') : '–ù–µ–¥–∞–≤–Ω–æ'}
        </td>
        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
            <div class="flex items-center space-x-2">
                <button onclick="openEditStatusModal(${deal.id}, '${deal.status}')"
                        class="text-[#059669] hover:text-[#047857] transition-colors" title="–ò–∑–º–µ–Ω–∏—Ç—å —Å—Ç–∞—Ç—É—Å">
                    <i class="fas fa-edit"></i>
                </button>
                <button onclick="viewDealDetails(${deal.id})"
                        class="text-blue-600 hover:text-blue-800 transition-colors" title="–ü–æ–¥—Ä–æ–±–Ω–æ—Å—Ç–∏">
                    <i class="fas fa-eye"></i>
                </button>
            </div>
        </td>
    `;
    
    return row;
}

// –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è –∏ –ø–æ–∏—Å–∫ —Å–¥–µ–ª–æ–∫
function applyFilters(saveToStorage = true) {
    const statusFilter = document.getElementById('status-filter').value;
    const searchInput = document.getElementById('search-deals');
    const searchTerm = searchInput ? searchInput.value.toLowerCase() : '';
    
    console.log('üîç Applying filter - Status:', statusFilter, 'Search:', searchTerm);
    
    // –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –ø–æ–∏—Å–∫–∞
    if (saveToStorage) {
        localStorage.setItem('manager_deals_status_filter', statusFilter);
        localStorage.setItem('manager_deals_search', searchTerm);
        console.log('üíæ Saved search params to localStorage');
    }
    
    const tableBody = document.querySelector('#deals-tbody');
    if (!tableBody) {
        console.error('‚ùå Table body not found: #deals-tbody');
        return;
    }
    
    const rows = tableBody.querySelectorAll('tr');
    let visibleCount = 0;
    
    rows.forEach(row => {
        // –ü—Ä–æ–ø—É—Å—Ç–∏—Ç—å —Å—Ç—Ä–æ–∫—É "–Ω–µ—Ç –¥–∞–Ω–Ω—ã—Ö"
        if (row.id === 'no-deals-row') return;
        
        const cells = row.querySelectorAll('td');
        if (cells.length === 0) return;
        
        // –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ –∏–∑ —Å—Ç—Ä–æ–∫–∏
        const dealNumber = cells[0]?.textContent?.toLowerCase() || '';
        const clientName = cells[1]?.textContent?.toLowerCase() || '';
        const complexName = cells[2]?.textContent?.toLowerCase() || '';
        
        // –ü–æ–ª—É—á–∞–µ–º —Å—Ç–∞—Ç—É—Å –∏–∑ data-–∞—Ç—Ä–∏–±—É—Ç–∞
        const statusBadge = row.querySelector('[data-status]');
        const dealStatus = statusBadge?.getAttribute('data-status') || '';
        
        // –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–∏—Å–∫–∞ (–∏—â–µ–º –ø–æ –Ω–æ–º–µ—Ä—É, –∫–ª–∏–µ–Ω—Ç—É –∏ –ñ–ö)
        const matchesSearch = !searchTerm || 
            dealNumber.includes(searchTerm) || 
            clientName.includes(searchTerm) || 
            complexName.includes(searchTerm);
        
        // –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ñ–∏–ª—å—Ç—Ä–∞ —Å—Ç–∞—Ç—É—Å–∞ (–∏—Å–ø–æ–ª—å–∑—É–µ–º data-–∞—Ç—Ä–∏–±—É—Ç!)
        const matchesStatus = !statusFilter || statusFilter === '' || 
            statusFilter === 'all' ||
            dealStatus === statusFilter;
        
        // –ü–æ–∫–∞–∑–∞—Ç—å/—Å–∫—Ä—ã—Ç—å —Å—Ç—Ä–æ–∫—É
        if (matchesSearch && matchesStatus) {
            row.style.display = '';
            visibleCount++;
        } else {
            row.style.display = 'none';
        }
    });
    
    console.log(`üìä Filtered results: ${visibleCount} deals visible out of ${rows.length}`);
}

// –û—á–∏—Å—Ç–∫–∞ —Ñ–∏–ª—å—Ç—Ä–æ–≤ –∏ –ø–æ–∏—Å–∫–∞
function clearFilters() {
    // –û—á–∏—Å—Ç–∏—Ç—å —Ñ–∏–ª—å—Ç—Ä —Å—Ç–∞—Ç—É—Å–∞
    const statusFilter = document.getElementById('status-filter');
    if (statusFilter) statusFilter.value = '';
    
    // –û—á–∏—Å—Ç–∏—Ç—å –ø–æ–ª–µ –ø–æ–∏—Å–∫–∞
    const searchInput = document.getElementById('search-deals');
    if (searchInput) searchInput.value = '';
    
    // –û—á–∏—Å—Ç–∏—Ç—å localStorage
    localStorage.removeItem('manager_deals_status_filter');
    localStorage.removeItem('manager_deals_search');
    console.log('üóëÔ∏è Cleared search params from localStorage');
    
    // –ü—Ä–∏–º–µ–Ω–∏—Ç—å —Ñ–∏–ª—å—Ç—Ä—ã (–±–µ–∑ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è, —Ç.–∫. —É–∂–µ –æ—á–∏—Å—Ç–∏–ª–∏)
    applyFilters(false);
}

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø–æ–∏—Å–∫–∞ –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏
function initializeSearch() {
    const searchInput = document.getElementById('search-deals');
    const statusFilter = document.getElementById('status-filter');
    
    // –í–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –ø–æ–∏—Å–∫–∞
    const savedStatus = localStorage.getItem('manager_deals_status_filter');
    const savedSearch = localStorage.getItem('manager_deals_search');
    
    if (savedStatus && statusFilter) {
        statusFilter.value = savedStatus;
        console.log('üìÇ Restored status filter:', savedStatus);
    }
    
    if (savedSearch && searchInput) {
        searchInput.value = savedSearch;
        console.log('üìÇ Restored search term:', savedSearch);
    }
    
    // –ü—Ä–∏–º–µ–Ω–∏—Ç—å –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—ã–µ —Ñ–∏–ª—å—Ç—Ä—ã
    if (savedStatus || savedSearch) {
        applyFilters(false); // –ù–µ —Å–æ—Ö—Ä–∞–Ω—è—Ç—å —Å–Ω–æ–≤–∞, —É–∂–µ –∑–∞–≥—Ä—É–∑–∏–ª–∏ –∏–∑ storage
    }
    
    // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—è –ø—Ä–∏ –≤–≤–æ–¥–µ —Ç–µ–∫—Å—Ç–∞
    if (searchInput) {
        searchInput.addEventListener('input', function() {
            applyFilters();
        });
        console.log('üîç Search input initialized with auto-filter');
    }
    
    // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—è –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ —Å—Ç–∞—Ç—É—Å–∞
    if (statusFilter) {
        statusFilter.addEventListener('change', function() {
            applyFilters();
        });
        console.log('üîç Status filter initialized with auto-change');
    }
}

// –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ —Å–¥–µ–ª–æ–∫
function updateStaticDealsStats(data) {
    if (!data.success || !data.deals) return;
    
    const deals = data.deals;
    const activeDeals = deals.filter(d => d.status === 'new' || d.status === 'object_reserved' || d.status === 'mortgage').length;
    const completedDeals = deals.filter(d => d.status === 'successful').length;
    const inProgressDeals = deals.filter(d => d.status === 'object_reserved' || d.status === 'mortgage').length;
    const totalCashback = deals.reduce((sum, d) => sum + (d.cashback_amount || 0), 0);
    const totalDeals = deals.length;
    
    // –û–±–Ω–æ–≤–ª—è–µ–º —Å—á—ë—Ç—á–∏–∫–∏ –≤ —Å–µ–∫—Ü–∏–∏
    const activeCount = document.getElementById('active-deals-count');
    const completedCount = document.getElementById('completed-deals-count');
    const inProgressCount = document.getElementById('in-progress-deals-count');
    const totalCashbackEl = document.getElementById('total-cashback');
    
    if (activeCount) activeCount.textContent = activeDeals;
    if (completedCount) completedCount.textContent = completedDeals;
    if (inProgressCount) inProgressCount.textContent = inProgressDeals;
    if (totalCashbackEl) totalCashbackEl.textContent = `${totalCashback.toLocaleString()} ‚ÇΩ`;
    
    // ‚úÖ –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï: –û–±–Ω–æ–≤–ª—è–µ–º —Å—á–µ—Ç—á–∏–∫ –≤ —Ç–∞–±–µ!
    const dealsTabCounter = document.getElementById('deals-count');
    console.log(`üîç Looking for deals-count element:`, dealsTabCounter);
    if (dealsTabCounter) {
        dealsTabCounter.textContent = totalDeals;
        console.log(`üè∑Ô∏è Updated deals tab counter: ${totalDeals}`);
    } else {
        console.warn(`‚ùå deals-count element not found! Available elements:`, document.querySelectorAll('[id*="deals"]'));
    }
    
    console.log(`üìä Updated deals stats: active=${activeDeals}, completed=${completedDeals}, inProgress=${inProgressDeals}, total=${totalDeals}`);
}

// –û–±—Ä–∞–±–æ—Ç–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è —Å–¥–µ–ª–∫–∏
function submitCreateDeal(event) {
    event.preventDefault();
    console.log('üìù Submitting new deal...');
    
    const form = document.getElementById('createDealForm');
    const formData = new FormData(form);
    
    const dealData = {
        client_id: formData.get('client_id'),
        residential_complex_name: formData.get('residential_complex_name'),
        property_price: parseFloat(formData.get('property_price')),
        cashback_amount: parseFloat(formData.get('cashback_amount')),
        property_description: formData.get('property_description'),
        property_floor: formData.get('property_floor') ? parseInt(formData.get('property_floor')) : null,
        property_area: formData.get('property_area') ? parseFloat(formData.get('property_area')) : null,
        property_rooms: formData.get('property_rooms'),
        notes: formData.get('notes')
    };
    
    console.log('üìù Deal data:', dealData);
    
    // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –Ω–∞ API
    fetch('/api/deals', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': formData.get('csrf_token')
        },
        body: JSON.stringify(dealData)
    })
    .then(response => response.json())
    .then(data => {
        console.log('üìù Create deal response:', data);
        
        if (data.success) {
            // –£—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω–æ - –∑–∞–∫—Ä—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –∏ –æ–±–Ω–æ–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ
            closeCreateDealModal();
            loadStaticDealsData(); // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º —Å–ø–∏—Å–æ–∫ —Å–¥–µ–ª–æ–∫
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ–± —É—Å–ø–µ—Ö–µ
            console.log('‚úÖ Deal created successfully!');
        } else {
            console.error('‚ùå Failed to create deal:', data.error);
            alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ —Å–¥–µ–ª–∫–∏: ' + (data.error || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'));
        }
    })
    .catch(error => {
        console.error('‚ùå Error creating deal:', error);
        alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ —Å–¥–µ–ª–∫–∏. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â–µ —Ä–∞–∑.');
    });
}

</script>

<!-- Modal: Create New Deal -->
<div id="createDealModal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50">
    <div class="flex items-center justify-center min-h-screen p-4">
        <div class="bg-white rounded-lg max-w-2xl w-full max-h-[90vh] overflow-y-auto">
            <div class="flex items-center justify-between p-6 border-b">
                <h3 class="text-lg font-semibold text-gray-900">–°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—É—é —Å–¥–µ–ª–∫—É</h3>
                <button onclick="closeCreateDealModal()" class="text-gray-400 hover:text-gray-600 transition-colors">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
            
            <form id="createDealForm" class="p-6 space-y-6" onsubmit="submitCreateDeal(event)">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                
                <!-- Client Selection -->
                <div>
                    <label for="client_id" class="block text-sm font-medium text-gray-700 mb-2">
                        –ö–ª–∏–µ–Ω—Ç <span class="text-red-500">*</span>
                    </label>
                    <select id="client_id" name="client_id" required
                            class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[#0088CC] focus:border-transparent">
                        <option value="">–ó–∞–≥—Ä—É–∑–∫–∞ –∫–ª–∏–µ–Ω—Ç–æ–≤...</option>
                    </select>
                </div>

                <!-- Residential Complex Name -->
                <div>
                    <label for="residential_complex_name" class="block text-sm font-medium text-gray-700 mb-2">
                        –ñ–∏–ª–æ–π –∫–æ–º–ø–ª–µ–∫—Å <span class="text-red-500">*</span>
                    </label>
                    <input type="text" id="residential_complex_name" name="residential_complex_name" required
                           placeholder="–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –ñ–ö (–Ω–∞–ø—Ä–∏–º–µ—Ä: –ñ–ö –õ–µ—Ç–Ω–∏–π)"
                           class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[#0088CC] focus:border-transparent">
                </div>

                <!-- Property Price -->
                <div>
                    <label for="property_price" class="block text-sm font-medium text-gray-700 mb-2">
                        –°—Ç–æ–∏–º–æ—Å—Ç—å –æ–±—ä–µ–∫—Ç–∞ (‚ÇΩ) <span class="text-red-500">*</span>
                    </label>
                    <input type="number" id="property_price" name="property_price" required
                           min="100000" step="10000" placeholder="3500000"
                           class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[#0088CC] focus:border-transparent">
                </div>

                <!-- Cashback Amount -->
                <div>
                    <label for="cashback_amount" class="block text-sm font-medium text-gray-700 mb-2">
                        –°—É–º–º–∞ –∫–µ—à–±–µ–∫–∞ (‚ÇΩ) <span class="text-red-500">*</span>
                    </label>
                    <input type="number" id="cashback_amount" name="cashback_amount" required
                           min="0" step="1000" placeholder="87500"
                           class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[#0088CC] focus:border-transparent">
                    <p class="text-sm text-gray-500 mt-1">–û–±—ã—á–Ω–æ 2-5% –æ—Ç —Å—Ç–æ–∏–º–æ—Å—Ç–∏ –æ–±—ä–µ–∫—Ç–∞</p>
                </div>

                <!-- Property Description -->
                <div>
                    <label for="property_description" class="block text-sm font-medium text-gray-700 mb-2">
                        –û–ø–∏—Å–∞–Ω–∏–µ –æ–±—ä–µ–∫—Ç–∞
                    </label>
                    <textarea id="property_description" name="property_description" rows="3"
                              placeholder="–ö–≤–∞—Ä—Ç–∏—Ä–∞ —Å –æ—Ç–¥–µ–ª–∫–æ–π, –ø–∞–Ω–æ—Ä–∞–º–Ω—ã–µ –æ–∫–Ω–∞, —Ö–æ—Ä–æ—à–∞—è –ø–ª–∞–Ω–∏—Ä–æ–≤–∫–∞..."
                              class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[#0088CC] focus:border-transparent resize-none"></textarea>
                </div>

                <!-- Property Details Grid -->
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div>
                        <label for="property_floor" class="block text-sm font-medium text-gray-700 mb-2">
                            –≠—Ç–∞–∂
                        </label>
                        <input type="number" id="property_floor" name="property_floor" 
                               min="1" max="50" placeholder="5"
                               class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[#0088CC] focus:border-transparent">
                    </div>
                    
                    <div>
                        <label for="property_area" class="block text-sm font-medium text-gray-700 mb-2">
                            –ü–ª–æ—â–∞–¥—å (–º¬≤)
                        </label>
                        <input type="number" id="property_area" name="property_area" 
                               min="10" step="0.1" placeholder="65.5"
                               class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[#0088CC] focus:border-transparent">
                    </div>
                    
                    <div>
                        <label for="property_rooms" class="block text-sm font-medium text-gray-700 mb-2">
                            –ö–æ–º–Ω–∞—Ç
                        </label>
                        <select id="property_rooms" name="property_rooms"
                                class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[#0088CC] focus:border-transparent">
                            <option value="">–ù–µ —É–∫–∞–∑–∞–Ω–æ</option>
                            <option value="—Å—Ç—É–¥–∏—è">–°—Ç—É–¥–∏—è</option>
                            <option value="1">1 –∫–æ–º–Ω–∞—Ç–∞</option>
                            <option value="2">2 –∫–æ–º–Ω–∞—Ç—ã</option>
                            <option value="3">3 –∫–æ–º–Ω–∞—Ç—ã</option>
                            <option value="4">4 –∫–æ–º–Ω–∞—Ç—ã</option>
                            <option value="5+">5+ –∫–æ–º–Ω–∞—Ç</option>
                        </select>
                    </div>
                </div>

                <!-- Notes -->
                <div>
                    <label for="notes" class="block text-sm font-medium text-gray-700 mb-2">
                        –ó–∞–º–µ—Ç–∫–∏ –º–µ–Ω–µ–¥–∂–µ—Ä–∞
                    </label>
                    <textarea id="notes" name="notes" rows="2"
                              placeholder="–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –∑–∞–º–µ—Ç–∫–∏ –æ —Å–¥–µ–ª–∫–µ..."
                              class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[#0088CC] focus:border-transparent resize-none"></textarea>
                </div>

                <!-- Action Buttons -->
                <div class="flex justify-end space-x-4 pt-4 border-t">
                    <button type="button" onclick="closeCreateDealModal()" 
                            class="px-6 py-2 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 transition-colors">
                        –û—Ç–º–µ–Ω–∞
                    </button>
                    <button type="submit" id="createDealBtn"
                            class="px-6 py-2 bg-[#0088CC] text-white rounded-lg hover:bg-[#0077BB] transition-colors">
                        <i class="fas fa-plus mr-2"></i>–°–æ–∑–¥–∞—Ç—å —Å–¥–µ–ª–∫—É
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Modal: Edit Status -->
<div id="editStatusModal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50">
    <div class="flex items-center justify-center min-h-screen p-4">
        <div class="bg-white rounded-lg max-w-lg w-full">
            <div class="flex items-center justify-between p-6 border-b">
                <h3 class="text-lg font-semibold text-gray-900">–ò–∑–º–µ–Ω–∏—Ç—å —Å—Ç–∞—Ç—É—Å —Å–¥–µ–ª–∫–∏</h3>
                <button onclick="closeEditStatusModal()" class="text-gray-400 hover:text-gray-600 transition-colors">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
            
            <form id="editStatusForm" class="p-6 space-y-4">
                <input type="hidden" id="edit-deal-id" name="deal_id">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                
                <div>
                    <label for="edit-status" class="block text-sm font-medium text-gray-700 mb-2">
                        –ù–æ–≤—ã–π —Å—Ç–∞—Ç—É—Å <span class="text-red-500">*</span>
                    </label>
                    <select id="edit-status" name="status" required
                            class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[#0088CC] focus:border-transparent">
                        <option value="new">–ù–æ–≤–∞—è</option>
                        <option value="object_reserved">–û–±—ä–µ–∫—Ç –∑–∞—Ä–µ–∑–µ—Ä–≤–∏—Ä–æ–≤–∞–Ω</option>
                        <option value="mortgage">–ò–ø–æ—Ç–µ–∫–∞</option>
                        <option value="successful">–£—Å–ø–µ—à–Ω–∞—è</option>
                        <option value="rejected">–û—Ç–∫–ª–æ–Ω–µ–Ω–∞</option>
                    </select>
                </div>
                
                <div>
                    <label for="status-notes" class="block text-sm font-medium text-gray-700 mb-2">
                        –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –∫ –∏–∑–º–µ–Ω–µ–Ω–∏—é
                    </label>
                    <textarea id="status-notes" name="status_notes" rows="3"
                              placeholder="–ü—Ä–∏—á–∏–Ω–∞ –∏–∑–º–µ–Ω–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–∞..."
                              class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[#0088CC] focus:border-transparent resize-none"></textarea>
                </div>

                <div class="flex justify-end space-x-4 pt-4 border-t">
                    <button type="button" onclick="closeEditStatusModal()" 
                            class="px-6 py-2 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 transition-colors">
                        –û—Ç–º–µ–Ω–∞
                    </button>
                    <button type="submit" id="updateStatusBtn"
                            class="px-6 py-2 bg-[#0088CC] text-white rounded-lg hover:bg-[#0077BB] transition-colors">
                        <i class="fas fa-save mr-2"></i>–û–±–Ω–æ–≤–∏—Ç—å —Å—Ç–∞—Ç—É—Å
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>


{% endblock %}