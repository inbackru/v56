<!DOCTYPE html>
<html lang="ru" data-page="presentation">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ presentation.title }} - InBack.ru</title>
    <meta name="description" content="Персональная подборка недвижимости">
    
    <!-- Cache Control -->
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    
    <!-- External Resources -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <script src="https://api-maps.yandex.ru/2.1/?apikey={{ config.get('YANDEX_MAPS_API_KEY', '') }}&lang=ru_RU&load=package.standard" type="text/javascript"></script>
    
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Manrope:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --primary-blue: #0088cc;
            --primary-blue-dark: #006699;
            --text-dark: #1a1a1a;
            --text-gray: #666666;
            --text-light: #999999;
            --text-muted: #b0b0b0;
            --bg-white: #ffffff;
            --bg-light: #f8fafc;
            --bg-tertiary: #e2e8f0;
            --border: #e2e8f0;
            --shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1);
            --shadow-lg: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Manrope', -apple-system, BlinkMacSystemFont, sans-serif;
            line-height: 1.6;
            color: var(--text-dark);
            background: var(--bg-light);
        }
        
        .container {
            max-width: 800px;
            margin: 0 auto;
            padding: 2rem 1rem;
        }
        
        /* Header */
        .header {
            text-align: center;
            margin-bottom: 3rem;
            padding: 2rem 0;
            background: var(--bg-white);
            border-radius: 12px;
            box-shadow: var(--shadow);
        }
        
        .header h1 {
            font-size: 2rem;
            font-weight: 600;
            color: var(--text-dark);
            margin-bottom: 0.5rem;
        }
        
        .header p {
            font-size: 1.125rem;
            color: var(--text-gray);
            font-weight: 400;
        }
        
        /* Property List */
        .property-list {
            display: flex;
            flex-direction: column;
            gap: 2rem;
        }
        
        .property-item {
            background: var(--bg-white);
            border-radius: 16px;
            box-shadow: var(--shadow-lg);
            border: 1px solid var(--border);
            transition: all 0.3s ease;
            overflow: hidden;
            position: relative;
        }
        
        .property-item:hover {
            transform: translateY(-4px);
            box-shadow: 0 12px 35px -8px rgba(0, 0, 0, 0.15);
        }
        
        /* Expanded Card Styles */
        .expanded-card {
            padding: 0;
        }
        
        /* Property Number Badge */
        .property-number-badge {
            position: absolute;
            top: 1rem;
            left: 1rem;
            width: 48px;
            height: 48px;
            background: linear-gradient(135deg, var(--primary-blue), var(--primary-blue-dark));
            color: white;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            font-weight: 700;
            z-index: 10;
            box-shadow: 0 4px 12px rgba(0, 136, 204, 0.3);
        }
        
        /* Photo Slider Styles */
        .property-photo-slider {
            height: 280px;
            position: relative;
            overflow: hidden;
            background: var(--bg-light);
        }
        
        .slider-container {
            position: relative;
            width: 100%;
            height: 100%;
        }
        
        .slides-wrapper {
            position: relative;
            width: 100%;
            height: 100%;
        }
        
        .slide {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            opacity: 0;
            transition: opacity 0.5s ease-in-out;
            background: var(--bg-light);
        }
        
        .slide.active {
            opacity: 1;
        }
        
        .slide img {
            width: 100%;
            height: 100%;
            object-fit: contain;
            background: var(--bg-light);
        }
        
        .slider-btn {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            width: 40px;
            height: 40px;
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(10px);
            border: none;
            border-radius: 50%;
            color: var(--text-dark);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            transition: all 0.2s ease;
            z-index: 10;
        }
        
        .slider-btn:hover {
            background: white;
            transform: translateY(-50%) scale(1.1);
        }
        
        .prev-btn {
            left: 12px;
        }
        
        .next-btn {
            right: 12px;
        }
        
        .slider-dots {
            position: absolute;
            bottom: 12px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            gap: 8px;
            z-index: 10;
        }
        
        .dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            border: none;
            background: rgba(255, 255, 255, 0.5);
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .dot.active {
            background: white;
            width: 24px;
            border-radius: 4px;
        }
        
        .no-image-placeholder {
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            background: linear-gradient(135deg, var(--bg-light), var(--bg-tertiary));
            color: var(--text-muted);
            font-size: 3rem;
        }
        
        .image-overlay {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            background: linear-gradient(180deg, rgba(0,0,0,0) 0%, rgba(0,0,0,0.7) 100%);
            padding: 1.5rem;
        }
        
        .property-price-overlay {
            color: white;
            text-align: left;
        }
        
        .property-price-overlay .price-amount {
            font-size: 2rem;
            font-weight: 700;
            margin-bottom: 0.5rem;
            text-shadow: 0 2px 4px rgba(0,0,0,0.3);
        }
        
        .cashback-badge-overlay {
            background: rgba(255, 255, 255, 0.2);
            backdrop-filter: blur(10px);
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 8px;
            font-size: 0.875rem;
            font-weight: 600;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        /* Property Content Grid */
        .property-content-grid {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 2rem;
            padding: 2rem;
        }
        
        /* Main Info Section */
        .property-main-info {
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
        }
        
        .property-title {
            font-size: 1.5rem;
            font-weight: 600;
            color: var(--text-dark);
            line-height: 1.3;
        }
        
        .property-complex {
            font-size: 1.125rem;
            color: var(--primary-blue);
            font-weight: 500;
        }
        
        .property-address {
            font-size: 0.95rem;
            color: var(--text-gray);
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        /* Quick Stats */
        .property-quick-stats {
            display: flex;
            flex-wrap: wrap;
            gap: 1rem;
        }
        
        .stat-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem 1rem;
            background: var(--bg-light);
            border-radius: 8px;
            font-size: 0.875rem;
            color: var(--text-dark);
            font-weight: 500;
        }
        
        .stat-item i {
            color: var(--primary-blue);
        }
        
        /* Complex Details Preview */
        .complex-details-preview {
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
            padding: 1.5rem;
            background: var(--bg-light);
            border-radius: 12px;
            border-left: 4px solid var(--primary-blue);
        }
        
        .detail-preview {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            font-size: 0.9rem;
            color: var(--text-dark);
        }
        
        .detail-preview i {
            color: var(--primary-blue);
            width: 16px;
            text-align: center;
        }
        
        .detail-preview strong {
            font-weight: 600;
        }
        
        /* Visual Section */
        .property-visual-section {
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
        }
        
        /* Mini Map */
        .mini-map-container {
            position: relative;
        }
        
        .mini-map {
            height: 140px;
            border-radius: 8px;
            overflow: hidden;
            border: 1px solid var(--border);
        }
        
        .map-label {
            position: absolute;
            bottom: 8px;
            left: 8px;
            background: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 0.25rem 0.75rem;
            border-radius: 4px;
            font-size: 0.75rem;
            font-weight: 500;
        }
        
        /* Photo Gallery Preview */
        .photo-gallery-preview {
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
        }
        
        .gallery-label {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.875rem;
            font-weight: 600;
            color: var(--text-dark);
        }
        
        .gallery-label i {
            color: var(--primary-blue);
        }
        
        .gallery-preview-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 0.5rem;
        }
        
        .gallery-preview-item {
            aspect-ratio: 4/3;
            border-radius: 6px;
            overflow: hidden;
            cursor: pointer;
            transition: transform 0.2s ease;
        }
        
        .gallery-preview-item:hover {
            transform: scale(1.05);
        }
        
        .gallery-preview-item img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .gallery-more {
            aspect-ratio: 4/3;
            background: var(--bg-light);
            border: 2px dashed var(--border);
            border-radius: 6px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s ease;
            color: var(--text-gray);
        }
        
        .gallery-more:hover {
            background: var(--bg-tertiary);
            border-color: var(--primary-blue);
            color: var(--primary-blue);
        }
        
        .gallery-more span {
            font-size: 1.25rem;
            font-weight: 600;
        }
        
        .gallery-more small {
            font-size: 0.75rem;
        }
        
        /* Expanded Action Buttons */
        .property-actions-expanded {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            border-top: 1px solid var(--border);
        }
        
        .btn.expanded {
            border-radius: 0;
            border: none;
            border-right: 1px solid var(--border);
            padding: 1rem;
            min-width: auto;
            flex-direction: column;
            gap: 0.5rem;
        }
        
        .btn.expanded:last-child {
            border-right: none;
        }
        
        .btn.expanded i {
            font-size: 1.125rem;
        }
        
        .btn.expanded span {
            font-size: 0.875rem;
            font-weight: 500;
        }
        
        /* Mobile Responsive Styles */
        @media (max-width: 768px) {
            .presentation-container {
                padding: 1rem;
                margin: 0;
            }
            
            .header h1 {
                font-size: 1.75rem;
            }
            
            .header-subtitle {
                font-size: 1rem;
            }
            
            .property-list {
                gap: 1.5rem;
            }
            
            .property-main-image {
                height: 200px;
            }
            
            .property-content-grid {
                grid-template-columns: 1fr;
                gap: 1.5rem;
                padding: 1.5rem;
            }
            
            .property-visual-section {
                order: -1;
            }
            
            .mini-map {
                height: 120px;
            }
            
            .property-quick-stats {
                justify-content: center;
            }
            
            .stat-item {
                font-size: 0.8rem;
                padding: 0.4rem 0.8rem;
            }
            
            .gallery-preview-grid {
                grid-template-columns: repeat(3, 1fr);
            }
            
            .property-actions-expanded {
                grid-template-columns: 1fr;
            }
            
            .btn.expanded {
                border-right: none;
                border-bottom: 1px solid var(--border);
                flex-direction: row;
                justify-content: center;
                gap: 0.75rem;
                padding: 1.25rem;
            }
            
            .btn.expanded:last-child {
                border-bottom: none;
            }
            
            .complex-details-preview {
                padding: 1rem;
            }
        }
        
        @media (max-width: 480px) {
            .presentation-container {
                padding: 0.75rem;
            }
            
            .header h1 {
                font-size: 1.5rem;
            }
            
            .property-content-grid {
                padding: 1rem;
            }
            
            .property-title {
                font-size: 1.25rem;
            }
            
            .property-quick-stats {
                flex-direction: column;
                gap: 0.5rem;
            }
            
            .stat-item {
                justify-content: center;
                width: 100%;
            }
            
            .gallery-preview-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }
        
        .property-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 1.5rem;
            gap: 2rem;
        }
        
        .property-number {
            font-size: 2.5rem;
            font-weight: 700;
            color: var(--primary-blue);
            line-height: 1;
            flex-shrink: 0;
        }
        
        .property-info {
            flex: 1;
        }
        
        .property-title {
            font-size: 1.25rem;
            font-weight: 600;
            color: var(--text-dark);
            margin-bottom: 0.5rem;
        }
        
        .property-complex {
            font-size: 1rem;
            color: var(--text-gray);
            margin-bottom: 0.75rem;
        }
        
        .property-address {
            font-size: 0.875rem;
            color: var(--text-light);
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .property-price {
            text-align: right;
            flex-shrink: 0;
        }
        
        .price-amount {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--text-dark);
            margin-bottom: 0.25rem;
        }
        
        .price-per-sqm {
            font-size: 0.875rem;
            color: var(--text-gray);
            margin-bottom: 0.5rem;
        }
        
        .cashback-badge {
            background: linear-gradient(135deg, var(--primary-blue), var(--primary-blue-dark));
            color: white;
            padding: 0.25rem 0.75rem;
            border-radius: 6px;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }
        
        .property-details {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 1rem;
            margin-bottom: 2rem;
            padding: 1.5rem;
            background: var(--bg-light);
            border-radius: 12px;
        }
        
        .detail-item {
            text-align: center;
        }
        
        .detail-label {
            font-size: 0.75rem;
            color: var(--text-light);
            text-transform: uppercase;
            letter-spacing: 0.05em;
            font-weight: 500;
            margin-bottom: 0.25rem;
        }
        
        .detail-value {
            font-size: 1rem;
            color: var(--text-dark);
            font-weight: 600;
        }
        
        /* Action Buttons */
        .property-actions {
            display: flex;
            gap: 1rem;
            flex-wrap: wrap;
        }
        
        .btn {
            padding: 0.4rem 0.75rem;
            border-radius: 6px;
            font-size: 0.8125rem;
            font-weight: 500;
            text-decoration: none;
            text-align: center;
            cursor: pointer;
            border: none;
            transition: all 0.2s ease;
            flex: none;
            min-width: auto;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.35rem;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, var(--primary-blue), var(--primary-blue-dark));
            color: white;
        }
        
        .btn-primary:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(0, 136, 204, 0.3);
        }
        
        .btn-secondary {
            background: var(--bg-light);
            color: var(--text-gray);
            border: 1px solid var(--border);
        }
        
        .btn-secondary:hover {
            background: var(--bg-white);
            color: var(--text-dark);
            border-color: var(--text-gray);
        }
        
        /* Modals */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            padding: 2rem;
        }
        
        .modal.active {
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .modal-content {
            background: var(--bg-white);
            border-radius: 16px;
            max-width: 600px;
            width: 100%;
            max-height: 80vh;
            overflow-y: auto;
            position: relative;
        }
        
        .modal-header {
            padding: 2rem 2rem 0;
            border-bottom: 1px solid var(--border);
            margin-bottom: 2rem;
        }
        
        .modal-title {
            font-size: 1.5rem;
            font-weight: 600;
            color: var(--text-dark);
            margin-bottom: 1rem;
        }
        
        .modal-close {
            position: absolute;
            top: 1rem;
            right: 1rem;
            background: none;
            border: none;
            font-size: 1.5rem;
            color: var(--text-gray);
            cursor: pointer;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 8px;
        }
        
        .modal-close:hover {
            background: var(--bg-light);
            color: var(--text-dark);
        }
        
        .modal-body {
            padding: 0 2rem 2rem;
        }
        
        /* Photo Gallery */
        .photo-gallery {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 1rem;
            margin: 1rem 0;
        }
        
        .photo-item {
            aspect-ratio: 4/3;
            border-radius: 8px;
            overflow: hidden;
            cursor: pointer;
            transition: transform 0.2s ease;
        }
        
        .photo-item:hover {
            transform: scale(1.02);
        }
        
        .photo-item img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        /* Map Container */
        .map-container {
            height: 300px;
            border-radius: 8px;
            overflow: hidden;
            margin: 1rem 0;
        }
        
        /* Responsive Design */
        @media (max-width: 768px) {
            .container {
                padding: 1rem;
            }
            
            .header h1 {
                font-size: 1.5rem;
            }
            
            .header p {
                font-size: 1rem;
            }
            
            .property-item {
                padding: 1.5rem;
            }
            
            .property-header {
                flex-direction: column;
                gap: 1rem;
                text-align: center;
            }
            
            .property-number {
                font-size: 2rem;
                align-self: center;
            }
            
            .property-price {
                text-align: center;
            }
            
            .property-details {
                grid-template-columns: repeat(2, 1fr);
                gap: 0.75rem;
            }
            
            .property-actions {
                flex-direction: column;
            }
            
            .btn {
                min-width: auto;
            }
            
            .modal {
                padding: 1rem;
            }
            
            .modal-content {
                max-height: 90vh;
            }
            
            .modal-header,
            .modal-body {
                padding-left: 1.5rem;
                padding-right: 1.5rem;
            }
        }
        
        /* Progress Bar Animations */
        @keyframes shine {
            0% { left: -100%; }
            100% { left: 100%; }
        }
        
        #progressContainer {
            animation: slideDown 0.4s ease-out;
        }
        
        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        /* Complex Modal Styles */
        .complex-modal-content {
            max-height: 80vh;
            overflow-y: auto;
            padding: 0.5rem;
        }
        
        .complex-section {
            margin-bottom: 2rem;
            padding: 1.5rem;
            background: var(--bg-light);
            border-radius: 12px;
            border: 1px solid var(--border);
        }
        
        .complex-section h4 {
            font-size: 1.25rem;
            font-weight: 600;
            margin-bottom: 1.5rem;
            color: var(--primary-blue);
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .complex-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1rem;
        }
        
        .complex-item {
            padding: 0.75rem;
            background: var(--bg-white);
            border-radius: 8px;
            border: 1px solid rgba(0, 0, 0, 0.05);
        }
        
        /* Price Section */
        .price-section {
            background: linear-gradient(135deg, #f8faff 0%, #e3f2ff 100%);
            border: 2px solid var(--primary-blue);
        }
        
        .price-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
        }
        
        .price-item {
            padding: 1rem;
            background: var(--bg-white);
            border-radius: 12px;
            text-align: center;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }
        
        .price-label {
            font-size: 0.875rem;
            color: var(--text-gray);
            margin-bottom: 0.5rem;
        }
        
        .price-value {
            font-size: 1.25rem;
            font-weight: 700;
            color: var(--text-dark);
        }
        
        .main-price .price-value {
            font-size: 1.5rem;
            color: var(--primary-blue);
        }
        
        .cashback-item {
            background: linear-gradient(135deg, #f1f9ff 0%, #e0f2fe 100%);
            border: 2px solid var(--primary-blue);
        }
        
        .cashback-value {
            color: var(--primary-blue-dark) !important;
        }
        
        /* Amenities */
        .amenities-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 0.75rem;
        }
        
        .amenity-item {
            padding: 0.75rem;
            background: var(--bg-white);
            border-radius: 8px;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            border: 1px solid rgba(0, 0, 0, 0.05);
        }
        
        .amenity-item i {
            color: var(--primary-blue);
        }
        
        /* Photo Gallery Complex */
        .photo-gallery-complex {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 1rem;
        }
        
        .photo-item-complex {
            position: relative;
            aspect-ratio: 1;
            border-radius: 12px;
            overflow: hidden;
            cursor: pointer;
            transition: transform 0.3s ease;
        }
        
        .photo-item-complex:hover {
            transform: scale(1.05);
        }
        
        .photo-item-complex img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .photo-overlay {
            position: absolute;
            inset: 0;
            background: rgba(0, 0, 0, 0.4);
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        
        .photo-item-complex:hover .photo-overlay {
            opacity: 1;
        }
        
        .photo-overlay i {
            color: white;
            font-size: 1.5rem;
        }
        
        .photo-more {
            display: flex;
            align-items: center;
            justify-content: center;
            background: var(--bg-gray);
            border-radius: 12px;
            font-weight: 600;
            color: var(--text-gray);
        }
        
        /* Photo Viewer Modal */
        .photo-viewer-modal {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.95);
            z-index: 10000;
            display: none;
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        
        .photo-viewer-modal.active {
            display: flex;
            opacity: 1;
        }
        
        .photo-viewer-content {
            position: relative;
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }
        
        .photo-viewer-close {
            position: absolute;
            top: 2rem;
            right: 2rem;
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
            font-size: 2rem;
            width: 3rem;
            height: 3rem;
            border-radius: 50%;
            cursor: pointer;
            z-index: 10001;
            transition: background 0.3s ease;
        }
        
        .photo-viewer-close:hover {
            background: rgba(255, 255, 255, 0.3);
        }
        
        .photo-nav {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
            font-size: 3rem;
            width: 4rem;
            height: 4rem;
            border-radius: 50%;
            cursor: pointer;
            z-index: 10001;
            transition: background 0.3s ease;
        }
        
        .photo-nav:hover {
            background: rgba(255, 255, 255, 0.3);
        }
        
        .photo-nav-prev {
            left: 2rem;
        }
        
        .photo-nav-next {
            right: 2rem;
        }
        
        .photo-viewer-main {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 4rem;
        }
        
        .photo-viewer-main img {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
            border-radius: 8px;
        }
        
        .photo-viewer-counter {
            position: absolute;
            bottom: 8rem;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 20px;
            font-weight: 600;
        }
        
        .photo-viewer-thumbnails {
            position: absolute;
            bottom: 1rem;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            gap: 0.5rem;
            max-width: 90%;
            overflow-x: auto;
            padding: 1rem;
        }
        
        .photo-thumbnail {
            flex-shrink: 0;
            width: 60px;
            height: 60px;
            border-radius: 8px;
            overflow: hidden;
            cursor: pointer;
            border: 2px solid transparent;
            transition: border-color 0.3s ease;
        }
        
        .photo-thumbnail.active {
            border-color: var(--primary-blue);
        }
        
        .photo-thumbnail img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        /* Mobile Responsive for Complex Modal */
        @media (max-width: 768px) {
            .complex-grid {
                grid-template-columns: 1fr;
            }
            
            .price-grid {
                grid-template-columns: 1fr;
            }
            
            .photo-viewer-main {
                padding: 2rem;
            }
            
            .photo-nav {
                width: 3rem;
                height: 3rem;
                font-size: 2rem;
            }
            
            .photo-nav-prev {
                left: 1rem;
            }
            
            .photo-nav-next {
                right: 1rem;
            }
            
            .photo-viewer-thumbnails {
                max-width: 95%;
            }
        }
        
        /* Compact Action Buttons - Modern Design */
        .property-actions-expanded {
            display: flex;
            gap: 0.5rem;
            padding: 1rem;
            justify-content: center;
            flex-wrap: wrap;
            border-top: 1px solid var(--border);
            background: var(--bg-light);
        }
        
        .btn.expanded {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            padding: 8px 12px;
            border-radius: 8px;
            font-size: 0.875rem;
            font-weight: 500;
            border: 1px solid transparent;
            cursor: pointer;
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            min-width: auto;
            flex: none;
            gap: 0.5rem;
            text-decoration: none;
            color: #64748b;
            background: white;
            border-color: #e2e8f0;
            box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
        }
        
        .btn.expanded:hover {
            color: #0088cc;
            background: #f1f9ff;
            border-color: #0088cc;
            transform: translateY(-1px);
            box-shadow: 0 2px 4px 0 rgba(0, 136, 204, 0.1);
        }
        
        .btn.expanded:active {
            transform: translateY(0);
        }
        
        .btn.expanded i {
            font-size: 0.875rem;
        }
        
        /* Remove old button styles overrides */
        .btn.expanded.btn-primary {
            background: white;
            color: #64748b;
            border-color: #e2e8f0;
        }
        
        .btn.expanded.btn-primary:hover {
            color: #0088cc;
            background: #f1f9ff;
            border-color: #0088cc;
        }
        
        .btn.expanded.btn-secondary {
            background: white;
            color: #64748b;
            border-color: #e2e8f0;
        }
        
        .btn.expanded.btn-secondary:hover {
            color: #0088cc;
            background: #f1f9ff;
            border-color: #0088cc;
        }
        
        /* Mobile responsive for compact buttons */
        @media (max-width: 640px) {
            .property-actions-expanded {
                gap: 0.25rem;
                padding: 0.75rem;
            }
            
            .btn.expanded {
                padding: 6px 10px;
                font-size: 0.8125rem;
                min-width: auto;
            }
            
            .btn.expanded span {
                display: none;
            }
            
            .btn.expanded i {
                margin: 0;
            }
        }
    </style>
</head>
<script>window.SKIP_MAIN_JS = true;</script>
<body data-page="presentation">
    <div class="container">
        <!-- Header -->
        <header class="header">
            {% set unique_complexes = properties | map(attribute='complex_name') | select | unique | list %}
            <h1>Подобрали для вас {{ properties|length }} {{ "квартиру" if properties|length == 1 else ("квартиры" if properties|length < 5 else "квартир") }} в {{ unique_complexes|length or 1 }} {{ "комплексе" if unique_complexes|length == 1 else ("комплексах" if unique_complexes|length < 5 else "комплексах") }}</h1>
            <p>{{ presentation.title }} • {{ presentation.created_at.strftime('%d.%m.%Y') }}</p>
            
            <!-- Action Buttons -->
            <div style="margin-top: 20px; display: flex; gap: 15px; flex-wrap: wrap;">
                <button id="downloadAllBtn" onclick="downloadAllPresentationPDF('{{ presentation.title }}')" 
                        class="btn" 
                        style="background: linear-gradient(135deg, #10B981 0%, #059669 100%); color: white; padding: 12px 24px; border-radius: 8px; border: none; font-weight: 600; box-shadow: 0 4px 12px rgba(16, 185, 129, 0.25); cursor: pointer; display: inline-flex; align-items: center; gap: 8px; font-size: 16px;">
                    <i class="fas fa-download"></i>
                    <span id="downloadBtnText">Скачать все квартиры в PDF</span>
                </button>
                
                <!-- Progress Bar Container (Hidden by default) -->
                <div id="progressContainer" style="display: none; width: 100%; margin-top: 20px; padding: 20px; background: linear-gradient(135deg, #F0F9FF 0%, #E0F2FE 100%); border-radius: 12px; border: 2px solid #0284C7; box-shadow: 0 4px 12px rgba(2, 132, 199, 0.15);">
                    <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 15px;">
                        <div style="width: 20px; height: 20px;">
                            <i id="progressIcon" class="fas fa-cog fa-spin" style="color: #0369A1; font-size: 20px;"></i>
                        </div>
                        <div>
                            <div id="progressMessage" style="font-weight: 600; color: #0F172A; font-size: 16px;">Подготавливаем файлы...</div>
                            <div id="progressDetails" style="color: #64748B; font-size: 14px; margin-top: 2px;"></div>
                        </div>
                    </div>
                    
                    <!-- Progress Bar -->
                    <div style="background: #CBD5E1; border-radius: 10px; height: 12px; overflow: hidden; position: relative;">
                        <div id="progressBar" 
                             style="background: linear-gradient(90deg, #0EA5E9, #0284C7); height: 100%; width: 0%; border-radius: 10px; transition: width 0.6s cubic-bezier(0.4, 0, 0.2, 1); position: relative;">
                            <!-- Animated shine effect -->
                            <div style="position: absolute; top: 0; left: -100%; width: 100%; height: 100%; background: linear-gradient(90deg, transparent, rgba(255,255,255,0.4), transparent); animation: shine 2s infinite;"></div>
                        </div>
                    </div>
                    
                    <!-- Progress Percentage -->
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 8px;">
                        <div id="progressPercent" style="font-weight: 600; color: #0369A1; font-size: 14px;">0%</div>
                        <div id="progressStatus" style="color: #64748B; font-size: 14px;"></div>
                    </div>
                </div>
                
                <button onclick="sharePresentation()" 
                        class="btn" 
                        style="background: linear-gradient(135deg, #3B82F6 0%, #1D4ED8 100%); color: white; padding: 12px 24px; border-radius: 8px; border: none; font-weight: 600; box-shadow: 0 4px 12px rgba(59, 130, 246, 0.25); cursor: pointer; display: inline-flex; align-items: center; gap: 8px; font-size: 16px;">
                    <i class="fas fa-share-alt"></i>
                    Поделиться ссылкой
                </button>
            </div>
            
            <!-- Manager Note -->
            {% if presentation and presentation.manager_note %}
            <div style="margin-top: 20px; padding: 16px; background: linear-gradient(135deg, #FEF3C7 0%, #FCD34D 20%); border-radius: 12px; border-left: 4px solid #F59E0B;">
                <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
                    <i class="fas fa-comment-alt" style="color: #D97706;"></i>
                    <strong style="color: #92400E; font-weight: 600;">Комментарий менеджера</strong>
                </div>
                <p style="margin: 0; color: #92400E; font-weight: 500; line-height: 1.5;">{{ presentation.manager_note }}</p>
            </div>
            {% endif %}
        </header>
        
        <!-- Property List -->
        <main class="property-list">
            {% for property in properties %}
            <article class="property-item expanded-card">
                <!-- Property Number Badge -->
                <div class="property-number-badge">{{ loop.index }}</div>
                
                <!-- Photo Slider Section -->
                <div class="property-photo-slider">
                    {% if property.images and property.images|length > 0 %}
                        <div class="slider-container">
                            <div class="slides-wrapper">
                                {% for image in property.images[:10] %}
                                <div class="slide {{ 'active' if loop.first else '' }}">
                                    <img src="{{ image }}" alt="Фото {{ loop.index }}" loading="lazy">
                                </div>
                                {% endfor %}
                            </div>
                            
                            <!-- Navigation -->
                            {% if property.images|length > 1 %}
                            <button class="slider-btn prev-btn" onclick="changeSlide({{ loop.index }}, -1)" aria-label="Предыдущее фото">
                                <i class="fas fa-chevron-left"></i>
                            </button>
                            <button class="slider-btn next-btn" onclick="changeSlide({{ loop.index }}, 1)" aria-label="Следующее фото">
                                <i class="fas fa-chevron-right"></i>
                            </button>
                            
                            <!-- Dots indicator -->
                            <div class="slider-dots">
                                {% for image in property.images[:10] %}
                                <button class="dot {{ 'active' if loop.first else '' }}" onclick="currentSlide({{ loop.index }}, {{ loop.index0 }})" aria-label="Фото {{ loop.index }}"></button>
                                {% endfor %}
                            </div>
                            {% endif %}
                        </div>
                    {% else %}
                    <div class="no-image-placeholder">
                        <i class="fas fa-home"></i>
                    </div>
                    {% endif %}
                </div>
                
                <!-- Property Content Grid -->
                <div class="property-content-grid">
                    <!-- Left Column: Main Info -->
                    <div class="property-main-info">
                        <div class="property-title">
                            {{ property.title }}
                        </div>
                        
                        {% if property.complex_name %}
                        <div class="property-complex">{{ property.complex_name }}</div>
                        {% endif %}
                        
                        {% if property.address %}
                        <div class="property-address">
                            <i class="fas fa-map-marker-alt"></i>
                            {{ property.address }}
                        </div>
                        {% endif %}
                        
                        <!-- Quick Stats -->
                        <div class="property-quick-stats">
                            {% if property.area %}
                            <div class="stat-item">
                                <i class="fas fa-expand"></i>
                                <span>{{ property.area }} м²</span>
                            </div>
                            {% endif %}
                            
                            {% if property.floor and property.total_floors %}
                            <div class="stat-item">
                                <i class="fas fa-layer-group"></i>
                                <span>{{ property.floor }}/{{ property.total_floors }} этаж</span>
                            </div>
                            {% endif %}
                            
                            {% if property.finishing and property.finishing != 'Не указана' %}
                            <div class="stat-item">
                                <i class="fas fa-paint-roller"></i>
                                <span>{{ property.finishing }}</span>
                            </div>
                            {% elif property.renovation %}
                            <div class="stat-item">
                                <i class="fas fa-paint-roller"></i>
                                <span>{{ property.renovation }}</span>
                            </div>
                            {% endif %}
                            
                            <!-- Стоимость и кэшбэк -->
                            {% if property.price %}
                            <div class="stat-item price-stat">
                                <i class="fas fa-ruble-sign"></i>
                                <span>{{ "{:,}".format(property.price|default(0)).replace(",", " ") }} ₽</span>
                            </div>
                            {% endif %}
                            
                            {% if property.cashback or property.cashback_amount %}
                            <div class="stat-item cashback-stat">
                                <i class="fas fa-gift"></i>
                                <span>Кэшбэк {{ "{:,}".format(property.cashback or property.cashback_amount).replace(",", " ") }} ₽</span>
                            </div>
                            {% endif %}
                            
                            {% if property.completion_date and property.completion_date != 'Не указана' and property.completion_date != 'Уточняется' %}
                            <div class="stat-item">
                                <i class="fas fa-calendar-check"></i>
                                <span>{{ property.completion_date }}</span>
                            </div>
                            {% endif %}
                            
                            {% if property.price_per_sqm %}
                            <div class="stat-item">
                                <i class="fas fa-ruble-sign"></i>
                                <span>{{ "{:,}".format(property.price_per_sqm).replace(",", " ") }} ₽/м²</span>
                            </div>
                            {% endif %}
                        </div>
                        
                        <!-- Complex Details -->
                        {% if property.completion_date or property.developer %}
                        <div class="complex-details-preview">
                            {% if property.completion_date and property.completion_date != 'Не указана' %}
                            <div class="detail-preview">
                                <i class="fas fa-calendar"></i>
                                <strong>Срок сдачи:</strong> {{ property.completion_date }}
                            </div>
                            {% endif %}
                            
                            {% if property.developer or property.developer_name %}
                            <div class="detail-preview">
                                <i class="fas fa-industry"></i>
                                <strong>Застройщик:</strong> {{ property.developer or property.developer_name }}
                            </div>
                            {% endif %}
                        </div>
                        {% endif %}
                        
                        <!-- Manager Comment for this Property -->
                        {% if property.manager_note %}
                        <div class="property-manager-comment" style="margin-top: 16px; padding: 14px; background: linear-gradient(135deg, #E0F2FE 0%, #BAE6FD 20%); border-radius: 10px; border-left: 4px solid #0284C7;">
                            <div style="display: flex; align-items: center; gap: 6px; margin-bottom: 6px;">
                                <i class="fas fa-comment-dots" style="color: #0369A1; font-size: 14px;"></i>
                                <strong style="color: #0F172A; font-weight: 600; font-size: 14px;">Комментарий менеджера</strong>
                            </div>
                            <p style="margin: 0; color: #1E293B; font-weight: 500; line-height: 1.4; font-size: 14px;">{{ property.manager_note }}</p>
                        </div>
                        {% endif %}
                    </div>
                    
                    <!-- Right Column: Visual Elements -->
                    <div class="property-visual-section">
                        <!-- Mini Map -->
                        {% if (property.property_info and property.property_info.coordinates and property.property_info.coordinates.lat != 45.0448) or (property.latitude and property.latitude != 0) %}
                        <div class="mini-map-container">
                            <div class="mini-map" id="miniMap-{{ loop.index0 }}"></div>
                            <div class="map-label">Расположение</div>
                        </div>
                        {% endif %}
                        
                        <!-- Photo Gallery Preview -->
                        {% if property.images and property.images|length > 1 %}
                        <div class="photo-gallery-preview">
                            <div class="gallery-label">
                                <i class="fas fa-images"></i>
                                Фото ({{ property.images|length }})
                            </div>
                            <div class="gallery-preview-grid">
                                {% for photo in property.images[1:4] %}
                                <div class="gallery-preview-item" onclick="openPropertyPhotoViewer({{ loop.index0 }}, {{ loop.index }})">
                                    <img src="{{ photo }}" alt="Фото {{ loop.index + 1 }}" loading="lazy">
                                </div>
                                {% endfor %}
                                {% if property.images|length > 4 %}
                                <div class="gallery-more" onclick="openPropertyPhotoViewer({{ loop.index0 }}, 0)">
                                    <span>+{{ property.images|length - 4 }}</span>
                                    <small>ещё</small>
                                </div>
                                {% endif %}
                            </div>
                        </div>
                        {% endif %}
                    </div>
                </div>
                
                <!-- Action Buttons -->
                <div class="property-actions-expanded">
                    <button class="btn btn-primary expanded" onclick="openReservationModal({{ loop.index0 }})">
                        <i class="fas fa-calendar-check"></i>
                        <span>Забронировать</span>
                    </button>
                    <button class="btn btn-secondary expanded" onclick="openComplexModal({{ loop.index0 }})">
                        <i class="fas fa-building"></i>
                        <span>О комплексе</span>
                    </button>
                    <button class="btn btn-secondary expanded" onclick="openApartmentModal({{ loop.index0 }})">
                        <i class="fas fa-home"></i>
                        <span>Подробнее</span>
                    </button>
                </div>
            </article>
            {% endfor %}
        </main>
    </div>
    
    <!-- Reservation Modal -->
    <div class="modal" id="reservationModal">
        <div class="modal-content">
            <button class="modal-close" onclick="closeModal('reservationModal')">×</button>
            <div class="modal-header">
                <h3 class="modal-title">Бронирование квартиры</h3>
            </div>
            <div class="modal-body">
                <div id="reservationContent">
                    <p>Для бронирования этой квартиры свяжитесь с нашим менеджером:</p>
                    <div style="text-align: center; margin: 2rem 0;">
                        <p style="font-size: 1.125rem; font-weight: 600; margin-bottom: 0.5rem;">Телефон: +7 (861) 123-45-67</p>
                        <p style="font-size: 1rem; color: var(--text-gray);">Email: manager@inback.ru</p>
                    </div>
                    <div style="display: flex; gap: 1rem; justify-content: center; margin-top: 2rem;">
                        <a href="tel:+78611234567" class="btn btn-primary">
                            <i class="fas fa-phone"></i>
                            Позвонить
                        </a>
                        <a href="mailto:manager@inback.ru" class="btn btn-secondary">
                            <i class="fas fa-envelope"></i>
                            Написать
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Complex Modal -->
    <div class="modal" id="complexModal">
        <div class="modal-content">
            <button class="modal-close" onclick="closeModal('complexModal')">×</button>
            <div class="modal-header">
                <h3 class="modal-title" id="complexModalTitle">О жилом комплексе</h3>
            </div>
            <div class="modal-body" id="complexModalBody">
                <!-- Content will be filled by JavaScript -->
            </div>
        </div>
    </div>
    
    <!-- Apartment Modal -->
    <div class="modal" id="apartmentModal">
        <div class="modal-content">
            <button class="modal-close" onclick="closeModal('apartmentModal')">×</button>
            <div class="modal-header">
                <h3 class="modal-title" id="apartmentModalTitle">О квартире</h3>
            </div>
            <div class="modal-body" id="apartmentModalBody">
                <!-- Content will be filled by JavaScript -->
            </div>
        </div>
    </div>

    <script>
        // Property data for JavaScript
        const properties = [
            {% for property in properties %}
            {
                id: {{ property.id | tojson | safe }},
                title: {{ (property.title or 'Квартира') | tojson | safe }},
                rooms: {{ property.rooms or 0 }},
                area: {{ property.area or property.size or 0 }},
                price: {{ property.price or 0 }},
                price_per_sqm: {{ property.price_per_sqm or 0 }},
                floor: {{ property.floor or 0 }},
                total_floors: {{ property.total_floors or 0 }},
                address: {{ (property.address or '') | tojson | safe }},
                complex_name: {{ (property.complex_name or '') | tojson | safe }},
                developer: {{ (property.developer or property.developer_name or '') | tojson | safe }},
                completion_date: {{ (property.completion_date or '') | tojson | safe }},
                cashback: {{ property.cashback or property.cashback_amount or 0 }},
                coordinates: {
                    lat: {{ property.property_info.coordinates.lat if property.property_info and property.property_info.coordinates else (property.latitude if property.latitude != 0 else 45.0448) }},
                    lng: {{ property.property_info.coordinates.lng if property.property_info and property.property_info.coordinates else (property.longitude if property.longitude != 0 else 38.976) }}
                },
                images: {{ property.images | tojson | safe }},
                complex_photos: {{ (property.complex.photos if property.complex else (property.complex_info.photos if property.complex_info else [])) | tojson | safe }},
                description: {{ (property.description or '') | tojson | safe }}
            }{% if not loop.last %},{% endif %}
            {% endfor %}
        ];
        
        let currentMap = null;
        let miniMaps = {};
        
        // Mini Map Initialization with Yandex Maps
        function initializeMiniMaps() {
            console.log('🗺️ Starting Yandex mini-maps initialization...');
            
            // Wait for Yandex Maps API to be ready
            ymaps.ready(() => {
                properties.forEach((property, index) => {
                    const mapId = `miniMap-${index}`;
                    const mapContainer = document.getElementById(mapId);
                    
                    console.log(`🗺️ Processing property ${index}: mapId=${mapId}, container=${!!mapContainer}, coords=${property.coordinates.lat},${property.coordinates.lng}`);
                    
                    if (!mapContainer) {
                        console.log(`⚠️ No container found for ${mapId}`);
                        return;
                    }
                    
                    if (miniMaps[mapId]) {
                        console.log(`⚠️ Map already exists for ${mapId}`);
                        return;
                    }
                    
                    if (property.coordinates.lat === 45.0448 || property.coordinates.lat === 0) {
                        console.log(`⚠️ Invalid coordinates for ${mapId}: lat=${property.coordinates.lat}`);
                        return;
                    }
                    
                    try {
                        console.log(`🗺️ Creating Yandex map for ${mapId} at [${property.coordinates.lat}, ${property.coordinates.lng}]`);
                        
                        const miniMap = new ymaps.Map(mapId, {
                            center: [property.coordinates.lat, property.coordinates.lng],
                            zoom: 14,
                            controls: [] // Remove all controls for mini map
                        }, {
                            // Disable all interactions for mini map
                            scrollZoom: false,
                            dblClickZoom: false,
                            drag: false,
                            rightMouseButtonMagnifier: false,
                            leftMouseButtonMagnifier: false,
                            multiTouch: false
                        });

                        // Add placemark (marker)
                        const placemark = new ymaps.Placemark([property.coordinates.lat, property.coordinates.lng], {
                            hintContent: property.address || 'Объект недвижимости'
                        }, {
                            preset: 'islands#redDotIcon'
                        });
                        
                        miniMap.geoObjects.add(placemark);

                        miniMaps[mapId] = miniMap;
                        console.log(`✅ Yandex mini map created successfully for ${mapId}`);
                        
                        // Click to expand in modal
                        mapContainer.style.cursor = 'pointer';
                        mapContainer.onclick = () => openComplexModal(index);
                        
                    } catch (error) {
                        console.error(`❌ Error initializing Yandex mini map ${mapId}:`, error);
                    }
                });
                
                console.log(`🗺️ Yandex mini-maps initialization completed. Created ${Object.keys(miniMaps).length} maps.`);
            });
        }
        
        // Modal functions
        function openReservationModal(index) {
            document.getElementById('reservationModal').classList.add('active');
        }
        
        function openComplexModal(index) {
            const property = properties[index];
            const complex = property.complex_info || {};
            const modal = document.getElementById('complexModal');
            const title = document.getElementById('complexModalTitle');
            const body = document.getElementById('complexModalBody');
            
            title.textContent = property.complex_name || 'Жилой комплекс';
            
            let content = `
                <div class="complex-modal-content">
                    <!-- Основная информация -->
                    <div class="complex-section">
                        <h4><i class="fas fa-info-circle"></i> Основная информация</h4>
                        <div class="complex-grid">
                            ${property.developer ? `<div class="complex-item"><strong>Застройщик:</strong> ${property.developer}</div>` : ''}
                            ${property.address ? `<div class="complex-item"><strong>Адрес:</strong> ${property.address}</div>` : ''}
                            ${property.completion_date ? `<div class="complex-item"><strong>Срок сдачи:</strong> ${property.completion_date}</div>` : ''}
                            ${property.complex_class ? `<div class="complex-item"><strong>Класс жилья:</strong> ${property.complex_class}</div>` : ''}
                            ${property.finishing ? `<div class="complex-item"><strong>Отделка:</strong> ${property.finishing}</div>` : ''}
                            ${property.renovation_type && property.renovation_type !== 'no_renovation' ? `<div class="complex-item"><strong>Тип ремонта:</strong> ${property.renovation_type}</div>` : ''}
                        </div>
                    </div>

                    <!-- Стоимость и кешбек -->
                    <div class="complex-section price-section">
                        <h4><i class="fas fa-ruble-sign"></i> Стоимость и выгода</h4>
                        <div class="price-grid">
                            <div class="price-item main-price">
                                <div class="price-label">Стоимость квартиры</div>
                                <div class="price-value">${property.price ? property.price.toLocaleString('ru-RU') + ' ₽' : 'Уточняйте'}</div>
                            </div>
                            ${property.price_per_sqm ? `
                                <div class="price-item">
                                    <div class="price-label">За м²</div>
                                    <div class="price-value">${property.price_per_sqm.toLocaleString('ru-RU')} ₽</div>
                                </div>
                            ` : ''}
                            ${property.cashback_available && property.cashback ? `
                                <div class="price-item cashback-item">
                                    <div class="price-label"><i class="fas fa-gift"></i> Кешбек InBack</div>
                                    <div class="price-value cashback-value">${property.cashback.toLocaleString('ru-RU')} ₽</div>
                                </div>
                            ` : ''}
                        </div>
                    </div>

                    <!-- Характеристики квартиры -->
                    <div class="complex-section">
                        <h4><i class="fas fa-home"></i> Характеристики квартиры</h4>
                        <div class="complex-grid">
                            ${property.type ? `<div class="complex-item"><strong>Тип:</strong> ${property.type}</div>` : ''}
                            ${property.size ? `<div class="complex-item"><strong>Площадь:</strong> ${property.size} м²</div>` : ''}
                            ${property.floor ? `<div class="complex-item"><strong>Этаж:</strong> ${property.floor}</div>` : ''}
                            ${property.total_floors ? `<div class="complex-item"><strong>Этажность:</strong> ${property.total_floors}</div>` : ''}
                            ${property.finishing ? `<div class="complex-item"><strong>Отделка:</strong> ${property.finishing}</div>` : ''}
                            ${property.complex_class ? `<div class="complex-item"><strong>Класс жилья:</strong> ${property.complex_class}</div>` : ''}
                            ${property.completion_date ? `<div class="complex-item"><strong>Срок сдачи:</strong> ${property.completion_date}</div>` : ''}
                            ${property.status ? `<div class="complex-item"><strong>Статус:</strong> ${property.status}</div>` : ''}
                            ${property.building || property.building_name ? `<div class="complex-item"><strong>Корпус:</strong> ${property.building || property.building_name}</div>` : ''}
                            ${property.apartment_number ? `<div class="complex-item"><strong>Номер квартиры:</strong> ${property.apartment_number}</div>` : ''}
                            ${property.balcony ? `<div class="complex-item"><strong>Балкон:</strong> Есть</div>` : ''}
                            ${property.ceiling_height && property.ceiling_height > 0 ? `<div class="complex-item"><strong>Высота потолков:</strong> ${property.ceiling_height} м</div>` : ''}
                            ${property.kitchen_area && property.kitchen_area > 0 ? `<div class="complex-item"><strong>Площадь кухни:</strong> ${property.kitchen_area} м²</div>` : ''}
                            ${property.living_area && property.living_area > 0 ? `<div class="complex-item"><strong>Жилая площадь:</strong> ${property.living_area} м²</div>` : ''}
                            ${property.windows_direction ? `<div class="complex-item"><strong>Окна на:</strong> ${property.windows_direction}</div>` : ''}
                            ${property.view ? `<div class="complex-item"><strong>Вид из окна:</strong> ${property.view}</div>` : ''}
                        </div>
                    </div>

                    <!-- Описание комплекса -->
                    ${complex.description ? `
                        <div class="complex-section">
                            <h4><i class="fas fa-align-left"></i> О комплексе</h4>
                            <div class="complex-description">${complex.description}</div>
                        </div>
                    ` : ''}

                    <!-- Инфраструктура -->
                    ${complex.amenities && complex.amenities.length > 0 ? `
                        <div class="complex-section">
                            <h4><i class="fas fa-map-marked-alt"></i> Инфраструктура</h4>
                            <div class="amenities-grid">
                                ${complex.amenities.map(amenity => `<div class="amenity-item"><i class="fas fa-check"></i> ${amenity}</div>`).join('')}
                            </div>
                        </div>
                    ` : ''}
            `;
            
            // Добавляем фотографии с полным просмотром
            const allPhotos = [
                ...(property.images || []),
                ...(complex.photos || []),
                ...(property.complex_photos || [])
            ];
            
            // Сохраняем фото для просмотрщика
            currentComplexPhotos = allPhotos;
            
            if (allPhotos.length > 0) {
                content += `
                    <div class="complex-section">
                        <h4><i class="fas fa-images"></i> Фотогалерея</h4>
                        <div class="photo-gallery-complex">
                            ${allPhotos.slice(0, 12).map((photo, idx) => 
                                `<div class="photo-item-complex" onclick="openPhotoViewerFromGallery(${idx})">
                                    <img src="${photo}" alt="Фото" loading="lazy">
                                    <div class="photo-overlay">
                                        <i class="fas fa-search-plus"></i>
                                    </div>
                                </div>`
                            ).join('')}
                            ${allPhotos.length > 12 ? `<div class="photo-more">+${allPhotos.length - 12} ещё</div>` : ''}
                        </div>
                    </div>
                `;
            }
            
            // Добавляем карту
            if (property.coordinates.lat !== 45.0448) {
                content += `
                    <div class="complex-section">
                        <h4><i class="fas fa-map-marker-alt"></i> Расположение</h4>
                        <div id="complexMap" class="map-container"></div>
                    </div>
                `;
            }
            
            content += `</div>`; // Закрываем complex-modal-content
            
            body.innerHTML = content;
            modal.classList.add('active');
            
            // Инициализируем карту
            if (property.coordinates.lat !== 45.0448) {
                setTimeout(() => initializeModalMap('complexMap', property), 100);
            }
        }
        
        function openApartmentModal(index) {
            const property = properties[index];
            console.log('🔍 Opening property details for:', property);
            
            // Переход на страницу объекта недвижимости
            let propertyId = property.property_id || property.id;
            if (propertyId) {
                window.open(`/object/${propertyId}`, '_blank');
            } else {
                console.error('Property ID not found for property:', property);
                alert('Не удалось найти ID объекта для просмотра деталей');
            }
        }
        
        function closeModal(modalId) {
            document.getElementById(modalId).classList.remove('active');
            
            // Destroy Yandex map if exists
            if (currentMap) {
                currentMap.destroy();
                currentMap = null;
            }
        }
        
        function initializeModalMap(containerId, property) {
            console.log(`🗺️ Initializing Yandex modal map for ${containerId}`);
            
            ymaps.ready(() => {
                try {
                    if (currentMap) {
                        currentMap.destroy();
                        currentMap = null;
                    }
                    
                    currentMap = new ymaps.Map(containerId, {
                        center: [property.coordinates.lat, property.coordinates.lng],
                        zoom: 15,
                        controls: ['zoomControl', 'fullscreenControl']
                    }, {
                        scrollZoom: true,
                        dblClickZoom: true,
                        drag: true
                    });
                    
                    // Add placemark with balloon
                    const placemark = new ymaps.Placemark([property.coordinates.lat, property.coordinates.lng], {
                        balloonContentHeader: property.complex_name || property.title,
                        balloonContentBody: property.address || 'Объект недвижимости',
                        balloonContentFooter: `<div style="margin-top: 8px; font-size: 12px; color: #666;">
                            ${property.developer ? `Застройщик: ${property.developer}` : ''}
                        </div>`,
                        hintContent: property.complex_name || 'Объект недвижимости'
                    }, {
                        preset: 'islands#redDotIcon',
                        iconColor: '#ff6b35'
                    });
                    
                    currentMap.geoObjects.add(placemark);
                    
                    // Open balloon by default
                    setTimeout(() => {
                        placemark.balloon.open();
                    }, 500);
                    
                    console.log(`✅ Yandex modal map created successfully for ${containerId}`);
                    
                } catch (error) {
                    console.error('❌ Error initializing Yandex modal map:', error);
                }
            });
        }
        
        // Close modal on outside click
        document.addEventListener('click', function(e) {
            if (e.target.classList.contains('modal')) {
                e.target.classList.remove('active');
                if (currentMap) {
                    currentMap.destroy();
                    currentMap = null;
                }
            }
        });
        
        // Photo viewer functionality
        let currentPhotoIndex = 0;
        let currentPhotoGallery = [];
        let currentComplexPhotos = [];
        
        function openPhotoViewer(photos, startIndex = 0) {
            currentPhotoGallery = photos;
            currentPhotoIndex = startIndex;
            showPhotoViewer();
        }
        
        function showPhotoViewer() {
            const photoViewer = document.getElementById('photoViewer');
            if (!photoViewer) {
                createPhotoViewer();
            }
            updatePhotoViewer();
            document.getElementById('photoViewer').classList.add('active');
        }
        
        function createPhotoViewer() {
            const viewer = document.createElement('div');
            viewer.id = 'photoViewer';
            viewer.className = 'photo-viewer-modal';
            viewer.innerHTML = `
                <div class="photo-viewer-content">
                    <button class="photo-viewer-close" onclick="closePhotoViewer()">×</button>
                    <button class="photo-nav photo-nav-prev" onclick="prevPhoto()">‹</button>
                    <button class="photo-nav photo-nav-next" onclick="nextPhoto()">›</button>
                    <div class="photo-viewer-main">
                        <img id="photoViewerImage" src="" alt="Фото">
                    </div>
                    <div class="photo-viewer-counter">
                        <span id="photoCounter">1 / 1</span>
                    </div>
                    <div class="photo-viewer-thumbnails" id="photoThumbnails"></div>
                </div>
            `;
            document.body.appendChild(viewer);
        }
        
        function updatePhotoViewer() {
            const image = document.getElementById('photoViewerImage');
            const counter = document.getElementById('photoCounter');
            const thumbnails = document.getElementById('photoThumbnails');
            
            if (!image || !counter || !thumbnails) return;
            
            image.src = currentPhotoGallery[currentPhotoIndex];
            counter.textContent = `${currentPhotoIndex + 1} / ${currentPhotoGallery.length}`;
            
            // Update thumbnails
            thumbnails.innerHTML = currentPhotoGallery.map((photo, index) => 
                `<div class="photo-thumbnail ${index === currentPhotoIndex ? 'active' : ''}" 
                      onclick="jumpToPhoto(${index})">
                    <img src="${photo}" alt="Миниатюра">
                </div>`
            ).join('');
        }
        
        function closePhotoViewer() {
            document.getElementById('photoViewer').classList.remove('active');
        }
        
        function prevPhoto() {
            currentPhotoIndex = (currentPhotoIndex - 1 + currentPhotoGallery.length) % currentPhotoGallery.length;
            updatePhotoViewer();
        }
        
        function nextPhoto() {
            currentPhotoIndex = (currentPhotoIndex + 1) % currentPhotoGallery.length;
            updatePhotoViewer();
        }
        
        function jumpToPhoto(index) {
            currentPhotoIndex = index;
            updatePhotoViewer();
        }
        
        function openPhotoViewerFromGallery(index) {
            openPhotoViewer(currentComplexPhotos, index);
        }
        
        function openPropertyPhotoViewer(propertyIndex, photoIndex) {
            const property = properties[propertyIndex];
            if (property && property.images && property.images.length > 0) {
                openPhotoViewer(property.images, photoIndex);
            }
        }

        // Close modal on Escape key
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                document.querySelectorAll('.modal.active').forEach(modal => {
                    modal.classList.remove('active');
                });
                if (document.getElementById('photoViewer')?.classList.contains('active')) {
                    closePhotoViewer();
                }
                if (currentMap) {
                    currentMap.destroy();
                    currentMap = null;
                }
            }
            if (document.getElementById('photoViewer')?.classList.contains('active')) {
                if (e.key === 'ArrowLeft') prevPhoto();
                if (e.key === 'ArrowRight') nextPhoto();
            }
        });
        
        console.log('✅ Reference-style presentation initialized with', properties.length, 'properties');
        console.log('🔍 Property data sample:', properties[0]);
        console.log('📷 Images available:', properties[0].images?.length || 0);
        console.log('🏢 Complex photos:', properties[0].complex_photos?.length || 0);
        console.log('🗺️ Coordinates:', properties[0].coordinates);
        
        // Initialize mini maps immediately (DOM is already loaded)
        setTimeout(() => {
            console.log('🗺️ Initializing mini maps...');
            initializeMiniMaps();
        }, 1000);
        
        // Photo Slider Functions
        let currentSlides = {};
        
        function changeSlide(propertyIndex, direction) {
            const propertyCard = document.querySelector(`.property-item:nth-child(${propertyIndex})`);
            const slides = propertyCard.querySelectorAll('.slide');
            const dots = propertyCard.querySelectorAll('.dot');
            
            if (!slides.length || slides.length <= 1) return;
            
            // Initialize currentSlides if not exists
            if (!currentSlides[propertyIndex]) {
                currentSlides[propertyIndex] = 0;
            }
            
            // Hide current slide
            slides[currentSlides[propertyIndex]].classList.remove('active');
            dots[currentSlides[propertyIndex]].classList.remove('active');
            
            // Calculate new index
            currentSlides[propertyIndex] += direction;
            if (currentSlides[propertyIndex] >= slides.length) {
                currentSlides[propertyIndex] = 0;
            } else if (currentSlides[propertyIndex] < 0) {
                currentSlides[propertyIndex] = slides.length - 1;
            }
            
            // Show new slide
            slides[currentSlides[propertyIndex]].classList.add('active');
            dots[currentSlides[propertyIndex]].classList.add('active');
        }
        
        function currentSlide(propertyIndex, slideIndex) {
            const propertyCard = document.querySelector(`.property-item:nth-child(${propertyIndex})`);
            const slides = propertyCard.querySelectorAll('.slide');
            const dots = propertyCard.querySelectorAll('.dot');
            
            if (!slides.length || slideIndex >= slides.length) return;
            
            // Hide all slides
            slides.forEach(slide => slide.classList.remove('active'));
            dots.forEach(dot => dot.classList.remove('active'));
            
            // Show selected slide
            slides[slideIndex].classList.add('active');
            dots[slideIndex].classList.add('active');
            
            currentSlides[propertyIndex] = slideIndex;
        }
        
        // Download All PDF Function with Progress Bar and SSE
        function downloadAllPresentationPDF(title) {
            // Extract unique_id from current URL path
            const pathParts = window.location.pathname.split('/');
            const uniqueId = pathParts[pathParts.length - 1]; // Last part of URL is unique_id
            
            console.log(`🔥 Starting downloadAllPresentationPDF with progress for unique_id: ${uniqueId}`);
            
            const downloadBtn = document.getElementById('downloadAllBtn');
            const downloadBtnText = document.getElementById('downloadBtnText');
            const progressContainer = document.getElementById('progressContainer');
            const progressBar = document.getElementById('progressBar');
            const progressPercent = document.getElementById('progressPercent');
            const progressMessage = document.getElementById('progressMessage');
            const progressDetails = document.getElementById('progressDetails');
            const progressStatus = document.getElementById('progressStatus');
            const progressIcon = document.getElementById('progressIcon');
            
            const originalText = downloadBtnText.textContent;
            
            // Hide button and show progress bar
            downloadBtn.style.display = 'none';
            progressContainer.style.display = 'block';
            
            // Reset progress bar state
            progressBar.style.width = '0%';
            progressPercent.textContent = '0%';
            progressMessage.textContent = 'Подготавливаем файлы...';
            progressDetails.textContent = '';
            progressStatus.textContent = '';
            progressIcon.className = 'fas fa-cog fa-spin';
            
            // Start the actual download immediately (this will trigger progress updates)
            const downloadFrame = document.createElement('iframe');
            downloadFrame.style.display = 'none';
            downloadFrame.src = `/presentation/view/${uniqueId}/download-all`;
            document.body.appendChild(downloadFrame);
            
            // Small delay then start monitoring progress
            setTimeout(() => {
                // Connect to Server-Sent Events for progress updates
                const eventSource = new EventSource(`/presentation/view/${uniqueId}/progress`);
                
                eventSource.onmessage = function(event) {
                try {
                    const data = JSON.parse(event.data);
                    console.log('📊 Progress update:', data);
                    
                    if (data.error) {
                        console.error('❌ Error:', data.error);
                        showProgressError(data.error);
                        return;
                    }
                    
                    // Update progress bar
                    if (data.progress !== undefined) {
                        progressBar.style.width = data.progress + '%';
                        progressPercent.textContent = data.progress + '%';
                    }
                    
                    // Update messages based on stage
                    if (data.stage === 'starting') {
                        progressMessage.textContent = data.message || 'Начинаем создание PDF файлов...';
                        progressDetails.textContent = `Всего объектов: ${data.total}`;
                        progressIcon.className = 'fas fa-cog fa-spin';
                    } else if (data.stage === 'processing') {
                        progressMessage.textContent = data.message || `Создаю PDF ${data.current} из ${data.total}`;
                        progressDetails.textContent = `Обрабатывается квартира ${data.current} из ${data.total}`;
                        progressStatus.textContent = `${data.current}/${data.total}`;
                        progressIcon.className = 'fas fa-file-pdf fa-spin';
                    } else if (data.stage === 'completing') {
                        progressMessage.textContent = data.message || 'Создаю архив...';
                        progressDetails.textContent = 'Упаковываю все файлы в ZIP архив';
                        progressStatus.textContent = 'Финализация';
                        progressIcon.className = 'fas fa-archive fa-pulse';
                    } else if (data.stage === 'complete') {
                        progressMessage.textContent = data.message || 'Готово!';
                        progressDetails.textContent = 'Файл загружается в ваш браузер';
                        progressStatus.textContent = 'Завершено';
                        progressIcon.className = 'fas fa-check-circle';
                        progressIcon.style.color = '#10B981';
                        
                        // Close the event source
                        eventSource.close();
                        
                        // Hide progress bar after successful download
                        setTimeout(() => {
                            resetDownloadButton();
                        }, 3000);
                    }
                } catch (error) {
                    console.error('❌ Error parsing progress data:', error);
                    showProgressError('Ошибка обработки данных');
                }
            };
            
                eventSource.onerror = function(error) {
                    console.error('❌ SSE Error:', error);
                    eventSource.close();
                    showProgressError('Ошибка соединения с сервером');
                };
                
                // Helper function to show error
                function showProgressError(errorMessage) {
                    progressMessage.textContent = 'Произошла ошибка';
                    progressDetails.textContent = errorMessage;
                    progressStatus.textContent = 'Ошибка';
                    progressIcon.className = 'fas fa-exclamation-triangle';
                    progressIcon.style.color = '#EF4444';
                    progressBar.style.background = '#EF4444';
                    
                    // Reset after 5 seconds
                    setTimeout(() => {
                        resetDownloadButton();
                    }, 5000);
                }
                
                // Helper function to reset button state
                function resetDownloadButton() {
                    progressContainer.style.display = 'none';
                    downloadBtn.style.display = 'inline-flex';
                    downloadBtn.style.opacity = '1';
                    downloadBtn.style.cursor = 'pointer';
                    downloadBtn.disabled = false;
                    downloadBtnText.innerHTML = `<i class="fas fa-download"></i> ${originalText.replace(/^.*?\s/, '')}`;
                    
                    // Reset progress bar colors
                    progressBar.style.background = 'linear-gradient(90deg, #0EA5E9, #0284C7)';
                    progressIcon.style.color = '#0369A1';
                }
                
            }, 500); // Close setTimeout - 500ms delay
        }
        
        // Share Presentation Function
        function sharePresentation() {
            const currentUrl = window.location.href;
            
            // Try to use Web Share API if available (mobile browsers)
            if (navigator.share) {
                navigator.share({
                    title: 'Презентация недвижимости',
                    text: 'Посмотрите подобранные для вас квартиры',
                    url: currentUrl
                }).then(() => {
                    console.log('Successful share');
                }).catch((error) => {
                    console.log('Error sharing:', error);
                    fallbackShare(currentUrl);
                });
            } else {
                // Fallback: copy to clipboard
                fallbackShare(currentUrl);
            }
        }
        
        function fallbackShare(url) {
            // Copy to clipboard
            if (navigator.clipboard) {
                navigator.clipboard.writeText(url).then(() => {
                    showShareSuccess('Ссылка скопирована в буфер обмена!');
                }).catch(() => {
                    showShareFallback(url);
                });
            } else {
                showShareFallback(url);
            }
        }
        
        function showShareFallback(url) {
            // Create modal with shareable link
            const modal = document.createElement('div');
            modal.innerHTML = `
                <div style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 10000; display: flex; align-items: center; justify-content: center;">
                    <div style="background: white; padding: 30px; border-radius: 12px; max-width: 500px; margin: 20px; box-shadow: 0 20px 40px rgba(0,0,0,0.2);">
                        <h3 style="margin: 0 0 15px 0; font-size: 20px; color: #333;">Поделиться презентацией</h3>
                        <p style="margin: 0 0 15px 0; color: #666; font-size: 14px;">Скопируйте ссылку и отправьте клиенту:</p>
                        <div style="display: flex; gap: 10px; margin-bottom: 20px;">
                            <input type="text" value="${url}" readonly style="flex: 1; padding: 12px; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 14px; background: #f9fafb;">
                            <button onclick="copyUrlFromModal('${url}')" style="padding: 12px 20px; background: #3B82F6; color: white; border: none; border-radius: 8px; font-weight: 600; cursor: pointer;">
                                <i class="fas fa-copy"></i> Копировать
                            </button>
                        </div>
                        <button onclick="this.parentElement.parentElement.remove()" style="width: 100%; padding: 12px; background: #6B7280; color: white; border: none; border-radius: 8px; font-weight: 600; cursor: pointer;">
                            Закрыть
                        </button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }
        
        function copyUrlFromModal(url) {
            navigator.clipboard.writeText(url).then(() => {
                showShareSuccess('Ссылка скопирована!');
                // Close modal
                setTimeout(() => {
                    const modal = document.querySelector('[style*="position: fixed"]');
                    if (modal) modal.remove();
                }, 1000);
            });
        }
        
        function showShareSuccess(message) {
            // Show toast notification
            const toast = document.createElement('div');
            toast.innerHTML = `
                <div style="position: fixed; top: 20px; right: 20px; background: #10B981; color: white; padding: 15px 25px; border-radius: 8px; box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3); z-index: 10001; display: flex; align-items: center; gap: 10px; font-weight: 600;">
                    <i class="fas fa-check-circle"></i>
                    ${message}
                </div>
            `;
            document.body.appendChild(toast);
            
            // Remove toast after 3 seconds
            setTimeout(() => {
                toast.remove();
            }, 3000);
        }
    </script>
</body>
</html>