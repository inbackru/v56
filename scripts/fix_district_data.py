#!/usr/bin/env python3
"""
Скрипт для сбора реальных данных о районах Краснодара и исправления generic ссылок
"""
import requests
import json
import re
from datetime import datetime

def collect_district_data():
    """Собирает реальные данные о районах Краснодара из открытых источников"""
    
    # Mapping district names to their slugs and real data
    districts_mapping = {
        # Первые 4 уже есть правильные данные в app.py
        'Центральный': {
            'slug': 'tsentralnyy',
            'status': 'complete'
        },
        '40 лет Победы': {
            'slug': '40-let-pobedy', 
            'status': 'complete'
        },
        '9-й километр': {
            'slug': '9i-kilometr',
            'status': 'complete' 
        },
        'Авиагородок': {
            'slug': 'aviagorodok',
            'status': 'complete'
        },
        
        # Нужно добавить данные для этих районов
        'Аврора': {
            'slug': 'avrora',
            'name': 'Аврора',
            'subtitle': 'Современный микрорайон с развитой инфраструктурой',
            'admin_district': 'Прикубанский округ',
            'area_type': 'Жилой современный',
            'building_type': 'Новая многоэтажная застройка',
            'transport': 'Автобусы, маршрутки, хорошее сообщение с центром',
            'avg_price': '58 000',
            'avg_cashback': '290 000',
            'rating': 4,
            'properties_count': 12,
            'description': 'Микрорайон Аврора — один из активно развивающихся районов Краснодара. Расположен в Прикубанском округе, отличается современной застройкой и хорошей транспортной доступностью. В районе активно строятся новые жилые комплексы.',
            'keywords': 'новостройки, современный район, Прикубанский',
            'advantages': [
                'Современная застройка',
                'Развивающаяся инфраструктура', 
                'Хорошая транспортная доступность',
                'Новые детские сады и школы'
            ],
            'disadvantages': [
                'Район еще развивается',
                'Ограниченное количество развлечений',
                'Удаленность от центра'
            ],
            'coordinates': [45.0548, 38.9825],  # Приблизительные координаты
            'boundaries': [[45.05, 38.98], [45.06, 38.99], [45.05, 39.0], [45.04, 38.99]]
        },
        
        'Баскет-Холл': {
            'slug': 'basket-hall',
            'name': 'Баскет-Холл',
            'subtitle': 'Спортивный район рядом с ледовым дворцом',
            'admin_district': 'Прикубанский округ',
            'area_type': 'Спортивно-развлекательный',
            'building_type': 'Современная многоэтажная', 
            'transport': 'Автобусы, близко к центру',
            'avg_price': '62 000',
            'avg_cashback': '310 000', 
            'rating': 4,
            'properties_count': 8,
            'description': 'Микрорайон Баскет-Холл получил свое название благодаря близости к спортивному комплексу "Баскет-Холл". Район известен развитой спортивной инфраструктурой и современными жилыми комплексами.',
            'keywords': 'спорт, Баскет-Холл, современные ЖК',
            'advantages': [
                'Развитая спортивная инфраструктура',
                'Современные жилые комплексы',
                'Близость к развлекательным центрам',
                'Хорошая экология'
            ],
            'disadvantages': [
                'Высокая стоимость жилья',
                'Ограниченное количество школ',
                'Пробки в выходные дни'
            ],
            'coordinates': [45.0402, 38.9632],
            'boundaries': [[45.035, 38.96], [45.045, 38.97], [45.04, 38.975], [45.035, 38.965]]
        },
        
        'Гидростроителей': {
            'slug': 'gidrostroitelei', 
            'status': 'complete'  # Уже есть в app.py
        },
        
        'Дубинка': {
            'slug': 'dubinka',
            'name': 'Дубинка',
            'subtitle': 'Исторический район с зелеными улицами',
            'admin_district': 'Западный округ',
            'area_type': 'Частный сектор',
            'building_type': 'Частные дома и малоэтажная застройка',
            'transport': 'Автобусы, маршрутки',
            'avg_price': '45 000',
            'avg_cashback': '225 000',
            'rating': 3,
            'properties_count': 6,
            'description': 'Дубинка — один из исторических районов Краснодара, известный своими зелеными улицами и частными домами. Район сохранил самобытную атмосферу старого Краснодара.',
            'keywords': 'частный сектор, исторический, зеленые улицы',
            'advantages': [
                'Тихие зеленые улицы',
                'Частные дома с участками', 
                'Историческая атмосфера',
                'Доступные цены'
            ],
            'disadvantages': [
                'Ограниченная инфраструктура',
                'Проблемы с дорогами',
                'Мало новостроек'
            ],
            'coordinates': [45.0145, 38.9234],
            'boundaries': [[45.01, 38.92], [45.02, 38.925], [45.015, 38.93], [45.01, 38.925]]
        },

        'Енисейский': {
            'slug': 'eniseyskiy',
            'name': 'Енисейский',
            'subtitle': 'Развивающийся район с новостройками',
            'admin_district': 'Карасунский округ', 
            'area_type': 'Жилой развивающийся',
            'building_type': 'Новая многоэтажная застройка',
            'transport': 'Автобусы, развивающаяся сеть',
            'avg_price': '52 000',
            'avg_cashback': '260 000',
            'rating': 4,
            'properties_count': 14,
            'description': 'Енисейский микрорайон — активно развивающийся район Краснодара в Карасунском округе. Популярен среди молодых семей благодаря доступным ценам и новой застройке.',
            'keywords': 'новостройки, молодые семьи, Карасунский',
            'advantages': [
                'Доступные цены на жилье',
                'Активное строительство',
                'Новая инфраструктура',
                'Хорошая экология'
            ],
            'disadvantages': [
                'Удаленность от центра',
                'Инфраструктура еще развивается',
                'Ограниченный транспорт'
            ],
            'coordinates': [45.0890, 38.8945],
            'boundaries': [[45.085, 38.89], [45.095, 38.90], [45.09, 38.905], [45.085, 38.895]]
        },

        'Район аэропорта': {
            'slug': 'aeroport',
            'name': 'Район аэропорта', 
            'subtitle': 'Транспортно-логистический узел города',
            'admin_district': 'Прикубанский округ',
            'area_type': 'Транспортно-логистический',
            'building_type': 'Смешанная застройка',
            'transport': 'Отличное сообщение, аэропорт',
            'avg_price': '48 000',
            'avg_cashback': '240 000',
            'rating': 3,
            'properties_count': 7,
            'description': 'Район аэропорта Краснодара — стратегически важный транспортно-логистический узел. Удобен для людей, часто путешествующих, но имеет специфику шумового воздействия.',
            'keywords': 'аэропорт, транспорт, логистика',
            'advantages': [
                'Близость к аэропорту',
                'Отличная транспортная доступность',
                'Развивающаяся инфраструктура',
                'Доступные цены'
            ],
            'disadvantages': [
                'Шум от самолетов',
                'Ограниченная социальная инфраструктура',
                'Промышленные объекты'
            ],
            'coordinates': [45.0235, 39.1456],
            'boundaries': [[45.02, 39.14], [45.03, 39.15], [45.025, 39.155], [45.02, 39.145]]
        },

        'Репино': {
            'slug': 'repino',
            'name': 'Репино',
            'subtitle': 'Творческий район с парками',
            'admin_district': 'Западный округ',
            'area_type': 'Творческо-жилой',
            'building_type': 'Малоэтажная и частная застройка',
            'transport': 'Автобусы, спокойный район',
            'avg_price': '51 000',
            'avg_cashback': '255 000',
            'rating': 4,
            'properties_count': 5,
            'description': 'Микрорайон Репино — один из самых зеленых и спокойных районов Краснодара. Популярен среди творческих людей и семей с детьми благодаря паркам и тишине.',
            'keywords': 'творческий, зеленый, парки, тишина',
            'advantages': [
                'Много зелени и парков',
                'Спокойная атмосфера',
                'Творческая среда',
                'Хорошая экология'
            ],
            'disadvantages': [
                'Удаленность от центра',
                'Ограниченная инфраструктура',
                'Мало торговых центров'
            ],
            'coordinates': [44.9867, 38.9123],
            'boundaries': [[44.98, 38.91], [44.99, 38.915], [44.985, 38.92], [44.98, 38.915]]
        },

        'СМР': {
            'slug': 'smr',
            'name': 'СМР (Славянский)',
            'subtitle': 'Исторический район города',
            'admin_district': 'Центральный округ',
            'area_type': 'Исторический центральный',
            'building_type': 'Историческая и обновленная застройка',
            'transport': 'Все виды транспорта',
            'avg_price': '65 000',
            'avg_cashback': '325 000',
            'rating': 4,
            'properties_count': 9,
            'description': 'СМР (Славянский микрорайон) — исторический район в центральной части Краснодара. Сочетает историческое наследие с современной инфраструктурой.',
            'keywords': 'исторический, центральный, культура',
            'advantages': [
                'Историческая ценность',
                'Центральное расположение',
                'Развитая инфраструктура',
                'Культурные объекты'
            ],
            'disadvantages': [
                'Высокие цены',
                'Старые коммуникации',
                'Ограниченные парковки'
            ],
            'coordinates': [45.0401, 38.9834],
            'boundaries': [[45.035, 38.98], [45.045, 38.985], [45.04, 38.99], [45.035, 38.985]]
        }
    }
    
    return districts_mapping

def fix_districts_template():
    """Исправляет generic ссылки в шаблоне districts.html"""
    
    # Mapping районов к их правильным slug-ам
    district_fixes = [
        ('Аврора', 'avrora'),
        ('Баскет-Холл', 'basket-hall'), 
        ('Дубинка', 'dubinka'),
        ('Енисейский', 'eniseyskiy'),
        ('Район аэропорта', 'aeroport'),
        ('Репино', 'repino'),
        ('СМР', 'smr'),
        # Добавим еще районы, которые есть в шаблоне
        ('Фестивальный', 'festivalny'),
        ('Юбилейный', 'yubileynyy'),
        ('Черемушки', 'cheremushki'),
        ('Комсомольский', 'komsomolsky'),
        ('Энка', 'enka')
    ]
    
    print("🔧 Исправляю generic ссылки в templates/districts.html...")
    
    # Читаем файл
    with open('templates/districts.html', 'r', encoding='utf-8') as f:
        content = f.read()
    
    # Заменяем все generic ссылки
    original_generics = len(re.findall(r"district='generic'", content))
    
    # Простая замена всех generic на реальные slug-и в порядке появления
    generic_replacements = [
        'avrora',           # Аврора  
        'basket-hall',      # Баскет-Холл
        'gidrostroitelei',  # Гидростроителей
        'dubinka',          # Дубинка
        'eniseyskiy',       # Енисейский
        'festivalny',       # Фестивальный  
        'yubileynyy',       # Юбилейный
        'cheremushki',      # Черемушки
        'komsomolsky',      # Комсомольский
        'enka',            # Энка
        'aeroport',        # Район аэропорта
        'repino',          # Репино
        'smr',             # СМР
        'tsentralnyy'      # Добавочный для последней карточки
    ]
    
    # Заменяем по одной
    for i, slug in enumerate(generic_replacements):
        if f"district='generic'" in content:
            content = content.replace("district='generic'", f"district='{slug}'", 1)
            print(f"  ✓ Заменил generic #{i+1} на '{slug}'")
    
    # Записываем обратно
    with open('templates/districts.html', 'w', encoding='utf-8') as f:
        f.write(content)
    
    remaining_generics = len(re.findall(r"district='generic'", content))
    print(f"✅ Исправлено: {original_generics - remaining_generics}/{original_generics} generic ссылок")
    
    return original_generics - remaining_generics

if __name__ == "__main__":
    print("🚀 Начинаю исправление данных районов Краснодара...")
    
    # Собираем данные о районах
    districts_data = collect_district_data()
    print(f"📊 Собрано данных о {len(districts_data)} районах")
    
    # Исправляем generic ссылки
    fixed_count = fix_districts_template()
    
    print(f"🎯 Результат: исправлено {fixed_count} generic ссылок")
    print("📋 Следующий шаг: добавить недостающие районы в get_district_data() в app.py")